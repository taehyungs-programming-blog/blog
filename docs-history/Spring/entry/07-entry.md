---
layout: default
title: "07. DB접근"
parent: "(입문)"
grand_parent: "Spring 🐍"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* **재정리 필요.**


## 환경세팅 (H2 DB)

* [Clone Code 🌍](https://github.com/EasyCoding-7/spring-entry/tree/7-1)

🚗 [H2 다운](https://www.h2database.com/html/main.html)

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/spring/entry/entry-7-1.png"/>
</p>

🚗 설치경로에서 `h2.bat` 실행

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/spring/entry/entry-7-2.png"/>
</p>

🚗 **연결**을 누르면 화면이 바뀌고 `C:\User\{사용자}`에 `test.mv.db`파일이 생성됨을 확인할 수 있다.

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/spring/entry/entry-7-3.png"/>
</p>

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/spring/entry/entry-7-4.png"/>
</p>

🚗 이후에 접속은 다중접속을 위하여 socket을 열어 접속하도록 하자. : `jdbc:h2:tcp://localhost/~/test`

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/spring/entry/entry-7-5.png"/>
</p>

🚗 간단한 테이블 생성 sql명령어는 아래와 같이 넣는다

```sql
drop table if exists member CASCADE;
create table member
(
    id bigint generated by default as identity,
    name varchar(255),
    primary key (id)
);
```

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/spring/entry/entry-7-6.png"/>
</p>

---

## 순수 JDBC를 통한 접근

* [Clone Code 🌍](https://github.com/EasyCoding-7/spring-entry/tree/7-2)

🚕 사실 이제 이 방식은 거의 사용되지 않는다.<br>
🚕 예전에 이렇게 힘들게 DB관리를 했다는 것을 이해하는 차원에서 알아두자.

🚕 `build.gradle`아래와 같이 수정

```gradle
dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
	implementation 'org.springframework.boot:spring-boot-starter-web'
	implementation 'org.springframework.boot:spring-boot-starter-jdbc'
	runtimeOnly 'com.h2database:h2'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
}
```

🚕 `src/main/resources/application.properties`아래 추가

```
spring.datasource.url=jdbc:h2:tcp://localhost/~/test
spring.datasource.driver-class-name=org.h2.Driver
```

🚕 `src/main/java/repository/JdbcMemverRepository.java`생성(코드가 길기에 Clone해서 볼 것)

🚕 하나만 예로보자

```java
@Override
public Member save(Member member) {
    // sql을 이렇게 쓸 것이다.
    String sql = "insert into member(name) values(?)";

    Connection conn = null;
    PreparedStatement pstmt = null;
    ResultSet rs = null;

    try {
        // connection을 가져오고
        conn = getConnection();
        // id를 하나씩 증가하며 넣는다
        pstmt = conn.prepareStatement(sql,
                Statement.RETURN_GENERATED_KEYS);
        // 넣을 이름을 넣고
        pstmt.setString(1, member.getName());
        // execute!
        pstmt.executeUpdate();

        rs = pstmt.getGeneratedKeys();
        if (rs.next()) {
            member.setId(rs.getLong(1));
        } else {
            throw new SQLException("id 조회 실패");
        }
        return member;
    } catch (Exception e) {
        throw new IllegalStateException(e);
    } finally {
        close(conn, pstmt, rs);
    }
}
```

🚕 이제 JdbcMemberRepository를 쓴다고 알린다.

```java
package hello.hellospring;

import hello.hellospring.repository.JdbcMemberRepository;
import hello.hellospring.repository.MemberRepository;
import hello.hellospring.service.MemberService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.sql.DataSource;

@Configuration
public class SpringConfig {

    private DataSource dataSource;

    @Autowired
    public SpringConfig(DataSource dataSource){
        this.dataSource = dataSource;
    }

    @Bean
    public MemberService memberService() {
        return new MemberService(memberRepository());
    }

    @Bean
    public MemberRepository memberRepository() {
        // return new MemoryMemberRepository();
        return new JdbcMemberRepository(dataSource);
    }
}
```

🚕 **하고싶은 말** - Spring을 통해서 오직 Config파일만 수정해 Class를 교환할 수 있었다.

---

