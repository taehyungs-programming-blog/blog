---
layout: default
title: "10. Spring Exception ë¬¸ì œ í•´ê²°"
parent: "(DB1)"
grand_parent: "Spring ğŸ"
nav_order: 2
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* ì„œë¹„ìŠ¤ê°€ ì²˜ë¦¬í•  ìˆ˜ ì—†ëŠ” SQLException ì— ëŒ€í•œ ì˜ì¡´ì„ ì œê±°í•˜ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œ? 

* ì„œë¹„ìŠ¤ê°€ ì²˜ë¦¬í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ë¦¬í¬ì§€í† ë¦¬ê°€ ë˜ì§€ëŠ” SQLException ì²´í¬ ì˜ˆì™¸ë¥¼ ëŸ°íƒ€ì„ ì˜ˆì™¸ë¡œ ì „í™˜í•´ì„œ ì„œë¹„ìŠ¤ ê³„ì¸µì— ë˜ì§€ì. 
* ì´ë ‡ê²Œ í•˜ë©´ ì„œë¹„ìŠ¤ ê³„ì¸µì´ í•´ë‹¹ ì˜ˆì™¸ë¥¼ ë¬´ì‹œí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì—, íŠ¹ì • êµ¬í˜„ ê¸°ìˆ ì— ì˜ì¡´í•˜ëŠ” ë¶€ë¶„ì„ ì œê±°í•˜ê³  ì„œë¹„ìŠ¤ ê³„ì¸µì„ ìˆœìˆ˜í•˜ê²Œ ìœ ì§€í•  ìˆ˜ ìˆë‹¤

---

## ì¸í„°í˜ì´ìŠ¤ ë„ì…

* ë¨¼ì € MemberRepository ì¸í„°í˜ì´ìŠ¤ë„ ë„ì…í•´ì„œ êµ¬í˜„ ê¸°ìˆ ì„ ì‰½ê²Œ ë³€ê²½í•  ìˆ˜ ìˆê²Œ í•´ë³´ì.

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/spring/db1/db1-10-1.png"/>
</p>

* ì‹¤ì œ ì½”ë“œì— ëŸ°íƒ€ì„ ì˜ˆì™¸ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì ìš©í•´ë³´ì.

```java
public interface MemberRepository {
    Member save(Member member);

    Member findById(String memberId);

    void update(String memberId, int money);

    void delete(String memberId);

}
```

```java
// RuntimeExceptionì„ ìƒì†ë°›ì•˜ìŒì— ì£¼ëª©.
public class MyDbException extends RuntimeException {

    public MyDbException() {
    }

    public MyDbException(String message) {
        super(message);
    }

    public MyDbException(String message, Throwable cause) {
        super(message, cause);
    }

    public MyDbException(Throwable cause) {
        super(cause);
    }
}
```

```java
/**
 * ì˜ˆì™¸ ëˆ„ìˆ˜ ë¬¸ì œ í•´ê²°
 * ì²´í¬ ì˜ˆì™¸ë¥¼ ëŸ°íƒ€ì„ ì˜ˆì™¸ë¡œ ë³€ê²½
 * MemberRepository ì¸í„°í˜ì´ìŠ¤ ì‚¬ìš©
 * throws SQLException ì œê±°
 */
@Slf4j
public class MemberRepositoryV4_1 implements MemberRepository {

    private final DataSource dataSource;

    public MemberRepositoryV4_1(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    @Override
    public Member save(Member member) {
        String sql = "insert into member(member_id, money) values (?, ?)";

        Connection con = null;
        PreparedStatement pstmt = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1, member.getMemberId());
            pstmt.setInt(2, member.getMoney());
            pstmt.executeUpdate();
            return member;
        } catch (SQLException e) {
            throw new MyDbException(e);
        } finally {
            close(con, pstmt, null);
        }

    }

    @Override
    public Member findById(String memberId) {
        String sql = "select * from member where member_id = ?";

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1, memberId);

            rs = pstmt.executeQuery();
            if (rs.next()) {
                Member member = new Member();
                member.setMemberId(rs.getString("member_id"));
                member.setMoney(rs.getInt("money"));
                return member;
            } else {
                throw new NoSuchElementException("member not found memberId=" + memberId);
            }

        } catch (SQLException e) {
            throw new MyDbException(e);
        } finally {
            close(con, pstmt, rs);
        }

    }

    @Override
    public void update(String memberId, int money) {
        String sql = "update member set money=? where member_id=?";

        Connection con = null;
        PreparedStatement pstmt = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setInt(1, money);
            pstmt.setString(2, memberId);
            int resultSize = pstmt.executeUpdate();
            log.info("resultSize={}", resultSize);
        } catch (SQLException e) {
            throw new MyDbException(e);
        } finally {
            close(con, pstmt, null);
        }

    }

    @Override
    public void delete(String memberId) {
        String sql = "delete from member where member_id=?";

        Connection con = null;
        PreparedStatement pstmt = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1, memberId);
            pstmt.executeUpdate();
        } catch (SQLException e) {
            throw new MyDbException(e);
        } finally {
            close(con, pstmt, null);
        }

    }

    private void close(Connection con, Statement stmt, ResultSet rs) {
        JdbcUtils.closeResultSet(rs);
        JdbcUtils.closeStatement(stmt);
        //ì£¼ì˜! íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ DataSourceUtilsë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
        DataSourceUtils.releaseConnection(con, dataSource);
    }


    private Connection getConnection() throws SQLException {
        //ì£¼ì˜! íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ DataSourceUtilsë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
        Connection con = DataSourceUtils.getConnection(dataSource);
        log.info("get connection={}, class={}", con, con.getClass());
        return con;
    }


}
```

---

```java
/**
 * ì˜ˆì™¸ ëˆ„ìˆ˜ ë¬¸ì œ í•´ê²°
 * SQLException ì œê±°
 *
 * MemberRepository ì¸í„°í˜ì´ìŠ¤ ì˜ì¡´
 */
@Slf4j
public class MemberServiceV4 {

    private final MemberRepository memberRepository;

    public MemberServiceV4(MemberRepository memberRepository) {
        this.memberRepository = memberRepository;
    }

    @Transactional
    public void accountTransfer(String fromId, String toId, int money) {
        bizLogic(fromId, toId, money);
    }

    private void bizLogic(String fromId, String toId, int money) {
        Member fromMember = memberRepository.findById(fromId);
        Member toMember = memberRepository.findById(toId);

        memberRepository.update(fromId, fromMember.getMoney() - money);

        validation(toMember);
        memberRepository.update(toId, toMember.getMoney() + money);
    }

    private void validation(Member toMember) {
        if (toMember.getMemberId().equals("ex")) {
            throw new IllegalStateException("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ");
        }
    }

}
```

---

* ë‚¨ì€ ë¬¸ì œ ?
* ë¦¬í¬ì§€í† ë¦¬ì—ì„œ ë„˜ì–´ì˜¤ëŠ” íŠ¹ì •í•œ ì˜ˆì™¸ì˜ ê²½ìš° ë³µêµ¬ë¥¼ ì‹œë„í•  ìˆ˜ë„ ìˆë‹¤. 
* ê·¸ëŸ°ë° ì§€ê¸ˆ ë°©ì‹ì€ í•­ìƒ MyDbException ì´ë¼ëŠ” ì˜ˆì™¸ë§Œ ë„˜ì–´ì˜¤ê¸° ë•Œë¬¸ì— ì˜ˆì™¸ë¥¼ êµ¬ë¶„í•  ìˆ˜ ì—†ëŠ” ë‹¨ì ì´ ìˆë‹¤. 
* ë§Œì•½ íŠ¹ì • ìƒí™©ì—ëŠ” ì˜ˆì™¸ë¥¼ ì¡ì•„ì„œ ë³µêµ¬í•˜ê³  ì‹¶ìœ¼ë©´ ì˜ˆì™¸ë¥¼ ì–´ë–»ê²Œ êµ¬ë¶„í•´ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆì„ê¹Œ?

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/spring/db1/db1-10-2.png"/>
</p>

```java
// MyDbExceptionì„ ìƒì†ë°›ìŒì„ ì£¼ëª©.
public class MyDuplicateKeyException extends MyDbException {

    public MyDuplicateKeyException() {
    }

    public MyDuplicateKeyException(String message) {
        super(message);
    }

    public MyDuplicateKeyException(String message, Throwable cause) {
        super(message, cause);
    }

    public MyDuplicateKeyException(Throwable cause) {
        super(cause);
    }
}
```

```java
@Slf4j
public class ExTranslatorV1Test {

    Repository repository;
    Service service;

    @BeforeEach
    void init() {
        DriverManagerDataSource dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);
        repository = new Repository(dataSource);
        service = new Service(repository);
    }

    @Test
    void duplicateKeySave() {
        service.create("myId");
        service.create("myId");//ê°™ì€ ID ì €ì¥ ì‹œë„
    }

    @Slf4j
    @RequiredArgsConstructor
    static class Service {
        private final Repository repository;

        public void create(String memberId) {
            try {
                repository.save(new Member(memberId, 0));
                log.info("saveId={}", memberId);
            } catch (MyDuplicateKeyException e) {
                log.info("í‚¤ ì¤‘ë³µ, ë³µêµ¬ ì‹œë„");
                String retryId = generateNewId(memberId);
                log.info("retryId={}", retryId);
                repository.save(new Member(retryId, 0));
            } catch (MyDbException e) {
                log.info("ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ ì˜ˆì™¸", e);
                throw e;
            }
        }

        private String generateNewId(String memberId) {
            return memberId + new Random().nextInt(10000);
        }

    }

    @RequiredArgsConstructor
    static class Repository {
        private final DataSource dataSource;

        public Member save(Member member) {
            String sql = "insert into member(member_id, money) values(?,?)";
            Connection con = null;
            PreparedStatement pstmt = null;

            try {
                con = dataSource.getConnection();
                pstmt = con.prepareStatement(sql);
                pstmt.setString(1, member.getMemberId());
                pstmt.setInt(2, member.getMoney());
                pstmt.executeUpdate();
                return member;
            } catch (SQLException e) {
                //h2 db
                if (e.getErrorCode() == 23505) {
                    throw new MyDuplicateKeyException(e);
                }
                throw new MyDbException(e);
            } finally {
                JdbcUtils.closeStatement(pstmt);
                JdbcUtils.closeConnection(con);
            }
        }
    }
}
```