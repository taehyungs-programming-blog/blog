---
layout: default
title: "03. Transaction ì´ë€? + ìˆœìˆ˜ JAVAë¡œ Transaction êµ¬í˜„"
parent: "(DB1)"
grand_parent: "Spring ğŸ"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## íŠ¸ëœì­ì…˜ì´ë€?

* íŠ¸ëœì­ì…˜ì„ ì´ë¦„ ê·¸ëŒ€ë¡œ ë²ˆì—­í•˜ë©´ ê±°ë˜ë¼ëŠ” ëœ»ì´ë‹¤. 
* DBì— ì¶©ëŒì—†ì´ ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë„£ê³ /ì§€ìš°ê³ /ìˆ˜ì •í•˜ê³  í•˜ëŠ” ë°©ë²•ì´ë¼ ìƒê°í•˜ë©´ í¸í•˜ë‹¤.

* ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ íŠ¸ëœì­ì…˜ì€ í•˜ë‚˜ì˜ ê±°ë˜ë¥¼ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•˜ë„ë¡ ë³´ì¥í•´ì£¼ëŠ” ê²ƒì„ ëœ»í•œë‹¤. 
    * í•˜ë‚˜ì˜ ê±°ë˜ë¥¼ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•˜ë ¤ë©´ ìƒê°ë³´ë‹¤ ê³ ë ¤í•´ì•¼ í•  ì ì´ ë§ë‹¤. 
    * ì˜ˆë¥¼ ë“¤ì–´ì„œ Aì˜ 5000ì›ì„ Bì—ê²Œ ê³„ì¢Œì´ì²´í•œë‹¤ê³  ìƒê°í•´ë³´ì. Aì˜ ì”ê³ ë¥¼ 5000ì› ê°ì†Œí•˜ê³ , Bì˜ ì”ê³ ë¥¼ 5000ì› ì¦ê°€í•´ì•¼í•œë‹¤.

* íŠ¸ëœì­ì…˜ì€ ACID(http://en.wikipedia.org/wiki/ACID)ë¼ í•˜ëŠ” ì›ìì„±(Atomicity), ì¼ê´€ì„± (Consistency), ê²©ë¦¬ì„±(Isolation), ì§€ì†ì„±(Durability)ì„ ë³´ì¥í•´ì•¼ í•œë‹¤. 
    * ì›ìì„±: íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì‹¤í–‰í•œ ì‘ì—…ë“¤ì€ ë§ˆì¹˜ í•˜ë‚˜ì˜ ì‘ì—…ì¸ ê²ƒì²˜ëŸ¼ ëª¨ë‘ ì„±ê³µ í•˜ê±°ë‚˜ ëª¨ë‘ ì‹¤íŒ¨í•´ì•¼ í•œë‹¤. 
    * ì¼ê´€ì„±: ëª¨ë“  íŠ¸ëœì­ì…˜ì€ ì¼ê´€ì„± ìˆëŠ” ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœë¥¼ ìœ ì§€í•´ì•¼ í•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì •í•œ ë¬´ê²°ì„± ì œì•½ ì¡°ê±´ì„ í•­ìƒ ë§Œì¡±í•´ì•¼ í•œë‹¤. 
    * ê²©ë¦¬ì„±: ë™ì‹œì— ì‹¤í–‰ë˜ëŠ” íŠ¸ëœì­ì…˜ë“¤ì´ ì„œë¡œì—ê²Œ ì˜í–¥ì„ ë¯¸ì¹˜ì§€ ì•Šë„ë¡ ê²©ë¦¬í•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ë™ì‹œì— ê°™ì€ ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ì§€ ëª»í•˜ë„ë¡ í•´ì•¼ í•œë‹¤. ê²©ë¦¬ì„±ì€ ë™ì‹œì„±ê³¼ ê´€ë ¨ëœ ì„±ëŠ¥ ì´ìŠˆë¡œ ì¸í•´ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ (Isolation level)ì„ ì„ íƒí•  ìˆ˜ ìˆë‹¤. 
    * ì§€ì†ì„±: íŠ¸ëœì­ì…˜ì„ ì„±ê³µì ìœ¼ë¡œ ëë‚´ë©´ ê·¸ ê²°ê³¼ê°€ í•­ìƒ ê¸°ë¡ë˜ì–´ì•¼ í•œë‹¤. ì¤‘ê°„ì— ì‹œìŠ¤í…œì— ë¬¸ì œê°€ ë°œìƒí•´ë„ ë°ì´í„°ë² ì´ìŠ¤ ë¡œê·¸ ë“±ì„ ì‚¬ìš©í•´ì„œ ì„±ê³µí•œ íŠ¸ëœì­ì…˜ ë‚´ìš©ì„ ë³µêµ¬í•´ì•¼ í•œë‹¤

---

## íŠ¸ëœì­ì…˜ì´ ì—†ëŠ”ê²½ìš° ë¬¸ì œ

```java
@RequiredArgsConstructor
public class MemberServiceV1 {

    private final MemberRepositoryV1 memberRepository;

    public void accountTransfer(String fromId, String toId, int money) throws SQLException {
        //ì‹œì‘
        Member fromMember = memberRepository.findById(fromId);
        Member toMember = memberRepository.findById(toId);

        memberRepository.update(fromId, fromMember.getMoney() - money);
        validation(toMember);
        memberRepository.update(toId, toMember.getMoney() + money);
        //ì»¤ë°‹, ë¡¤ë°±
    }

    private void validation(Member toMember) {
        // exë¼ëŠ” ë©¤ë²„ê°€ ë“¤ì–´ì˜¤ë©´ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ì
        if (toMember.getMemberId().equals("ex")) {
            throw new IllegalStateException("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ");
        }
    }
}
```

```java
/**
 * ê¸°ë³¸ ë™ì‘, íŠ¸ëœì­ì…˜ì´ ì—†ì–´ì„œ ë¬¸ì œ ë°œìƒ
 */
class MemberServiceV1Test {

    public static final String MEMBER_A = "memberA";
    public static final String MEMBER_B = "memberB";
    public static final String MEMBER_EX = "ex";

    private MemberRepositoryV1 memberRepository;
    private MemberServiceV1 memberService;

    @BeforeEach
    void before() {
        DriverManagerDataSource dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);
        memberRepository = new MemberRepositoryV1(dataSource);
        memberService = new MemberServiceV1(memberRepository);
    }

    @AfterEach
    void after() throws SQLException {
        memberRepository.delete(MEMBER_A);
        memberRepository.delete(MEMBER_B);
        memberRepository.delete(MEMBER_EX);
    }

    @Test
    @DisplayName("ì •ìƒ ì´ì²´")
    void accountTransfer() throws SQLException {
        //given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberB = new Member(MEMBER_B, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberB);

        //when
        memberService.accountTransfer(memberA.getMemberId(), memberB.getMemberId(), 2000);

        //then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberB = memberRepository.findById(memberB.getMemberId());
        assertThat(findMemberA.getMoney()).isEqualTo(8000);
        assertThat(findMemberB.getMoney()).isEqualTo(12000);
    }

    @Test
    @DisplayName("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ")
    void accountTransferEx() throws SQLException {
        //given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberEx = new Member(MEMBER_EX, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberEx);

        //when
        assertThatThrownBy(() -> memberService.accountTransfer(memberA.getMemberId(), memberEx.getMemberId(), 2000))
                .isInstanceOf(IllegalStateException.class);

        //then
        // ì˜ˆìƒëœ ê²°ê³¼ê°€ ë‚˜ì˜¤ì§€ ì•Šê²Œëœë‹¤.
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberB = memberRepository.findById(memberEx.getMemberId());
        assertThat(findMemberA.getMoney()).isEqualTo(8000);
        assertThat(findMemberB.getMoney()).isEqualTo(10000);
    }
}
```

---

## íŠ¸ëœì­ì…˜ìœ¼ë¡œ í•´ê²°

```java
/**
 * íŠ¸ëœì­ì…˜ - íŒŒë¼ë¯¸í„° ì—°ë™, í’€ì„ ê³ ë ¤í•œ ì¢…ë£Œ
 */
@Slf4j
@RequiredArgsConstructor
public class MemberServiceV2 {

    private final DataSource dataSource;
    private final MemberRepositoryV2 memberRepository;

    public void accountTransfer(String fromId, String toId, int money) throws SQLException {
        Connection con = dataSource.getConnection();
        try {
            con.setAutoCommit(false);//íŠ¸ëœì­ì…˜ ì‹œì‘
            //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
            bizLogic(con, fromId, toId, money);
            con.commit(); //ì„±ê³µì‹œ ì»¤ë°‹
        } catch (Exception e) {
            con.rollback(); //ì‹¤íŒ¨ì‹œ ë¡¤ë°±
            throw new IllegalStateException(e);
        } finally {
            release(con);
        }

    }

    private void bizLogic(Connection con, String fromId, String toId, int money) throws SQLException {
        Member fromMember = memberRepository.findById(con, fromId);
        Member toMember = memberRepository.findById(con, toId);

        memberRepository.update(con, fromId, fromMember.getMoney() - money);
        validation(toMember);
        memberRepository.update(con, toId, toMember.getMoney() + money);
    }

    private void validation(Member toMember) {
        if (toMember.getMemberId().equals("ex")) {
            throw new IllegalStateException("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ");
        }
    }

    private void release(Connection con) {
        if (con != null) {
            try {
                con.setAutoCommit(true); //ì»¤ë„¥ì…˜ í’€ ê³ ë ¤
                con.close();
            } catch (Exception e) {
                log.info("error", e);
            }
        }
    }
}
```

```java
/**
 * íŠ¸ëœì­ì…˜ - ì»¤ë„¥ì…˜ íŒŒë¼ë¯¸í„° ì „ë‹¬ ë°©ì‹ ë™ê¸°í™”
 */
class MemberServiceV2Test {

    public static final String MEMBER_A = "memberA";
    public static final String MEMBER_B = "memberB";
    public static final String MEMBER_EX = "ex";

    private MemberRepositoryV2 memberRepository;
    private MemberServiceV2 memberService;

    @BeforeEach
    void before() {
        DriverManagerDataSource dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);
        memberRepository = new MemberRepositoryV2(dataSource);
        memberService = new MemberServiceV2(dataSource, memberRepository);
    }

    @AfterEach
    void after() throws SQLException {
        memberRepository.delete(MEMBER_A);
        memberRepository.delete(MEMBER_B);
        memberRepository.delete(MEMBER_EX);
    }

    @Test
    @DisplayName("ì •ìƒ ì´ì²´")
    void accountTransfer() throws SQLException {
        //given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberB = new Member(MEMBER_B, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberB);

        //when
        memberService.accountTransfer(memberA.getMemberId(), memberB.getMemberId(), 2000);

        //then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberB = memberRepository.findById(memberB.getMemberId());
        assertThat(findMemberA.getMoney()).isEqualTo(8000);
        assertThat(findMemberB.getMoney()).isEqualTo(12000);
    }

    @Test
    @DisplayName("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ")
    void accountTransferEx() throws SQLException {
        //given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberEx = new Member(MEMBER_EX, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberEx);

        //when
        assertThatThrownBy(() -> memberService.accountTransfer(memberA.getMemberId(), memberEx.getMemberId(), 2000))
                .isInstanceOf(IllegalStateException.class);

        //then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberB = memberRepository.findById(memberEx.getMemberId());
        assertThat(findMemberA.getMoney()).isEqualTo(10000);
        assertThat(findMemberB.getMoney()).isEqualTo(10000);
    }

}
```

* ê·¼ë° ì´ê±° ë„ˆë¬´ ë³µì¡í•˜ì§€ ì•Šë‚˜?
* Springì´ ê°„ë‹¨íˆ í•´ê²°í•´ ì¤€ë‹¤.