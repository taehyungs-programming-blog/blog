---
layout: default
title: "04. Springì—ì„œ ì§€ì›í•˜ëŠ” Transaction"
parent: "(DB1)"
grand_parent: "Spring ğŸ"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* ê¸°ì¡´ ë¬¸ì œì ì„ ë¶„ì„í•˜ê¸° ì „ ì´ë¡ ì  ë¶€ë¶„ì„ ì •ë¦¬í•˜ê³  ë“¤ì–´ê°€ì

* ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì¡° 
    * ì—¬ëŸ¬ê°€ì§€ ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì¡°ê°€ ìˆì§€ë§Œ, ê°€ì¥ ë‹¨ìˆœí•˜ë©´ì„œ ë§ì´ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì€ ì—­í• ì— ë”°ë¼ 3ê°€ì§€ ê³„ì¸µìœ¼ë¡œ ë‚˜ëˆ„ëŠ” ê²ƒì´ë‹¤.

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/spring/db1/db1-4-1.png"/>
</p>

* í”„ë ˆì  í…Œì´ì…˜ ê³„ì¸µ 
    * UIì™€ ê´€ë ¨ëœ ì²˜ë¦¬ ë‹´ë‹¹ 
    * ì›¹ ìš”ì²­ê³¼ ì‘ë‹µ 
    * ì‚¬ìš©ì ìš”ì²­ì„ ê²€ì¦ 
    * ì£¼ ì‚¬ìš© ê¸°ìˆ : ì„œë¸”ë¦¿ê³¼ HTTP ê°™ì€ ì›¹ ê¸°ìˆ , ìŠ¤í”„ë§ MVC 
* ì„œë¹„ìŠ¤ ê³„ì¸µ 
    * ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹´ë‹¹ 
    * ì£¼ ì‚¬ìš© ê¸°ìˆ : ê°€ê¸‰ì  íŠ¹ì • ê¸°ìˆ ì— ì˜ì¡´í•˜ì§€ ì•Šê³ , ìˆœìˆ˜ ìë°” ì½”ë“œë¡œ ì‘ì„± 
* ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ
    * ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ê·¼í•˜ëŠ” ì½”ë“œ 
    * ì£¼ ì‚¬ìš© ê¸°ìˆ : JDBC, JPA, File, Redis, Mongo ...

* ì—¬ê¸°ì„œ ê°€ì¥ ì¤‘ìš”í•œ ê³³ì€ ì–´ë””ì¼ê¹Œ? ë°”ë¡œ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ë“¤ì–´ìˆëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µì´ë‹¤. 
* ì‹œê°„ì´ í˜ëŸ¬ì„œ UI(ì›¹)ì™€ ê´€ë ¨ëœ ë¶€ë¶„ì´ ë³€í•˜ê³ , ë°ì´í„° ì €ì¥ ê¸°ìˆ ì„ ë‹¤ë¥¸ ê¸°ìˆ ë¡œ ë³€ê²½í•´ë„, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ìµœëŒ€í•œ ë³€ê²½ì—†ì´ ìœ ì§€ë˜ì–´ì•¼ í•œë‹¤.

---

* ìœ„ ì§€ì‹ì„ ê¸°ë°˜ìœ¼ë¡œ ê¸°ì¡´ì½”ë“œì˜ ë¬¸ì œë¥¼ ë³´ì.

## ê¸°ì¡´ ì½”ë“œì˜ ë¬¸ì œ

```java
@RequiredArgsConstructor
public class MemberServiceV1 {

    private final MemberRepositoryV1 memberRepository;

    public void accountTransfer(String fromId, String toId, int money) throws SQLException {
        // ì¼ë‹¨ V1ì€ íŠ¸ëœì­ì…˜ì´ êµ¬í˜„ì•ˆë˜ìˆìœ¼ë‹ˆ ë¬¸ì œì´ê³ 
        // MemberServiceV1ì€ JDBCì— ì˜ì¡´ì ì´ë‹¤.
            // MemberRepositoryV1ê°€ JDBCê³  
        // Exceptionì„ MemberRepositoryV1ê°€ ì•„ë‹ˆë¼ Repositoryì—ì„œ ë°›ì•„ ì²˜ë¦¬í•œë‹¤.
        Member fromMember = memberRepository.findById(fromId);
        Member toMember = memberRepository.findById(toId);

        // ...
```

```java
@Slf4j
@RequiredArgsConstructor
public class MemberServiceV2 {

    private final DataSource dataSource;
    private final MemberRepositoryV2 memberRepository;

    // V2ì—­ì‹œ JDBCì— ì˜ì¡´ì ì´ë©°
    // transactionê³¼ ë¹„ì§€ë‹ˆìŠ¤ë¡œì§ì´ ê°™ì´ ì“°ì´ë©° ì½ê¸° ì¢‹ì€ ì½”ë“œë¼ í•˜ê¸° ì–´ë µë‹¤.

    public void accountTransfer(String fromId, String toId, int money) throws SQLException {
        Connection con = dataSource.getConnection();
        try {
            con.setAutoCommit(false);//íŠ¸ëœì­ì…˜ ì‹œì‘
            //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
            bizLogic(con, fromId, toId, money);
            con.commit(); //ì„±ê³µì‹œ ì»¤ë°‹
        } catch (Exception e) {
            con.rollback(); //ì‹¤íŒ¨ì‹œ ë¡¤ë°±
            throw new IllegalStateException(e);
        } finally {
            release(con);
        }

    }

    private void bizLogic(Connection con, String fromId, String toId, int money) throws SQLException {
        Member fromMember = memberRepository.findById(con, fromId);
        Member toMember = memberRepository.findById(con, toId);

        memberRepository.update(con, fromId, fromMember.getMoney() - money);
        validation(toMember);
        memberRepository.update(con, toId, toMember.getMoney() + money);
    }
```

---

## íŠ¸ëœì­ì…˜ ë¬¸ì œ 

* ê°€ì¥ í° ë¬¸ì œëŠ” íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ë©´ì„œ ìƒê¸´ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œë“¤ì´ë‹¤. 

* JDBC êµ¬í˜„ ê¸°ìˆ ì´ ì„œë¹„ìŠ¤ ê³„ì¸µì— ëˆ„ìˆ˜ë˜ëŠ” ë¬¸ì œ 
* íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ê¸° ìœ„í•´ JDBC êµ¬í˜„ ê¸°ìˆ ì´ ì„œë¹„ìŠ¤ ê³„ì¸µì— ëˆ„ìˆ˜ë˜ì—ˆë‹¤. 
* ì„œë¹„ìŠ¤ ê³„ì¸µì€ ìˆœìˆ˜í•´ì•¼ í•œë‹¤. -> êµ¬í˜„ ê¸°ìˆ ì„ ë³€ê²½í•´ë„ ì„œë¹„ìŠ¤ ê³„ì¸µ ì½”ë“œëŠ” ìµœëŒ€í•œ ìœ ì§€í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤. (ë³€í™”ì— ëŒ€ì‘) 
* ê·¸ë˜ì„œ ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì— JDBC ì½”ë“œë¥¼ ë‹¤ ëª°ì•„ë‘ëŠ” ê²ƒì´ë‹¤. 
* ë¬¼ë¡  ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì˜ êµ¬í˜„ ê¸°ìˆ ì´ ë³€ê²½ë  ìˆ˜ë„ ìˆìœ¼ë‹ˆ ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì€ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤. 

* ì„œë¹„ìŠ¤ ê³„ì¸µì€ íŠ¹ì • ê¸°ìˆ ì— ì¢…ì†ë˜ì§€ ì•Šì•„ì•¼ í•œë‹¤. ì§€ê¸ˆê¹Œì§€ ê·¸ë ‡ê²Œ ë…¸ë ¥í•´ì„œ ë°ì´í„° ì ‘ê·¼  ê³„ì¸µìœ¼ë¡œ JDBC ê´€ë ¨ ì½”ë“œë¥¼ ëª¨ì•˜ëŠ”ë°, íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ë©´ì„œ ê²°êµ­ ì„œë¹„ìŠ¤ ê³„ì¸µì— JDBC êµ¬í˜„ ê¸°ìˆ ì˜ ëˆ„ìˆ˜ê°€ ë°œìƒí–ˆë‹¤. 

* íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë¬¸ì œ 
    * ê°™ì€ íŠ¸ëœì­ì…˜ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ ì»¤ë„¥ì…˜ì„ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê²¨ì•¼ í•œë‹¤. 
    * ì´ë•Œ íŒŒìƒë˜ëŠ” ë¬¸ì œë“¤ë„ ìˆë‹¤. ë˜‘ê°™ì€ ê¸°ëŠ¥ë„ íŠ¸ëœì­ì…˜ìš© ê¸°ëŠ¥ê³¼ íŠ¸ëœì­ì…˜ì„ ìœ ì§€í•˜ì§€ ì•Šì•„ë„ ë˜ëŠ” ê¸°ëŠ¥ìœ¼ë¡œ ë¶„ë¦¬í•´ì•¼ í•œë‹¤. 

* íŠ¸ëœì­ì…˜ ì ìš© ë°˜ë³µ ë¬¸ì œ 
    * íŠ¸ëœì­ì…˜ ì ìš© ì½”ë“œë¥¼ ë³´ë©´ ë°˜ë³µì´ ë§ë‹¤. try , catch , finally ...

ì¶”ê°€ì ì¸ ë¬¸ì œëŠ” ìˆì§€ë§Œ ìƒëµí•˜ê³  ...

---

## í•´ê²°í•´ ë³´ì.

* íŠ¸ëœì­ì…˜ì˜ ì¶”ìƒí™”
    * PlatformTransactionManager(ê°„ë‹¨íˆ Transaction Managerë¼ê³  í•œë‹¤)ë¥¼ í†µí•´ êµ¬í˜„í•œë‹¤

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/spring/db1/db1-4-2.png"/>
</p>

* Transaction ManagerëŠ” í¬ê²Œ ë‘ ê°€ì§€ ì¼ì„ í•˜ëŠ”ë°

* íŠ¸ëœì­ì…˜ ì¶”ìƒí™” 
    * íŠ¸ëœì­ì…˜ ê¸°ìˆ ì„ ì¶”ìƒí™” í•˜ëŠ” ë¶€ë¶„ì€ ì•ì—ì„œ ì„¤ëª…í–ˆë‹¤. 
* ë¦¬ì†ŒìŠ¤ ë™ê¸°í™” 
    * íŠ¸ëœì­ì…˜ì„ ìœ ì§€í•˜ë ¤ë©´ íŠ¸ëœì­ì…˜ì˜ ì‹œì‘ë¶€í„° ëê¹Œì§€ ê°™ì€ ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ì„ ìœ ì§€í•´ì•„í•œë‹¤. 
    * ê²°êµ­ ê°™ì€ ì»¤ë„¥ì…˜ì„ ë™ê¸°í™”(ë§ì¶”ì–´ ì‚¬ìš©)í•˜ê¸° ìœ„í•´ì„œ ì´ì „ì—ëŠ” íŒŒë¼ë¯¸í„°ë¡œ ì»¤ë„¥ì…˜ì„ ì „ë‹¬í•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í–ˆë‹¤. 
    * íŒŒë¼ë¯¸í„°ë¡œ ì»¤ë„¥ì…˜ì„ ì „ë‹¬í•˜ëŠ” ë°©ë²•ì€ ì½”ë“œê°€ ì§€ì €ë¶„í•´ì§€ëŠ” ê²ƒì€ ë¬¼ë¡ ì´ê³ , ì»¤ë„¥ì…˜ì„ ë„˜ê¸°ëŠ” ë©”ì„œë“œì™€ ë„˜ê¸°ì§€ ì•ŠëŠ” ë©”ì„œë“œë¥¼ ì¤‘ë³µí•´ì„œ ë§Œë“¤ì–´ì•¼ í•˜ëŠ” ë“± ì—¬ëŸ¬ê°€ì§€ ë‹¨ì ë“¤ì´ ë§ë‹¤

---

## êµ¬í˜„í•´ë³´ì

```java
/**
 * íŠ¸ëœì­ì…˜ - íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €

* DataSourceUtilsì—ì„œ ê²°êµ­ PlatformTransactionManagerë¥¼ ì‚¬ìš©í•˜ê²Œ ë¨
* ë”°ë¼ì„œ DataSourceUtilsë¡œ transactionì„ ì²˜ë¦¬í•˜ë©´ ëœë‹¤.

 * DataSourceUtils.getConnection()
 * DataSourceUtils.releaseConnection()
 */
@Slf4j
public class MemberRepositoryV3 {

    private final DataSource dataSource;

    public MemberRepositoryV3(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    public Member save(Member member) throws SQLException {
        String sql = "insert into member(member_id, money) values (?, ?)";

        Connection con = null;
        PreparedStatement pstmt = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1, member.getMemberId());
            pstmt.setInt(2, member.getMoney());
            pstmt.executeUpdate();
            return member;
        } catch (SQLException e) {
            log.error("db error", e);
            throw e;
        } finally {
            close(con, pstmt, null);
        }

    }

    // ...

    private void close(Connection con, Statement stmt, ResultSet rs) {
        JdbcUtils.closeResultSet(rs);
        JdbcUtils.closeStatement(stmt);
        //ì£¼ì˜! íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ DataSourceUtilsë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
        DataSourceUtils.releaseConnection(con, dataSource);
    }


    private Connection getConnection() throws SQLException {
        //ì£¼ì˜! íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ DataSourceUtilsë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
        Connection con = DataSourceUtils.getConnection(dataSource);
        log.info("get connection={}, class={}", con, con.getClass());
        return con;
    }


}
```

```java
@Slf4j
@RequiredArgsConstructor
public class MemberServiceV3_1 {

    // transaction manager ì‚¬ìš©
    private final PlatformTransactionManager transactionManager;
    private final MemberRepositoryV3 memberRepository;

    public void accountTransfer(String fromId, String toId, int money) throws SQLException {
        //íŠ¸ëœì­ì…˜ ì‹œì‘
        TransactionStatus status = transactionManager.getTransaction(new DefaultTransactionDefinition());

        try {
            //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
            bizLogic(fromId, toId, money);
            transactionManager.commit(status); //ì„±ê³µì‹œ ì»¤ë°‹
        } catch (Exception e) {
            transactionManager.rollback(status); //ì‹¤íŒ¨ì‹œ ë¡¤ë°±
            throw new IllegalStateException(e);
        }

    }

    private void bizLogic(String fromId, String toId, int money) throws SQLException {
        Member fromMember = memberRepository.findById(fromId);
        Member toMember = memberRepository.findById(toId);

        memberRepository.update(fromId, fromMember.getMoney() - money);
        validation(toMember);
        memberRepository.update(toId, toMember.getMoney() + money);
    }

    private void validation(Member toMember) {
        if (toMember.getMemberId().equals("ex")) {
            throw new IllegalStateException("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ");
        }
    }

}
```

```java
class MemberServiceV3_1Test {

    public static final String MEMBER_A = "memberA";
    public static final String MEMBER_B = "memberB";
    public static final String MEMBER_EX = "ex";

    private MemberRepositoryV3 memberRepository;
    private MemberServiceV3_1 memberService;

    @BeforeEach
    void before() {
        DriverManagerDataSource dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);
        memberRepository = new MemberRepositoryV3(dataSource);
        // ì˜ì¡´ì„±ì„ ì£¼ì…í•˜ë ¤ë©´ ì—¬ê¸°ì„œ DataSourceTrasctionManagerê°€ ì•„ë‹Œ ë‹¤ë¥¸ ì• ë¥¼ ë„£ì–´ì£¼ë©´ ë¨.
        PlatformTransactionManager transactionManager = new DataSourceTransactionManager(dataSource);
        memberService = new MemberServiceV3_1(transactionManager, memberRepository);
    }

    // ...
```