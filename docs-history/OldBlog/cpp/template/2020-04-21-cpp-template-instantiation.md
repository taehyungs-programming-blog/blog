---
title: "C++ Template : Template Instantiation 개념"
permalink: cpp/template/Instantiation/                # link 직접 지정
toc: true                       # for Sub-title (On this page)
comments: true                  # for disqus Comments
categories:                     # for categories
date: 2020-04-21 00:00:00 -0000
last_modified_at: 2020-06-16 00:00:00 -0000
sidebar:
  title: "C++"
  nav: cpp
header:
  teaser: /file/image/cpp-page-teaser.gif
tag:
  - C++
category:
  - template
  - Instantiation
excerpt: ""
---

```cpp
template<typename T>
T square(T a)
{
  return a * a;
}

int main()
{
  // square<int>(3);
  // square를 쓰기전 까지는 기계어 코드가 생성이 안됨.
  
  square(3);
  // square를 쓰면 기계어 코드까지 생성이 된다.
  
  // Template을 통해서 기계어를 뽑아 내는 과정을 Template Instantiation이라 한다.
}
```

* Template instantiation
    * 컴파일러가 함수(클래스) 템플릿으로 부터 실제 함수(클래스)를 만들어 내는 과정
    * 명시적/ 암시적 인스턴스화로 나눌 수 있다.

```cpp
int add(int a, int b)
{
  return a + b;
}

template<typename T>
T square(T a)
{
  return a * a;
}

int main()
{
  // square(3);
}

// 여기서 기계어를 뽑아보면
```

참고로 기계어 코드를 만드는 방법은

```s
# 기계어 뽑는 방법
# VS기준으로
$ cl file.cpp /FAs
```

> 전체 코드는 아래의 기계어 코드1을 확인하자

아래처럼 기계어가 add만 생성됨을 확인할 수 있다.

```
// ...
?add@@YAHHH@Z PROC					; add

; 2    : {

	mov	DWORD PTR [rsp+16], edx
	mov	DWORD PTR [rsp+8], ecx

; 3    :   return a + b;

	mov	eax, DWORD PTR b$[rsp]
	mov	ecx, DWORD PTR a$[rsp]
	add	ecx, eax
	mov	eax, ecx

; 4    : }

	ret	0
?add@@YAHHH@Z ENDP					; add
// ...
```

```cpp
int add(int a, int b)
{
  return a + b;
}

template<typename T>
T square(T a)
{
  return a * a;
}

int main()
{
  square(3);
}
```

square를 쓰게된다면 기계어에서 squre도 확인할 수 있다

```
// ...
PUBLIC	??$square@H@@YAHH@Z				; square<int>
pdata	SEGMENT
$pdata$main DD	imagerel $LN3
	DD	imagerel $LN3+21
	DD	imagerel $unwind$main
pdata	ENDS
xdata	SEGMENT
$unwind$main DD	010401H
	DD	04204H
xdata	ENDS
; Function compile flags: /Odtp
; File c:\users\ncsoft\test.cpp
;	COMDAT ??$square@H@@YAHH@Z
_TEXT	SEGMENT
a$ = 8
??$square@H@@YAHH@Z PROC				; square<int>, COMDAT
// ...
```

---
---

## 기계어1

```
; Listing generated by Microsoft (R) Optimizing Compiler Version 19.16.27034.0 

include listing.inc

INCLUDELIB LIBCMT
INCLUDELIB OLDNAMES

PUBLIC	?add@@YAHHH@Z					; add
PUBLIC	main
; Function compile flags: /Odtp
; File c:\users\ncsoft\test.cpp
_TEXT	SEGMENT
main	PROC

; 14   :   // square(3);
; 15   : }

	xor	eax, eax
	ret	0
main	ENDP
_TEXT	ENDS
; Function compile flags: /Odtp
; File c:\users\ncsoft\test.cpp
_TEXT	SEGMENT
a$ = 8
b$ = 16
?add@@YAHHH@Z PROC					; add

; 2    : {

	mov	DWORD PTR [rsp+16], edx
	mov	DWORD PTR [rsp+8], ecx

; 3    :   return a + b;

	mov	eax, DWORD PTR b$[rsp]
	mov	ecx, DWORD PTR a$[rsp]
	add	ecx, eax
	mov	eax, ecx

; 4    : }

	ret	0
?add@@YAHHH@Z ENDP					; add
_TEXT	ENDS
END
```

## 기계어2

```
; Listing generated by Microsoft (R) Optimizing Compiler Version 19.16.27034.0 

include listing.inc

INCLUDELIB LIBCMT
INCLUDELIB OLDNAMES

PUBLIC	?add@@YAHHH@Z					; add
PUBLIC	main
PUBLIC	??$square@H@@YAHH@Z				; square<int>
pdata	SEGMENT
$pdata$main DD	imagerel $LN3
	DD	imagerel $LN3+21
	DD	imagerel $unwind$main
pdata	ENDS
xdata	SEGMENT
$unwind$main DD	010401H
	DD	04204H
xdata	ENDS
; Function compile flags: /Odtp
; File c:\users\ncsoft\test.cpp
;	COMDAT ??$square@H@@YAHH@Z
_TEXT	SEGMENT
a$ = 8
??$square@H@@YAHH@Z PROC				; square<int>, COMDAT

; 8    : {

	mov	DWORD PTR [rsp+8], ecx

; 9    :   return a * a;

	mov	eax, DWORD PTR a$[rsp]
	imul	eax, DWORD PTR a$[rsp]

; 10   : }

	ret	0
??$square@H@@YAHH@Z ENDP				; square<int>
_TEXT	ENDS
; Function compile flags: /Odtp
; File c:\users\ncsoft\test.cpp
_TEXT	SEGMENT
main	PROC

; 13   : {

$LN3:
	sub	rsp, 40					; 00000028H

; 14   :   square(3);

	mov	ecx, 3
	call	??$square@H@@YAHH@Z			; square<int>

; 15   : }

	xor	eax, eax
	add	rsp, 40					; 00000028H
	ret	0
main	ENDP
_TEXT	ENDS
; Function compile flags: /Odtp
; File c:\users\ncsoft\test.cpp
_TEXT	SEGMENT
a$ = 8
b$ = 16
?add@@YAHHH@Z PROC					; add

; 2    : {

	mov	DWORD PTR [rsp+16], edx
	mov	DWORD PTR [rsp+8], ecx

; 3    :   return a + b;

	mov	eax, DWORD PTR b$[rsp]
	mov	ecx, DWORD PTR a$[rsp]
	add	ecx, eax
	mov	eax, ecx

; 4    : }

	ret	0
?add@@YAHHH@Z ENDP					; add
_TEXT	ENDS
END
```