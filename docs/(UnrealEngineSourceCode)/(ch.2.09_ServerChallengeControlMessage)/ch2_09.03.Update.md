---
layout: default
title: "09-03. Update"
parent: "([Network] 09. ServerChallengeControlMessage)"
grand_parent: "(UE SourceCode ë¶„ì„ ğŸ¤–)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

```cpp
class UNetConnection : public UPlayer
{
    // ...

virtual void ReceivedPacket(FBitReader& Reader, bool bIsReinjectedPacket=false, bool bDispatchPacket=true)
{
    // ...

    const int32 UpdatedPacketSequenceDelta = PacketNotify.Update(Header, HandlePacketNotification);
}
```

```cpp
class FNetPacketNotify
{
    // ...


    template<class Functor>
    SequenceNumberT::DifferenceT Update(const FNotificationHeader& NotificationData, Functor&& InFunc)
    {
        const SequenceNumberT::DifferenceT InSeqDelta = GetSequenceDelta(NotificationData);
        if (InSeqDelta > 0)
        {
            ProcessReceivedAcks(NotificationData, InFunc);
            return InternalUpdate(NotificationData, InSeqDelta);
        }
    }
```

```cpp
SequenceNumberT::DifferenceT GetSequenceDelta(const FNotificationHeader& NotificationHeader)
{
    // ë‹¤ìŒ ì¡°ê±´ë“¤ì„ ì£¼ì˜ ê¹Šê²Œ ì½ì–´ë³´ì„¸ìš”:
    // 1. NotificationData.Seq > InSeq
    // 2. NotificationData.AckedSeq >= OutAckSeq
    // 3. OutSeq > NotificationData.AckedSeq
    // *** ì´ ì¡°ê±´ë“¤ì€ 'NotificationHeader'ì˜ ìœ íš¨ì„±ì„ ê²€ì¦í•©ë‹ˆë‹¤!
    // - (NotificationData.Seq - InSeq)ëŠ” íŒ¨í‚·ìœ¼ë¡œë¶€í„° ìƒˆë¡œ ì—…ë°ì´íŠ¸ëœ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ InSeqì˜ ë¸íƒ€ê°’ì…ë‹ˆë‹¤

    if (NotificationData.Seq > InSeq && NotificationData.AckedSeq >= OutAckSeq && OutSeq > NotificationData.AckedSeq)
    {
        return SequenceNumberT::Diff(NotificationData.Seq, InSeq);
    }
    else
    {
        return 0;
    }
}
```

```cpp
    /** get the delta between the present sequence, and the sequence inside the specified header - if the delta is positive */
    /** í˜„ì¬ ì‹œí€€ìŠ¤ì™€ ì§€ì •ëœ í—¤ë” ë‚´ì˜ ì‹œí€€ìŠ¤ ê°„ì˜ ì–‘ì˜ ë¸íƒ€ê°’ì„ êµ¬í•©ë‹ˆë‹¤ */

    // - ì˜ˆì‹œë¥¼ í†µí•´ ì´í•´í•´ë³´ê² ìŠµë‹ˆë‹¤:
    //                                                                              
    //     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                         
    //     â”‚ Client â”‚                            â”‚ Server â”‚                         
    //     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜                            â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                         
    //          â”‚         Seq:255                    â”‚   InSeq:254                  
    //          â”‚         AckedSeq:127               â”‚   OutSeq:128                 
    //          â”‚                                    â”‚   OutAckSeq:126              
    //          â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚      â”‚                       
    //          â”‚                                    â”‚      â–¼                       
    //          â”‚                                    â”‚   InSeq:255â—„â”€â”€â”€â”€â”€â”€â”          
    //          â”‚         Seq:256                    â”‚   OutSeq:128      â”‚updated!  
    //          â”‚         AckedSeq:127               â”‚   OutAckSeq:127â—„â”€â”€â”˜          
    //          â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚      â”‚                       
    //          â”‚                                    â”‚      â–¼                       
    //          â”‚                                    â”‚   InSeq:256                  
    //          â”‚                                    â”‚   OutSeq:128                 
    //          â”‚                                    â”‚   OutAckSeq:127**            
    //          â”‚                                    â”‚                              
    //                                                                              
    //                                                                              
    //                                                                              
    //                                                                              
    //                                                                              
    //   ***Packet-loss happens!                                                    
    //   ***íŒ¨í‚· ì†ì‹¤ ë°œìƒ!                                                          
    //     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                         
    //     â”‚ Client â”‚                            â”‚ Server â”‚                         
    //     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜                            â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                         
    //          â”‚         Seq:255                    â”‚   InSeq:254                  
    //          â”‚         AckedSeq:127               â”‚   OutSeq:128                 
    //          â”‚                                    â”‚   OutAckSeq:126              
    //          â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€xâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚      â”‚                       
    //          â”‚            ***packet-loss!!        â”‚      â”‚                       
    //          â”‚            ***íŒ¨í‚· ì†ì‹¤!!           â”‚      â”‚                       
    //          â”‚                                    â”‚      â”‚                       
    //          â”‚         Seq:256                    â”‚      â”‚                       
    //          â”‚         AckedSeq:127               â”‚      â”‚                       
    //          â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚      â”‚                       
    //          â”‚                                    â”‚      â–¼                       
    //          â”‚                                    â”‚   InSeq:256â—„â”€â”€â”€â”€â”€â”€â”                  
    //          â”‚                                    â”‚   OutSeq:128      â”‚updated!           
    //          â”‚                                    â”‚   OutAckSeq:127â—„â”€â”€â”˜              
    //          â”‚                                    â”‚                              
    //                                                                                  
```

```cpp
// AckRecordëŠ” íì—ì„œ OutSeqì™€ InAckSeqë¥¼ ê´€ë¦¬í•˜ì—¬ ì¶”ì í•©ë‹ˆë‹¤
// - ì œ ê´€ì ì—ì„œëŠ” ë””ë²„ê¹…ê³¼ ìœ íš¨ì„± ê²€ì‚¬ ëª©ì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤
SequenceNumberT UpdateInAckSeqAck(SequenceNumberT::DifferenceT AckCount, SequenceNumberT AckedSeq)
{                                                                                         
    
    // ë¡œì§ì„ ê·¸ë¦¼ìœ¼ë¡œ ì´í•´í•´ë´…ì‹œë‹¤:
    //                                                                                          
    //          - AckCount==3                                                                   
    //          - AckedSeq==128               ***InAckSeq==AckedSeq                             
    //                                                 â–²                                        
    //                                                 â”‚                                        
    //           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                                 
    //           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   
    // AckRecord:â”‚   OutSeq:244 â”‚   OutSeq:245 â”‚   OutSeq:246 â”‚   OutSeq:247 â”‚    ...       â”‚   
    //           â”‚ InAckSeq:127 â”‚ InAckSeq:127 â”‚ InAckSeq:128 â”‚ InAckSeq:128 â”‚              â”‚   
    //           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   
    //           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 
    //                                â”‚                                                         
    //                                â”‚                                                         
    //                                â–¼                                                         
    //                            Pop(AckCount-1):ì œê±°ë¨                                       
    //                                                                                           
    if ((SIZE_T)AckCount <= AckRecord.Count())
    {
        if (AckCount > 1)
        {
            AckRecord.PopNoCheck(AckCount - 1);
        }

        FSentAckData AckData = AckRecord.PeekNoCheck();
        AckRecord.PopNoCheck();

        // verify that we have a matching sequence number
        // ì¼ì¹˜í•˜ëŠ” ì‹œí€€ìŠ¤ ë²ˆí˜¸ê°€ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤
        if (AckData.OutSeq == AckedSeq)
        {
            return AckData.InAckSeq;
        }
    }

    // pessimistic view, should never occur but we do want to know about it if it would
    // this should NOT be happened! it is implemented for fixing compile-error
    
    // ë¹„ê´€ì ì¸ ê´€ì ìœ¼ë¡œ, ì ˆëŒ€ ë°œìƒí•´ì„œëŠ” ì•ˆ ë˜ì§€ë§Œ ë§Œì•½ ë°œìƒí•œë‹¤ë©´ ì•Œê³  ì‹¶ìŠµë‹ˆë‹¤
    // ì´ëŸ° ìƒí™©ì€ ì ˆëŒ€ ë°œìƒí•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤! ì»´íŒŒì¼ ì—ëŸ¬ë¥¼ ìˆ˜ì •í•˜ê¸° ìœ„í•´ êµ¬í˜„ë˜ì—ˆìŠµë‹ˆë‹¤
    ensureMsgf(false, TEXT("FNetPacketNotify::UpdateInAckSeqAck - Failed to find matching AckRecord for %u"), AckedSeq.Get());
    return SequenceNumberT(AckedSeq.Get() - MaxSequenceHistoryLength);
}
```