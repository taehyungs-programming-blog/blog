---
layout: default
title: "09-05. NetPacketNotify"
parent: "([Network] 09. ServerChallengeControlMessage)"
grand_parent: "(UE SourceCode ë¶„ì„ ğŸ¤–)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## NetPacketNotify

* NetPacketNotifyëŠ” Unreal Engineì˜ ë„¤íŠ¸ì›Œí¬ ì‹œìŠ¤í…œì—ì„œ íŒ¨í‚·ì˜ ì‹ ë¢°ì„± ìˆëŠ” ì „ì†¡ì„ ë³´ì¥í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” í•µì‹¬ í´ë˜ìŠ¤ì…ë‹ˆë‹¤. ì£¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ìš©ë„ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤:
	* íŒ¨í‚· ì‹œí€€ìŠ¤ ë²ˆí˜¸ ê´€ë¦¬
	* ACK/NAK ì²˜ë¦¬
	* íŒ¨í‚· ì „ë‹¬ ìƒíƒœ ì¶”ì 
	* ì¬ì „ì†¡ ê´€ë¦¬

```cpp
// NetConnection.hì˜ ì¼ë¶€
class UNetConnection : public UPlayer
{
    // ...
    FNetPacketNotify PacketNotify;
    
    /** íŒ¨í‚·ì„ ë³´ë‚¼ ë•Œ */
    void SendPacket()
    {
        // ìƒˆë¡œìš´ ì‹œí€€ìŠ¤ ë²ˆí˜¸ ì–»ê¸°
        FNetPacketNotify::SequenceNumberT OutSeq = PacketNotify.CommitAndIncrementOutSeq();
        
        // íŒ¨í‚· í—¤ë” ì‘ì„±
        FBitWriter Writer;
        PacketNotify.WriteHeader(Writer);
        
        // íŒ¨í‚· ë°ì´í„° ì‘ì„±
        // ...
        
        // íŒ¨í‚· ì „ì†¡
        Socket->SendTo(Writer.GetData(), Writer.GetNumBytes());
    }
    
    /** íŒ¨í‚·ì„ ë°›ì•˜ì„ ë•Œ */
    void ReceivedPacket(uint8* Data, int32 Size)
    {
        FBitReader Reader(Data, Size);
        
        // íŒ¨í‚· í—¤ë” ì½ê¸°
        FNetPacketNotify::FNotificationHeader Header;
        if (PacketNotify.ReadHeader(Header, Reader))
        {
            // ACK ì²˜ë¦¬
            PacketNotify.Update(Header, [this](auto Seq, bool bDelivered) {
                if (bDelivered)
                {
                    // ACKëœ íŒ¨í‚· ì²˜ë¦¬
                    HandleAckedPacket(Seq);
                }
                else
                {
                    // NAKëœ íŒ¨í‚· ì¬ì „ì†¡
                    RetransmitPacket(Seq);
                }
            });
            
            // íŒ¨í‚· ë°ì´í„° ì²˜ë¦¬
            // ...
        }
    }
};
```

* SendPacket()ì€ ìƒˆë¡œìš´ íŒ¨í‚·ì„ ë³´ë‚¼ ë•Œ PacketNotifyë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹œí€€ìŠ¤ ë²ˆí˜¸ë¥¼ ê´€ë¦¬í•˜ê³  í—¤ë”ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.
* ReceivedPacket()ì€ íŒ¨í‚·ì„ ë°›ì•˜ì„ ë•Œ PacketNotifyë¥¼ ì‚¬ìš©í•˜ì—¬:
	* íŒ¨í‚· í—¤ë”ë¥¼ íŒŒì‹±
	* ACK/NAK ìƒíƒœë¥¼ ì²˜ë¦¬
	* í•„ìš”í•œ ê²½ìš° ì¬ì „ì†¡ì„ íŠ¸ë¦¬ê±°
* ì‹¤ì œ Unreal Engineì—ì„œëŠ” ì´ë³´ë‹¤ ë” ë³µì¡í•œ ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©ë˜ë©°, íŠ¹íˆ Actor Replicationê³¼ RPC ì‹œìŠ¤í…œì—ì„œ ì¤‘ìš”í•œ ì—­í• ì„ í•©ë‹ˆë‹¤.

---

## ì½”ë“œë¡œ ë³´ì!

```cpp
class FNetPacketNotify
{
    // ...

    // ë³€ìˆ˜ë¨¼ì € ë³´ìë©´ ..

        /** update state of PacketNotification based on received header and invoke notification for received acks */
    /** PacketNotificationì˜ ìƒíƒœë¥¼ ìˆ˜ì‹ ëœ í—¤ë”ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ê³  ìˆ˜ì‹ ëœ ackì— ëŒ€í•œ ì•Œë¦¼ì„ í˜¸ì¶œí•©ë‹ˆë‹¤ */
    template<class Functor>
    SequenceNumberT::DifferenceT Update(const FNotificationHeader& NotificationData, Functor&& InFunc)
    {
        // we also called GetSequenceDelta() again~ :)
        //   - we pass the lambda to this function!
        //   *** ProcessReceivedAcks() processes received 'InSeqHistory' (== from server-side OutSeqHistory)

        // GetSequenceDelta()ë¥¼ ë‹¤ì‹œ í•œë²ˆ í˜¸ì¶œí•©ë‹ˆë‹¤~ :)
        //   - ì´ í•¨ìˆ˜ì— lambdaë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤!
        //   *** ProcessReceivedAcks()ëŠ” ìˆ˜ì‹ ëœ 'InSeqHistory'ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤ (== ì„œë²„ ì¸¡ì˜ OutSeqHistory)
        const SequenceNumberT::DifferenceT InSeqDelta = GetSequenceDelta(NotificationData);
        if (InSeqDelta > 0)
        {
            // *** 1. SYNCing "UNetConnection::OutAckSeq" and "NotificationData.History(SeqHistory)"
            
            // *** 1. "UNetConnection::OutAckSeq"ì™€ "NotificationData.History(SeqHistory)" ë™ê¸°í™”
            ProcessReceivedAcks(NotificationData, InFunc);

            // *** 2.  SYNCing "NotificationData.Seq(OutSeq in client-side)" and "UNetConnection::InSeqHistory"
            // see FNetPacketNotify::InternalUpdate(goto 024: ServerChallengeControlMessage)

            // *** 2. "NotificationData.Seq(í´ë¼ì´ì–¸íŠ¸ ì¸¡ì˜ OutSeq)"ì™€ "UNetConnection::InSeqHistory" ë™ê¸°í™”
            return InternalUpdate(NotificationData, InSeqDelta);
        }
    }

    struct FSentAckData
    {
        /** not needed... just to verify that things work as expected */
        /** í•„ìš”í•˜ì§€ ì•ŠìŒ... ë‹¨ì§€ ì˜ˆìƒëŒ€ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤ */
        SequenceNumberT OutSeq;
        SequenceNumberT InAckSeq;
    };
    typedef TResizableCircularQueue<FSentAckData, TInlineAllocator<128>> AckRecordT;

    /** track acked seq for each sent packet to track size of ack history */
    /** ê° ì „ì†¡ëœ íŒ¨í‚·ì— ëŒ€í•œ ackëœ ì‹œí€€ìŠ¤ë¥¼ ì¶”ì í•˜ì—¬ ack íˆìŠ¤í† ë¦¬ì˜ í¬ê¸°ë¥¼ ì¶”ì í•©ë‹ˆë‹¤ */
    AckRecordT AckRecord;

    /** bookkeeping to track if we can update data */
    /** ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆëŠ”ì§€ ì¶”ì í•˜ê¸° ìœ„í•œ ë¶í‚¤í•‘ */
    SIZE_T WrittenHistoryWordCount;

    /** when we call CommitAndIncrementOutSequence this will be committed along with the current outgoing sequence number for bookeeping */
    /** CommitAndIncrementOutSequenceë¥¼ í˜¸ì¶œí•  ë•Œ í˜„ì¬ ë‚˜ê°€ëŠ” ì‹œí€€ìŠ¤ ë²ˆí˜¸ì™€ í•¨ê»˜ ë¶í‚¤í•‘ì„ ìœ„í•´ ì»¤ë°‹ë©ë‹ˆë‹¤ */
    SequenceNumberT WrittenInAckSeq;

    /**
     * tracking incoming sequence data
     */
    /**
     * ë“¤ì–´ì˜¤ëŠ” ì‹œí€€ìŠ¤ ë°ì´í„° ì¶”ì 
     */

    /** bit buffer containing a bitfield describing the history of received packets */
    /** ìˆ˜ì‹ ëœ íŒ¨í‚·ì˜ íˆìŠ¤í† ë¦¬ë¥¼ ì„¤ëª…í•˜ëŠ” ë¹„íŠ¸í•„ë“œê°€ í¬í•¨ëœ ë¹„íŠ¸ ë²„í¼ */
    SequenceHistoryT InSeqHistory;

    /** last sequence number received and accepted from remote */
    /** ì›ê²©ì—ì„œ ìˆ˜ì‹ í•˜ê³  ìŠ¹ì¸í•œ ë§ˆì§€ë§‰ ì‹œí€€ìŠ¤ ë²ˆí˜¸ */
    SequenceNumberT InSeq;

    /** last sequence number received from remote that we have acknowledged, this is needed since we support accepting a packet but explicitly not acknowledge it as received */
    /** ì›ê²©ì—ì„œ ìˆ˜ì‹ í•˜ì—¬ ìš°ë¦¬ê°€ ìŠ¹ì¸í•œ ë§ˆì§€ë§‰ ì‹œí€€ìŠ¤ ë²ˆí˜¸, íŒ¨í‚·ì„ ìˆ˜ì‹ ì€ í•˜ì§€ë§Œ ëª…ì‹œì ìœ¼ë¡œ ìˆ˜ì‹  í™•ì¸ì„ í•˜ì§€ ì•ŠëŠ” ê²ƒì„ ì§€ì›í•˜ê¸° ë•Œë¬¸ì— í•„ìš”í•©ë‹ˆë‹¤ */
    SequenceNumberT InAckSeq;

    /** last sequence number received from remote that we have acknowledged and also knows that the remote has received the ack, used to calculate how big our history must be */
    /** ì›ê²©ì—ì„œ ìˆ˜ì‹ í•˜ì—¬ ìš°ë¦¬ê°€ ìŠ¹ì¸í–ˆê³  ì›ê²©ë„ ackë¥¼ ìˆ˜ì‹ í–ˆë‹¤ëŠ” ê²ƒì„ ì•Œê³  ìˆëŠ” ë§ˆì§€ë§‰ ì‹œí€€ìŠ¤ ë²ˆí˜¸, íˆìŠ¤í† ë¦¬ê°€ ì–¼ë§ˆë‚˜ ì»¤ì•¼ í•˜ëŠ”ì§€ ê³„ì‚°í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤ */
    SequenceNumberT InAckSeqAck;

    SequenceNumberT WaitingForFlushSeqAck;

    /**
     * tracking outoging sequence data
     */
    /**
     * ë‚˜ê°€ëŠ” ì‹œí€€ìŠ¤ ë°ì´í„° ì¶”ì 
     */

    /** outgoing sequence number */
    /** ë‚˜ê°€ëŠ” ì‹œí€€ìŠ¤ ë²ˆí˜¸ */
    SequenceNumberT OutSeq;

    /** last sequence number that we know that the remote side have received */
    /** ì›ê²© ì¸¡ì—ì„œ ìˆ˜ì‹ í–ˆë‹¤ëŠ” ê²ƒì„ ì•Œê³  ìˆëŠ” ë§ˆì§€ë§‰ ì‹œí€€ìŠ¤ ë²ˆí˜¸ */
    SequenceNumberT OutAckSeq;
};
```

* í•¨ìˆ˜ë„ í•˜ë‚˜ì”© ë³¼ê¹Œ?

```cpp
    SequenceNumberT::DifferenceT InternalUpdate(const FNotificationHeader& NotificationData, SequenceNumberT::DifferenceT InSeqDelta)
    {
        // we must check if we will overflow our outgoing ack-window, if we do and it contains processed data we must initiate a re-sync of ack-sequence history
        // this is done by ignoring any new packets until we are in sync again
        // this would typically only occur in situations where we would have had huge packet loss or spikes on the receiving end

        // ë‚˜ê°€ëŠ” ack-windowê°€ ì˜¤ë²„í”Œë¡œìš°ë˜ëŠ”ì§€ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤. ë§Œì•½ ì˜¤ë²„í”Œë¡œìš°ë˜ê³  ì²˜ë¦¬ëœ ë°ì´í„°ê°€ ìˆë‹¤ë©´ ack-sequence íˆìŠ¤í† ë¦¬ì˜ ì¬ë™ê¸°í™”ë¥¼ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤
        // ì´ëŠ” ë‹¤ì‹œ ë™ê¸°í™”ë  ë•Œê¹Œì§€ ìƒˆë¡œìš´ íŒ¨í‚·ë“¤ì„ ë¬´ì‹œí•¨ìœ¼ë¡œì¨ ìˆ˜í–‰ë©ë‹ˆë‹¤
        // ì´ëŠ” ì¼ë°˜ì ìœ¼ë¡œ í° íŒ¨í‚· ì†ì‹¤ì´ë‚˜ ìˆ˜ì‹  ì¸¡ì˜ ìŠ¤íŒŒì´í¬ê°€ ìˆëŠ” ìƒí™©ì—ì„œë§Œ ë°œìƒí•©ë‹ˆë‹¤

        // determine whether we are "waiting sequence history to flush or not"
        // - if (NotificationData.Seq(client) - InAckSeqAck) > 256(HistorySize), there are two cases:
        //   *** we are in STRANGE-situation!

        // "ì‹œí€€ìŠ¤ íˆìŠ¤í† ë¦¬ë¥¼ í”ŒëŸ¬ì‹œí•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆëŠ”ì§€ ì•„ë‹Œì§€" ê²°ì •í•©ë‹ˆë‹¤
        // - ë§Œì•½ (NotificationData.Seq(í´ë¼ì´ì–¸íŠ¸) - InAckSeqAck) > 256(HistorySize)ì´ë©´, ë‘ ê°€ì§€ ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤:
        //   *** ìš°ë¦¬ëŠ” ì´ìƒí•œ ìƒí™©ì— ìˆìŠµë‹ˆë‹¤!


        //   1. when all elements in sequence-history have invalid-deliverity (== false):
        //                                                                                                                            
        //           â”Œâ”€â”€1.All deliverities are 0 in sequence-history                                                                  
        //           â”‚                                                                                                                
        //      â”‚â—„â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                                                                                             
        //      â”‚                       â”‚                                                                                             
        //      â”œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¤                                                                                             
        //      â”‚ 0 â”‚ 0 â”‚...â”‚ 0 â”‚ 0 â”‚ 0 â”‚                                                                                             
        //      â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â–²â”€â”˜                                                                                             
        //                            â”‚                                                                                               
        //                            â”‚                                                                                               
        //                         2.Before adding new InSeq, we update 'InAckSeqAck' silently by InSeq:                              
        //                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
        //                           â”‚ Count = (InAckSeqAck - InSeq)                                                               â”‚  
        //                           â”‚                                                                                             â”‚  
        //                           â”‚ [InSeq - Count, InSeq] will be processed as 'Nak' in other-side(client in our current case) â”‚  
        //                           â”‚                        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  
        //                           â”‚                                 *** the client will re-transmit bunches again               â”‚  
        //                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  

        //   1. ì‹œí€€ìŠ¤ íˆìŠ¤í† ë¦¬ì˜ ëª¨ë“  ìš”ì†Œê°€ ìœ íš¨í•˜ì§€ ì•Šì€ ì „ë‹¬(== false)ì„ ê°€ì§ˆ ë•Œ:
        //                                                                                                                            
        //           â”Œâ”€â”€1.ì‹œí€€ìŠ¤ íˆìŠ¤í† ë¦¬ì˜ ëª¨ë“  ì „ë‹¬ê°’ì´ 0ì…ë‹ˆë‹¤                                                                  
        //           â”‚                                                                                                                
        //      â”‚â—„â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                                                                                             
        //      â”‚                       â”‚                                                                                             
        //      â”œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¤                                                                                             
        //      â”‚ 0 â”‚ 0 â”‚...â”‚ 0 â”‚ 0 â”‚ 0 â”‚                                                                                             
        //      â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â–²â”€â”˜                                                                                             
        //                            â”‚                                                                                               
        //                            â”‚                                                                                               
        //                         2.ìƒˆë¡œìš´ InSeqë¥¼ ì¶”ê°€í•˜ê¸° ì „ì—, 'InAckSeqAck'ë¥¼ InSeqë¡œ ì¡°ìš©íˆ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤:                              
        //                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
        //                           â”‚ Count = (InAckSeqAck - InSeq)                                                               â”‚  
        //                           â”‚                                                                                             â”‚  
        //                           â”‚ [InSeq - Count, InSeq]ëŠ” ìƒëŒ€ë°©(í˜„ì¬ ìš°ë¦¬ ì¼€ì´ìŠ¤ì—ì„œëŠ” í´ë¼ì´ì–¸íŠ¸)ì—ì„œ 'Nak'ë¡œ ì²˜ë¦¬ë  ê²ƒì…ë‹ˆë‹¤ â”‚  
        //                           â”‚                        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  
        //                           â”‚                                 *** í´ë¼ì´ì–¸íŠ¸ëŠ” ë²ˆì¹˜ë“¤ì„ ë‹¤ì‹œ ì „ì†¡í•  ê²ƒì…ë‹ˆë‹¤               â”‚  
        //                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  


        //   2. when sequence-history includes any valid-deliverity (== true):
        //      
        //                      1.some deliverities are 1 in sequence-history                                                                                                                  
        //                            â”‚                                                                                                                                                        
        //                        â”Œâ”€â”€â”€â”´â”€â”€â”€â”                                                                                                                                                    
        //      â”‚               â”‚ â”‚       â”‚ â”‚                                                                                                                                                  
        //      â”‚               â”‚ â”‚       â”‚ â”‚                                                                                                                                                  
        //      â”œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¼â”€â–¼â”€â”¬â”€â”€â”€â”¬â”€â–¼â”€â”¤                                                                                                                                                  
        //      â”‚ 0 â”‚ 0 â”‚ 0 â”‚...â”‚ 1 â”‚ 0 â”‚ 1 â”‚                                                                                                                                                  
        //      â”œâ”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”¼â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”¤                                                                                                                                                  
        //      â”‚               â”‚           â”‚                                                                                                                                                  
        //      â”‚â—„â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚â—„â”€â”€â”€â”€â”¬â”€â”€â”€â”€â–ºâ”‚                                                                                                                                                  
        //      â”‚     â”‚         â”‚     â”‚     â”‚                                                                                                                                                  
        //            â”‚               â”‚                                                                                                                                                        
        //            â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€2.CurrentSequenceHistoryLength() == 3                                                                                                          
        //            â”‚                                                                                                                                                                        
        //        3. HistorySize(256) - CurrentSequenceHistoryLength(3) == 253                                                                                                                 
        //                                                                â”€â”€â”€â”€â”€                                                                                                                
        //                                                                *** we can add total 253 entries as 'Nak' to InSeqHistory                                                            

        //   2. ì‹œí€€ìŠ¤ íˆìŠ¤í† ë¦¬ê°€ ìœ íš¨í•œ ì „ë‹¬ê°’(== true)ì„ í¬í•¨í•  ë•Œ:
        //      
        //                      1.ì‹œí€€ìŠ¤ íˆìŠ¤í† ë¦¬ì—ì„œ ì¼ë¶€ ì „ë‹¬ê°’ì´ 1ì…ë‹ˆë‹¤                                                                                                                  
        //                            â”‚                                                                                                                                                        
        //                        â”Œâ”€â”€â”€â”´â”€â”€â”€â”                                                                                                                                                    
        //      â”‚               â”‚ â”‚       â”‚ â”‚                                                                                                                                                  
        //      â”‚               â”‚ â”‚       â”‚ â”‚                                                                                                                                                  
        //      â”œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¼â”€â–¼â”€â”¬â”€â”€â”€â”¬â”€â–¼â”€â”¤                                                                                                                                                  
        //      â”‚ 0 â”‚ 0 â”‚ 0 â”‚...â”‚ 1 â”‚ 0 â”‚ 1 â”‚                                                                                                                                                  
        //      â”œâ”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”¼â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”¤                                                                                                                                                  
        //      â”‚               â”‚           â”‚                                                                                                                                                  
        //      â”‚â—„â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚â—„â”€â”€â”€â”€â”¬â”€â”€â”€â”€â–ºâ”‚                                                                                                                                                  
        //      â”‚     â”‚         â”‚     â”‚     â”‚                                                                                                                                                  
        //            â”‚               â”‚                                                                                                                                                        
        //            â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€2.CurrentSequenceHistoryLength() == 3                                                                                                          
        //            â”‚                                                                                                                                                                        
        //        3. HistorySize(256) - CurrentSequenceHistoryLength(3) == 253                                                                                                                 
        //                                                                â”€â”€â”€â”€â”€                                                                                                                
        //                                                                *** InSeqHistoryì— ì´ 253ê°œì˜ í•­ëª©ì„ 'Nak'ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤                                                            


        //                                                                    â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                           
        //                                        â”‚                                   â”‚                                                                                                        
        //                                        â”‚                                   â–¼                                                                                                        
        //                                        â”‚  4.NewInSeqToAck = InAckSeqAck + 253                                                                                                       
        //                                        â”‚                                                                                                                                            
        //                                        â”‚  5.call FNetPacketNotify::AckSeq(NewInSeqToAck)                                                                                            
        //                                        â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                                             
        //                                        â”‚                                 â”‚                                                                                                          
        //                                        â–¼                                 â”‚                                                                                                          
        //                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                                                                                                          
        //                               â”œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¤              â”‚                                                                                                          
        //                               â”‚ 0 â”‚ 0 â”‚ 0 â”‚...â”‚ 1 â”‚ 0 â”‚ 1 â”‚              â”‚                                                                                                          
        //                               â”œâ”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”¤              â”‚                                                                                                          
        //                               â””â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                                                                                                          
        //                                   â”‚               â”‚                      â”‚                                                                                                          
        //                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜                      â”‚                                                                                                          
        //                                            â”‚                             â”‚                                                                                                          
        //                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                                          

        //                                                                    â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                           
        //                                        â”‚                                   â”‚                                                                                                        
        //                                        â”‚                                   â–¼                                                                                                        
        //                                        â”‚  4.NewInSeqToAck = InAckSeqAck + 253                                                                                                       
        //                                        â”‚                                                                                                                                            
        //                                        â”‚  5.FNetPacketNotify::AckSeq(NewInSeqToAck) í˜¸ì¶œ                                                                                            
        //                                        â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                                             
        //                                        â”‚                                 â”‚                                                                                                          
        //                                        â–¼                                 â”‚                                                                                                          
        //                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                                                                                                          
        //                               â”œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¤              â”‚                                                                                                          
        //                               â”‚ 0 â”‚ 0 â”‚ 0 â”‚...â”‚ 1 â”‚ 0 â”‚ 1 â”‚              â”‚                                                                                                          
        //                               â”œâ”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”¤              â”‚                                                                                                          
        //                               â””â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                                                                                                          
        //                                   â”‚               â”‚                      â”‚                                                                                                          
        //                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜                      â”‚                                                                                                          
        //                                            â”‚                             â”‚                                                                                                          
        //                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                                          

        //                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    *** three-entries [0,2] shifted to [253,255]                                                                         
        //                               â”œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¤        and total 253 entries are filled with '0'                                                                        
        //                               â”‚ 1 â”‚ 0 â”‚ 1 â”‚...â”‚ 0 â”‚ 0 â”‚ 0 â”‚         â”‚                                                                                                               
        //                               â”œâ”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”¤         â””â”€â”€â”€6. all sequence numbers who has '0' deliverity are processed as 'Nak' and will be re-send by other-side     
        //                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                                                         
        //                                                                                                                                                                                                                                                                                                           
        //
        // - when does it happens?
        //   *** huge packet-loss or heavy network-traffic

        //                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    *** ì„¸ ê°œì˜ í•­ëª© [0,2]ê°€ [253,255]ë¡œ ì´ë™ë¨                                                                         
        //                               â”œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¤        ê·¸ë¦¬ê³  ì´ 253ê°œì˜ í•­ëª©ì´ '0'ìœ¼ë¡œ ì±„ì›Œì§                                                                        
        //                               â”‚ 1 â”‚ 0 â”‚ 1 â”‚...â”‚ 0 â”‚ 0 â”‚ 0 â”‚         â”‚                                                                                                               
        //                               â”œâ”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”¤         â””â”€â”€â”€6. '0' ì „ë‹¬ê°’ì„ ê°€ì§„ ëª¨ë“  ì‹œí€€ìŠ¤ ë²ˆí˜¸ëŠ” 'Nak'ë¡œ ì²˜ë¦¬ë˜ê³  ìƒëŒ€ë°©ì— ì˜í•´ ì¬ì „ì†¡ë  ê²ƒì…ë‹ˆë‹¤     
        //                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                                                         
        //                                                                                                                                                                                                                                                                                                           
        //
        // - ì–¸ì œ ì´ëŸ° ì¼ì´ ë°œìƒí•˜ë‚˜ìš”?
        //   *** í° íŒ¨í‚· ì†ì‹¤ì´ë‚˜ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì´ ë§ì„ ë•Œ

        if (!IsWaitingForSequenceHistoryFlush() && !WillSequenceFitInSequenceHistory(NotificationData.Seq))
        {
            if (GetHasUnacknowledgedAcks())
            {
                // *** when any deliverity(==true) exists, we need to adjust
                // *** ì „ë‹¬ê°’(==true)ì´ ì¡´ì¬í•  ë•Œ, ì¡°ì •ì´ í•„ìš”í•©ë‹ˆë‹¤
                SetWaitForSequenceHistoryFlush();
            }
            else
            {
                // we can reset if we have no previous acks and can then safely synthesize NACKs on the receiving end
                // when all entries (deliverity) in InSeqHistory are '0', just update 'InAckSeqAck' as 'NotificationData.Seq'
                // *** no need to handle this specially, just do it as normal

                // ì´ì „ ackê°€ ì—†ê³  ìˆ˜ì‹  ì¸¡ì—ì„œ ì•ˆì „í•˜ê²Œ NACKë¥¼ í•©ì„±í•  ìˆ˜ ìˆë‹¤ë©´ ë¦¬ì…‹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                // InSeqHistoryì˜ ëª¨ë“  í•­ëª©(ì „ë‹¬ê°’)ì´ '0'ì¼ ë•Œ, 'InAckSeqAck'ë¥¼ 'NotificationData.Seq'ë¡œ ì—…ë°ì´íŠ¸í•˜ë©´ ë©ë‹ˆë‹¤
                // *** íŠ¹ë³„íˆ ì²˜ë¦¬í•  í•„ìš” ì—†ì´ ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬í•˜ë©´ ë©ë‹ˆë‹¤

                const SequenceNumberT NewInAckSeqAck(Notification.Seq.Get() - 1);
                InAckSeqAck = NewInAckSeqAck;
            }
        }

        if (!IsWaitingForSequenceHistoryFlush())
        {
            // just accept the incoming sequence, under normal circumstances NetConnection explicitly handles the acks
            // *** this is the usual case!
            // - update InSeq with NotificationData.Seq and returns un-modified input-parameter(InSeqDelta)

            // ë“¤ì–´ì˜¤ëŠ” ì‹œí€€ìŠ¤ë¥¼ ê·¸ëƒ¥ ë°›ì•„ë“¤ì…ë‹ˆë‹¤. ì •ìƒì ì¸ ìƒí™©ì—ì„œëŠ” NetConnectionì´ ëª…ì‹œì ìœ¼ë¡œ ackë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤
            // *** ì´ê²ƒì´ ì¼ë°˜ì ì¸ ê²½ìš°ì…ë‹ˆë‹¤!
            // - InSeqë¥¼ NotificationData.Seqë¡œ ì—…ë°ì´íŠ¸í•˜ê³  ìˆ˜ì •ë˜ì§€ ì•Šì€ ì…ë ¥ íŒŒë¼ë¯¸í„°(InSeqDelta)ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤

            InSeq = NotificationData.Seq;
            return InSeqDelta;
        }
        else
        {
            // this is the second-case to do special-handlings
            // - remembering what we have covered with figures, look through the codes

            // ì´ê²ƒì€ íŠ¹ë³„í•œ ì²˜ë¦¬ê°€ í•„ìš”í•œ ë‘ ë²ˆì§¸ ê²½ìš°ì…ë‹ˆë‹¤
            // - ì•ì„œ ê·¸ë¦¼ìœ¼ë¡œ ì„¤ëª…í•œ ë‚´ìš©ì„ ê¸°ì–µí•˜ë©´ì„œ ì½”ë“œë¥¼ ì‚´í´ë³´ì„¸ìš”

            // until we have flushed the history, we treat incoming packets as lost while still advacning ack window as far as we can
            // íˆìŠ¤í† ë¦¬ë¥¼ í”ŒëŸ¬ì‹œí•  ë•Œê¹Œì§€, ë“¤ì–´ì˜¤ëŠ” íŒ¨í‚·ë“¤ì„ ì†ì‹¤ëœ ê²ƒìœ¼ë¡œ ì²˜ë¦¬í•˜ë©´ì„œë„ ê°€ëŠ¥í•œ í•œ ack ìœˆë„ìš°ë¥¼ ê³„ì† ì „ì§„ì‹œí‚µë‹ˆë‹¤

            SequenceNumberT NewInSeqToAck(NotificationData.Seq);

            // still waiting on flush, but we can fill up the history
            // ì•„ì§ í”ŒëŸ¬ì‹œë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆì§€ë§Œ, íˆìŠ¤í† ë¦¬ë¥¼ ì±„ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤

            if (!WillSequenceFitInSequenceHistory(NotificationData.Seq) && GetHasUnacknowledgedAcks())
            {
                // mark everything we can as lost up until the end of the sequence history
                // ì‹œí€€ìŠ¤ íˆìŠ¤í† ë¦¬ì˜ ëê¹Œì§€ ê°€ëŠ¥í•œ ëª¨ë“  ê²ƒì„ ì†ì‹¤ëœ ê²ƒìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤

                NewInSeqToAck = SequenceNumberT(InAckSeqAck.Get() + (MaxSequenceHistoryLength - GetCurrentSequenceHistoryLength()));
            }

            if (NewInSeqToAck >= InSeq)
            {
                const SequenceNumberT::DifferenceT AdjustedSequenceDelta = SequenceNumberT::Diff(NewInSeqToAck, InSeq);

                InSeq = NewInSeqToAck;

                // NACK driven from here
                // AckSeq() function add deliverities from 'AckedSeq' to 'NewInSeqToAck': [AckedSeq, NewInSeqAck]
                // - see FNetPacketNotify::AckSeq() (goto 029: ServerChallengeControlMessage)

                // ì—¬ê¸°ì„œë¶€í„° NACKê°€ ì‹œì‘ë©ë‹ˆë‹¤
                // AckSeq() í•¨ìˆ˜ëŠ” 'AckedSeq'ë¶€í„° 'NewInSeqToAck'ê¹Œì§€ì˜ ì „ë‹¬ê°’ì„ ì¶”ê°€í•©ë‹ˆë‹¤: [AckedSeq, NewInSeqAck]
                // - FNetPacketNotify::AckSeq() ì°¸ì¡° (029: ServerChallengeControlMessageë¡œ ì´ë™)

                AckSeq(NewInSeqToAck, false);
                
                return AdjustedSequenceDelta;
            }
            else
            {
                return 0;
            }
        }
    }

```