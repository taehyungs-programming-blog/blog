---
layout: default
title: "09-02. ProcessReceivedAcks"
parent: "([Network] 09. ServerChallengeControlMessage)"
grand_parent: "(UE SourceCode Î∂ÑÏÑù ü§ñ)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

```cpp
template<class Functor>
void ProcessReceivedAcks(const FNotificationHeader& NotificationData, Functor&& InFunc)
{
    // can you understand what "(NotificationData.AckedSeq > OutAckSeq)" means?
    // - it means whether we have any left OutAckSeq to be processed
    // - it means ***any ACKs left to be processed***

    // "(NotificationData.AckedSeq > OutAckSeq)"Í∞Ä Î¨¥ÏóáÏùÑ ÏùòÎØ∏ÌïòÎäîÏßÄ Ïù¥Ìï¥ÌïòÏãúÎÇòÏöî?
    // - Ï≤òÎ¶¨Ìï¥Ïïº Ìï† OutAckSeqÍ∞Ä ÎÇ®ÏïÑÏûàÎäîÏßÄÎ•º ÏùòÎØ∏Ìï©ÎãàÎã§
    // - ***Ï≤òÎ¶¨Ìï¥Ïïº Ìï† ACKÎì§Ïù¥ ÎÇ®ÏïÑÏûàÎã§Îäî Í≤ÉÏùÑ ÏùòÎØ∏Ìï©ÎãàÎã§***
    if (NotificationData.AckedSeq > OutAckSeq)
    {
        // calculate 'AckCount' to process by: NotificationData.AckedSeq - OutAckSeq
        // - the condition should be 'true' for (NotificationData.AckedSeq > OutAckSeq)

        // Ï≤òÎ¶¨Ìï† 'AckCount'Î•º Í≥ÑÏÇ∞Ìï©ÎãàÎã§: NotificationData.AckedSeq - OutAckSeq
        // - (NotificationData.AckedSeq > OutAckSeq) Ï°∞Í±¥Ïóê ÎåÄÌï¥ 'true'Ïó¨Ïïº Ìï©ÎãàÎã§
        SequenceNumberT::DifferenceT AckCount = SequenceNumberT::Diff(NotificationData.AckedSeq, OutAckSeq);

        // update InAckSeqAck used to track the needed number of bits to transmit our ack history
        // @note: as we might reset sequence history we need to check if we already have advanced the InAckSeqAck
        // update AckRecord queue and validate InAckSeqAck with NotificationData.AckedSeq
        // *** note that UpdateInAckSeqAck() returns up-to-date's InAckSeqAck

        // ack ÌûàÏä§ÌÜ†Î¶¨Î•º Ï†ÑÏÜ°ÌïòÎäîÎç∞ ÌïÑÏöîÌïú ÎπÑÌä∏ ÏàòÎ•º Ï∂îÏ†ÅÌïòÎäîÎç∞ ÏÇ¨Ïö©ÎêòÎäî InAckSeqAckÎ•º ÏóÖÎç∞Ïù¥Ìä∏Ìï©ÎãàÎã§
        // @Ï∞∏Í≥†: ÏãúÌÄÄÏä§ ÌûàÏä§ÌÜ†Î¶¨Î•º Î¶¨ÏÖãÌï† Ïàò ÏûàÏúºÎØÄÎ°ú InAckSeqAckÍ∞Ä Ïù¥ÎØ∏ ÏßÑÌñâÎêòÏóàÎäîÏßÄ ÌôïÏù∏Ìï¥Ïïº Ìï©ÎãàÎã§
        // AckRecord ÌÅêÎ•º ÏóÖÎç∞Ïù¥Ìä∏ÌïòÍ≥† InAckSeqAckÎ•º NotificationData.AckedSeqÎ°ú Í≤ÄÏ¶ùÌï©ÎãàÎã§
        // *** UpdateInAckSeqAck()Îäî ÏµúÏã† InAckSeqAckÎ•º Î∞òÌôòÌïúÎã§Îäî Ï†êÏóê Ï£ºÏùòÌïòÏÑ∏Ïöî
        const SequenceNumberT NewInAckSeqAck = UpdateInAckSeqAck(AckCount, NotificationData.AckedSeq);
        if (NewInAckSeqAck > InAckSeqAck)
        {
            InAckSeqAck = NewInAckSeqAck;
        }

        // ExpectedAck = OutAckSeq + 1
        // OutAckSeq is not proven for updating, so we use temporary-variable, 'CurrentAck' and increment it to look through sequence-history

        // ExpectedAck = OutAckSeq + 1
        // OutAckSeqÎäî ÏóÖÎç∞Ïù¥Ìä∏Í∞Ä ÌôïÏù∏ÎêòÏßÄ ÏïäÏïòÏúºÎØÄÎ°ú, ÏûÑÏãú Î≥ÄÏàòÏù∏ 'CurrentAck'Î•º ÏÇ¨Ïö©ÌïòÍ≥† ÏãúÌÄÄÏä§ ÌûàÏä§ÌÜ†Î¶¨Î•º ÏÇ¥Ìé¥Î≥¥Í∏∞ ÏúÑÌï¥ Ï¶ùÍ∞ÄÏãúÌÇµÎãàÎã§
        SequenceNumberT CurrentAck(OutAckSeq);
        ++CurrentAck;

        // make sure that we only look at the sequence history bit included in the notification data as the sequence history might have been reset
        // in which case we might not receive the max size history even tough the ack-count is bigger than the history

        // ÏãúÌÄÄÏä§ ÌûàÏä§ÌÜ†Î¶¨Í∞Ä Î¶¨ÏÖãÎêòÏóàÏùÑ Ïàò ÏûàÏúºÎØÄÎ°ú ÏïåÎ¶º Îç∞Ïù¥ÌÑ∞Ïóê Ìè¨Ìï®Îêú ÏãúÌÄÄÏä§ ÌûàÏä§ÌÜ†Î¶¨ ÎπÑÌä∏Îßå ÌôïÏù∏ÌïòÎèÑÎ°ù Ìï©ÎãàÎã§
        // Ïù¥ Í≤ΩÏö∞ ack-countÍ∞Ä ÌûàÏä§ÌÜ†Î¶¨Î≥¥Îã§ ÌÅ¨ÎçîÎùºÎèÑ ÏµúÎåÄ ÌÅ¨Í∏∞Ïùò ÌûàÏä§ÌÜ†Î¶¨Î•º Î∞õÏßÄ Î™ªÌï† Ïàò ÏûàÏäµÎãàÎã§
        const SequenceNumberT::DifferenceT HistoryBits = NotificationData.HistoryWordCount * SequenceHistoryT::BitsPerWord;

        // warn if the received sequence number is greater than our history buffer, since if that is the case we have to treat the data as lost
        // @note: this should normally not be a problem since we try to flush the sequence history before allowing an overshoot of the sequence history window on the sending side
        // if this occurs with no hitches on server or client, there might be reason to investigate if too much data is being sent in which case the size sequence history might have to be increased

        // ÏàòÏã†Îêú ÏãúÌÄÄÏä§ Î≤àÌò∏Í∞Ä ÌûàÏä§ÌÜ†Î¶¨ Î≤ÑÌçºÎ≥¥Îã§ ÌÅ¨Î©¥ Í≤ΩÍ≥†Ìï©ÎãàÎã§. Ïù¥ Í≤ΩÏö∞ Îç∞Ïù¥ÌÑ∞Î•º ÏÜêÏã§Îêú Í≤ÉÏúºÎ°ú Ï≤òÎ¶¨Ìï¥Ïïº ÌïòÍ∏∞ ÎïåÎ¨∏ÏûÖÎãàÎã§
        // @Ï∞∏Í≥†: Î≥¥ÎÇ¥Îäî Ï™ΩÏùò ÏãúÌÄÄÏä§ ÌûàÏä§ÌÜ†Î¶¨ ÏúàÎèÑÏö∞Í∞Ä Ï¥àÍ≥ºÎêòÍ∏∞ Ï†ÑÏóê ÏãúÌÄÄÏä§ ÌûàÏä§ÌÜ†Î¶¨Î•º ÌîåÎü¨ÏãúÌïòÎ†§Í≥† ÌïòÎØÄÎ°ú ÏùºÎ∞òÏ†ÅÏúºÎ°ú Î¨∏Ï†úÍ∞Ä ÎêòÏßÄ ÏïäÏäµÎãàÎã§
        // ÏÑúÎ≤ÑÎÇò ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú Î¨∏Ï†úÏóÜÏù¥ Ïù¥Îü∞ ÏùºÏù¥ Î∞úÏÉùÌïúÎã§Î©¥, ÎÑàÎ¨¥ ÎßéÏùÄ Îç∞Ïù¥ÌÑ∞Í∞Ä Ï†ÑÏÜ°ÎêòÍ≥† ÏûàÎäîÏßÄ Ï°∞ÏÇ¨Ìï¥Î≥º ÌïÑÏöîÍ∞Ä ÏûàÏúºÎ©∞ Ïù¥ Í≤ΩÏö∞ ÏãúÌÄÄÏä§ ÌûàÏä§ÌÜ†Î¶¨ ÌÅ¨Í∏∞Î•º ÎäòÎ†§Ïïº Ìï† Ïàò ÏûàÏäµÎãàÎã§
        if (AckCount > (SequenceNumberT::DifferenceT)(SequenceHistoryT::Size))
        {
            UE_LOG_PACKET_NOTIFY_WARNING(TEXT("FNetPacketNotify::ProcessReceivedAcks - Missed Acks: AckedSeq: %u, OutAckSeq: %u, FirstMissingSeq: %u Count: %u"), NotificationData.AckedSeq.Get(), OutAckSeq.Get(), CurrentAck.Get(), AckCount - (SequenceNumberT::DifferenceT)(SequenceHistoryT::Size));
        }

        // everything not found in the history buffer is treated as lost
        // if AckCount is bigger than HistoryBits(256), we missed acks
        // - for missing acks, we just process these packet-id as NAK not ACK
        // - InFunc is the lambda, 'UNetConnection::HandlePacketNotification'

        // ÌûàÏä§ÌÜ†Î¶¨ Î≤ÑÌçºÏóêÏÑú Ï∞æÏùÑ Ïàò ÏóÜÎäî Î™®Îì† Í≤ÉÏùÄ ÏÜêÏã§Îêú Í≤ÉÏúºÎ°ú Ï≤òÎ¶¨Îê©ÎãàÎã§
        // AckCountÍ∞Ä HistoryBits(256)Î≥¥Îã§ ÌÅ¨Îã§Î©¥, ackÎì§ÏùÑ ÎÜìÏ≥§Îã§Îäî ÏùòÎØ∏ÏûÖÎãàÎã§
        // - ÎÜìÏπú ackÎì§Ïóê ÎåÄÌï¥ÏÑúÎäî, Ïù¥ Ìå®ÌÇ∑-idÎì§ÏùÑ ACKÍ∞Ä ÏïÑÎãå NAKÎ°ú Ï≤òÎ¶¨Ìï©ÎãàÎã§
        // - InFuncÎäî 'UNetConnection::HandlePacketNotification' ÎûåÎã§ÏûÖÎãàÎã§
        while (AckCount > HistoryBits)
        {
            --AckCount;
            InFunc(CurrentAck, false);
            ++CurrentAck;
        }

        // for sequence numbers contained in the history we lookup the delivery status from the history
        // call the lambda with NotificationData.History's bit deliverity

        // ÌûàÏä§ÌÜ†Î¶¨Ïóê Ìè¨Ìï®Îêú ÏãúÌÄÄÏä§ Î≤àÌò∏Îì§Ïóê ÎåÄÌï¥ ÌûàÏä§ÌÜ†Î¶¨ÏóêÏÑú Ï†ÑÎã¨ ÏÉÅÌÉúÎ•º Ï°∞ÌöåÌï©ÎãàÎã§
        // NotificationData.HistoryÏùò ÎπÑÌä∏ Ï†ÑÎã¨ ÏÉÅÌÉúÎ°ú ÎûåÎã§Î•º Ìò∏Ï∂úÌï©ÎãàÎã§
        while (AckCount > 0)
        {
            --AckCount;
            InFunc(CurrentAck, NotificationData.History.IsDelivered(AckCount));
            ++CurrentAck;
        }

        // update OutAckSeq with NotificationData.AckedSeq
        // - if OutAckSeq is updated and bigger than WaitingForFlushSeqAck, update WaitingForFlushSeqAck as newly-updated OutAckSeq

        // OutAckSeqÎ•º NotificationData.AckedSeqÎ°ú ÏóÖÎç∞Ïù¥Ìä∏Ìï©ÎãàÎã§
        // - OutAckSeqÍ∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÍ≥† WaitingForFlushSeqAckÎ≥¥Îã§ ÌÅ¨Îã§Î©¥, WaitingForFlushSeqAckÎ•º ÏÉàÎ°ú ÏóÖÎç∞Ïù¥Ìä∏Îêú OutAckSeqÎ°ú ÏóÖÎç∞Ïù¥Ìä∏Ìï©ÎãàÎã§
        OutAckSeq = NotificationData.AckedSeq;

        // are we done waiting for an reset of the ack history
        // ack ÌûàÏä§ÌÜ†Î¶¨Ïùò Î¶¨ÏÖãÏùÑ Í∏∞Îã§Î¶¨Îäî Í≤ÉÏù¥ ÎÅùÎÇ¨ÎÇòÏöî
        if (OutAckSeq > WaitingForFlushSeqAck)
        {
            WaitingForFlushSeqAck = OutAckSeq;
        }

    }
}
```

