---
layout: default
title: "05-02. FPacketIterator"
parent: "([Network] 05. ServerInitalSendPacket)"
grand_parent: "(UE SourceCode ë¶„ì„ ğŸ¤–)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

```cpp
/**
 * encapsulates the NetDriver TickDispatch code required for executing all variations of packet receives
 * (FSocket::RecvFrom, FSocket::RecvMulti, and the ReceiveThread) as well as implementing/abstracting-away some of the outermost
 * (non-NetConnection-related) parts of the DDoS detection code, and code for timing receives/iterations (which affects control flow)
 */
/**
 * íŒ¨í‚· ìˆ˜ì‹ ì˜ ëª¨ë“  ë³€í˜•(FSocket::RecvFrom, FSocket::RecvMulti, ReceiveThread)ì„ ì‹¤í–‰í•˜ëŠ” ë° í•„ìš”í•œ NetDriver TickDispatch ì½”ë“œë¥¼ ìº¡ìŠí™”í•˜ë©°,
 * DDoS ê°ì§€ ì½”ë“œì˜ ê°€ì¥ ë°”ê¹¥ìª½ ë¶€ë¶„(NetConnectionê³¼ ê´€ë ¨ ì—†ëŠ”)ê³¼ ìˆ˜ì‹ /ë°˜ë³µ íƒ€ì´ë° ì½”ë“œ(ì œì–´ íë¦„ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ”)ì˜ ì¼ë¶€ë¥¼ êµ¬í˜„/ì¶”ìƒí™”í•©ë‹ˆë‹¤.
 */

// 'FPacketIteartor' is the wrapper of receiving raw packets every tick
// - under its implementation, it actually calls FSocket::RecvFrom
// - using the iterator pattern, it gives the access of recv-buffer data
// *** see member variables ***
// - to understand how 'FPacketIterator' works, let's see its member methods:
//   1. FPacketIterator constructor
//   2. iterator pattern:
//      - see ++operator
//      - see (bool)operator
//   3. lastly, every iteration, we retrieve received packet

// 'FPacketIterator'ëŠ” ë§¤ í‹±ë§ˆë‹¤ ì›ì‹œ íŒ¨í‚·ì„ ìˆ˜ì‹ í•˜ëŠ” ë˜í¼ì…ë‹ˆë‹¤
// - ê·¸ êµ¬í˜„ ë‚´ë¶€ì—ì„œ ì‹¤ì œë¡œ FSocket::RecvFromì„ í˜¸ì¶œí•©ë‹ˆë‹¤
// - ë°˜ë³µì íŒ¨í„´ì„ ì‚¬ìš©í•˜ì—¬ recv-buffer ë°ì´í„°ì— ëŒ€í•œ ì ‘ê·¼ì„ ì œê³µí•©ë‹ˆë‹¤
// *** ë©¤ë²„ ë³€ìˆ˜ë“¤ì„ ë³´ì„¸ìš” ***
// - 'FPacketIterator'ê°€ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€ ì´í•´í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ë©¤ë²„ ë©”ì„œë“œë“¤ì„ ì‚´í´ë´…ì‹œë‹¤:
//   1. FPacketIterator ìƒì„±ì
//   2. ë°˜ë³µì íŒ¨í„´:
//      - ++ì—°ì‚°ì ì°¸ì¡°
//      - (bool)ì—°ì‚°ì ì°¸ì¡°
//   3. ë§ˆì§€ë§‰ìœ¼ë¡œ, ë§¤ ë°˜ë³µë§ˆë‹¤ ìˆ˜ì‹ ëœ íŒ¨í‚·ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤. GetCurrentPacket ì°¸ì¡°
class FPacketIterator
```

```cpp
FPacketIterator(UIpNetDriver* InDirver)
    : Driver(InDriver)
    , bBreak(false)
    , IterationCount(0)
    , SocketSubsystem(InDriver->GetSocketSubsystem())
    , CurrentPacket()
{
    CurrentPacket.Address = SocketSubsystem->CreateInternetAddr();
    AdvanceCurrentPacket();
}
```

```cpp
FPacketIteartor& operator++()
{
    IterationCount++;
    AdvanceCurrentPacket();
    return *this;
}
```

```cpp
bool GetCurrentPacket(FReceivedPacketView& OutPacket)
{
    bool bRecvSuccess = false;
    {
        OutPacket.DataView = {CurrentPacket.Data.GetData(), CurrentPacket.Data.Num(), ECountUnits::Bytes};
        OutPacket.Error = CurrentPacket.Error;
        OutPacket.Address = CurrentPacket.Address;
        bRecvSuccess = CurrentPacket.bRecvSuccess;
    }
    return bRecvSuccess;
}
```

```cpp
/**
 * represents a view of a received packet, which may be modified to update data it points to and data size, as a packet processed
 * should only be stored as a local variable within functions that handle received packets
 */
/**
 * ìˆ˜ì‹ ëœ íŒ¨í‚·ì˜ ë·°ë¥¼ ë‚˜íƒ€ë‚´ë©°, íŒ¨í‚·ì´ ì²˜ë¦¬ë¨ì— ë”°ë¼ ë°ì´í„°ê°€ ê°€ë¦¬í‚¤ëŠ” ê³³ê³¼ ë°ì´í„° í¬ê¸°ë¥¼ ì—…ë°ì´íŠ¸í•˜ë„ë¡ ìˆ˜ì •ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤
 * ìˆ˜ì‹ ëœ íŒ¨í‚·ì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ ë‚´ì—ì„œë§Œ ë¡œì»¬ ë³€ìˆ˜ë¡œ ì €ì¥ë˜ì–´ì•¼ í•©ë‹ˆë‹¤
 */

// like ArrayView, it is view object for FCachedPacket in FPacketIterator
// - the actual data is in (FPacketIterator::CurrentPacket: FCachedPacket)
// - it is just a view object
// - see its member variables briefly

// ArrayViewì™€ ê°™ì´, FPacketIteratorì˜ FCachedPacketì— ëŒ€í•œ ë·° ê°ì²´ì…ë‹ˆë‹¤
// - ì‹¤ì œ ë°ì´í„°ëŠ” (FPacketIterator::CurrentPacket: FCachedPacket)ì— ìˆìŠµë‹ˆë‹¤
// - ì´ê²ƒì€ ë‹¨ìˆœí•œ ë·° ê°ì²´ì…ë‹ˆë‹¤
// - ë©¤ë²„ ë³€ìˆ˜ë“¤ì„ ê°„ë‹¨íˆ ì‚´í´ë³´ì„¸ìš”
struct FReceivedPacketView
{
    /** view of packet data - can reassign to point elsewhere, but don't use to modify packet data */
    /** íŒ¨í‚· ë°ì´í„°ì˜ ë·° - ë‹¤ë¥¸ ê³³ì„ ê°€ë¦¬í‚¤ë„ë¡ ì¬í• ë‹¹í•  ìˆ˜ ìˆì§€ë§Œ, íŒ¨í‚· ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ëŠ” ë° ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš” */
    FPacketDataView DataView = {nullptr, 0, ECountUnits::Bits};

    /** receive address for the packet */
    /** íŒ¨í‚·ì˜ ìˆ˜ì‹  ì£¼ì†Œ */
    TSharedPtr<const FInternetAddr> Address;

    /** error if receiving a packet failed */
    /** íŒ¨í‚· ìˆ˜ì‹ ì— ì‹¤íŒ¨í•œ ê²½ìš°ì˜ ì˜¤ë¥˜ */
    ESocketErrors Error;

    /** metadata and flags for the received packet, indicating what it contains and how to process it */
    /** ìˆ˜ì‹ ëœ íŒ¨í‚·ì— ëŒ€í•œ ë©”íƒ€ë°ì´í„°ì™€ í”Œë˜ê·¸ë¡œ, íŒ¨í‚·ì´ ë¬´ì—‡ì„ í¬í•¨í•˜ê³  ìˆëŠ”ì§€ì™€ ì–´ë–»ê²Œ ì²˜ë¦¬í•´ì•¼ í•˜ëŠ”ì§€ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤ */
    FInPacketTraits Traits;
};
```