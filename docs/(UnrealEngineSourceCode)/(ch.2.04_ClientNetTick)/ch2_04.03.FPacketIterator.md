---
layout: default
title: "04-03. FPacketIterator"
parent: "([Network] 04. ClientNetTick)"
grand_parent: "(UE SourceCode ë¶„ì„ ğŸ¤–)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

```cpp
/**
 * encapsulates the NetDriver TickDispatch code required for executing all variations of packet receives
 * (FSocket::RecvFrom, FSocket::RecvMulti, and the ReceiveThread) as well as implementing/abstracting-away some of the outermost
 * (non-NetConnection-related) parts of the DDoS detection code, and code for timing receives/iterations (which affects control flow)
 */
/**
 * NetDriver TickDispatch ì½”ë“œë¥¼ ìº¡ìŠí™”í•˜ì—¬ ëª¨ë“  ì¢…ë¥˜ì˜ íŒ¨í‚· ìˆ˜ì‹ (FSocket::RecvFrom, FSocket::RecvMulti, ReceiveThread)ì„ ì‹¤í–‰í•˜ê³ ,
 * ê°€ì¥ ë°”ê¹¥ìª½(NetConnectionê³¼ ê´€ë ¨ ì—†ëŠ”) DDoS ê°ì§€ ì½”ë“œì˜ ì¼ë¶€ì™€ ìˆ˜ì‹ /ë°˜ë³µ íƒ€ì´ë° ì½”ë“œ(ì œì–´ íë¦„ì— ì˜í–¥ì„ ë¯¸ì¹¨)ë¥¼ êµ¬í˜„/ì¶”ìƒí™”í•©ë‹ˆë‹¤.
 */

// 'FPacketIteartor' is the wrapper of receiving raw packets every tick
// - under its implementation, it actually calls FSocket::RecvFrom
// - using the iterator pattern, it gives the access of recv-buffer data

    // 'FPacketIterator'ëŠ” ë§¤ í‹±ë§ˆë‹¤ ì›ì‹œ íŒ¨í‚·ì„ ìˆ˜ì‹ í•˜ëŠ” ë˜í¼ì…ë‹ˆë‹¤
    // - ë‚´ë¶€ êµ¬í˜„ì—ì„œëŠ” ì‹¤ì œë¡œ FSocket::RecvFromì„ í˜¸ì¶œí•©ë‹ˆë‹¤
    // - ë°˜ë³µì íŒ¨í„´ì„ ì‚¬ìš©í•˜ì—¬ ìˆ˜ì‹  ë²„í¼ ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤

// *** see member variables ***
// - to understand how 'FPacketIterator' works, let's see its member methods:
//   1. FPacketIterator constructor
//   2. iterator pattern:
//      - see ++operator
//      - see (bool)operator
//   3. lastly, every iteration, we retrieve received packet, see GetCurrentPacket

    // *** ë©¤ë²„ ë³€ìˆ˜ ì°¸ì¡° ***
    // - 'FPacketIterator'ì˜ ì‘ë™ ë°©ì‹ì„ ì´í•´í•˜ê¸° ìœ„í•´ ë©¤ë²„ ë©”ì„œë“œë¥¼ ì‚´í´ë´…ì‹œë‹¤:
    //   1. FPacketIterator ìƒì„±ì
    //   2. ë°˜ë³µì íŒ¨í„´:
    //      - ++ì—°ì‚°ì ì°¸ì¡°
    //      - (bool)ì—°ì‚°ì ì°¸ì¡°
    //   3. ë§ˆì§€ë§‰ìœ¼ë¡œ, ë§¤ ë°˜ë³µë§ˆë‹¤ ìˆ˜ì‹ ëœ íŒ¨í‚·ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤. GetCurrentPacket ì°¸ì¡°

class FPacketIterator
{
    struct FCachedPacket
    {
        /** whether socket receive succeeded; don't rely on the Error field for this (due to implementation/platform uncertainties) */
        /** ì†Œì¼“ ìˆ˜ì‹  ì„±ê³µ ì—¬ë¶€; êµ¬í˜„/í”Œë«í¼ ë¶ˆí™•ì‹¤ì„±ìœ¼ë¡œ ì¸í•´ ì´ë¥¼ ìœ„í•´ Error í•„ë“œì— ì˜ì¡´í•˜ì§€ ë§ˆì„¸ìš” */
        bool bRecvSuccess;

        /** pre-allocated data field, for storing packets of any expected size */
        /** ì˜ˆìƒë˜ëŠ” ëª¨ë“  í¬ê¸°ì˜ íŒ¨í‚·ì„ ì €ì¥í•˜ê¸° ìœ„í•œ ì‚¬ì „ í• ë‹¹ëœ ë°ì´í„° í•„ë“œ */
        // note that Data is based on TFixedAllocator:
        // - basing on TFixedAllocator means that it has just fixed-size array (NOT dynamic array)
        // - MAX_PACKET_SIZE == 1024 (considering MTU/MSS)
        // Dataê°€ TFixedAllocatorë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•¨ì„ ì£¼ëª©í•˜ì„¸ìš”:
        // - TFixedAllocatorë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œë‹¤ëŠ” ê²ƒì€ ê³ ì • í¬ê¸° ë°°ì—´ì„ ê°€ì§„ë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤ (ë™ì  ë°°ì—´ì´ ì•„ë‹˜)
        // - MAX_PACKET_SIZE == 1024 (MTU/MSSë¥¼ ê³ ë ¤)
        TArray<uint8, TFixedAllocator<MAX_PACKET_SIZE>> Data;

        /** receive address for the packet */
        /** íŒ¨í‚·ì˜ ìˆ˜ì‹  ì£¼ì†Œ */
        // by calling SocketSubSystem's RecvFrom, we can retrieve the address info which is from the received packet
        // SocketSubSystemì˜ RecvFromì„ í˜¸ì¶œí•˜ì—¬ ìˆ˜ì‹ ëœ íŒ¨í‚·ì˜ ì£¼ì†Œ ì •ë³´ë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
        TSharedPtr<FInternetAddr> Address;

        /** error if receiving a packet failed */
        /** íŒ¨í‚· ìˆ˜ì‹  ì‹¤íŒ¨ ì‹œ ì˜¤ë¥˜ */
        ESocketErrors Error;
    };

    // every preparing to receive packets, we pass 'NetDriver(IpNetDriver)' to the FPacketIterator
        // íŒ¨í‚· ìˆ˜ì‹ ì„ ì¤€ë¹„í•  ë•Œë§ˆë‹¤ 'NetDriver(IpNetDriver)'ë¥¼ FPacketIteratorì— ì „ë‹¬í•©ë‹ˆë‹¤
    FPacketIterator(UIpNetDriver* InDirver)
        : Driver(InDriver)
        , bBreak(false)
        , IterationCount(0)
        , SocketSubsystem(InDriver->GetSocketSubsystem())
        , CurrentPacket()
    {
        // by default, assign new instance of CurrentPacket.Address
        // - see FPacketIterator::AdvanceCurrentPacket
            // ê¸°ë³¸ì ìœ¼ë¡œ CurrentPacket.Addressì˜ ìƒˆ ì¸ìŠ¤í„´ìŠ¤ë¥¼ í• ë‹¹í•©ë‹ˆë‹¤
            // - FPacketIterator::AdvanceCurrentPacket ì°¸ì¡°
        CurrentPacket.Address = SocketSubsystem->CreateInternetAddr();
        AdvanceCurrentPacket();
    }
```