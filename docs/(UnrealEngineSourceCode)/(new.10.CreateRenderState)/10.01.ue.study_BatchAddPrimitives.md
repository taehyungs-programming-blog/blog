---
layout: default
title: "10-01. BatchAddPrimitives"
parent: (10. CreateRenderState)"
grand_parent: "(UE SourceCode ë¶„ì„ ğŸ¤–)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

```cpp
virtual void BatchAddPrimitives(TArrayView<UPrimitiveComponent*> InPrimitives) override
{
    // see briefly FCreateRenderThreadParameters
    // - now it's time to see what render object is, aligned to UPrimitiveComponent

    // - 'FCreateRenderThreadParameters' is the wrapper class to transfer necessary inputs to "render-thread"
    //    - try to understand how reading/writing to scene works:
    //                                                                                                                                                     
    //      :World is only allowed to read/write in GameThread         :Scene is only allowed to read/write in RenderThread                                
    //                                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  
    //               ***GameThread     ****                                 ***RenderThread       ****                                                     
    //                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           
    //                  â”‚ World â”‚                                        â”‚ Scene(Render-World) â”‚                                                           
    //                  â””â”€â”€â”€â”¬â”€â”€â”€â”˜                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                           
    //                      â”‚                                                       â”‚                                                                      
    //                      â”‚                                                       â”‚                                                                      
    //                      â”‚                                                       â”‚                                                                      
    //                      â”œâ”€â”€â”€â”€â”                                                  â”‚                                                                      
    //                      â”‚    â”‚ Create PrimitiveSceneInfo/SceneProxy             â”‚                                                                      
    //                      â”‚    â”‚ (in GameThread)                                  â”‚                                                                      
    //                      â—„â”€â”€â”€â”€â”˜                                                  â”‚                                                                      
    //                      â”‚                                                       â”‚                                                                      
    //                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                                                                      
    //                      â”‚       Add RenderCommand with ParamList                â”‚                                                                      
    //                      â”‚       : ParamList is                                  â”‚                                                                      
    //                      â”‚         TArray<FCreateRenderThreadParameters>         â”‚                                                                      
    //                      â”‚                                                       â”œâ”€â”€â”€â”€â”                                                                 
    //                      â”‚                                                       â”‚    â”‚1.FPrimitiveSceneProxy::SetTransform()                           
    //                      â”‚                                                       â”‚    â”‚2.Process ParamList to add inputs into AddedPrimitiveSceneInfos  
    //                      â”‚                                                       â—„â”€â”€â”€â”€â”˜                                       â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
    //                      â”‚                                                       â”‚                                              â”‚                       
    //                      â”‚                                                       â”‚                                              â”‚                       
    //                      â”‚                                                       â”‚                                              â”‚                       
    //                      â”‚                                                       â”œâ”€â”€â”€â”€â”                                         â”‚                       
    //                      â”‚                                                       â”‚    â”‚UpdateAllPrimitiveSceneInfos():          â–¼                       
    //                      â”‚                                                       â”‚    â”‚  process pending scene infos(AddedPrimitiveSceneInfos)          
    //                      â”‚                                                       â—„â”€â”€â”€â”€â”˜                                                                 
    //                      â”‚                                                       â”‚                                                                      
    //                                                                                                                                                             
    //            
    struct FCreateRenderThreadParameters
    {
        FPrimitiveSceneInfo* PrimitiveSceneInfo;
        FPrimitiveSceneProxy* PrimitiveSceneProxy;
        FMatrix RenderMatrix;
        FBoxSphereBounds WorldBounds;
        FVector AttachmentRootPosition;
        FBoxSphereBounds LocalBounds;
        TOptional<FTransform> PreviousTransform;
    };

    TArray<FCreateRenderThreadParameters> ParamsList;
    ParamsList.Reserve(InPrimitives.Num());

    // iterate batched primitives and prepare 'FCreateRenderThreadParameters'
    for (UPrimitiveComponent* Primitive : InPrimitives)
    {
        const float WorldTime = GetWorld()->GetTimeSeconds();

        // save the world transform for next time the primitive is added to the scene
        float DeltaTime = WorldTime - Primitive->LastSubmitTime;
        if (DeltaTime < -0.0001f || Primitive->LastSubmitTime < 0.0001f)
        {
            // the was reset?
            // do we have negative DeltaTime?...
            Primitive->LastSubmitTime = WorldTime;
        }
        else if (DeltaTime > 0.001f)
        {
            // first call for the new frame
            Primitive->LastSubmitTime = WorldTime;
        }
        // else condition is -0.0001f < DeltaTime < 0.001f
        // - Primitive->LastSubmitTime is remained when it is nearly '0'

        // create the primitive's scene proxy
        FPrimitiveSceneProxy* PrimitiveSceneProxy = Primitive->CreateSceneProxy();

        // see UPrimitiveComponent's SceneProxy briefly:
        // - PrimitiveComponent has the ownership of SceneProxy
        Primitive->SceneProxy = PrimitiveSceneProxy;
        if (!PrimitiveSceneProxy)
        {
            // primitive which don't have a proxy are irrelevant to the scene manager
            continue;
        }

        // create the primitive scene info
        // PrimitiveSceneInfo creation is also done by GameThread!
        // - construct link between PrimitiveSceneInfo and PrimitiveSceneProxy
        FPrimitiveSceneInfo* PrimitiveSceneInfo = new FPrimitiveSceneInfo(Primitive, this);
        PrimitiveSceneProxy->PrimitiveSceneInfo = PrimitiveSceneInfo;

        // cache the primitives initial transform
        // see GetRenderMatrix briefly:
        // - it returns ComponentTransform()
        // - RenderMatrix is the transform data to apply to the render-world(FScene)
        FMatrix RenderMatrix = Primitive->GetRenderMatrix();
        FVector AttachmentRootPosition = Primitive->GetActorPositionForRenderer();

        // we contruct each parameter(FCreateRenderThreadParameters) per PrimitiveComponent
        ParameterList.Emplace(	
            PrimitiveSceneInfo,
            PrimitiveSceneProxy,
            RenderMatrix,
            Primitive->Bounds,
            AttachmentRootPosition,
            Primitive->GetLocalBounds()
        );
    }

    // create any RenderThreadResources required and send a command to the rendering thread to add the primitive to the scene
    FScene* Scene = this;

    // ENQUEUE_RENDER_COMMAND is lambda function executed in render-thread:
    // - let's understand ENQUEUE_RENDER_COMMAND conceptually:
    //                                                                                                        
    //   [GameThread]                                                                                 
    //   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  
    //                    â”‚                                                                           
    //                    â”‚                                                                           
    //                    â”‚ENQUEUE_RENDER_COMMAND(Lambda)                                             
    //                    â”‚                                                                           
    //                    â”‚                                                                           
    //                  â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            
    //   [RenderThread]:â”‚  CommandQueue  â”‚                                                            
    //                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”˜                                                            
    //                                 â”‚ Polling each command and execute in RenderThread             
    //   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  
    //                                                                                                
    ENQUEUE_RENDER_COMMAND(AddPrimitiveCommand)(
        [ParamList = MoveTemp(ParamsList), Scene](FRHICommandListImmediate& RHICmdList)
        {
            // iterating ParamList in 'RenderThread'
            for (const FCreateRenderThreadParameters& Params : ParamsList)
            {
                FPrimitiveSceneProxy* SceneProxy = Params.PrimitiveSceneProxy;

                SceneProxy->SetTransform(Params.RenderMatrix, Params.WorldBounds, Params.LocalBounds, Params.AttachmentRootPosition);

                Scene->AddPrimitiveSceneInfo_RenderThread(Params.PrimitiveSceneInfo, Params.PreviousTransform);
            }
        }
    );
}
```