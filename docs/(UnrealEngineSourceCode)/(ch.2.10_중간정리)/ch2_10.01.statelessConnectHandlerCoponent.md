---
layout: default
title: "10-01. 2"
parent: "([Network] 10. ì¤‘ê°„ì •ë¦¬)"
grand_parent: "(UE SourceCode ë¶„ì„ ğŸ¤–)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* ì¼ë‹¨ `Incoming`ê¹Œì§„ ìˆ˜ì‹ ì´ ë˜ì—ˆë‹¤ ê°€ì •í•˜ì.

```cpp
class StatelessConnectHandlerComponent : public HandlerComponent
{
    // ...

virtual void Incoming(FBitReader& Packet) override
{
    if (MagicHeader.Num() > 0)
    {
        //...
    }

    bool bHasValidSessionID = true;
    bool bHasValidClientID = true;
    uint8 SessionID = 0;
    uint8 ClientID = 0;
    {
        Packet.SerializeBits(&SessionID, SessionIDSizeBits);
        Packet.SerializeBits(&ClientID, ClientIDSizeBits);

        bHasValidSessionID = (SessionID == CachedGlobalNetTravelCount && !Packet.IsError());
        bHasValidClientID = (ClientID == CachedClientID && !Packet.IsError());
    }

    // íŒ¨í‚·ì´ ì—ëŸ¬ê°€ ì—†ê³  ì²« ë¹„íŠ¸ê°€ 1ì¼ ê²½ìš° HandShakeë¼ ê°€ì •í•˜ì
    bool bHandshakePacket = !!Packet.ReadBit() && !Packet.IsError();
    if (bHandshakePacket)
    {
        // ë‹¹ì¥ì€ í° ì˜ë¯¸ê°€ ì—†ìœ¼ë‹ˆ ìƒëµ.
        // ...
    }
}
```

```cpp
class PacketHandler
{
    // ...

EIncomingResult Incoming_Internal(FReceivedPacketView& PacketView)
{
    // ...

    FBitReader ProcessedPacketReader(DataView.GetMutableData(), CountBits);
    FIncomingPacketRef PacketRef = {ProcessedPacketReader, PacketView.Address, PacketView.Traits};

    for (int32 i = HandlerComponents.Num() - 1; i >= 0; --i)
    {
        HandlerComponent& CurComponent = *HandlerComponents[i];
        if (CurComponent.IsActive() && !ProcessedPacketReader.IsError() && ProcessedPacketReader.GetBitsLeft() > 0)
        {
            if (PacketView.Traits.bConnectionlessPacket)
            {
                CurComponent.IncomingConnectionless(PacketRef);
            }
            else
            {
                CurComponent.Incoming(PacketRef);
            }
        }
    }

    // Processedëœ íŒ¨í‚·ì´ ì—¬ê¸°ë¡œ ì˜¨ë‹¤
    if (!ProcessedPacketReader.IsError())
    {
        ReplaceIncomingPacket(ProcessedPacketReader);
        PacketView.DataView = {IncomingPacket.GetData(), (int32)IncomingPacket.GetBitsLeft(), ECountBits::Bits};
    }
}
```

```cpp
class UIpNetDriver : public UNetDriver
{
    // ...
class PacketHandler
{
    // ...

// ìœ„ì¹˜ì— ë”°ë¼ IncomingPacketë¥¼ ì„¸íŒ…
void ReplaceIncomingPacket(FBitReader& ReplacementPacket)
{
    if (ReplacementPacket.GetPosBits() == 0 || ReplacementPacket.GetBitsLeft() == 0)
    {
        IncomingPacket = MoveTemp(ReplacementPacket);
    }
    else
    {
        TArray<uint8> TempPacketData;
        TempPacketData.AddUninitialized(IntCastLog<int32, int64>(ReplacementPacket.GetBytesLeft()));
        TempPacketData[TempPacketData.Num()-1] = 0;

        int64 NewPacketSizeBits = ReplacementPacket.GetBitsLeft();
        ReplacementPacket.SerializeBits(TempPacketData.GetData(), NewPacketSizeBits);
        IncomingPacket.SetData(MoveTemp(TempPacketData), NewPacketSizeBits);
    }
}
```

* ìš”ê¸°ê¹Œì§€ í•˜ë©´ `PacketView.DataView`ì— ë°ì´í„°ê°€ ë‹´ê¸°ê²Œ ëœë‹¤.

```cpp
virtual void TickDispatch(float DeltaTime) override
{
    //...


    if (bOk == false)
    {
        // ERROR
    }
    else
    {
        // ...

        if (Connection != nullptr && !bIgnorePacket)
        {
            // ê²°êµ­ ì—¬ë¦¬ê³  ë“¤ì–´ì˜¤ê³  ReceivedRawPacket í˜¸ì¶œ!
            Connection->ReceivedRawPacket((uint8*)ReceivedPacket.DataView.GetData(), ReceivedPacket.DataView.NumBytes());
        }
    }
}
```

```cpp
class UNetConnection : public UPlayer
{
    // ...

// ê²°êµ­ ì—¬ê¸°ë¡œ ë“¤ì–´ì˜¤ê²Œ ë¨.
virtual void ReceivedPacket(FBitReader& Reader, bool bIsReinjectedPacket=false, bool bDispatchPacket=true)
{
    // ...

    // ì¢…ë£Œì²˜ë¦¬(id, ì´ìœ )ëŠ” FChannelsToCloseë¥¼ í†µí•´ ì•Œë¦°ë‹¤.
    FChannelsToClose ChannelsToClose;
    const int32 OldInPacketId = InPacketId;

    if (IsInternalAck())
    {
        //...
    }
    else
    {
        // ê²°êµ­ FNetPacketNotifyë¥¼ í†µí•´ 
        FNetPacketNotify::FNotificationHeader Header;
        if (!PacketNotify.ReadHeader(Header, Reader))
        {
            return;
        }

        bool bHasPacketInfoPayload = true;
        if (PacketEngineNetVer >= FEngineNetworkCustomVersion::JitterInHeader)
        {
            bHasPacketInfoPayload = Reader.ReadBit() == 1u;
            if (bHasPacketInfoPayload)
            {
                uint32 PacketJitterClockTimeMS = 0;
                Reader.SerializeInt(PacketJitterClockTimeMS, UE::Net::Connection::Private::MaxJitterClockTimeValue + 1);       
            
                ProcessJitter();
            }
        }

        const int32 PacketSequenceDelta = PacketNotify.GetSequenceDelta(Header);
        if (PacketSequenceDelta > 0)
        {
            auto HandlePacketNotification = [&Header, &ChannelsToClose, this](FNetPacketNotify::SequenceNumberT AckedSequence, bool bDelivered)
            {
                ++LastNotifiedPacketId;

                if (FNetPacketNotify::SequenceNumberT(LastNotifiedPacketId) != AckedSequence)
                {
                    // ERROR!
                }

                if (bDelivered)
                {
                    ReceivedAck(LastNotifiedPacketId, ChannelsToClose);       
                }
                else
                {
                    ReceivedNak(LastNotifiedPacketId);
                }
            };

            const int32 UpdatedPacketSequenceDelta = PacketNotify.Update(Header, HandlePacketNotification);


            if (PacketNotify.IsWaitingForSequenceHistoryFlush())
            {
                ++HasDirtyAcks;
                InPacketId = OldInPacketId + UpdatedPacketSequenceDelta;

                return;
            }

            InPacketId += PacketSequenceDelta;
            check(FNetPacketNotify::SequenceNumberT(InPacketId).Get() == Header.Seq.Get());
        }

        if (PacketSequenceDelta > 0 && !ReadPacketInfo(Reader, bHasPacketInfoPayload, PacketEngineNetVer))
        {
            // ERROR!
            return;
        }
    }
```

* ê²°êµ­ ì´ë²ˆì¥ì˜ í•µì‹¬ì€ `FNetPacketNotify`

```cpp
class FNetPacketNotify
{
public:
    enum { SequenceNumberBits = 14 };
    enum { MaxSequenceHistoryLength = 256 };

    typedef TSequenceNumber<SequenceNumberBits, uint16> SequenceNumberT;
    typedef TSequenceHistory<MaxSequenceHistoryLength> SequenceHistoryT;

    //  ***FNetPacketNotify::FNotificationHeader                                                    
    //     â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                    
    //         â”‚                                                                                    
    //         â”œâ”€â”€AckedSeq: InAckSeq(client): 1023                                                  
    //         â”‚                                                                                    
    //         â””â”€â”€History:      â”Œâ”€â”€â”€bit-0 means latest bit-delivery(up-to-date)!                    
    //            â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â–¼â”€â” :1023 is the latest InAckSeq(client)                            
    //            â”‚ 1 â”‚ 1 â”‚ 0 â”‚ 1 â”‚    â”‚                                                            
    //            â””â”€â–²â”€â”´â”€â–²â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜    â””â”€InAckSeq(client) == OutSeq(server)                         
    //              â”‚   â”‚                : packet-id(1023) is sent by server and received by client 
    //              â”‚   â”‚                                                                           
    //              â”‚  ***1021 is acked successfully in client-side                                 
    //              â”‚                                                                               
    //        ***1020 is acked successfully in client-side                                          
    //                                                                                                                                                                                   
```

```cpp
    //     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                         
    //     â”‚ Client â”‚                            â”‚ Server â”‚                         
    //     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜                            â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                         
    //          â”‚         Seq:255                    â”‚   InSeq:254                  
    //          â”‚         AckedSeq:127               â”‚   OutSeq:128                 
    //          â”‚                                    â”‚   OutAckSeq:126              
    //          â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚      â”‚                       
    //          â”‚                                    â”‚      â–¼                       
    //          â”‚                                    â”‚   InSeq:255â—„â”€â”€â”€â”€â”€â”€â”          
    //          â”‚         Seq:256                    â”‚   OutSeq:128      â”‚updated!  
    //          â”‚         AckedSeq:127               â”‚   OutAckSeq:127â—„â”€â”€â”˜          
    //          â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚      â”‚                       
    //          â”‚                                    â”‚      â–¼                       
    //          â”‚                                    â”‚   InSeq:256                  
    //          â”‚                                    â”‚   OutSeq:128                 
    //          â”‚                                    â”‚   OutAckSeq:127**            
    //          â”‚                                    â”‚                              
    //                                                                              
    //                                                                              
    //                                                                              
    //                                                                              
    //                                                                              
    //   ***Packet-loss happens!                                                    
    //     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                         
    //     â”‚ Client â”‚                            â”‚ Server â”‚                         
    //     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜                            â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                         
    //          â”‚         Seq:255                    â”‚   InSeq:254                  
    //          â”‚         AckedSeq:127               â”‚   OutSeq:128                 
    //          â”‚                                    â”‚   OutAckSeq:126              
    //          â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€xâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚      â”‚                       
    //          â”‚            ***packet-loss!!        â”‚      â”‚                       
    //          â”‚                                    â”‚      â”‚                       
    //          â”‚         Seq:256                    â”‚      â”‚                       
    //          â”‚         AckedSeq:127               â”‚      â”‚                       
    //          â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚      â”‚                       
    //          â”‚                                    â”‚      â–¼                       
    //          â”‚                                    â”‚   InSeq:256â—„â”€â”€â”€â”€â”€â”€â”                  
    //          â”‚                                    â”‚   OutSeq:128      â”‚updated!           
    //          â”‚                                    â”‚   OutAckSeq:127â—„â”€â”€â”˜              
    //          â”‚                                    â”‚                              
    //                                                                                  
```

```cpp
void ReceivedAck(int32 AckPacketId, FChannelsToClose& OutChannelsToClose)
{
    OutAckPacketId = AckPacketId;

    auto AckChannelFunc = [this, &OutChannelsToClose](int32 AckedPacketId, uint32 ChannelIndex)
    {
        UChannel* const Channel = Channels[ChannelIndex];
        if (Channel)
        {
            // we can easily understand what this logic is for:
            //                                                                                                                        
            //                 AckedPacketId==246                           
            //                 OpenPacketId.Last==246                                                                             
            //                                                                                                                       
            //                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           
            // Channel->OutRec:â”‚   PacketId:244 â”œâ”€â”€â”€â”¼   PacketId:245 â”œâ”€â”€â”€â”¼   PacketId:246 â”‚                                           
            //                 â”‚ ReceiveAck:1   â”‚   â”‚ ReceiveAck:0   â”‚   â”‚ ReceiveAck:1   â”‚                                           
            //                 â”‚      bOpen:0   â”‚   â”‚      bOpen:1   â”‚   â”‚      bOpen:0   â”‚                                           
            //                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           
            //                                                   â”‚                                                                    
            //                  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                                           
            //                   iterating 'OutRec' and FOutBunchâ”‚:bOpen is true, marking bOpenAcked=FALSE                            
            //                                         â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                     
            //                                              â”‚    â”‚                                                                    
            //                                              â”‚    â”‚                                                                    
            //                                              â””â”€â”€â”€â”€â”˜                                                                    
            //                                                                                                                        
            for (FOutBunch* OutBunch = Channel->OutRec; OutBunch; OutBunch = OutBunch->Next)
            {
                if (OutBunch->bOpen)
                {
                    Channel->OpenAcked = 0;
                }

                if (OutBunch->PacketId == AckedPacketId)
                {
                    OutBunch->ReceiveAck = 1;
                }
            }

            //   - processing acks of OutBunch means that we delete OutBunches which arrived to client successfully!
            EChannelCloseReason CloseReason;
            if (Channel->ReceivedAcks(CloseReason))
            {
                const FChannelCloseInfo Info = {ChannelIndex, CloseReason};
                OutChannelsToClose.Emplace(Info);
            }
        }
    };

    FChannelRecordImpl::ConsumeChannelRecordsForPacket(ChannelRecord, AckPacketId, AckChannelFunc);
}
```

* 17ë¶€í„° ì§„í–‰í•˜ì‹œì˜¤