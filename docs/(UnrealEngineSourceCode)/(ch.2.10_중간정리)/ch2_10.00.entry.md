---
layout: default
title: "([Network] 10. ì¤‘ê°„ì •ë¦¬)"
parent: "(UE SourceCode ë¶„ì„ ğŸ¤–)"
has_children: true
nav_order: 4
---

* ì‹œì‘ì€ World::Tick

```cpp
// World.h

void Tick(ELevelTick TickType, float DeltaSeconds)
{
    FWorldDelegates::OnWorldTickStart.Broadcast(this, TickType, DeltaSeconds);

    {
        // update the net code and fetch all incoming packets
        BroadcastTickDispatch(DeltaSeconds);
        BroadcastPostTickDispatch();
    }
```

```cpp
FOnNetTickEvent& OnTickDispatch() { return TickDispatchEvent; }

void BroadcastTickDispatch(float DeltaTime)
{
    TickDispatchEvent.Broadcast(DeltaTime);
}
```

```cpp
// NetDriver.h
class UNetDriver : public UObject, public FExec
{
    // ...

    void RegisterTickEvents(class UWorld* InWorld)
        {
            if (InWorld)
            {
                
                TickDispatchDelegateHandle = InWorld->OnTickDispatch().AddUObject(this, &UNetDriver::InternalTickDispatch);

    // ...
}
```

```cpp
class UIpNetDriver : public UNetDriver
{
    // ...
    void InternalTickDispatch(float DeltaSeconds)
    {
        TickDispatch(DeltaSeconds);
    }
}
```

```cpp
class UIpNetDriver : public UNetDriver
{
    // ...
    FPacketIteartor& operator++()
    {
        IterationCount++;
        AdvanceCurrentPacket();
        return *this;
    }

class FPacketIterator
{
    // ...

    void AdvanceCurrentPacket()
    {
        if (!bBreak)
        {
            bBreak = !ReceiveSinglePacket();
        }
    }
```

```cpp
class FPacketIterator
{
    // ...

bool ReceiveSinglePacket()
{
    bool bReceivedPacketOrError = false;

    // íŒ¨í‚·ì„ CurrentPacketì— ë„£ì–´ë‘ê³  ì•„ë˜ì„œ ì‚¬ìš©í•˜ê²Œ ë¨ ì£¼ì˜!
    CurrentPacket.bRecvSuccess = false;
    CurrentPacket.Data.SetNumUninitialized(0, EAllowShrinking::No);
    CurrentPacket.Address->SetAnyAddress();
    CurrentPacket.Error = SE_NO_ERROR;

    while (true)
    {
        bReceivedPacketOrError = false;
        
        int32 BytesRead = 0;
        bool bReceivedPacket = Driver->GetSocket()->RecvFrom(CurrentPacket.Data.GetData(), MAX_PACKET_SIZE, BytesRead, *CurrentPacket.Address);
        CurrentPacket.bRecvSuccess = bReceivedPacket;
        bReceivedPacketOrError = bReceivedPacket;

        if (bReceivedPacket)
        {
            CurrentPacket.Data.SetNumUninitialized(BytesRead, EAllowShrinking::No);
        }

        break;
    }

    return bReceivedPacketOrError;
}

```

```cpp
class UIpNetDriver : public UNetDriver
{
    // ...

virtual void TickDispatch(float DeltaTime) override
{
    //...

    for (FPacketIterator It(this); It; ++It)
    {
        FReceivedPacketView ReceivedPacket;
        FInPacketTraits& ReceivedTraits = ReceivedPacket.Traits;
        bool bOk = It.GetCurrentPacket(ReceivedPacket);

        const TSharedRef<const FInternetAddr> FromAddr = ReceivedPacket.Address.ToSharedRef();

        UNetConnection* Connection = nullptr;
        UIpConnection* const MyServerConnection = GetServerConnection();


        if (MyServerConnection)
        {
            if (MyServerConnection->RemoteAddr->CompareEndpoints(*FromAddr))
            {
                Connection = MyServerConnection;
            }
        }

        if (Connection == nullptr)
        {
            auto* Result = MappedClientConnections.Find(FromAddr);
            if (Result)
            {
                UNetConnection* ConnVal = *Result;
                if (ConnVal)
                {
                    Connection = ConnVal;
                }
            }

            check(Connection == nullptr || CastChecked<UIpConnection>(Connection)->RemoteAddr->CompareEndpoints(*FromAddr));
        }

        if (bOk == false)
        {
            // ERROR
        }
        else
        {
            if (Connection == nullptr)
            {
                FPacketBufferView WorkingBuffer = It.GetWorkingBuffer();
                Connection = ProcessConnectionlessPacket(ReceivedPacket, WorkingBuffer);

                bIgnorePacket = ReceivedPacket.DataView.NumBytes() == 0;
            }

            if (Connection != nullptr && !bIgnorePacket)
            {
                Connection->ReceivedRawPacket((uint8*)ReceivedPacket.DataView.GetData(), ReceivedPacket.DataView.NumBytes());
            }
        }
    }
}
```

```cpp
class UNetConnection : public UPlayer
{
    // ...

virtual void ReceivedRawPacket(void* Data, int32 Count)
{
    uint8* Data = (uint8*)InData;

    if (Handler.IsValid())
    {
        FReceivedPacketView PacketView;
        PacketView.DataView = {Data, Count, ECountUnits::Bytes};

        // PacketHandler::Outgoing(StatelessConnectHandlerComponent::Outgoing)ì„ í˜¸ì¶œí•˜ì—¬ ì¶”ê°€ ë°ì´í„°ë¥¼ ì§ë ¬í™”í•œë‹¤ëŠ” ê²ƒì„ ê¸°ì–µí•˜ì‹œë‚˜ìš”?
        // - ì´í›„ì— íŒ¨í‚·ì„ ì˜¬ë°”ë¥´ê²Œ ì½ê¸° ìœ„í•´ì„œëŠ” ì´ ë°ì´í„° ë¹„íŠ¸ë“¤ì„ ì†Œë¹„í•´ì•¼ í•©ë‹ˆë‹¤:
        //   *** StatelessConnectHandlerComponent::Outgoingì„ ê°„ë‹¨íˆ ì°¸ê³ í•˜ì„¸ìš”
        //
        //          NewPacket                                     PacketHandlerì˜ ë°ì´í„°                                                                        
        //           â”‚                                              â”‚                                                                                         
        //           â”œâ”€MagicHeader(0)                               â”‚            send-buffer ë°ì´í„°                                                             
        //           â”‚                                              â”‚               â”‚                                                                         
        //           â”œâ”€SessionClientId(2)                      â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       
        //           â”‚                                 â”€â”€â”€â”€â”€â”€â–º â”‚    â–¼    â”‚          â–¼                 â”‚                                                       
        //           â”œâ”€ClientID(3)                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       
        //           â”‚                                         â–²   â–²     â–²                                                                                    
        //           â”œâ”€bHandshakePacket(1): false              â”‚   â”‚     â”‚                                                                                    
        //           â”‚                                        (1) (2)   (...)                                                                                 
        //           â””â”€send-buffer ë°ì´í„°                                                                                                                       
        //             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                                                                                    
        //              ***                                      *** bunch ë°ì´í„°ë¥¼ ì½ê¸° ì „ì— ë¹„íŠ¸ë“¤ì„ ì§ë ¬í™”(ì½ê¸°)í•˜ì—¬ ì»¤ì„œë¥¼ ì ì ˆíˆ ì´ë™ì‹œì¼œì•¼ í•©ë‹ˆë‹¤!                                                                                                                                                                                                                                          
        // ì•„ë˜ ì°¸ê³ ,
        EIncomingResult IncomingResult = Handler->Incoming(PacketView);

        if (IncomingResult == EIncomingResult::Success)
        {
            Count = PacketView.DataView.NumBytes();
            if (Count > 0)
            {
                Data = PacketView.DataView.GetMutableData();
            }
            else
            {

                return;
            }
        }
    }

    
    if (Count > 0)
    {
        uint8 LastByte = Data[Count-1];
        if (LastByte != 0)
        {
            int32 BitSize = (Count * 8) - 1;

            // bit streaming, starts at the LSB(Least Significant Bit), and ends at the MSB
            while (!(LastByte & 0x80))
            {
                LastByte *= 2;
                BitSize--;
            }

            
            FBitReader Reader(Data, BitSize);

            // set the network version on the reader
            SetNetVersionsOnArchive(Reader);

            if (Reader.GetBitsLeft() > 0)
            {
                ReceivedPacket(Reader);
            }
        }
    }
}
```

```cpp
class PacketHandler
{
    // ...

    EIncomingResult Incoming(FReceivedPacketView& PacketView)
    {
        return Incoming_Internal(PacketView);
    }
```

```cpp
/**
 * ìˆ˜ì‹ ëœ íŒ¨í‚·ì˜ ë·°ë¥¼ ë‚˜íƒ€ë‚´ë©°, íŒ¨í‚·ì´ ì²˜ë¦¬ë˜ë©´ì„œ ê°€ë¦¬í‚¤ëŠ” ë°ì´í„°ì™€ ë°ì´í„° í¬ê¸°ë¥¼ ì—…ë°ì´íŠ¸í•˜ë„ë¡ ìˆ˜ì •ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 * ìˆ˜ì‹ ëœ íŒ¨í‚·ì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ ë‚´ì—ì„œë§Œ ë¡œì»¬ ë³€ìˆ˜ë¡œ ì €ì¥ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
 */

// ArrayViewì™€ ê°™ì´, FPacketIteratorì— ìˆëŠ” FCachedPacketì„ ìœ„í•œ ë·° ê°ì²´ì…ë‹ˆë‹¤
// - ì‹¤ì œ ë°ì´í„°ëŠ” (FPacketIterator::CurrentPacket: FCachedPacket)ì— ìˆìŠµë‹ˆë‹¤
// - ì´ê²ƒì€ ë‹¨ìˆœí•œ ë·° ê°ì²´ì…ë‹ˆë‹¤
// - ë©¤ë²„ ë³€ìˆ˜ë“¤ì„ ê°„ë‹¨íˆ ì‚´í´ë³´ì„¸ìš”
struct FReceivedPacketView
{
    /** íŒ¨í‚· ë°ì´í„°ì˜ ë·° - ë‹¤ë¥¸ ê³³ì„ ê°€ë¦¬í‚¤ë„ë¡ ì¬í• ë‹¹í•  ìˆ˜ ìˆì§€ë§Œ, íŒ¨í‚· ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ëŠ” ë°ëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš” */
    FPacketDataView DataView = {nullptr, 0, ECountUnits::Bits};

    /** íŒ¨í‚·ì˜ ìˆ˜ì‹  ì£¼ì†Œ */
    TSharedPtr<const FInternetAddr> Address;

    /** íŒ¨í‚· ìˆ˜ì‹  ì‹¤íŒ¨ ì‹œì˜ ì—ëŸ¬ */
    ESocketErrors Error;

    /** ìˆ˜ì‹ ëœ íŒ¨í‚·ì˜ ë©”íƒ€ë°ì´í„°ì™€ í”Œë˜ê·¸ë¡œ, íŒ¨í‚·ì´ í¬í•¨í•˜ëŠ” ë‚´ìš©ê³¼ ì²˜ë¦¬ ë°©ë²•ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤ */
    FInPacketTraits Traits;
};
```

* Unrealì—ì„œ ë§í•˜ëŠ” Connectionless Packet
    * ì—°ê²° ìƒíƒœì™€ ë¬´ê´€í•œ íŒ¨í‚·
        * ê¸°ì¡´ì˜ established connection ì—†ì´ë„ ì „ì†¡/ìˆ˜ì‹ ì´ ê°€ëŠ¥í•œ íŒ¨í‚·ì„ ì˜ë¯¸í•©ë‹ˆë‹¤
        * ì£¼ë¡œ **ì´ˆê¸° ì—°ê²° ìˆ˜ë¦½(handshake) ê³¼ì •**ì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤

```cpp
EIncomingResult Incoming_Internal(FReceivedPacketView& PacketView)
{
    EIncomingResult ReturnVal = EIncomingResult::Success;
    FPacketDataView& DataView = PacketView.DataView;
    int32 CountBits = DataView.NumBits();

    if (HandlerComponents.Num() > 0)
    {
        const uint8* DataPtr = DataView.GetData();
        uint8 LastByte = (UNLIKELY(DataPtr == nullptr)) ? 0 : DataPtr[DataView.NumBytes()-1];
        if (LastByte != 0)
        {
            // haker: what is the meaning of 0x80?
            // - we already seen '0x80' in GShift
            // - 0x80 == 10000000(2) == 128(2^7)
            // - 'while(!(LastByte & 0x80))' means that we iterates bits until we reach valid 7-th bit value
            // - we substract early for 0x80 case
            // - '*= 2' is same as '<<= 1'
            CountBits--;
            while (!(LastByte & 0x80))
            {
                LastByte *= 2;
                CountBits--;
            }
        }
        else
        {
            PacketView.DataView = {nullptr, 0, ECountUnits::Bits};
            ReturnVal = EIncomingResult::Error;
        }
    }

    if (ReturnVal == EIncomingResult::Success)
    {
        FBitReader ProcessedPacketReader(DataView.GetMutableData(), CountBits);
        FIncomingPacketRef PacketRef = {ProcessedPacketReader, PacketView.Address, PacketView.Traits};

        for (int32 i = HandlerComponents.Num() - 1; i >= 0; --i)
        {
            HandlerComponent& CurComponent = *HandlerComponents[i];
            if (CurComponent.IsActive() && !ProcessedPacketReader.IsError() && ProcessedPacketReader.GetBitsLeft() > 0)
            {
                if (PacketView.Traits.bConnectionlessPacket)
                {
                    CurComponent.IncomingConnectionless(PacketRef);
                }
                else
                {
                    CurComponent.Incoming(PacketRef);
                }
            }
        }

    
        if (!ProcessedPacketReader.IsError())
        {
            ReplaceIncomingPacket(ProcessedPacketReader);
            
            PacketView.DataView = {IncomingPacket.GetData(), (int32)IncomingPacket.GetBitsLeft(), ECountBits::Bits};
        }
    }

    return ReturnVal;
}
```

```plantuml

skinparam DefaultFontName "Malgun Gothic"

participant UWorld
participant UIpNetDriver
participant FPacketIterator

UWorld -> UIpNetDriver: BroadcastTickDispatch()
activate UIpNetDriver

UIpNetDriver -> UIpNetDriver: OnTickDispatch()
activate UIpNetDriver #DarkSalmon

UIpNetDriver -> UIpNetDriver: InternalTickDispatch()
activate UIpNetDriver #LightBlue

UIpNetDriver -> UIpNetDriver: TickDispatch()
activate UIpNetDriver #LightGreen

create FPacketIterator
UIpNetDriver -> FPacketIterator: <<create>>

loop For Each Packet
    UIpNetDriver -> UIpNetDriver: ReceivedRawPacket()
end

deactivate UIpNetDriver
deactivate UIpNetDriver
deactivate UIpNetDriver
deactivate UIpNetDriver

legend right
  ==ì•„ì§ ì •ë¦¬ë˜ì§€ ì•Šì€ ë¶€ë¶„==
  ë‚˜ë¨¸ì§€ íŒ¨í‚· ì²˜ë¦¬ ë¡œì§ì€ ì¶”ê°€ ì •ë¦¬ í•„ìš”
  5 ë¶€í„° í•˜ë©´ ë©ë‹ˆë‹¤.
end legend

```