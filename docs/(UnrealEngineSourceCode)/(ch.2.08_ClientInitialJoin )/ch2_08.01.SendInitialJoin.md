---
layout: default
title: "08-01. SendInitialJoin"
parent: "([Network] 08. ClientInitialJoin)"
grand_parent: "(UE SourceCode λ¶„μ„ π¤–)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

```cpp
class UPendingNetGame : public UObject, FNetworkNotify
{
  // ...
  
void SendInitialJoin()
{
    if (NetDriver != nullptr)
    {
        // don't forget that we are dealing this code in the client-side
        // μ΄ μ½”λ“λ” ν΄λΌμ΄μ–ΈνΈ μΈ΅μ—μ„ μ²λ¦¬λκ³  μλ‹¤λ” κ²ƒμ„ μμ§€ λ§μ
        UNetConnection* ServerConn = NetDriver->ServerConnection;
        if (ServerConn)
        {
            // 'IsLittleEndian' == true
            // 'IsLittleEndian'μ€ trueμ„
            uint8 IsLittleEndian = uint8(PLATFORM_LITTLE_ENDIAN);

            // 'AllowEncryption' == true
            // - 'EncryptionToken' is the empty token("")
            
            // 'AllowEncryption'μ€ trueμ„
            // - 'EncryptionToken'μ€ λΉ ν† ν°("")μ„
            const int32 AllowEncryption = CVarNetAllowEncryption.GetValueOnGameThread();
            FString EncryptionToken;
            if (AllowEncryption)
            {
                EncryptionToken = URL.GetOption(TEXT("EncryptionToken="), TEXT(""));
            }

            uint32 LocalNetworkVersion = FNetworkVersion::GetLocalNetworkVersion();
            EEngineNetworkRuntimeFeatures LocalNetworkFeatures = NetDriver->GetNetworkRuntimeFeatures();

            // now we start sending data using channel, ControlChannel!
            // - as we saw, we are trying to send 'NMT_Hello' message through ControlChannel to the server

            // μ΄μ  ControlChannelμ„ μ‚¬μ©ν•μ—¬ λ°μ΄ν„° μ „μ†΅μ„ μ‹μ‘ν•©λ‹λ‹¤!
            // - λ³΄μ‹λ‹¤μ‹ν”Ό ControlChannelμ„ ν†µν•΄ μ„λ²„λ΅ 'NMT_Hello' λ©”μ‹μ§€λ¥Ό μ „μ†΅ν•λ ¤κ³  ν•©λ‹λ‹¤
            FNetControlMessage<NMT_Hello>::Send(ServerConn, IsLittleEndian, LocalNetworkVersion, EncryptionToken, LocalNetworkFeatures);
        
            ServerConn->FlushNet();
        }
    }
}
```

## StatelessConnectHandlerComponentμ μ΄ν•΄κ°€ μ΅°κΈ ν•„μ”ν•λ‹¤

* StatelessConnectHandlerComponentμ λ©μ 
  * UDP μ—°κ²°μ€ UDP ν¨ν‚·μ IP μ£Όμ†λ¥Ό μ¤ν‘Έν•‘ν•λ” λ“± λ‹¤μ–‘ν• DDoS κ³µκ²©μ— μ·¨μ•½ν•©λ‹λ‹¤
  * "ν•Έλ“μ…°μ΄ν¬"λ” ν΄λΌμ΄μ–ΈνΈ IPλ¥Ό κ²€μ¦ν•μ—¬ DDoS κ³µκ²©μΌλ΅λ¶€ν„° λ³΄νΈν•κΈ° μ„ν•΄ ν•„μ”ν•©λ‹λ‹¤ (Challenge ν¨ν‚·!!)
  * "ν•Έλ“μ…°μ΄ν¬"μ—λ” λ‘ κ°€μ§€ μ ν•μ΄ μμµλ‹λ‹¤:
    * Stateful:
      * ν•Έλ“μ…°μ΄ν¬ μ§„ν–‰ μ¤‘μ— μ—°κ²°(NetConnection)μ΄ μ„λ²„μ λ©”λ¨λ¦¬μ— μ μ§€λ©λ‹λ‹¤
    * Stateless:
      * ν•Έλ“μ…°μ΄ν¬ μ§„ν–‰ μ¤‘μ— μ—°κ²°(NetConnection)μ΄ μ„λ²„μ λ©”λ¨λ¦¬μ— μ μ§€λμ§€ μ•μµλ‹λ‹¤
  * λ¨λ“  ν•Έλ“μ…°μ΄ν¬ μƒνƒλ” ν•Έλ“μ…°μ΄ν¬ ν¨ν‚·μ— μ €μ¥λ©λ‹λ‹¤:
    * FParsedHandshakeData
  * StatelessConnectHandlerComponent(ν•Έλ“μ…°μ΄ν¬)λ” "Stateless" λ°©μ‹μΌλ΅ μν–‰λ©λ‹λ‹¤:
    * μ„λ²„ λ©”λ¨λ¦¬μ— λ€ν• DDoS κ³µκ²©μ— λ§¤μ° κ°•λ ¥ν•©λ‹λ‹¤
    * μ: λ§μ€ μ—°κ²° μ”μ²­μ΄ 'μ„λ²„ λ©”λ¨λ¦¬ λ¶€μ΅±'μ„ μ λ° = μ μ•λ ¤μ§„ DDoS κ³µκ²©!
  * 'Stateless'λ” 'Stateful'μ— λΉ„ν•΄ ν• κ°€μ§€ ν° λ‹¨μ μ΄ μμµλ‹λ‹¤:

```
                                                      UDP ν¨ν‚· μ†μ‹¤!                                                      
                                                             β”‚                                                              
     ***Stateless μ—°κ²°:                                      β”‚                                                              
                                                             β”‚                                                              
                                                             β”‚                                                              
     β”β”€β–Ί1.μ΄κΈ°ν¨ν‚·          β”€β”€β”€β”€β”€β”€β–Ί 2.μ—°κ²°λ„μ „μ „μ†΅ β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”Όβ”€β”€β–Ί 3.λ„μ „μ‘λ‹µμ „μ†΅ β”€β”€β”€β”€β”€β”€β–Ί 4.λ„μ „μΉμΈμ „μ†΅        
     β”‚    [ν΄λΌμ΄μ–ΈνΈβ”€β–Ίμ„λ²„]         [μ„λ²„β”€β–Ίν΄λΌμ΄μ–ΈνΈ]      β”‚    [ν΄λΌμ΄μ–ΈνΈβ”€β–Ίμ„λ²„]      [μ„λ²„β”€β–Ίν΄λΌμ΄μ–ΈνΈ]        
     β”‚                                                       β”‚                                                              
     β”‚                                                       β”‚                                                              
     β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤                                                              
            μ—°κ²°μ΄ κ°€μ¥ μ²μλ¶€ν„° λ‹¤μ‹ μ‹λ„λ©λ‹λ‹¤!            β”‚                                                              
            β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€                                                                     
              *** ν¨ν‚·μ— μ—°κ²° μƒνƒκ°€ ν¬ν•¨λμ–΄ μμ–΄μ„ ν¨ν‚· μ†μ‹¤μ΄ λ°μƒν•λ©΄ λ³µκµ¬ν•  λ°©λ²•μ΄ μ—†μµλ‹λ‹¤                     
                             β”‚                                                                                              
                             β”‚                                                                                              
                             β”‚                                                                                              
                             β–Ό                                                                                              
                    μ΄λ” μ„±κ³µμ μΈ μ—°κ²°μ„ μ„ν•΄μ„λ” μ—°μ†λ λ„¤ κ°μ ν¨ν‚·μ΄ λ¨λ‘ μ•μ „ν•κ² μ „μ†΅/μμ‹ λμ–΄μ•Ό ν•¨μ„ μλ―Έν•©λ‹λ‹¤!  
```

* μ”μ•½ν•λ©΄, StatelessConnectHandlerComponentλ” μƒνƒκ°€ ν¨ν‚·μ— μ €μ¥λλ” ν•Έλ“μ…°μ΄ν¬μ…λ‹λ‹¤
* HandshakeSecret/Cookie:
  * ν•Έλ“μ…°μ΄ν¬μ μ‹¤μ  UE κµ¬ν„μ„ λ³΄λ©΄μ„, μ„λ²„κ°€ μ ν¨ν• μΏ ν‚¤λ¥Ό μƒμ„±ν•κ³  μΈμ‹ν•  μ μλ‹¤λ” κ²ƒμ„ μ΄ν•΄ν–μµλ‹λ‹¤
  * μ„λ²„λ” ν΄λΌμ΄μ–ΈνΈκ°€ λ³΄λ‚Έ μΏ ν‚¤λ¥Ό κ²€μ¦ν•κΈ° μ„ν•΄ μΏ ν‚¤λ¥Ό μ¬μƒμ„±ν•  μ μμµλ‹λ‹¤
  * μ„λ²„λ” ν΄λΌμ΄μ–ΈνΈκ°€ λ³΄λ‚Έ μΏ ν‚¤κ°€ μ ν¨ν•μ§€ ν™•μΈν•κΈ° μ„ν•΄ μΏ ν‚¤λ¥Ό μ¬μƒμ„±ν•κ³  λΉ„κµν•©λ‹λ‹¤
  * μ¬μƒμ„±ν•λ” λ™μ• μ—°κ²°μ„ μ„ν• μ¶”κ°€ μƒνƒκ°€ ν•„μ”ν•μ§€ μ•μµλ‹λ‹¤!
  * Cookie = SHA1(HandshakeSecret, Timestamp + Client IP + Client Port)
  * μ¬μ „μ†΅ κ³µκ²©μ„ λ°©μ§€ν•κΈ° μ„ν•΄ ν•Έλ“μ…°μ΄ν¬ νƒ€μ„μ¤νƒ¬ν”„λ¥Ό μ‚¬μ©ν•μ—¬ μΏ ν‚¤λ¥Ό λ¬΄ν¨ν™”ν•©λ‹λ‹¤(MAX_COOKIE_LIFETIME)
  * 'μ¬μ „μ†΅ κ³µκ²©'μ€ μ΄μ „ ν¨ν‚·μ„ μ¬μ „μ†΅ν•λ” κ³µκ²©μ…λ‹λ‹¤
* IP/Port μ „ν™:
  * μ¬μ‹μ‘ ν•Έλ“μ…°μ΄ν¬κ°€ ν•„μ”ν• μ΄μ λ¥Ό μ„¤λ…ν•κΈ° μ„ν•΄ μ΄λ―Έ λ‹¤λ£¨μ—μµλ‹λ‹¤
  * μΌλ¶€ λΌμ°ν„°λ” ν¬νΈλ¥Ό λ³€κ²½ν•λ” λ²„κ·Έκ°€ μμ„ μ μμµλ‹λ‹¤(?!)
  * μ΄ κ²½μ° μ„λ²„λ” DDoS κ³µκ²©μΌλ΅ μ¤ν•΄ν•  μ μμµλ‹λ‹¤(μ• μ μ—†λ” μ†μ¤μ ν¨ν‚·!)
  * 'ClientID'λ” μƒλ΅ μ—°κ²°λ IP/Port μ΅°ν•©μΌλ΅ μ—°κ²°μ„ μ‹λ³„ν•λ” λ° λ„μ›€μ΄ λ©λ‹λ‹¤
  * ν•μ§€λ§ μ—°κ²°μ„ λ‹¤μ‹ ν™•μΈν•΄μ•Ό ν•λ―€λ΅ μ„λ²„μ— μν•΄ νΈλ¦¬κ±°λ 'μ¬μ‹μ‘ ν•Έλ“μ…°μ΄ν¬'κ°€ λ°μƒν•©λ‹λ‹¤
* SessionID/ClientIDμ™€ λΉ„μ„μ‹(non-ephemeral) μ†μΌ“
  * ClientIDκ°€ ν•„μ”ν• μ΄μ λ¥Ό μ„¤λ…ν•λ” κ·Έλ¦Όμ„ κΈ°μ–µν•μ‹λ‚μ”?