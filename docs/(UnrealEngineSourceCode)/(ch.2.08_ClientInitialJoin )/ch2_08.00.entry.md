---
layout: default
title: "([Network] 08. ClientInitialJoin)"
parent: "(UE SourceCode ë¶„ì„ ğŸ¤–)"
has_children: true
nav_order: 3
---

## ClientInitialJoinëŠ” ë­˜ í•˜ë ¤ëŠ” ê±¸ê¹Œ?

* í•¸ë“œì‰ì´í¬ ì´í›„ ì‹œì‘ì„ í•˜ë ¤í•˜ëŠ” í•¨ìˆ˜ì´ë‹¤.

```
í•¸ë“œì‰ì´í¬ ì‹œì‘ -> í•¸ë“œì‰ì´í¬ ì™„ë£Œ -> SendInitialJoin() -> NMT_Hello ì „ì†¡
```

* ì–´ë–»ê²Œ ì‹œì‘ì´ ë˜ëŠ”ì§€ ì‚´í´ë³´ì.

---

```cpp
class UPendingNetGame : public UObject, FNetworkNotify
{
    // ...
void BeginHandshake()
{
    // ...

    UNetConnection* ServerConn = NetDriver->ServerConnection;
    if (ServerConn->Handler.IsValid())
    {
        // ê²°êµ­ ì‹œì‘ì€ ì—¬ê¸°ì„œ, 
        ServerConn->Handler->BeginHandshaking(
            FPacketHandlerHandshakeComplete::CreateUObject(this, &UPendingNetGame::SendInitialJoin)
        );
    }
}
```

```cpp
class PacketHandler
{
    // ...

    // BeginHandshakingì˜ ì—­í• .
    void BeginHandshaking(FPacketHandlerHandshakeComplete InHandshakeDel=FPacketHandlerHandshakeComplete())
    {
        /*
        1. HandshakeCompleteDel ë¸ë¦¬ê²Œì´í„° ë“±ë¡
        2. HandlerComponents ìˆœíšŒ í•˜ë©° HandshadkeBegin ì•Œë¦¼
        */
        bBeganHandshaking = true; 
        HandshakeCompleteDel = InHandshakeDel;

        for (int32 i = HanderComponents.Num() - 1; i >= 0; --i)
        {
            HandleComponent& CurComponent = *HandlerComponents[i];
            if (CurComponent.RequiresHandshake() && !CurComponent.IsInitialized())
            {
                CurComponent.NotifyHandshakeBegin();
                break;
            }
        }
    }
}
```

```cpp
class StatelessConnectHandlerComponent : public HandlerComponent
{
    // ...

virtual void Incoming(FBitReader& Packet) override
{
    // ...

    /*
    1. ì¼ë‹¨ ì´ëŸ° ì½”ë“œê°€ ìˆë‹¤ ì •ë„ ì•Œê³ , ì¤‘ìš”í•œê±´ Incomingìœ¼ë¡œ HandShakeê°€ì˜¤ë©´ Initializedê°€ í˜¸ì¶œë¨ ì´ë‹¤.
    */

    bool bHandshakePacket = !!Packet.ReadBit() && !Packet.IsError();
    if (bHandshakePacket)
    {
        FParsedHandshakeData HandshakeData;
        bHandshakePacket = ParseHandshakePacket(Packet, HandshakeData);
        if (bHandshakePacket)
        {
            const bool bIsChallengePacket = HandshakePacketType == EHandshakePacketType::Challenge && HandshakeData.Timestamp > 0.0;
            const bool bIsInitialChallengePacket = bIsChallengePacket && State != UE::Handler::Component::State::Initialized;

            if (Handler->Mode == UE::Handler::Mode::Client && bHasValidClientID && (bHasValidSessionID || bIsInitialChallengePacket))
            {
                if (State == UE::Handler::State::UnInitialized || State == UE::Handler::Component::State::InitializedOnLocal)
                {
                    if (bIsChallengePacket)
                    {
                        // ...
                    }
                    
                    else if (HandshakeData.HandshakePacketType == EHandshakePacketType::Ack && HandshakeData.Timestamp < 0.0)
                    {
                        if (!bRestartedHandshake)
                        {
                            UNetConnection* ServerConn = (Driver != nullptr ? ToRawPtr(Driver->ServerConnection) : nullptr);

                            if (ensure(ServerConn != nullptr))
                            {
                                int16* CurSequence = (int16*)HandshakeData.Cookie;
                                int32 ServerSequence = *CurSequence & (MAX_PACKETID - 1);
                                int32 ClientSequence = *(CurSequence + 1) & (MAX_PACKETID - 1);
                                ServerConn->InitSequence(ServerSequence, ClientSequence);
                            }

                            FMemory::Memcpy(AuthorisedCookie, HandshakeData.Cookie, UE_ARRAY_COUNT(AuthorisedCookie));
                        }

                        SetState(UE::Handler::Component::State::Initialized)
                        // ì—¬ê¸°ë¡œ ë“¤ì–´ê°„ë‹¤
                        Initialized();

                        bRestartedHandshake = false;
                    }
                }
            }
        }
    }
}
```

```cpp
class HandlerComponent
{   
    friend class PacketHandler;
public:
    HandlerComponent(FName InName)
        : Name(InName)
    {}


    void Initialized()
    {
        bInitialized = true;

        Handler->HandlerComponentInitialized(this);
    }
```


```cpp
class PacketHandler
{
    // ...

    void HandlerComponentInitialized(HandlerComponent* InComponent)
    {
        if (State != UE::Handler::State::Initialized)
        {
            bool bAllInitialized = true;
            bool bEncounteredComponent = false;
            for (int32 i = HandlerComponents.Num() - 1; i >= 0; --i)
            {
                // Componentì˜ ì´ˆê¸°í™” ì—¬ë¶€ í™•ì¸
                HandlerComponent& CurComponent = *HandlerComponents[i];
                if (!CurComponent.IsInitialized())
                {
                    bAllInitialized = false;
                }
                if (bEncounteredComponent)
                {
                    //...
                }
                else
                {
                    bEncounteredComponent = &CurComponent == InComponent;
                }
            }

            // ëª¨ë“  í•¸ë“¤ëŸ¬ê°€ ì´ˆê¸°í™”ë˜ì—ˆë‹¤ë©´, HandlerInitialized í˜¸ì¶œ
            if (bAllInitialized)
            {
                HandlerInitialized();
            } 
        }
    }

void HandlerInitialized()
{
    // ...

    SetState(UE::Handler::State::Initialized);

    if (bBeganHandshaking)
    {
        // í•¸ë“œì‰ì´í¬ ì™„ë£Œ ë¸ë¦¬ê²Œì´í„° ì‹¤í–‰
        HandshakeCompleteDel.ExecuteIfBound();
    }
}
```

```cpp
class UPendingNetGame : public UObject, FNetworkNotify
{
    // ...

// HandshakeCompleteDelê°€ í˜¸ì¶œë˜ë©´ ì—¬ê¸°ë¡œ ë“¤ì–´ì˜¤ê²Œ ëœë‹¤.
void SendInitialJoin()
{
    if (NetDriver != nullptr)
    {
        // don't forget that we are dealing this code in the client-side
        // ì´ ì½”ë“œëŠ” í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì‹¤í–‰ëœë‹¤ëŠ” ê²ƒì„ ìŠì§€ ë§ˆì„¸ìš”
        UNetConnection* ServerConn = NetDriver->ServerConnection;
        if (ServerConn)
        {
            // 'IsLittleEndian' == true
            // 'IsLittleEndian'ì€ trueì…ë‹ˆë‹¤
            uint8 IsLittleEndian = uint8(PLATFORM_LITTLE_ENDIAN);

            const int32 AllowEncryption = CVarNetAllowEncryption.GetValueOnGameThread();
            FString EncryptionToken;
            if (AllowEncryption)
            {
                EncryptionToken = URL.GetOption(TEXT("EncryptionToken="), TEXT(""));
            }

            uint32 LocalNetworkVersion = FNetworkVersion::GetLocalNetworkVersion();
            EEngineNetworkRuntimeFeatures LocalNetworkFeatures = NetDriver->GetNetworkRuntimeFeatures();

            FNetControlMessage<NMT_Hello>::Send(ServerConn, IsLittleEndian, LocalNetworkVersion, EncryptionToken, LocalNetworkFeatures);
        
            ServerConn->FlushNet();
        }
    }
}
```

* ì‚¬ì‹¤ìƒ `UPendingNetGame::SendInitialJoin`ë¶€í„° ì‹œì‘ì´ë¼ ë´ë„ ì¢‹ë‹¤.