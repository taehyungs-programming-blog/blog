---
layout: default
title: "02. DetachFromComponent"
parent: "(06.USceneComponent::OnRegister ë¶„ì„)"
grand_parent: "(UE SourceCode ë¶„ì„ ðŸ¤–)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## UnWeldFromParent

```cpp
virtual void UnWeldFromParent()
{
    // Diagram:
    //                                                                                                                                                              
    //                     OnRegister():ExecuteRegisterEvents()                                 â”Œâ”€â”€Game-Worldâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        
    //                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚                                  â”‚                        
    //          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  Game Thread               â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                        
    //                     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”Œâ”€â”€â”€â”¼â”€â”¤Component0â”‚      â”‚Component1â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         
    //                         â”‚      â”‚                                                     â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚              â”‚         
    //                         â”‚      â”‚                                                     â”‚   â”‚                                  â”‚              â”‚         
    //                         â”‚      â”‚                                                     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚         
    //  CreateRenderState_Concurrent()â”‚                                                     â”‚                                                     â”‚         
    //                         â”‚      â”‚                                               Syncedâ”‚   â”Œâ”€â”€Render-Worldâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚Synced   
    //                         â”‚      â”‚                                                     â”‚   â”‚                                           â”‚     â”‚         
    //                         â”‚      â”‚                                                     â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚     â”‚         
    //                        â”Œâ–¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”                                              â”œâ”€â”€â”€â”¼â”€â–ºPrimitiveSceneInfo0â”‚                     â”‚     â”‚         
    //          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  Render Thread         â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚     â”‚         
    //                        â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜                                              â”‚   â”‚                                           â”‚     â”‚         
    //                                â”‚                                                     â”‚   â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚         
    //                                â”‚                                                     â”‚   â”‚                     â”‚PrimitiveSceneInfo1â—„â”€â”¼â”€â”€â”€â”€â”€â”¤         
    //                                â”‚                                                     â”‚   â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚         
    //                           CreatePhysicsState()                                       â”‚   â”‚                                           â”‚     â”‚         
    //                                â”‚                                                     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚         
    //                                â”‚                                                     â”‚                                                     â”‚         
    //                                â”‚                                                     â”‚   â”Œâ”€â”€Physics-Worldâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚         
    //                          â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                                              â”‚   â”‚                                           â”‚     â”‚         
    //          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  Physics Thread        â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚     â”‚         
    //                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â””â”€â”€â”€â”¼â”€â–ºBodyInstance0â”‚        â”‚BodyInstance1â—„â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜         
    //                                                                                          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚               
    //                                                                                          â”‚                                           â”‚               
    //                                                                                          â”‚                                           â”‚               
    //                                                                                          â”‚                                           â”‚               
    //                                                                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               
    //                                                                                                                                            

    FBodyInstance* NewRootBI = GetBodyInstance(NAME_None, false);
    UWorld* CurrentWorld = GetWorld();
    if (NewRootBI == NULL 
        || NewRootBI->WeldParent == nullptr 
        || CurrentWorld == nullptr 
        || CurrentWorld->GetPhysicsScene() == nullptr 
        || !IsValidChecked(this) 
        || IsUnreachable())
    {
        return;
    }

    FName SocketName;
    UPrimitiveComponent* RootComponent = GetRootWelded(this, GetAttachSocketName(), &SocketName);
    if (RootComponent)
    {
        if (FBodyInstance* RootBI = RootComponent->GetBodyInstance(SocketName, false))
        {
            bool bRootIsBeingDeleted = !IsValidChecked(RootComponent) || RootComponent->IsUnreachable();
            const FBodyInstance* PrevWeldParent = NewRootBI->WeldParent;
                                                                                                          
            //      Component0:BodyInstance0                                                                Component0:BodyInstance0                                                                           
            //      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                      
            //      â”‚           â”‚                                                                           â”‚           â”‚                                                                                      
            //      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¤                                                                           â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¤                                                                                      
            //              â”‚   â”‚    Component2:WeldParent=BodyInstance0                                            â”‚   â”‚    Component2:WeldParent=BodyInstance0                                               
            //              â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                         â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                            
            //              â”‚   â”‚         â”‚                                                                         â”‚   â”‚         â”‚                                                                            
            //              â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  1.Unweld(Component1)                   â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                            
            //              â”‚   â”‚                                              : Just UnWeld(Component1)            â”‚   â”‚                                                                                      
            //              â””â”€â”€â”€â”˜                                            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º           â””â”€â”€â”€â”˜                                                                                      
            //               Component1:WeldParent=BodyInstance0                                                     Component1:WeldParent=nullptr                                                             
            //                                                                                                                                                                                                 
            //                                                                                                                                                                                                 
            //                                                                                                                                                                                                 
            //             Component0:AttachChildren[Component1]                                                   Component0:AttachChildren[Component1]                                                       
            //                 â–²      WeldChildren[Component1,Component2]                                              â–²      WeldChildren[Component2]â—„â”€â”€â”€â”€â”€â”€â”€***Still Component2 is left                      
            //                 â”‚                                                                                       â”‚                                         as welded to Component0                       
            //             Component1:AttachChildren[Component2]                                                   Component1:AttachChildren[Component2]                                                       
            //                 â–²                                                                                       â–²      WeldChildren[]                                                                   
            //                 â”‚                                                                                       â”‚                                                                                       
            //             Component2                                                                              Component2:                                                                                 
            //                                                                                                                                                                                                 
            //                                                                                                                                                                                                 
            //                                                                                                           â”‚                                                                                     
            //                                                                                                           â”‚                                                                                     
            //                                                                                                           â”‚ 2.Iterating Component1's AttachChildren:                                            
            //                                                                                                           â”‚    â”‚                                                                                
            //                                                                                                           â”‚    â””â”€ Unweld(Component0)                                                            
            //                                                                                                           â”‚                                                                                     
            //                                                                                                           â”‚                                                                                     
            //                                                                                                           â”‚                                                                                     
            //                                                                                                           â–¼                                                                                     
            //                                                                                                                                                                                                 
            //                                                                                                                                                                                                 
            //    Component0:BodyInstance0                                                                  Component0:BodyInstance0                                                                           
            //    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                      
            //    â”‚           â”‚                                                                             â”‚           â”‚                                                                                      
            //    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¤                                                                             â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¤                                                                                      
            //            â”‚   â”‚    Component2:WeldParent=BodyInstance1                                              â”‚   â”‚    Component2:WeldParent=nullptr                                                     
            //            â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  3.ApplyWeldOnChildren()                  â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                            
            //            â”‚   â”‚         â”‚                                  :weld Component1's AttachChildren        â”‚   â”‚         â”‚                                                                            
            //            â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                           â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                            
            //            â”‚   â”‚                                             â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚   â”‚                                                                                      
            //            â””â”€â”€â”€â”˜                                                                                     â””â”€â”€â”€â”˜                                                                                      
            //             Component1:WeldParent=nullptr                                                             Component1:WeldParent=nullptr                                                             
            //                                                                                                                                                                                                 
            //                                                                                                                                                                                                 
            //                                                                                                                                                                                                 
            //           Component0:AttachChildren[Component1]                                                     Component0:AttachChildren[Component1]                                                       
            //               â–²      WeldChildren[]                                                                     â–²      WeldChildren[]                                                                   
            //               â”‚                                                                                         â”‚                                                                                       
            //           Component1:AttachChildren[Component2]                                                     Component1:AttachChildren[Component2]â—„â”€â”€â”€â”€â”€â”€â”€***Component2 should be welded to Component1   
            //               â–²      WeldChildren[Component1]â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€***What we expected!!                           â–²      WeldChildren[]                                                                   
            //               â”‚                                                                                         â”‚                                                                                       
            //           Component2:                                                                               Component2:                                                                                 
            //                                                                                                                                                                                                 
            RootBI->UnWeld(NewRootBI);
            FPlatformAtomics::InterlockedExchangePtr((void**)&NewRootBI->WeldParent, nullptr);

            // if BodyInstance hasn't already been created, we need to initialize it
            bool bHasBodySetup = GetBodySetup() != nullptr;
            if (!bRootIsBeingDeleted && bHasBodySetup && NewRootBI->IsValidBodyInstance() == false)
            {
                bool bPrevAutoWeld = NewRootBI->bAutoWeld;
                NewRootBI->bAutoWeld = false;
                NewRootBI->InitBody(GetBodySetup(), GetComponentToWorld(), this, CurrentWorld->GetPhysicsScene());
                NewRootBI->bAutoWeld = bPrevAutoWeld;
            }

            TArray<FBodyInstance*> ChildrenBodies;
            TArray<FName> ChildrenLabels;
            GetWeldedBodies(ChildrenBodies, ChildrenLabels);

            // haker: 2. iterate welded children's BodyInstances and call unweld()
            for (int32 ChildIdx = 0; ChildIdx < ChildrenBodies.Num(); ++ChildIdx)
            {
                FBodyInstance* ChildBI = ChildrenBodies[ChildIdx];
                if (ChildBI != NewRootBI)
                {
                    if (!bRootIsBeingDeleted)
                    {
                        RootBI->UnWeld(ChildBI);
                    }

                    // at this point, NewRootBI must be kinematic because it's being unwelded
                    FPlatformAtomics::InterlockedExchangePtr((void**)&ChildBI->WeldParent, nullptr); // null because we are currently kinematic
                }
            }

        
            if (!bRootIsBeingDeleted && NewRootBI->ShouldInstanceSimulatingPhysics())
            {
                NewRootBI->ApplyWeldOnChildren();
            }
        }
    }
}
```

---

## DetachFromComponent

```cpp
virtual void DetachFromComponent(const FDetachmentTransformRules& DetachmentRules)
{
    if (GetAttachParent() != nullptr)
    {
        AActor* Owner = GetOwner();

        if (UPrimitiveComponent* PrimComp = Cast<UPrimitiveComponent>(this))
        {
            // UnWeld
            PrimComp->UnWeldFromParent();
        }

        if ((Owner && Owner->GetLocalRole() == ROLE_Authority() || !(GetIsReplicated() || GetAttachParent()->GetIsReplicated())))
        {
            ensureMsgf(!bRegistered || GetAttachParent()->GetAttachChildren().Contains(this), TEXT("attempt to detach SceneComponent while not attached"));
        }

        if (DetachmentRules.bCallModify && !HasAnyFlags(RF_Transient))
        {
            Modify();

            GetAttachParent()->Modify(/*bAlwaysMarkDirty=*/false);
        }


        PrimaryComponentTick.RemovePrerequisites(GetAttachParent(), GetAttachParent()->PrimaryComponentTick);


        GetAttachParent()->AttachChildren.Remove(this);

        GetAttachParent()->ClientAttachedChildren.Remove(this);

        GetAttachParent()->OnChildDetached(this);
        GetAttachParent()->ModifiedAttachChildren();

        SetAttachParent(nullptr);
        SetAttachSocketName(NAME_None);

        OnAttachmentChanged();


        switch (DetachmentRules.LocationRule)
        {
        case EDetachmentRule::KeepRelative:
            break;
        case EDetachmentRule::KeepWorld:
            // or GetComponentLocation, but worried about custom location
            SetRelativeLocation_Direct(GetComponentTransform().GetTranslation());
            break;
        }

        switch (DetachmentRules.RotationRule)
        {
        case EDetachmentRule::KeepRelative:
            break;
        case EDetachmentRule::KeepWorld:
            SetRelativeRotation_Direct(GetComponentRotation());
            break;
        }

        switch (DetachmentRules.ScaleRule)
        {
        case EDetachmentRule::KeepRelative:
            break;
        case EDetachmentRule::KeepWorld:
            SetRelativeScale3D_Direct(GetComponentScale());
            break;
        }


        UpdateComponentToWorld();


        if (IsRegistered() && !bDisableDetachmentUpdateOverlaps)
        {
            UpdateOverlaps();
        }
    }
}
```