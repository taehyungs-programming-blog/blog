---
layout: default
title: "06-01. Weld"
parent: "(06. AttachMent Rules)"
grand_parent: "(UE SourceCode ë¶„ì„ ğŸ¤–)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

```cpp
struct FAttachmentTransformRules
{
    EAttachmentRule LocationRule;
    EAttachmentRule RotationRule;
    EAttachmentRule ScaleRule;

    // ...

    // please when you're trying to use 'Welding', you should have a solid understanding about physics engine!
    // - otherwise, just stick to fake physics using transform and ticking
    bool bWeldSimulatedBodies;  // ì–˜ëŠ” ë­˜ê¹Œ?
};
```

```cpp
/** whether to weld simulated bodies together when attaching */
// what is the meaning of 'weld'?
// - in the dictionary, 'weld' means 'join together (metal pieces or parts) by heating the surfaces to the point of emlting using blow torch'
// - firstly, you need to understand what a 'rigid body' is and what a 'shape' is in physics engine:
//                                                  
//   RigidBody                                      
//   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            
//   â”‚                                 â”‚            
//   â”‚      Shape0                     â”‚            
//   â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚            
//   â”‚      â”‚           â”‚              â”‚            
//   â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¤              â”‚            
//   â”‚              â”‚   â”‚    Shape2    â”‚            
//   â”‚              â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚            
//   â”‚              â”‚   â”‚         â”‚    â”‚            
//   â”‚              â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚            
//   â”‚              â”‚   â”‚              â”‚            
//   â”‚              â””â”€â”€â”€â”˜              â”‚            
//   â”‚               Shape1            â”‚            
//   â”‚                                 â”‚            
//   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            
//                                                  
//   - RigidBody is the unit of physics simulation  
//   - Shape is the unit of physics properties:     
//      1. ShapeType(Sphere,Box,Capsule,...)        
//      2. Mass                                     
//      3. ...etc.                                  
//
// - secondly, understand what is the simulation unit(rigid-body) is:
//                                                                                                         
//   Case 1) Each Shape has its own Rigid-Body               Case 2) All shapes owned by one Rigid-Body     
//                                                                                                          
//        Shape0:RigidBody0                                       RigidBody                                 
//        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       
//        â”‚           â”‚                                           â”‚      Shape0                     â”‚       
//        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¤                                           â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚       
//                â”‚   â”‚    Shape2:RigidBody2                      â”‚      â”‚           â”‚              â”‚       
//                â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¤              â”‚       
//                â”‚   â”‚         â”‚                                 â”‚              â”‚   â”‚    Shape2    â”‚       
//                â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚              â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚       
//                â”‚   â”‚                                           â”‚              â”‚   â”‚         â”‚    â”‚       
//                â””â”€â”€â”€â”˜                                           â”‚              â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚       
//                 Shape1:RigidBody1                              â”‚              â”‚   â”‚              â”‚       
//                                                                â”‚              â””â”€â”€â”€â”˜              â”‚       
//                  â”‚                                             â”‚               Shape1            â”‚       
//                  â”‚                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       
//                  â”‚ Gravity is applied                                                                    
//                  â”‚                                                              â”‚                        
//                  â”‚                                                              â”‚                        
//                  â–¼                                                              â”‚ Gravity is applied     
//                                                                                 â”‚                        
//                                                                                 â”‚                        
//               Shape1:RigidBody1                                                 â–¼                        
//                     â”Œâ”€â”€â”€â”                                                                                
//                     â”‚   â”‚                                              Shape0                            
//                     â”‚   â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     
//    Shape0:RigidBody0â”‚   â”‚ Shape2:RigidBody2                            â”‚           â”‚                     
//    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¤                     
//    â”‚           â”‚    â”‚   â”‚ â”‚         â”‚                                          â”‚   â”‚    Shape2           
// â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€                                         â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           
//                                                                                â”‚   â”‚         â”‚           
//                                                                                â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           
//                                                                                â”‚   â”‚                     
//                                                                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    
//                                                                                 Shape1                                                        
//
// - thirdly, how a shape and a rigid-body are mapped into in UE4/UE5
//   - Shape -> Geometry(Shape)
//   - Rigid-Body -> FBodyInstance
//
// - lastly, what is 'welding'?
//   - normally, each primitive component has its own BodyInstance:
//     - skeletal mesh component has multiple BodyInstances, cuz usually we assign BodyInstance to each bone
//   - scene-graph consists of SceneComponents which means it could have multiple BodyInstances:
//     - physics stability could result in artifacts like jittering
//     - we can increase the phyiscs stability by reducing simulating units(rigid-body=BodyInstance)
//   - 'welding' means merging BodyInstances(multiple rigid bodies) into one BodyInstance (the most ancestor)
//   - Diagram:
//                                                                                                                                    
//     Component0:BodyInstance0                                                    Component0:BodyInstance0                                  
//     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             
//     â”‚           â”‚                                                               â”‚           â”‚                                             
//     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¤                                                               â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¤                                             
//             â”‚   â”‚    Component2:BodyInstance2                                           â”‚   â”‚    Component2:WeldParent=BodyInstance0      
//             â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                             â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   
//             â”‚   â”‚         â”‚                   Conceptually,                             â”‚   â”‚         â”‚                                   
//             â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    Merge AllComponent's RididBodies         â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   
//             â”‚   â”‚                              into Component0(RootComponent)           â”‚   â”‚                                             
//             â””â”€â”€â”€â”˜                             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º            â””â”€â”€â”€â”˜                                             
//              Component1:BodyInstance1                                                    Component1:WeldParent=BodyInstance0              
//                                                                                                                                           
//                                                                                                                                           
//                                                                                                                                           
//            Component0:AttachChildren[Component1]                                       Component0:AttachChildren[Component1]              
//                â–²                                                                           â–²      WeldChildren[Component1,Component2]     
//                â”‚                                                                           â”‚                                              
//            Component1:AttachChildren[Component2]                                       Component1:AttachChildren[Component2]              
//                â–²                                                                           â–²                                              
//                â”‚                                                                           â”‚                                              
//            Component2                                                                  Component2                                         
//                                                                                                                                           
```

```cpp
bool AttachToComponent(USceneComponent* Parent, const FAttachmentTransformRules& AttachmentRules, FName InSocketName=NAME_None)
{
    // ...
    
    if (AttachmentRules.bWeldSimulatedBodies)
    {
        if (UPrimitiveComponent* PrimitiveComponent = Cast<UPrimitiveComponent>(this))
        {
            if (FBodyInstance* BI = PrimitiveComponent->GetBodyInstance())
            {
                // ì˜ˆë¥¼ë“¤ì–´ ì´ë ‡ê²Œ ë¶™ì´ê²Œ ëœë‹¤.
                PrimitiveComponent->WeldToImplementation(GetAttachParent(), GetAttachSocketName(), AttachmentRules.bWeldSimulatedBodies);
            }
        }
    }
```