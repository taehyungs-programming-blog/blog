---
layout: default
title: "10-03. SceneRenderer"
parent: (10. CreateRenderState)"
grand_parent: "(UE SourceCode ë¶„ì„ ğŸ¤–)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

```cpp
virtual void Tick(float DeltaSeconds, bool bIdleMode) override
{
    // ...

// redraw viewports:
{
    // gather worlds that need EOF(End Of Frame update) updates
    // - this must be done in two steps as the object hash table is locked during ForEachObjectOfClass so any newObject calls would fail
    // we'll skip ForEachObjectOfClass works:
    // - we collect worlds(UWorld) which has to call EndOfFrame(EOF)Update to 'WorldsToEOFUpdate'
    TArray<UWorld*> WorldsToEOFUpdate;
    ForEachObjectOfClass(UWorld::StaticClass(), [&WorldsToEOFUpdate](UObject* WorldObject)
    {
        UWorld* World = CastChecked<UWorld>(WorldObj);
        if (World->HasEndOfFrameUpdates())
        {
            WorldsToEOFUpdate.Add(World);
        }
    });

    // make sure deferred component updates have been sent to the rendering thread
    // MarkRenderTransformDirty() explanation with SendAllEndOfFrameUpdate
    for (UWorld* World : WorldsToEOFUpdate)
    {
        World->SendAllEndOfFrameUpdates();
    }

    // iterate contexts (in our case, PieContext is expected)
    for (auto ContextIt = WorldList.CreateIterator(); ContextIt; ++ContextIt)
    {
        FWorldContext& PieContext = *Context.It;
        if (PieContext.WorldType != EWorldType::PIE)
        {
            continue;
        }

        PlayWorld = PieContext.World();
        GameViewport = PieContext.GameViewport;

        // render playworld:
        // to render scene, UWorld and UGameViewportClient are necessary!
        if (PlayWorld && GameViewport)
        {
            // use the PlayWorld as the GWorld, because who knows what will happen in the Tick
            // see SetPlayInEditorWorld briefly
            // - see the 'RestoreEditorWorld' also
            // - these function take care of maintaining the GWorld's consistency
            UWorld* OldGWorld = SetPlayInEditorWorld(PlayWorld);

            // render everything
            // the scene draw call is started from GameViewportClient's Viewport 
            GameViewport->Viewport->Draw();

            // pop the world
            RestoreEditorWorld(OldGWorld);
        }
    }
}
```

* ê·¸ëŸ°ë° ì™œ EOFë¥¼ ì‚¬ìš©í•´ ë§ˆí‚¹ë§Œ í•˜ê³  ë§ˆì§€ë§‰ì— Renderë¥¼ í• ê¹Œ?

```cpp
/**
    * mark a component as needing an end of frame update 
    */
// this function register a component to do 'EOFUpdate':
// - what is the benefit of marking the 'needed-end-of-frame-update'?
    // í•œ Frameì— SendRenderTransformì´ í•œ Frameì— ë‘ ë²ˆ(í˜¹ì€ ì´ìƒ) ì¼ì–´ë‚  ìˆ˜ ìˆë‹¤.
    // ë³€í™”ë¥¼ ë§ˆí‚¹ë§Œ í•´ë‘ê³  ë§ˆì§€ë§‰ì— ì²˜ë¦¬í•˜ëŠ”ê²Œ ìœ ë¦¬í•˜ê² ì§€?
//   â”Œâ”€[Before]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
//   â”‚                                                                                                                    â”‚
//   â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
//   â”‚                       â”‚Component0â”‚ â”‚Component1â”‚ â”‚Component2â”‚                                                       â”‚
//   â”‚                       â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
//   â”‚                         â”‚               â”‚           â”‚                                                              â”‚
//   â”‚  RecreateRenderState    â”‚               â”‚           â”‚                                                              â”‚
//   â”‚  SendRenderTransform0   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”¬â”€â” â”œâ”€â”¬â”€â” â”Œâ”€â”¬â”€â”€â”€â”˜                                                              â”‚
//   â”‚  SendRenderTransform1             â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚                                                                  â”‚
//   â”‚                                 â”Œâ”€â–¼â”€â–¼â”€â–¼â”€â–¼â”€â–¼â”€â–¼â”€â–¼â”€â–¼â”                                                                 â”‚
//   â”‚                                 â”‚ Command Queue  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€Too many RenderCommands are created:                   â”‚
//   â”‚                                 â””â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”˜          *** what if we reduce total count of RenderCommands?   â”‚
//   â”‚                                   â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
//   â”‚                                   â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚                                                                  â”‚
//   â”‚                                   â–¼ â–¼ â–¼ â–¼ â–¼ â–¼ â–¼ â–¼                                                                  â”‚
//   â”‚                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                 â”‚
//   â”‚                                 â”‚  RenderThread  â”‚                                                                 â”‚
//   â”‚                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                 â”‚
//   â”‚                                                                                                                    â”‚
//   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//                                                                                                                         
//                                                                                                                         
//   â”Œâ”€[After]-â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
//   â”‚                                                                                                                    â”‚
//   â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
//   â”‚                       â”‚Component0â”‚ â”‚Component1â”‚ â”‚Component2â”‚                                                       â”‚
//   â”‚                       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                       â”‚
//   â”‚                            â”‚            â”‚            â”‚                                                             â”‚
//   â”‚                            â”‚            â”‚            â”‚                                                             â”‚
//   â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                             â”‚
//   â”‚                                     â”‚   â”‚   â”‚                                                                      â”‚
//   â”‚                                 â”Œâ”€â”€â”€â–¼â”€â”€â”€â–¼â”€â”€â”€â–¼â”€â”€â”€â”€â”                                                                 â”‚
//   â”‚                                 â”‚ Command Queue  â”‚â—„â”€â”€â”€â”€â”€â”€Reduce the count of RenderComands by MarkEndOfFrameUpdate â”‚
//   â”‚                                 â””â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       *** we can relieve the burden of processing RenderCommandsâ”‚
//   â”‚                                     â”‚   â”‚   â”‚                                                                      â”‚
//   â”‚                                     â”‚   â”‚   â”‚                                                                      â”‚
//   â”‚                                     â”‚   â”‚   â”‚                                                                      â”‚
//   â”‚                                 â”Œâ”€â”€â”€â–¼â”€â”€â”€â–¼â”€â”€â”€â–¼â”€â”€â”€â”€â”                                                                 â”‚
//   â”‚                                 â”‚  RenderThread  â”‚                                                                 â”‚
//   â”‚                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                 â”‚
//   â”‚                                                                                                                    â”‚
//   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
void MarkActorComponentForNeededEndOfFrameUpdate(UActorComponent* Component, bool bForceGameThread)
{
```

```cpp
void MarkRenderTransformDirty()
{
    // world's transform update(change) can be applied after bRenderStateCreated:
    // - in UActorComponent::CreateRenderState_Concurrent(), we update 'bRenderStateCreated' as true
    if (IsRegistered() && bRenderStateCreated)
    {
        // mark 'bRenderTransformDirty' as true, and register this component to do EOFUpdate(EndOfFrameUpdate)
        bRenderTransformDirty = true;
        MarkForNeededEndOfFrameUpdate();
    }
    else if (!IsUnreachable())
    {
        // we don't have a world, do it right now
        DoDeferredRenderUpdates_Concurrent();
    }
}
```