---
layout: default
title: "(11. FDeferredShadingSceneRenderer)"
parent: "(UE SourceCode 분석 🤖)"
has_children: true
nav_order: 2
---

```cpp
/** scene renderer that implements a deferred shading pipeline and associated features */
// - DeferredShadingSceneRenderer is the renderer supporting 'deferred-shading'
// - e.g. we have another type of SceneRenderer, 'MobileShadingSceneRenderer'
class FDeferredShadingSceneRenderer : public FSceneRenderer
{
    struct FInitViewTaskDatas
    {

    };

    IVisibilityTaskData UpdateScene(FRDGBuilder& GraphBuilder, FGlobalDynamicBuffers GlobalDynamicBuffers)
    {
        Scene->UpdateAllPrimitiveSceneInfos(GraphBuilder, GetUpdateAllPrimitiveSceneInfosSyncOps());

        //...
    }

    /** render the view family */
    virtual void Render(FRDGBuilder& GraphBuilder) override
    {
        // see FDeferredShadingSceneRenderer::UpdateScene
        FInitViewTaskDatas InitViewTaskDatas = UpdateScene(GraphBuilder, FGlobalDynamicBuffers(DynamicIndexBufferForInitViews, DynamicVertexBufferForInitViews, DynamicReadBufferForInitViews));

        //...
    }
};
```

```cpp
/** creates multiple scene renderers based on the current feature level: all view families must point to the same scene */

// we create each SceneRenderer per SceneViewFamilys
static void CreateSceneRenderers(TArrayView<const FSceneViewFamily*> InViewFamilies, FHitProxyConsumer* HitProxyConsumer, TArray<FSceneRenderer*>& OutSceneRenderers)
{
    OutSceneRenderers.Empty(InViewFamilies.Num());
    if (InViewFamilies.Num())
    {
        return;
    }

    const FSceneInterface* Scene = InViewFamilies[0]->Scene;
    check(Scene);

    for (int32 FamilyIndex = 0; FamilyIndex < InViewFamilies.Num(); ++FamilyIndex)
    {
        const FSceneViewFamily* InViewFamily = InViewFamilies[FamilyIndex];

        // actually I abbreviate the code a lot!
        // - I leave the code for creating DeferredShadingSceneRenderer
        FDeferredShadingSceneRenderer* SceneRenderer = new FDeferredShadingSceneRenderer(InViewFamily, HitProxyConsumer);
        OutSceneRenderers.Add(SceneRenderer);
    }
}
```

* `UpdateAllPrimitiveSceneInfos`은 UE 5.4에서는 사라졌습니다.
    * UE 5.3기준으로 확인해 주세요.

```cpp
// we add render-object to the Scene from pending queues like 'UpdatedTransforms' and 'AddedPrimitiveSceneInfos'
// - UpdatedTransforms's commands are queued by 'UpdatePrimitiveTransform_RenderThread'
// - AddedPrimitiveSceneInfos's commands are queued by 'AddPrimitiveSceneInfo_RenderThread'
void UpdateAllPrimitiveSceneInfos(FRDGBuilder& GraphBuilder, EUpdateAllPrimitiveSceneInfosAsyncOps AsyncOps)
{
    // we are focusing on 'AddedPrimitiveSceneInfos' and 'UpdatedTransforms'
    // - other than that, rest of codes are omitted

    // we copy AddedPrimitiveSceneInfos to 'AddedLocalPrimitiveSceneInfos'
    TArray<FPrimitiveSceneInfo*> AddedLocalPrimitiveSceneInfos;
    AddedLocalPrimitiveSceneInfos.Reserve(AddedPrimitiveSceneInfos.Num());
    for (FPrimitiveSceneInfo* SceneInfo : AddedPrimitiveSceneInfos)
    {
        AddedLocalPrimitiveSceneInfos.Add(SceneInfo);
    }

    // this is why we copy it to local variable:
    // - sort them with PrimitiveArraySortKey
    // - the expected result of sorting is like this:
    //  0               4                          11                                          21    
    //  │               │                           │                                           │    
    //  │               │                           │                                           │    
    //  │               │                           │                                           │    
    //  ├───┬───┬───┬───┼───┬───┬───┬───┬───┬───┬───┼───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┼───┐
    //  │ 0 │ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │ 8 │ 9 │ 10│ 11│ 12│ 13│ 14│ 15│ 16│ 17│ 18│ 19│ 20│ 21│...│
    //  ├───┴───┴───┴───┼───┴───┴───┴───┴───┴───┴───┼───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┼───┘
    //  │               │                           │                                           │    
    //  │               │                           │                                           │    
    //  │◄─────────────►│◄─────────────────────────►│◄─────────────────────────────────────────►│    
    //  │               │                           │                                           │    
    //                                                                                               
    // StaticMeshSceneProxy    PrimitiveSceneProxy           SkeletalMeshSceneProxy                   
    // :Offset==4              :Offset==11                   :Offset==21                              
    
    // FPrimitiveArraySortKey라는 Functor로 Sort해달라.
    AddedLocalPrimitiveSceneInfos.Sort(FPrimitiveArraySortKey());
```

```cpp
struct FPrimitiveArraySortKey
{
    inline bool operator()(const FPrimitiveSceneInfo& A, const FPrimitiveSceneInfo& B) const
    {
        uint32 AHash = A.Proxy->GetTypeHash();
        uint32 BHash = B.Proxy->GetTypeHash();

        if (AHash == BHash)
        {
            // if A and B's proxy hash is same, we sort them by 'RegistrationSerialNumber'
            // - by doing this, we can preserve deterministic order of proxies in the scene 
            return A.RegistrationSerialNumber < B.RegistrationSerialNumber;
        }
        else
        {
            return AHash < BHash;
        }
    }
};
```

```cpp
/** a static mesh component scene proxy */
class FStaticMeshSceneProxy : public FPrimitiveSceneProxy
{
    virtual SIZE_T GetTypeHash() const override
    {
        // UniquePointer is static variable which means it is global variable
        // - returning global variable's pointer means GetTypeHash() has unique value for each type:
        //   - FStaticMeshSceneProxy's GetTypeHash returns unique value
        //   - FSkeletalMeshSceneProxy's GetTypeHash returns unique value
        // - it is unique identifier for PrimitiveSceneProxy types
        
        // FStaticMeshSceneProxy 클래스 마다 유니크한 Pointer를 넘겨주게 된다.
        static size_t UniquePointer;
        return reinterpret_cast<size_t>(&UniquePointer);
    }
};
```

```cpp
// UpdateAllPrimitiveSceneInfos 계속

    //...

    // classify SceneInfos depending on initialization phases:
    // 1. AddToScene: call FPrimitiveSceneInfo::AddToScene()
    // 2. StaticDrawListUpdate: call FPrimitiveSceneInfo::CacheMeshDrawCommands()
    // - we'll see this phase in detail on the below code
    TArray<FPrimitiveSceneInfo*, SceneRenderingAllocator>& SceneInfosWithAddToScene = *GraphBuilder.AllocateObject<TArray<FPrimitiveSceneInfo*, SceneRenderingAllocator>>();
    TArray<FPrimitiveSceneInfo*, SceneRenderingAllocator>& SceneInfosWithStaticDrawListUpdate = *GraphBuilder.AllocObject<TArray<FPrimitiveSceneInfo*, SceneRenderingAllocator>>();
    SceneInfosWithAddToScene.Reserve(SceneInfosContainerReservedSize);
    SceneInfosWithStaticDrawListUpdate.Reserve(SceneInfosContainerReservedSize);

    // QueueAddToScene and QueueAddStaticMeshes are the lambda to enqueue into SceneInfosWithAddToScene and SceneInfosWithStaticDrawListUpdate respectively
    const auto QueueAddToScene = [&](FPrimitiveSceneInfo* SceneInfo) -> bool
    {
        if (!SceneInfo->bPendingAddToScene)
        {
            SceneInfo->bPendingAddToScene = true;
            SceneInfosWithAddToScene.Push(SceneInfo);
            return true;
        }
        return false;
    };

    const auto QueueAddStaticMeshes = [&](FPrimitiveSceneInfo* SceneInfo)
    {
        if (!SceneInfo->bPendingAddStaticMeshes)
        {
            SceneInfo->bPendingAddStaticMeshes = 1;
            SceneInfosWithStaticDrawListUpdate.Push(SceneInfo);
            PrimitivesNeedingStaticMeshUpdate[SceneInfo->PackedIndex] = false;
            return true;
        }
        return false;
    };

    //...

    // preserve SOA of the scene:
    // - we'll add SceneInfos into the end of SOA of the scene:
    //   e.g. Primitives, PrimitiveTransforms, PrimitiveSceneProxies, PrimitiveBounds, ...
    //                                                                                                                           │                                             
    //                                                                                                                           │*** We add new PrimitiveSceneInfo from here  
    //                                                                                                                           ├───────────────►                             
    //                                                                                                                           │                                             
    //                            ┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬──────────┼──────────┐                                  
    //                Primitives: │ SceneInfo0  │ SceneInfo1  │ SceneInfo2  │ SceneInfo3  │ SceneInfo4  │ SceneInfo5  │ ...      │          │                                  
    //                            └─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴──────────┼──────────┘                                  
    //                                                                                                                           │                                             
    //                            ┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬──────────┼──────────┐                                  
    //       PrimitiveTransforms: │ Transform0  │ Transform1  │ Transform2  │ Transform3  │ Transform4  │ Transform5  │ ...      │          │                                  
    //                            └─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴──────────┼──────────┘                                  
    //                                                                                                                           │                                             
    //                            ┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬──────────┼──────────┐                                  
    //     PrimitiveSceneProxies: │ SceneProxy0 │ SceneProxy1 │ SceneProxy2 │ SceneProxy3 │ SceneProxy4 │ SceneProxy5 │ ...      │          │                                  
    //                            └─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴──────────┼──────────┘                                  
    //                                                                                                                           │                                             
    //                            ┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬──────────┼──────────┐                                  
    //           PrimitiveBounds: │ Bounds0     │ Bounds1     │ Bounds2     │ Bounds3     │ Bounds4     │ Bounds5     │ ...      │          │                                  
    //                            └─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴──────────┼──────────┘                                  
    //                                                                                                                           │                                                                                       
    if (AddedLocalPrimitiveSceneInfos.Num())
    {
        // we only deal with four data types: Primitives, PrimitiveTransforms, PrimitiveSceneProxies and PrimitiveBounds
        Primitives.Reserve(Primitives.Num() + AddedLocalPrimitiveSceneInfos.Num());
        PrimitiveTransforms.Reserve(PrimitiveTransforms.Num() + AddedLocalPrimitiveSceneInfos.Num());
        PrimitiveSceneProxies.Reserve(PrimitiveSceneProxies.Num() + AddedLocalPrimitiveSceneInfos.Num());
        PrimitiveBounds.Reserve(PrimitiveBounds.Num() + AddedLocalPrimitiveSceneInfos.Num());

        //...
    }

    // we deal with the below code logic conceptually:
    //
    //                                                            ***sorted by GetTypeHash(), SceneProxy's type                                                             
    //                                                                                  │                                                                                   
    //                                                                                  │                                                                                   
    //                                                      ┌───────────────────────────┼────────────────────────┐                                                          
    //                                                      │                           │                        │                                                          
    //                                                      │                           │                        │                                                          
    //                                                      ▼                           ▼                        ▼                                                          
    //                                         │   StaticMeshSceneProxy    │   SkeletalMeshSceneProxy  │    PrimitiveSceneProxy    │                                        
    //                                         │◄─────────────────────────►│◄─────────────────────────►│◄─────────────────────────►│                                        
    //                                         │                           │                           │                           │                                        
    //                                         ├─────────────┬─────────────┼─────────────┬─────────────┼─────────────┬─────────────┤                                        
    //          AddedLocalPrimitiveSceneInfos: │ SceneInfo0  │ SceneInfo1  │ SceneInfo2  │ SceneInfo3  │ SceneInfo4  │ SceneInfo5  │                                        
    //                                         ├─────────────┴─────────────┼─────────────┴─────────────┼─────────────┴─────────────┤                                        
    //                                         │                           │                           │                           │                                        
    //                                         │            (1)            │            (2)            │            (3)            │                                        
    //                                                                                                                                                                      
    //                                                                                                                                                                      
    //          1. We iterates AddedLocalPrimitiveSceneInfos in order of (3)──►(2)──►(1)                                                                                    
    //                                                                                                                                                                      
    //          2. When we adding each block (e.g. (3),(2),(1)):                                                                                                            
    //              │                                                                                                                                                       
    //              │                                                                                                                                                       
    //              ├───2-0. Suppose we have Primitives(PrimitiveSceneInfos) like below:                                                                                    
    //              │                                                                                                                                                       
    //              │                         │             │             │                                                                                                 
    //              │                         ├─────────────┼─────────────┤                                                                                                 
    //              │             Primitives: │ SceneInfo6  │ SceneInfo7  │                                                                                                 
    //              │                         ├─────────────┼─────────────┤                                                                                                 
    //              │                         │   ▲         │          ▲  │                                                                                                 
    //              │                         │   │         │          │  │                                                                                                 
    //              │                      StaticMeshSceneProxy    SkeletalMeshSceneProxy                                                                                   
    //              │                                                                                                                                                       
    //              │                                                                                                                                                       
    //              │                         ┌─────────────────────────┬────────────────────────────┐                                                                      
    //              │        TypeOffsetTable: │(StaticMeshSceneProxy, 1)│ (SkeletalMeshSceneProxy, 2)│                                                                      
    //              │                         └─────────────────────────┴────────────────────────────┘                                                                      
    //              │                                                                                                                                                       
    //              │                                                                                                                                                       
    //              ├───2.1. add elements in block(3) to SOA of the scene:                                                                                                  
    //              │                                                                                                                                                       
    //              │                        │             │             │ *** newly added!                                                                                 
    //              │                        ├─────────────┼─────────────┼────────────┬────────────┐                                                                        
    //              │            Primitives: │ SceneInfo6  │ SceneInfo7  │ SceneInfo4 │ SceneInfo5 │                                                                        
    //              │                        ├─────────────┼─────────────┼────────────┴────────────┘                                                                        
    //              │                        │   ▲         │          ▲  │                                                                                                  
    //              │                        │   │         │          │  │                                                                                                  
    //              │                     StaticMeshSceneProxy    SkeletalMeshSceneProxy                                                                                    
    //              │                                                                                                                                                       
    //              │                        ┌─────────────┬─────────────┬────────────┬────────────┐                                                                        
    //              │   PrimitiveTransforms: │ Transform6  │ Transform7  │ Transform4 │ Transform5 │                                                                        
    //              │                        └─────────────┴─────────────┴────────────┴────────────┘                                                                        
    //              │                                                                                                                                                       
    //              │                       *** like PrimitiveTransforms, PrimitiveSceneProxies and PrimitiveBounds are extended based on block(3)                          
    //              │                           ───────────────────────────────────────────────────────────────────────────────────────────────────                         
    //              │                                                                                                                                                       
    //              │                                                                                                                                                       
    //              ├────2-2. Find the entry by 'FScene::TypeOffsetTable'                                                                                                   
    //              │          │                                                                                                                                            
    //              │          │                                                                                                                                            
    //              │          ├────if we failed to find the entry                                                                                                          
    //              │          │    : we add the new 'TypeOffsetEntry' to the FScene::TypeOffsetTable                                                                       
    //              │          │        │                                                                                                                                   
    //              │          │        │                                                                                                                                   
    //              │          │        └───In our case, we don't have 'PrimitiveSceneProxy'                                                                                
    //              │          │            : when we process the block(3), we add new TypeOffsetEntry for 'PrimitiveSceneProxy' as (PrimitiveSceneProxy, 2)                
    //              │          │                                                                                                                                            
    //              │          │                                                                                                                                            
    //              │          └────TypeOffsetTable looks like this:                                                                                                        
    //              │                                                                                                                                                       
    //              │                                   ┌─────────────────────────┬────────────────────────────┬─────────────────────────┐                                  
    //              │                  TypeOffsetTable: │(StaticMeshSceneProxy, 1)│ (SkeletalMeshSceneProxy, 2)│ (PrimitiveSceneProxy, 2)│                                  
    //              │                                   └─────────────────────────┴──────────────────────────┬─┴───────────────────────▲─┘                                  
    //              │                                                                                        │                         │                                    
    //              │                                                                                        └─────────────────────────┘                                    
    //              │                                                                                        initialize as '2'                                              
    //              ├────2.3. Swap the SOA of the scene:                                                     ─────────┬────────                                             
    //              │          │                                                                                      │                                                     
    //              │          │                     ┌────────────┬────────────┐                                      │                                                     
    //              │          └───Iterate block(3): │ SceneInfo4 │ SceneInfo5 │                                      │                                                     
    //              │                │               └────────────┴────────────┘                                      │                                                     
    //              │                │  SourceIndex:     2             3                                              │                                                     
    //              │                │                   │             │                                              │                                                     
    //              │                │                   │             └────────────────────────────┐                 │                                                     
    //              │                │                   │                                          │                 │                                                     
    //              │                │                   └─────────────────────────────┐            │                 │                                                     
    //              │                │                                                 │            │                 │                                                     
    //              │                │               ┌─────────────┬─────────────┬─────▼──────┬─────▼──────┐          │                                                     
    //              │                │   Primitives: │ SceneInfo6  │ SceneInfo7  │ SceneInfo4 │ SceneInfo5 │          │                                                     
    //              │                │               └─────────────┴─────────────┴────────────┴────────────┘          │                                                     
    //              │                │                    [0]            [1]          [2]          [3]                │                                                     
    //              │                │                                                                                │                                                     
    //              │                │                                                                                │                                                     
    //              │                └────Iterate [BroadIndex, TypeOffsetTable.Num()] as TypeIndex                    │ *** As a result, Offset becomes 2──►4               
    //              │                     : BroadIndex == 2: (PrimitiveSceneProxy, 2) == TypeOffsetTable[2]           │                                                     
    //              │                       │                                                                         │                                                     
    //              │                       │                                                                         │                                                     
    //              │                       ├───Increase TypeOffsetTable[TypeIndex].Offset++ ◄────────────────────────┘                                                     
    //              │                       │    :DestIndex = TypeOffsetTable[TypeIndex].Offset++                                                                           
    //              │                       │                                                                                                                               
    //              │                       │                                                                                                                               
    //              │                       │                                                                                                                               
    //              │                       └───Swap the SOA of the scene only if DestIndex and SourceIndex is different:                                                   
    //              │                            │                                                                                                                          
    //              │                            │                                                                                                                          
    //              │                            └───In our case:                                                                                                           
    //              │                                ┌────────────────────────────────┐                                                                                     
    //  Block(3)    │                                │ SourceIndex: 2, DestIndex: 2   │                                                                                     
    //    ▲         │                                │          │                     │ *** No need to swap the SOA!                                                        
    //    │         │                                │          ▼                     │                                                                                     
    //    │         │                                │ SourceIndex: 3, DestIndex: 3   │                                                                                     
    //    │         │                                └────────────────────────────────┘                                                                                     
    //    │         │                                                                                                                                                       
    //  ──┼─────────┼───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    //    │         │                                                                                                                                                       
    //    │         │                                                                                                                                                       
    //    │         │                                                                                                                                                       
    //    │         ├────2-0. we have Primitives(PrimitiveSceneInfos) like below:                                                                                           
    //    │         │                                                                                                                                                       
    //    ▼         │                                                                                                                                                       
    //  Block(2)    │                       │             │             │                         │                                                                         
    //              │                       ├─────────────┼─────────────┼────────────┬────────────┤                                                                         
    //              │           Primitives: │ SceneInfo6  │ SceneInfo7  │ SceneInfo4 │ SceneInfo5 │                                                                         
    //              │                       ├─────────────┼─────────────┼────────────┴────────────┤                                                                         
    //              │                       │   ▲         │          ▲  │                   ▲     │                                                                         
    //              │                       │   │         │          │  │                   │     │                                                                         
    //              │                    StaticMeshSceneProxy    SkeletalMeshSceneProxy   PrimitiveSceneProxy                                                               
    //              │                                                                                                                                                       
    //              │                                                                                                                                                       
    //              │                       ┌─────────────────────────┬────────────────────────────┬─────────────────────────┐                                              
    //              │      TypeOffsetTable: │(StaticMeshSceneProxy, 1)│ (SkeletalMeshSceneProxy, 2)│ (PrimitiveSceneProxy, 4)│                                              
    //              │                       └─────────────────────────┴────────────────────────────┴─────────────────────────┘                                              
    //              │                                                                                                                                                       
    //              │                                                                                                                                                       
    //              │                                                                                                                                                       
    //              │                                                                                                                                                       
    //              ├────2.1. add elements in block(2) to SOA of the scene:                                                                                                 
    //              │                                                                                                                                                       
    //              │                      │             │             │                         │*** newly added SkeletalMeshSceneProxy                                    
    //              │                      ├─────────────┼─────────────┼────────────┬────────────┼────────────┬────────────┐                                                
    //              │          Primitives: │ SceneInfo6  │ SceneInfo7  │ SceneInfo4 │ SceneInfo5 │ SceneInfo2 │ SceneInfo3 │                                                
    //              │                      ├─────────────┼─────────────┼────────────┴────────────┼────────────┴────────────┘                                                
    //              │                      │   ▲         │          ▲  │                   ▲     │                                                                          
    //              │                      │   │         │          │  │                   │     │                                                                          
    //              │                   StaticMeshSceneProxy    SkeletalMeshSceneProxy   PrimitiveSceneProxy                                                                
    //              │                                                                                                                                                       
    //              │                                                                                                                                                       
    //              │                      ┌─────────────┬─────────────┬────────────┬────────────┬────────────┬────────────┐                                                
    //              │ PrimitiveTransforms: │ Transform6  │ Transform7  │ Transform4 │ Transform5 │ Transform2 │ Transform3 │                                                
    //              │                      └─────────────┴─────────────┴────────────┴────────────┴────────────┴────────────┘                                                
    //              │                                                                                                                                                       
    //              │                                                                                                                                                       
    //              │                                                                                                                                                       
    //              ├────2-2. Find the entry by 'FScene::TypeOffsetTable'                                                                                                   
    //              │          │                                                                                                                                            
    //              │          │                                                                                                                                            
    //              │          ├────Successfully find the TypeOffsetTableEntry in the index [1]:                                                                            
    //              │          │                                                                                                                                            
    //              │          │     BroadIndex = 1:                                                                                                                        
    //              │          │ ────────────────────                                                                                                                       
    //              │          │      ***                                                                                                                                   
    //              │          │                                                                                                                                            
    //              │          └────TypeOffsetTable looks like this:                                                                                                        
    //              │                                                                                                                                                       
    //              │                                   ┌─────────────────────────┬────────────────────────────┬─────────────────────────┐                                  
    //              │                  TypeOffsetTable: │(StaticMeshSceneProxy, 1)│ (SkeletalMeshSceneProxy, 2)│ (PrimitiveSceneProxy, 4)│                                  
    //              │                                   └─────────────────────────┴────────────────────────────┴─────────────────────────┘                                  
    //              │                                                                                                                                                       
    //              │                                                                                                                                                       
    //              └────2.3. Swap the SOA of the scene:                                                                                                                    
    //                         │                                                                                                                                            
    //                         │                     ┌────────────┬────────────┐                                                                                            
    //                         └───Iterate block(2): │ SceneInfo2 │ SceneInfo3 │                                                                                            
    //                               │               └────────────┴────────────┘                                                                                            
    //                               │  SourceIndex:     4             5                                                                                                    
    //                               │                   │             │                                                                                                    
    //                               │                   │             └──────────────────────────────────────────────────────┐                                             
    //                               │                   │                                                                    │                                             
    //                               │                   └────────────────────────────────────────────────────────┐           │                                             
    //                               │                                                                            │           │                                             
    //                               │               ┌─────────────┬─────────────┬────────────┬────────────┬──────▼─────┬─────▼──────┐                                      
    //                               │   Primitives: │ SceneInfo6  │ SceneInfo7  │ SceneInfo4 │ SceneInfo5 │ SceneInfo2 │ SceneInfo3 │                                      
    //                               │               └─────────────┴─────────────┴────────────┴────────────┴────────────┴────────────┘                                      
    //                               │                    [0]           [1]            [2]          [3]          [4]         [5]                                            
    //                               │                                                                                                                                      
    //                               │                                                                                                                                      
    //                               ├────Iterate [BroadIndex, TypeOffsetTable.Num()] as TypeIndex                                                                          
    //                               │    : BroadIndex == 1: (SkeletalMeshSceneProxy, 2) == TypeOffsetTable[1]                                                              
    //                               │      │                                                                                                                               
    //                               │      │                                                                                                                               
    //                               │      ├───TypeIndex == 1: (SkeletalMeshSceneProxy, 2) == TypeOffsetTable[1]                                                           
    //                               │      │   Increase TypeOffsetTable[TypeIndex].Offset                                                                                  
    //                               │      │    :DestIndex = TypeOffsetTable[TypeIndex].Offset++  ───► (SkeletalMeshSceneProxy, 3)                                         
    //                               │      │      │                                                                                                                        
    //                               │      │      │                                                                                                                        
    //                               │      │      └───Swap the SOA of the scene only if DestIndex and SourceIndex is different:                                            
    //                               │      │           │                                                                                                                   
    //                               │      │           │                                                                                                                   
    //                               │      │           └───In our case:                                                                                                    
    //                               │      │               │                                                                                                               
    //                               │      │               └────SourceIndex: 4, DestIndex: 2 : SourceIndex != DestIndex                                                    
    //                               │      │                                     ┌─────────────┬─────────────┬────────────┬────────────┬────────────┬────────────┐         
    //                               │      │                         Primitives: │ SceneInfo6  │ SceneInfo7  │ SceneInfo2 │ SceneInfo5 │ SceneInfo4 │ SceneInfo3 │         
    //                               │      │                                     └─────────────┴─────────────┴──────▲─────┴────────────┴─────▲──────┴────────────┘         
    //                               │      │                                                                        │                        │                             
    //                               │      │                                                                        └────────────────────────┘                             
    //                               │      │                                                                                                                               
    //                               │      │                                                                                                                               
    //                               │      └───TypeIndex == 2: (PrimitiveSceneProxy, 4) == TypeOffsetTable[2]                                                              
    //                               │          Increase TypeOffsetTable[TypeIndex].Offset                                                                                  
    //                               │           :DestIndex = TypeOffsetTable[TypeIndex].Offset++ ───► (PrimitiveSceneProxy, 5)                                             
    //                               │                                                                                                                                      
    //                               │                                                                                                                                      
    //                               │                                                                                                                                      
    //                               │                                                                                                                                      
    //                               └────Iterate [BroadIndex, TypeOffsetTable.Num()] as TypeIndex                                                                          
    //                                    : BroadIndex == 1: (SkeletalMeshSceneProxy, 3) == TypeOffsetTable[1]                                                              
    //                                      │                                                                                                                               
    //                                      │                                                                                                                               
    //                                      ├───TypeIndex == 1: (SkeletalMeshSceneProxy, 3) == TypeOffsetTable[1]                                                           
    //                                      │   Increase TypeOffsetTable[TypeIndex].Offset                                                                                  
    //                                      │    :DestIndex = TypeOffsetTable[TypeIndex].Offset++  ───► (SkeletalMeshSceneProxy, 4)                                         
    //                                      │      │                                                                                                                        
    //                                      │      │                                                                                                                        
    //                                      │      └───Swap the SOA of the scene only if DestIndex and SourceIndex is different:                                            
    //                                      │           │                                                                                                                   
    //                                      │           │                                                                                                                   
    //                                      │           └───In our case:                                                                                                    
    //                                      │               │                                                                                                               
    //                                      │               └────SourceIndex: 5, DestIndex: 3 : SourceIndex != DestIndex                                                    
    //                                      │                                     ┌─────────────┬─────────────┬────────────┬────────────┬────────────┬────────────┐         
    //                                      │                         Primitives: │ SceneInfo6  │ SceneInfo7  │ SceneInfo2 │ SceneInfo3 │ SceneInfo4 │ SceneInfo5 │         
    //                                      │                                     └─────────────┴─────────────┴────────────┴─────▲──────┴────────────┴──────▲─────┘         
    //                                      │                                                                                    │                          │               
    //                                      │                                                                                    └──────────────────────────┘               
    //                                      │                                                                                                                               
    //                                      │                                                                                                                               
    //                                      └───TypeIndex == 2: (PrimitiveSceneProxy, 5) == TypeOffsetTable[2]                                                              
    //                                          Increase TypeOffsetTable[TypeIndex].Offset                                                                                  
    //                                           :DestIndex = TypeOffsetTable[TypeIndex].Offset++ ───► (PrimitiveSceneProxy, 6)                                             
    //                                                                                                                                                                      
    //                                                                                                                                                                      
    //                                                                                                                                                                      
    //                                                                                                                                                                      
    //                  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐                                     
    //                  │      *** Final Result:                                                                                      │                                     
    //                  │                                                                                                             │                                     
    //                  │                                                                                                             │                                     
    //                  │                      StaticMeshSceneProxy   SkeletalMeshSceneProxy                  PrimitiveSceneProxy     │                                     
    //                  │                           │                         │                                  │                    │                                     
    //                  │                           │      │                  │                    │             │           │        │                                     
    //                  │                           ▼      │                  ▼                    │             ▼           │        │                                     
    //                  │                    ┌─────────────┼─────────────┬────────────┬────────────┼────────────┬────────────┤        │                                     
    //                  │        Primitives: │ SceneInfo6  │ SceneInfo7  │ SceneInfo2 │ SceneInfo3 │ SceneInfo4 │ SceneInfo5 │        │                                     
    //                  │                    └─────────────┼─────────────┴────────────┴────────────┼────────────┴────────────┤        │                                     
    //                  │                                  │                                       │                         │        │                                     
    //                  │                                                                                                             │                                     
    //                  │                                                                                                             │                                     
    //                  │                    ┌─────────────────────────┬────────────────────────────┬─────────────────────────┐       │                                     
    //                  │   TypeOffsetTable: │(StaticMeshSceneProxy, 1)│ (SkeletalMeshSceneProxy, 4)│ (PrimitiveSceneProxy, 6)│       │                                     
    //                  │                    └─────────────────────────┴────────────────────────────┴─────────────────────────┘       │                                     
    //                  │                                                                                                             │                                     
    //                  │                                                                                                             │                                     
    //                  └─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘                                     
    //   
    // the conceptual overview is a little bit complicated, but you are now ready to understand the below code!
    // - I hope you to help your understanding the below logic with the diagram~ :)                                                                                                                                                           
    while (AddedLocalPrimitiveSceneInfos.Num())
    {
        // 1. as we said, it starts the end of block which has the same proxy type(e.g. SkeletalMeshSceneProxy) in 'AddedLocalPrimitiveSceneInfos'
        int32 StartIndex = AddedLocalPrimitiveSceneInfos.Num() - 1;
        SIZE_T InsertProxyHash = AddedPrimitiveSceneInfos[StartIndex]->Proxy->GetTypeHash();
        while (StartIndex > 0 && AddedLocalPrimitiveSceneInfos[StartIndex - 1]->Proxy->GetTypeHash() == InsertProxyHash)
        {
            StartIndex--;
        }

        // 2-1. we add all SceneInfos in the block which has same proxy type at the end of SOA of the scene
        {
            for (int32 AddIndex = StartIndex; AddIndex < AddedLocalPrimitiveSceneInfos.Num(); ++AddIndex)
            {
                FPrimitiveSceneInfo* PrimitiveSceneInfo = AddedLocalPrimitiveSceneInfos[AddIndex];
                Primitives.Add(PrimitiveSceneInfo);

                const FMatrix LocalToWorld = PrimitiveSceneInfo->Proxy->GetLocalToWorld();
                PrimitiveTransforms.Add(LocalToWorld);

                PrimitiveSceneProxies.Add(PrimitiveSceneInfo->Proxy);
                PrimitiveBounds.AddUninitialized();
                
                //...

                // note that we cached our current index of the SOA in the FPrimitiveSceneInfo::PackedIndex
                const int32 SourceIndex = PrimitiveSceneProxies.Num() - 1;
                PrimitiveSceneInfo->PackedIndex = SourceIndex;

                //...
            }
        }

        // 2-2. we try to find TypeOffsetTableEntry matching proxy type 
        // - 'BroadIndex' is the index of TypeOffsetTable
        bool EntryFound = false;
        int32 BroadIndex = -1;
        {
            // broad phase search for a matching type
            for (BroadIndex = TypeOffsetTable.Num() - 1; BroadIndex >= 0; BroadIndex--)
            {
                // example how the prefix sum of the tails could look like:
                // we already covered the simple example to understand how the overall logic works
                // - let's deal with the comments of UnrealEngine
                // PrimitiveSceneProxies[0,0,0,6,6,6,6,6,2,2,2,2,1,1,1,7,4,8]
                // TypeOffsetTable[3,8,12,15,16,17,18] 

                // as we saw that 'ProxyHash' is the type-id of SceneProxy
                if (TypeOffsetTable[BroadIndex].PrimitiveSceneProxyType == InsertProxyHash)
                {
                    EntryFound = true;
                    break;
                }
            }

            // new type encountered
            // if we failed to find 'EntryFound', we add 'new entry'
            if (EntryFound == false)
            {
                BroadIndex = TypeOffsetTable.Num();
                if (BroadIndex)
                {
                    // we get the last TypeOffset entry and get the 'offset' and using it, create new entry
                    FTypeOffsetTableEntry Entry = TypeOffsetTable[BroadIndex - 1];

                    // adding to the end of the list and offset of the tail (will be incremented once during the while loop)
                    TypeOffsetTable.Push(FTypeOffsetTableEntry(InsertProxyHash, Entry.Offset));
                }
                else
                {
                    // starting with an empty list and offset zero (will be incremented once during during the while loop)
                    TypeOffsetTable.Push(FTypeOffsetTableEntry(InsertProxyHash, 0));
                }
            }
        }

        // swap PrimitiveSceneInfos
        // 2-3. swap the SOA of the scene
        {
            for (int32 AddIndex = StartIndex; AddIndex < AddedLocalPrimitiveSceneInfos.Num(); AddIndex++)
            {
                // PackedIndex already is cached when adding it at the end of 'AddedLocalPrimitiveSceneInfos' in 2-1
                int32 SourceIndex = AddedLocalPrimitiveSceneInfos[AddIndex]->PackedIndex;

                // 'BroadIndex' is calculated at the phase 2-2
                for (int32 TypeIndex = BroadIndex; TypeIndex < TypeOffsetTable.Num(); TypeIndex++)
                {
                    FTypeOffsetTableEntry& NextEntry = TypeOffsetTable[TypeIndex];
                    int32 DestIndex = NextEntry.Offset++;

                    // example swap chain of inserting a type of 6 at the end
                    // 1. PrimitiveSceneProxies[0,0,0,6,6,6,6,6,2,2,2,2,1,1,1,7,4,8,[6]]
                    // - TypeOffsetTable[3,8,12,15,16,17,18] 

                    // 2. PrimitiveSceneProxies[0,0,0,6,6,6,6,6,[6],2,2,2,1,1,1,7,4,8,[2]]
                    // - TypeOffsetTable[3,[9],12,15,16,17,18] 

                    // 3. PrimitiveSceneProxies[0,0,0,6,6,6,6,6,6,2,2,2,[2],1,1,7,4,8,[1]]
                    // - TypeOffsetTable[3,9,[13],15,16,17,18] 

                    // 4. PrimitiveSceneProxies[0,0,0,6,6,6,6,6,6,2,2,2,2,1,1,[1],4,8,[7]]
                    // - TypeOffsetTable[3,9,13,[16],16,17,18] 

                    // 5. PrimitiveSceneProxies[0,0,0,6,6,6,6,6,6,2,2,2,2,1,1,1,[7],8,[4]]
                    // - TypeOffsetTable[3,9,13,16,[17],17,18] 

                    // 6. PrimitiveSceneProxies[0,0,0,6,6,6,6,6,6,2,2,2,2,1,1,1,7,[4],[8]]
                    // - TypeOffsetTable[3,9,13,16,17,[18],18] 

                    // 7. no swap happens(DestIndex != SourceIndex), but TypeOffsetTableEntry's Offset is updated
                    // - TypeOffsetTable[3,9,13,16,17,18,[19]]

                    if (DestIndex != SourceIndex)
                    {
                        Primitives[DestIndex]->PackedIndex = SourceIndex;
                        Primitives[SourceIndex]->PackedIndex = DestIndex;

                        TArraySwapElements(Primitives, DestIndex, SourceIndex);
                        TArraySwapElements(PrimitiveTransforms, DestIndex, SourceIndex);
                        TArraySwapElements(PrimitiveSceneProxies, DestIndex, SourceIndex);
                        TArraySwapElements(PrimitiveBounds, DestIndex, SourceIndex);

                        //...
                    }
                }
            }
        }

        // the SOA order in the scene is updated, now it is time to initialize(or update) data of SOA in the scene e.g. Bounds, MeshDrawCommand, ...
        for (int AddIndex = StartIndex; AddIndex < AddedLocalPrimitiveSceneInfos.Num(); AddIndex++)
        {
            FPrimitiveSceneInfo* PrimitiveSceneInfo = AddedLocalPrimitiveSceneInfos[AddIndex];
            int32 PrimitiveIndex = PrimitiveSceneInfo->PackedIndex;

            // create UniformBuffer for each SceneProxy
            FPrimitiveSceneProxy* SceneProxy = PrimitiveSceneInfo->Proxy;
            SceneProxy->CreateUniformBuffer();

            //...

            // we queue the newly added and sorted SceneInfo:
            // 1. see QueueAddToScene
            // 2. see QueueAddStaticMeshes
            QueueAddToScene(PrimitiveSceneInfo);
            QueueAddStaticMeshes(PrimitiveSceneInfo);
        }

        //...

        // we successfully add all SceneInfo in the block, so remove elements in the block
        // - we're ready to iterate next block
        AddedLocalPrimitiveSceneInfos.RemoveAt(Start, AddedLocalPrimitiveSceneInfos.Num() - StartIndex, false);

    } // END: while (AddedLocalPrimitiveSceneInfos.Num())

    //...

    // update accumulated 'FUpdateTransformCommand's in the 'UpdatedTransforms'
    {
        for (const auto& Transform : UpdatedTransforms)
        {
            FPrimitiveSceneProxy* PrimitiveSceneProxy = Transform.Key;
            if (DeletedSceneInfos.Contains(PrimitiveSceneProxy->GetPrimitiveSceneInfo()))
            {
                continue;
            }

            const FBoxSphereBounds& WorldBounds = Transform.Value.WorldBounds;
            const FBoxSphereBounds& LocalBounds = Transform.Value.LocalBounds;
            const FMatrix& LocalToWorld = Transform.Value.LocalToWorld;
            const FVector& AttachmentRootPosition = Transform.Value.AttachmentRootPosition;
            
            //...

            // update the primitive transform
            // we already had seen FPrimitiveSceneProxy::SetTransform()
            // - rather removing and adding FPrimitiveSceneInfo to update transform, this is a way more cheaper as performance
            PrimitiveSceneProxy->SetTransform(LocalToWorld, WorldBounds, LocalBounds, AttachmentRootPosition);
            PrimitiveTransforms[PrimitiveSceneInfo->PackedIndex] = LocalToWorld;

            //...
        }
    }

    //...

    // we already accumulated SceneInfosWithAddToScene after finishing to add and sort new SceneInfos into the SOA of the scene
    // - see FPrimitiveSceneInfo::AddToScene (goto 040: SceneRenderer)
    if (SceneInfosWithAddToScene.Num() > 0)
    {
        FPrimitiveSceneInfo::AddToScene(this, SceneInfosWithAddToScene);
    }

    //...

    // we are not covering MeshDrawCommand in detail, but let's briefly understand it conceptually with the diagram:
    //
    //                                                                                                              ┌────────────────────────────┐                                                          
    //                                                                                   ***                        │                            │                                                          
    //                                                                       ───────────────────────────────────────┴──                          │                                                          
    //                                                SkeletalMeshComponent: SkeletalMeshSceneProxy(PrimitiveSceneInfo)                          │                                                          
    //                Root                                                                                                                       │                                                          
    //                 ▲                                 ┌──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┐                     │                                                          
    //                 │                  Vertex Buffer: │ 0│ 1│ 2│ 3│ 4│ 5│ 6│ 7│ 8│ 9│10│11│12│13│14│15│16│17│18│19│20│21│                     │                                                          
    //                Pelvis                             ├──┴──┴──┴──┴──┴──┼──┴──┴──┴──┼──┴──┴──┴──┴──┼──┴──┴──┴──┼──┴──┴──┤                     │                                                          
    //                 ▲                   Index Buffer: │   [0,5]         │  [6,9]    │   [10,14]    │  [15,18]  │ [19,21]│                     │                                                          
    //                 │                                 │◄───────────────►│◄─────────►│◄────────────►│◄─────────►│◄──────►│                     │                                                          
    //       ┌─────────┼─────────┐                       │   R_Leg         │  L_Leg    │   Head       │  R_Arm    │ R_Hand │                     │                                                          
    //       │         │         │                           +Mat0            +Mat1        +Mat2         +Mat3      +Mat4                        │                                                          
    //      L_Leg     Spine     R_Leg                          │                │            │             │            │                        │ Primitive can be splited into multiple MeshDrawCommands  
    //       ▲          ▲        ▲                             │                │            │             │            │                        │ ──────────────────────────────────────────────────────── 
    //       │          │        │                             ▼                ▼            │             ▼            │                        │           ***                                            
    //     L_Foot       │       R_Foot             MeshDrawCommand0      MeshDrawCommand1    │          MeshDrawCommand3│                        │            │                                             
    //             ┌────┼──────┐                                                             ▼                          ▼                        │            │                                             
    //             │    │      │                                                         MeshDrawCommand2             MeshDrawCommand4           │            │ How MeshDrawCommand consists of?            
    //             │    │      │                                                                                                                 │            │ : MeshDrawCommand is the cache state unit of rendering in GPU                                            
    //           L_Arm  Head  R_Arm                                                                                                              │            │   ──────────────────────────────────────────────────────────                                          
    //             ▲            ▲                                                                                                                │            ▼                     ****                        
    //             │            │                                                                                                                │         MeshDrawCommand                                  
    //          L_Hand        R_Hand                     ┌────────────────┬────────────────┬────────────────┬────────────────┬────────────────┐  │          │                                               
    //                                                   │MeshDrawCommand0│MeshDrawCommand1│MeshDrawCommand2│MeshDrawCommand3│MeshDrawCommand4│◄─┘          ├──PipelineStateObject(PSO)                     
    //                                                   └────────────────┴────────────────┴────────────────┴────────────────┴────────────────┘             │   │                                           
    //                                                                                                                                                      │   ├──VertexShader                             
    //                                                                                                                                                      │   │                                           
    //                                                                                                                                                      │   ├──PixelShader                              
    //                                                                                                                                                      │   │                                           
    //                                                                                                                                                      │   └──RasterizedState                          
    //                                                                                                                                                      │                                               
    //                                                                                                                                                      └──Vertex Buffer + Index Buffer                 
    //                                                                                                                                                                                                      
    if (SceneInfosWithStaticDrawListUpdate.Num() > 0)
    {
        CacheMeshDrawCommandsTask = GraphBuilder.AddSetupTask([this, &SceneInfosWithStaticDrawListUpdate, bLaunchAsyncTask]()
        {
            // CacheMeshDrawCommands
            FPrimitiveSceneInfo::CacheMeshDrawCommands(this, SceneInfosWithStaticDrawListUpdate);
        }, IsMobilePlatform(GetShaderPlatform()) ? CreateLightPrimitiveInteractionsTask : UE::Tasks::FTask(), UE::Tasks::ETaskPriority::High, bLaunchAsyncTask);

        //...
    }

    AddedPrimitiveSceneInfos.Empty();
}
```