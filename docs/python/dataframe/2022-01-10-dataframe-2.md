---
layout: default
title: 2. Dataframe 그룹핑
parent: (Dataframe)
grand_parent: Python
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## Install Library


```python
!pip install finance-datareader
!pip install beautifulsoup4 
!pip install numpy
!pip install pandas
```


```python
# default settings
import numpy as np
import pandas as pd

# jupyter notebook 여러 실행인자 실행해도 print되게 만들기
from IPython.core.interactiveshell import InteractiveShell
InteractiveShell.ast_node_interactivity = "all"

pd.set_option('display.float_format', lambda x: '%.3f' % x)
pd.set_option('max_columns', None)
```

---

### 데이터 준비


```python
df = pd.read_csv("data/2016_12.csv")
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ticker</th>
      <th>매출액(억원)</th>
      <th>영업이익률(%)</th>
      <th>순이익률(%)</th>
      <th>당기순이익(억원)</th>
      <th>ROE(%)</th>
      <th>ROA(%)</th>
      <th>ROIC(%)</th>
      <th>EPS(원)</th>
      <th>BPS(원)</th>
      <th>SPS(원)</th>
      <th>PER(배)</th>
      <th>PBR(배)</th>
      <th>PSR(배)</th>
      <th>price</th>
      <th>price2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AK홀딩스</td>
      <td>29218.310</td>
      <td>7.313</td>
      <td>4.563</td>
      <td>1333.223</td>
      <td>12.193</td>
      <td>5.091</td>
      <td>15.515</td>
      <td>5436.413</td>
      <td>48112.402</td>
      <td>220556.160</td>
      <td>10.301</td>
      <td>1.164</td>
      <td>0.254</td>
      <td>56000.000</td>
      <td>68500.000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BGF</td>
      <td>860.773</td>
      <td>9.315</td>
      <td>214.481</td>
      <td>1846.192</td>
      <td>21.624</td>
      <td>10.433</td>
      <td>8.015</td>
      <td>3703.577</td>
      <td>18648.623</td>
      <td>1737.263</td>
      <td>22.757</td>
      <td>4.519</td>
      <td>48.514</td>
      <td>42140.000</td>
      <td>15250.000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>BNK금융지주</td>
      <td>49126.760</td>
      <td>14.499</td>
      <td>10.546</td>
      <td>5181.144</td>
      <td>7.919</td>
      <td>0.564</td>
      <td>NaN</td>
      <td>1568.237</td>
      <td>20810.660</td>
      <td>15358.993</td>
      <td>5.535</td>
      <td>0.417</td>
      <td>0.565</td>
      <td>8680.000</td>
      <td>9420.000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>BYC</td>
      <td>2118.576</td>
      <td>7.625</td>
      <td>8.281</td>
      <td>175.433</td>
      <td>4.543</td>
      <td>2.463</td>
      <td>10.748</td>
      <td>20872.312</td>
      <td>471887.000</td>
      <td>252211.450</td>
      <td>19.020</td>
      <td>0.841</td>
      <td>1.574</td>
      <td>397000.000</td>
      <td>306000.000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>CJ</td>
      <td>239541.970</td>
      <td>5.230</td>
      <td>2.379</td>
      <td>5698.234</td>
      <td>6.080</td>
      <td>2.253</td>
      <td>5.158</td>
      <td>6257.152</td>
      <td>114276.080</td>
      <td>672045.900</td>
      <td>28.181</td>
      <td>1.543</td>
      <td>0.262</td>
      <td>176334.000</td>
      <td>171148.000</td>
    </tr>
  </tbody>
</table>
</div>



---


```python
# 수익률을 구해보자
    # 참고로 price2 : 17.12 종가
    # price : 16.12 종가 이다.
df['rtn'] = df['price2'] / df['price'] - 1
df[['ticker', 'rtn']].head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ticker</th>
      <th>rtn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AK홀딩스</td>
      <td>0.223</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BGF</td>
      <td>-0.638</td>
    </tr>
    <tr>
      <th>2</th>
      <td>BNK금융지주</td>
      <td>0.085</td>
    </tr>
    <tr>
      <th>3</th>
      <td>BYC</td>
      <td>-0.229</td>
    </tr>
    <tr>
      <th>4</th>
      <td>CJ</td>
      <td>-0.029</td>
    </tr>
  </tbody>
</table>
</div>



---

## 값을 기준으로 grouping


```python
# 아래와 같은 네 가지 그룹으로 나눠보자
bound1 = df['PER(배)'] >= 10
bound2 = (5 <= df['PER(배)']) & (df['PER(배)'] < 10)
bound3 = (0 <= df['PER(배)']) & (df['PER(배)'] < 5)
bound4 = df['PER(배)'] < 0
```


```python
# PER이 10보다 큰 애들만 출력
df[bound1].head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ticker</th>
      <th>매출액(억원)</th>
      <th>영업이익률(%)</th>
      <th>순이익률(%)</th>
      <th>당기순이익(억원)</th>
      <th>ROE(%)</th>
      <th>ROA(%)</th>
      <th>ROIC(%)</th>
      <th>EPS(원)</th>
      <th>BPS(원)</th>
      <th>SPS(원)</th>
      <th>PER(배)</th>
      <th>PBR(배)</th>
      <th>PSR(배)</th>
      <th>price</th>
      <th>price2</th>
      <th>rtn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AK홀딩스</td>
      <td>29218.310</td>
      <td>7.313</td>
      <td>4.563</td>
      <td>1333.223</td>
      <td>12.193</td>
      <td>5.091</td>
      <td>15.515</td>
      <td>5436.413</td>
      <td>48112.402</td>
      <td>220556.160</td>
      <td>10.301</td>
      <td>1.164</td>
      <td>0.254</td>
      <td>56000.000</td>
      <td>68500.000</td>
      <td>0.223</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BGF</td>
      <td>860.773</td>
      <td>9.315</td>
      <td>214.481</td>
      <td>1846.192</td>
      <td>21.624</td>
      <td>10.433</td>
      <td>8.015</td>
      <td>3703.577</td>
      <td>18648.623</td>
      <td>1737.263</td>
      <td>22.757</td>
      <td>4.519</td>
      <td>48.514</td>
      <td>42140.000</td>
      <td>15250.000</td>
      <td>-0.638</td>
    </tr>
    <tr>
      <th>3</th>
      <td>BYC</td>
      <td>2118.576</td>
      <td>7.625</td>
      <td>8.281</td>
      <td>175.433</td>
      <td>4.543</td>
      <td>2.463</td>
      <td>10.748</td>
      <td>20872.312</td>
      <td>471887.000</td>
      <td>252211.450</td>
      <td>19.020</td>
      <td>0.841</td>
      <td>1.574</td>
      <td>397000.000</td>
      <td>306000.000</td>
      <td>-0.229</td>
    </tr>
    <tr>
      <th>4</th>
      <td>CJ</td>
      <td>239541.970</td>
      <td>5.230</td>
      <td>2.379</td>
      <td>5698.234</td>
      <td>6.080</td>
      <td>2.253</td>
      <td>5.158</td>
      <td>6257.152</td>
      <td>114276.080</td>
      <td>672045.900</td>
      <td>28.181</td>
      <td>1.543</td>
      <td>0.262</td>
      <td>176334.000</td>
      <td>171148.000</td>
      <td>-0.029</td>
    </tr>
    <tr>
      <th>5</th>
      <td>CJ CGV</td>
      <td>14322.454</td>
      <td>4.911</td>
      <td>0.393</td>
      <td>56.217</td>
      <td>3.105</td>
      <td>0.284</td>
      <td>2.919</td>
      <td>583.051</td>
      <td>17654.154</td>
      <td>67682.260</td>
      <td>120.744</td>
      <td>3.988</td>
      <td>1.040</td>
      <td>70400.000</td>
      <td>74200.000</td>
      <td>0.054</td>
    </tr>
  </tbody>
</table>
</div>



---

그룹으로 나눠보자


```python
"""
bound1 = df['PER(배)'] >= 10
bound2 = (5 <= df['PER(배)']) & (df['PER(배)'] < 10)
bound3 = (0 <= df['PER(배)']) & (df['PER(배)'] < 5)
bound4 = df['PER(배)'] < 0
위 조건에 따라 값을 나눈다
"""

df.loc[bound1, 'PER_Score'] = 1
df.loc[bound2, 'PER_Score'] = 2
df.loc[bound3, 'PER_Score'] = 3
df.loc[bound4, 'PER_Score'] = -1
```




    "\nbound1 = df['PER(배)'] >= 10\nbound2 = (5 <= df['PER(배)']) & (df['PER(배)'] < 10)\nbound3 = (0 <= df['PER(배)']) & (df['PER(배)'] < 5)\nbound4 = df['PER(배)'] < 0\n위 조건에 따라 값을 나눈다\n"




```python
df['PER_Score'].head()
```




    0   1.000
    1   1.000
    2   2.000
    3   1.000
    4   1.000
    Name: PER_Score, dtype: float64



---


```python
df['PER_Score'].nunique()
```




    4



---


```python
# 각 그룹별로 몇개인지 출력
df['PER_Score'].value_counts()
```




    1.000     378
    2.000     148
    -1.000    120
    3.000      23
    Name: PER_Score, dtype: int64



---


```python
# nan가 있는지 체크해보자
df['PER_Score'].hasnans
```




    True



---


```python
# nan이 몇개나 있지?
df['PER_Score'].isna().sum()
```




    12



---


```python
# PER_Score를 만드는 PER(배)를 먼저 분석해 보자
df['PER(배)'].isna().sum()
```




    12



---

역시 PER(배)에서 부터 nan이 존재한다


```python
df[df['PER(배)'].isna()].head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ticker</th>
      <th>매출액(억원)</th>
      <th>영업이익률(%)</th>
      <th>순이익률(%)</th>
      <th>당기순이익(억원)</th>
      <th>ROE(%)</th>
      <th>ROA(%)</th>
      <th>ROIC(%)</th>
      <th>EPS(원)</th>
      <th>BPS(원)</th>
      <th>SPS(원)</th>
      <th>PER(배)</th>
      <th>PBR(배)</th>
      <th>PSR(배)</th>
      <th>price</th>
      <th>price2</th>
      <th>rtn</th>
      <th>PER_Score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>27</th>
      <td>HSD엔진</td>
      <td>8029.166</td>
      <td>0.528</td>
      <td>-22.571</td>
      <td>-1812.265</td>
      <td>-32.685</td>
      <td>-13.120</td>
      <td>2.749</td>
      <td>-2607.575</td>
      <td>7687.264</td>
      <td>11552.757</td>
      <td>NaN</td>
      <td>0.404</td>
      <td>NaN</td>
      <td>2290.000</td>
      <td>2569.000</td>
      <td>0.122</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>103</th>
      <td>고려개발</td>
      <td>6238.648</td>
      <td>4.223</td>
      <td>-4.895</td>
      <td>-305.362</td>
      <td>141.454</td>
      <td>-4.903</td>
      <td>20.462</td>
      <td>-3118.716</td>
      <td>1988.392</td>
      <td>63716.438</td>
      <td>NaN</td>
      <td>6.327</td>
      <td>NaN</td>
      <td>12430.000</td>
      <td>11659.000</td>
      <td>-0.062</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>126</th>
      <td>까뮤이앤씨</td>
      <td>1397.081</td>
      <td>3.180</td>
      <td>2.331</td>
      <td>32.563</td>
      <td>6.721</td>
      <td>2.390</td>
      <td>7.808</td>
      <td>72.117</td>
      <td>1153.474</td>
      <td>3094.153</td>
      <td>NaN</td>
      <td>0.958</td>
      <td>NaN</td>
      <td>1105.000</td>
      <td>1010.000</td>
      <td>-0.086</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>133</th>
      <td>남영비비안</td>
      <td>2074.953</td>
      <td>-0.949</td>
      <td>-1.103</td>
      <td>-22.895</td>
      <td>-1.667</td>
      <td>-1.371</td>
      <td>-2.101</td>
      <td>-32.324</td>
      <td>2031.729</td>
      <td>3021.213</td>
      <td>NaN</td>
      <td>0.436</td>
      <td>NaN</td>
      <td>885.000</td>
      <td>777.000</td>
      <td>-0.122</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>203</th>
      <td>티탑스</td>
      <td>940.880</td>
      <td>-7.061</td>
      <td>-4.217</td>
      <td>-39.673</td>
      <td>-8.980</td>
      <td>-4.092</td>
      <td>NaN</td>
      <td>-1917.146</td>
      <td>19287.736</td>
      <td>44614.258</td>
      <td>NaN</td>
      <td>0.058</td>
      <td>NaN</td>
      <td>1115.000</td>
      <td>1575.000</td>
      <td>0.413</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>




```python
# PER_Score가 nan일 경우 0으로 채우자
df.loc[df['PER_Score'].isna(), "PER_Score"] = 0

# 혹은 이렇게 가능
# df['PER_Score'] = df['PER_Score'].fillna(0)
```


```python
df.loc[:, "PER_Score1"] = (bound1 * 1)  + (bound2 * 2) + (bound3 * 3) + (bound4 * -1) 
df['PER_Score1'].head()
```




    0    1
    1    1
    2    2
    3    1
    4    1
    Name: PER_Score1, dtype: int32



---


```python
# 이런식으로 처리시 nan이 애초에 존재하지 않는다
df['PER_Score1'].hasnans
```




    False



---


```python
# 두 PER Score는 같을까?
df['PER_Score'].equals(df['PER_Score1'])
```




    False



---


```python
# 데이터 타입자체가 다르다
df['PER_Score'].dtypes
df['PER_Score1'].dtypes
```




    dtype('float64')






    dtype('int32')



---


```python
# 데이터형을 통일시키면 같음.
df['PER_Score'].astype(int).equals(df['PER_Score1'])
```




    True



---

## 구간 나누기 함수 cut()


```python
per_cuts = pd.cut(
    df['PER(배)'],
    [-np.inf, 0, 5, 10, np.inf], 
     # -np.inf, 0 / 0, 5 / 5, 10 / 10, np.inf
     # 구간 중 하나로 
)

per_cuts.head()
```




    0    (10.0, inf]
    1    (10.0, inf]
    2    (5.0, 10.0]
    3    (10.0, inf]
    4    (10.0, inf]
    Name: PER(배), dtype: category
    Categories (4, interval[float64, right]): [(-inf, 0.0] < (0.0, 5.0] < (5.0, 10.0] < (10.0, inf]]



---


```python
# Interval이라는 자료형으로 들어가게 됨.
per_cuts.iloc[0]
```




    Interval(10.0, inf, closed='right')



---


```python
# 각 몇개씩 들어가 있는지 보자면.
per_cuts.value_counts()
```




    (10.0, inf]    378
    (5.0, 10.0]    148
    (-inf, 0.0]    120
    (0.0, 5.0]      23
    Name: PER(배), dtype: int64



---


```python
per_cuts.isna().sum()
```




    12



---


```python
bins = [-np.inf, 10, 20, np.inf]
labels = ['저평가주', '보통주', '고평가주']
per_cuts2 = pd.cut(
    df['PER(배)'], 
    bins=bins, 
    labels=labels
)
per_cuts2.head()
```




    0     보통주
    1    고평가주
    2    저평가주
    3     보통주
    4    고평가주
    Name: PER(배), dtype: category
    Categories (3, object): ['저평가주' < '보통주' < '고평가주']



---

## 개체수 기준으로 grouping - qcut()


```python
# qcut
pd.qcut(df['PER(배)'], 3, labels=[1,2,3]).head()
# pd.qcut(df['PER(배)'], 3, labels=[1,2,3]).value_counts()
```




    0    2
    1    3
    2    1
    3    3
    4    3
    Name: PER(배), dtype: category
    Categories (3, int64): [1 < 2 < 3]



---


```python
df.loc[:, 'PER_Score2'] = pd.qcut(df['PER(배)'], 10, labels=range(1, 11))
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ticker</th>
      <th>매출액(억원)</th>
      <th>영업이익률(%)</th>
      <th>순이익률(%)</th>
      <th>당기순이익(억원)</th>
      <th>ROE(%)</th>
      <th>ROA(%)</th>
      <th>ROIC(%)</th>
      <th>EPS(원)</th>
      <th>BPS(원)</th>
      <th>SPS(원)</th>
      <th>PER(배)</th>
      <th>PBR(배)</th>
      <th>PSR(배)</th>
      <th>price</th>
      <th>price2</th>
      <th>rtn</th>
      <th>PER_Score</th>
      <th>PER_Score1</th>
      <th>PER_Score2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AK홀딩스</td>
      <td>29218.310</td>
      <td>7.313</td>
      <td>4.563</td>
      <td>1333.223</td>
      <td>12.193</td>
      <td>5.091</td>
      <td>15.515</td>
      <td>5436.413</td>
      <td>48112.402</td>
      <td>220556.160</td>
      <td>10.301</td>
      <td>1.164</td>
      <td>0.254</td>
      <td>56000.000</td>
      <td>68500.000</td>
      <td>0.223</td>
      <td>1.000</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BGF</td>
      <td>860.773</td>
      <td>9.315</td>
      <td>214.481</td>
      <td>1846.192</td>
      <td>21.624</td>
      <td>10.433</td>
      <td>8.015</td>
      <td>3703.577</td>
      <td>18648.623</td>
      <td>1737.263</td>
      <td>22.757</td>
      <td>4.519</td>
      <td>48.514</td>
      <td>42140.000</td>
      <td>15250.000</td>
      <td>-0.638</td>
      <td>1.000</td>
      <td>1</td>
      <td>8</td>
    </tr>
    <tr>
      <th>2</th>
      <td>BNK금융지주</td>
      <td>49126.760</td>
      <td>14.499</td>
      <td>10.546</td>
      <td>5181.144</td>
      <td>7.919</td>
      <td>0.564</td>
      <td>NaN</td>
      <td>1568.237</td>
      <td>20810.660</td>
      <td>15358.993</td>
      <td>5.535</td>
      <td>0.417</td>
      <td>0.565</td>
      <td>8680.000</td>
      <td>9420.000</td>
      <td>0.085</td>
      <td>2.000</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>BYC</td>
      <td>2118.576</td>
      <td>7.625</td>
      <td>8.281</td>
      <td>175.433</td>
      <td>4.543</td>
      <td>2.463</td>
      <td>10.748</td>
      <td>20872.312</td>
      <td>471887.000</td>
      <td>252211.450</td>
      <td>19.020</td>
      <td>0.841</td>
      <td>1.574</td>
      <td>397000.000</td>
      <td>306000.000</td>
      <td>-0.229</td>
      <td>1.000</td>
      <td>1</td>
      <td>8</td>
    </tr>
    <tr>
      <th>4</th>
      <td>CJ</td>
      <td>239541.970</td>
      <td>5.230</td>
      <td>2.379</td>
      <td>5698.234</td>
      <td>6.080</td>
      <td>2.253</td>
      <td>5.158</td>
      <td>6257.152</td>
      <td>114276.080</td>
      <td>672045.900</td>
      <td>28.181</td>
      <td>1.543</td>
      <td>0.262</td>
      <td>176334.000</td>
      <td>171148.000</td>
      <td>-0.029</td>
      <td>1.000</td>
      <td>1</td>
      <td>9</td>
    </tr>
  </tbody>
</table>
</div>



---


```python
df['PER_Score2'].value_counts()
```




    1     67
    2     67
    3     67
    4     67
    5     67
    7     67
    8     67
    9     67
    10    67
    6     66
    Name: PER_Score2, dtype: int64



---


```python
# 역시 nan는 있다
df['PER_Score2'].hasnans
```




    True



---


```python
df = df.dropna(subset=['PER(배)'])
```


```python
df['PER_Score2'].isna().sum()
```




    0



---

## 데이터 세팅


```python
df = pd.read_csv("data/2016_12.csv")
df = df.dropna()
```


```python
g_df = df.copy()
g_df['rtn'] = g_df['price2'] / g_df['price'] - 1
g_df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ticker</th>
      <th>매출액(억원)</th>
      <th>영업이익률(%)</th>
      <th>순이익률(%)</th>
      <th>당기순이익(억원)</th>
      <th>ROE(%)</th>
      <th>ROA(%)</th>
      <th>ROIC(%)</th>
      <th>EPS(원)</th>
      <th>BPS(원)</th>
      <th>SPS(원)</th>
      <th>PER(배)</th>
      <th>PBR(배)</th>
      <th>PSR(배)</th>
      <th>price</th>
      <th>price2</th>
      <th>rtn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AK홀딩스</td>
      <td>29218.310</td>
      <td>7.313</td>
      <td>4.563</td>
      <td>1333.223</td>
      <td>12.193</td>
      <td>5.091</td>
      <td>15.515</td>
      <td>5436.413</td>
      <td>48112.402</td>
      <td>220556.160</td>
      <td>10.301</td>
      <td>1.164</td>
      <td>0.254</td>
      <td>56000.000</td>
      <td>68500.000</td>
      <td>0.223</td>
    </tr>
    <tr>
      <th>1</th>
      <td>BGF</td>
      <td>860.773</td>
      <td>9.315</td>
      <td>214.481</td>
      <td>1846.192</td>
      <td>21.624</td>
      <td>10.433</td>
      <td>8.015</td>
      <td>3703.577</td>
      <td>18648.623</td>
      <td>1737.263</td>
      <td>22.757</td>
      <td>4.519</td>
      <td>48.514</td>
      <td>42140.000</td>
      <td>15250.000</td>
      <td>-0.638</td>
    </tr>
    <tr>
      <th>3</th>
      <td>BYC</td>
      <td>2118.576</td>
      <td>7.625</td>
      <td>8.281</td>
      <td>175.433</td>
      <td>4.543</td>
      <td>2.463</td>
      <td>10.748</td>
      <td>20872.312</td>
      <td>471887.000</td>
      <td>252211.450</td>
      <td>19.020</td>
      <td>0.841</td>
      <td>1.574</td>
      <td>397000.000</td>
      <td>306000.000</td>
      <td>-0.229</td>
    </tr>
    <tr>
      <th>4</th>
      <td>CJ</td>
      <td>239541.970</td>
      <td>5.230</td>
      <td>2.379</td>
      <td>5698.234</td>
      <td>6.080</td>
      <td>2.253</td>
      <td>5.158</td>
      <td>6257.152</td>
      <td>114276.080</td>
      <td>672045.900</td>
      <td>28.181</td>
      <td>1.543</td>
      <td>0.262</td>
      <td>176334.000</td>
      <td>171148.000</td>
      <td>-0.029</td>
    </tr>
    <tr>
      <th>5</th>
      <td>CJ CGV</td>
      <td>14322.454</td>
      <td>4.911</td>
      <td>0.393</td>
      <td>56.217</td>
      <td>3.105</td>
      <td>0.284</td>
      <td>2.919</td>
      <td>583.051</td>
      <td>17654.154</td>
      <td>67682.260</td>
      <td>120.744</td>
      <td>3.988</td>
      <td>1.040</td>
      <td>70400.000</td>
      <td>74200.000</td>
      <td>0.054</td>
    </tr>
  </tbody>
</table>
</div>



---


```python
g_df.loc[:, 'PER_score'] = pd.qcut(g_df['PER(배)'], 10, labels=range(1, 11))
g_df.loc[:, 'PBR_score'] = pd.qcut(g_df['PBR(배)'], 10, labels=range(1, 11))
```


```python
g_df.set_index('ticker', inplace=True)
```


```python
g_df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>매출액(억원)</th>
      <th>영업이익률(%)</th>
      <th>순이익률(%)</th>
      <th>당기순이익(억원)</th>
      <th>ROE(%)</th>
      <th>ROA(%)</th>
      <th>ROIC(%)</th>
      <th>EPS(원)</th>
      <th>BPS(원)</th>
      <th>SPS(원)</th>
      <th>PER(배)</th>
      <th>PBR(배)</th>
      <th>PSR(배)</th>
      <th>price</th>
      <th>price2</th>
      <th>rtn</th>
      <th>PER_score</th>
      <th>PBR_score</th>
    </tr>
    <tr>
      <th>ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AK홀딩스</th>
      <td>29218.310</td>
      <td>7.313</td>
      <td>4.563</td>
      <td>1333.223</td>
      <td>12.193</td>
      <td>5.091</td>
      <td>15.515</td>
      <td>5436.413</td>
      <td>48112.402</td>
      <td>220556.160</td>
      <td>10.301</td>
      <td>1.164</td>
      <td>0.254</td>
      <td>56000.000</td>
      <td>68500.000</td>
      <td>0.223</td>
      <td>5</td>
      <td>7</td>
    </tr>
    <tr>
      <th>BGF</th>
      <td>860.773</td>
      <td>9.315</td>
      <td>214.481</td>
      <td>1846.192</td>
      <td>21.624</td>
      <td>10.433</td>
      <td>8.015</td>
      <td>3703.577</td>
      <td>18648.623</td>
      <td>1737.263</td>
      <td>22.757</td>
      <td>4.519</td>
      <td>48.514</td>
      <td>42140.000</td>
      <td>15250.000</td>
      <td>-0.638</td>
      <td>8</td>
      <td>10</td>
    </tr>
    <tr>
      <th>BYC</th>
      <td>2118.576</td>
      <td>7.625</td>
      <td>8.281</td>
      <td>175.433</td>
      <td>4.543</td>
      <td>2.463</td>
      <td>10.748</td>
      <td>20872.312</td>
      <td>471887.000</td>
      <td>252211.450</td>
      <td>19.020</td>
      <td>0.841</td>
      <td>1.574</td>
      <td>397000.000</td>
      <td>306000.000</td>
      <td>-0.229</td>
      <td>8</td>
      <td>5</td>
    </tr>
    <tr>
      <th>CJ</th>
      <td>239541.970</td>
      <td>5.230</td>
      <td>2.379</td>
      <td>5698.234</td>
      <td>6.080</td>
      <td>2.253</td>
      <td>5.158</td>
      <td>6257.152</td>
      <td>114276.080</td>
      <td>672045.900</td>
      <td>28.181</td>
      <td>1.543</td>
      <td>0.262</td>
      <td>176334.000</td>
      <td>171148.000</td>
      <td>-0.029</td>
      <td>9</td>
      <td>8</td>
    </tr>
    <tr>
      <th>CJ CGV</th>
      <td>14322.454</td>
      <td>4.911</td>
      <td>0.393</td>
      <td>56.217</td>
      <td>3.105</td>
      <td>0.284</td>
      <td>2.919</td>
      <td>583.051</td>
      <td>17654.154</td>
      <td>67682.260</td>
      <td>120.744</td>
      <td>3.988</td>
      <td>1.040</td>
      <td>70400.000</td>
      <td>74200.000</td>
      <td>0.054</td>
      <td>10</td>
      <td>10</td>
    </tr>
  </tbody>
</table>
</div>



---

## groupby() vs aggregation()

### groupby()


```python
# "PBR_score", "PER_score"로 group을 생성해 달라
    # 예를들어 PBR_score(1), PER_score(2) 인 그룹
    # PBR_score(1), PER_score(3) 인 그룹
    # ...
g_df_obj = g_df.groupby(["PBR_score", "PER_score"])
g_df_obj
```




    <pandas.core.groupby.generic.DataFrameGroupBy object at 0x000001FD6D0BD180>



---


```python
# 타입조사
type(g_df_obj)
```




    pandas.core.groupby.generic.DataFrameGroupBy



---


```python
# 몇개의 그룹이 나올까?
g_df_obj.ngroups
```




    96



---


```python
g_df['PBR_score'].nunique()
g_df['PER_score'].nunique()
```




    10






    10



---


```python
# (참고) g_df_obj = g_df.groupby(["PBR_score", "PER_score"])

# 몇개씩 들어가 있는지 확인
g_df_obj.size().head()
```




    PBR_score  PER_score
    1          1             5
               2            11
               3            11
               4            11
               5             7
    dtype: int64



---


```python
# Multi-level index를 가진 Series indexing하는 법 
g_df_obj.size().loc[1]
g_df_obj.size().loc[2]
g_df_obj.size().loc[(1, 1)]
```




    PER_score
    1      5
    2     11
    3     11
    4     11
    5      7
    6      2
    7      4
    8      0
    9      3
    10     7
    dtype: int64






    PER_score
    1      6
    2      2
    3     10
    4      9
    5      8
    6      7
    7      5
    8      5
    9      5
    10     4
    dtype: int64






    5



---


```python
# 좀 보기 편하게 하기 위해서
    # Series -> DataFrame으로 변환
g_df_obj.size().to_frame().head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>0</th>
    </tr>
    <tr>
      <th>PBR_score</th>
      <th>PER_score</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">1</th>
      <th>1</th>
      <td>5</td>
    </tr>
    <tr>
      <th>2</th>
      <td>11</td>
    </tr>
    <tr>
      <th>3</th>
      <td>11</td>
    </tr>
    <tr>
      <th>4</th>
      <td>11</td>
    </tr>
    <tr>
      <th>5</th>
      <td>7</td>
    </tr>
  </tbody>
</table>
</div>



---


```python
# 이런식으로 keys와 value를 볼 수 있는데 너무 길어서 생략.
# g_df_obj.groups.keys()
# g_df_obj.groups.values()
```

---


```python
# 그룹에 속한 아이템 확인가능.
g_df_obj.get_group((1, 1))
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>매출액(억원)</th>
      <th>영업이익률(%)</th>
      <th>순이익률(%)</th>
      <th>당기순이익(억원)</th>
      <th>ROE(%)</th>
      <th>ROA(%)</th>
      <th>ROIC(%)</th>
      <th>EPS(원)</th>
      <th>BPS(원)</th>
      <th>SPS(원)</th>
      <th>PER(배)</th>
      <th>PBR(배)</th>
      <th>PSR(배)</th>
      <th>price</th>
      <th>price2</th>
      <th>rtn</th>
      <th>PER_score</th>
      <th>PBR_score</th>
    </tr>
    <tr>
      <th>ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>E1</th>
      <td>39959.008</td>
      <td>0.277</td>
      <td>-0.949</td>
      <td>-379.397</td>
      <td>-2.350</td>
      <td>-1.076</td>
      <td>-1.633</td>
      <td>-3869.011</td>
      <td>191789.690</td>
      <td>582492.800</td>
      <td>-16.206</td>
      <td>0.327</td>
      <td>0.108</td>
      <td>62700.000</td>
      <td>56900.000</td>
      <td>-0.093</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>S&amp;T중공업</th>
      <td>4680.078</td>
      <td>-0.309</td>
      <td>-5.221</td>
      <td>-244.358</td>
      <td>-3.671</td>
      <td>-2.697</td>
      <td>-0.791</td>
      <td>-734.851</td>
      <td>21043.785</td>
      <td>14074.280</td>
      <td>-12.369</td>
      <td>0.432</td>
      <td>0.646</td>
      <td>9089.000</td>
      <td>7310.000</td>
      <td>-0.196</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>디아이동일</th>
      <td>8224.145</td>
      <td>2.100</td>
      <td>0.132</td>
      <td>10.885</td>
      <td>-0.753</td>
      <td>0.111</td>
      <td>0.051</td>
      <td>-1523.407</td>
      <td>270773.030</td>
      <td>333554.280</td>
      <td>-37.365</td>
      <td>0.210</td>
      <td>0.171</td>
      <td>56922.000</td>
      <td>51884.000</td>
      <td>-0.089</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>한국수출포장공업</th>
      <td>2282.604</td>
      <td>1.344</td>
      <td>-0.091</td>
      <td>-2.075</td>
      <td>-0.092</td>
      <td>-0.069</td>
      <td>0.152</td>
      <td>-51.880</td>
      <td>56026.280</td>
      <td>57065.100</td>
      <td>-345.030</td>
      <td>0.319</td>
      <td>0.314</td>
      <td>17900.000</td>
      <td>15650.000</td>
      <td>-0.126</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>휴스틸</th>
      <td>3640.215</td>
      <td>0.370</td>
      <td>-0.153</td>
      <td>-5.562</td>
      <td>-0.143</td>
      <td>-0.101</td>
      <td>0.059</td>
      <td>-80.399</td>
      <td>55779.490</td>
      <td>52614.773</td>
      <td>-191.546</td>
      <td>0.276</td>
      <td>0.293</td>
      <td>15400.000</td>
      <td>15450.000</td>
      <td>0.003</td>
      <td>1</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>



---


```python
# for문을 통해 출력
for name, group in g_df_obj:
    name
    group.head()
    break
```




    (1, 1)






<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>매출액(억원)</th>
      <th>영업이익률(%)</th>
      <th>순이익률(%)</th>
      <th>당기순이익(억원)</th>
      <th>ROE(%)</th>
      <th>ROA(%)</th>
      <th>ROIC(%)</th>
      <th>EPS(원)</th>
      <th>BPS(원)</th>
      <th>SPS(원)</th>
      <th>PER(배)</th>
      <th>PBR(배)</th>
      <th>PSR(배)</th>
      <th>price</th>
      <th>price2</th>
      <th>rtn</th>
      <th>PER_score</th>
      <th>PBR_score</th>
    </tr>
    <tr>
      <th>ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>E1</th>
      <td>39959.008</td>
      <td>0.277</td>
      <td>-0.949</td>
      <td>-379.397</td>
      <td>-2.350</td>
      <td>-1.076</td>
      <td>-1.633</td>
      <td>-3869.011</td>
      <td>191789.690</td>
      <td>582492.800</td>
      <td>-16.206</td>
      <td>0.327</td>
      <td>0.108</td>
      <td>62700.000</td>
      <td>56900.000</td>
      <td>-0.093</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>S&amp;T중공업</th>
      <td>4680.078</td>
      <td>-0.309</td>
      <td>-5.221</td>
      <td>-244.358</td>
      <td>-3.671</td>
      <td>-2.697</td>
      <td>-0.791</td>
      <td>-734.851</td>
      <td>21043.785</td>
      <td>14074.280</td>
      <td>-12.369</td>
      <td>0.432</td>
      <td>0.646</td>
      <td>9089.000</td>
      <td>7310.000</td>
      <td>-0.196</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>디아이동일</th>
      <td>8224.145</td>
      <td>2.100</td>
      <td>0.132</td>
      <td>10.885</td>
      <td>-0.753</td>
      <td>0.111</td>
      <td>0.051</td>
      <td>-1523.407</td>
      <td>270773.030</td>
      <td>333554.280</td>
      <td>-37.365</td>
      <td>0.210</td>
      <td>0.171</td>
      <td>56922.000</td>
      <td>51884.000</td>
      <td>-0.089</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>한국수출포장공업</th>
      <td>2282.604</td>
      <td>1.344</td>
      <td>-0.091</td>
      <td>-2.075</td>
      <td>-0.092</td>
      <td>-0.069</td>
      <td>0.152</td>
      <td>-51.880</td>
      <td>56026.280</td>
      <td>57065.100</td>
      <td>-345.030</td>
      <td>0.319</td>
      <td>0.314</td>
      <td>17900.000</td>
      <td>15650.000</td>
      <td>-0.126</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>휴스틸</th>
      <td>3640.215</td>
      <td>0.370</td>
      <td>-0.153</td>
      <td>-5.562</td>
      <td>-0.143</td>
      <td>-0.101</td>
      <td>0.059</td>
      <td>-80.399</td>
      <td>55779.490</td>
      <td>52614.773</td>
      <td>-191.546</td>
      <td>0.276</td>
      <td>0.293</td>
      <td>15400.000</td>
      <td>15450.000</td>
      <td>0.003</td>
      <td>1</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>



---


```python
g_df.groupby('PER_score').size()
g_df.groupby('PER_score').head(1).head(5)
```




    PER_score
    1     61
    2     61
    3     61
    4     61
    5     61
    6     60
    7     61
    8     61
    9     61
    10    61
    dtype: int64






<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>매출액(억원)</th>
      <th>영업이익률(%)</th>
      <th>순이익률(%)</th>
      <th>당기순이익(억원)</th>
      <th>ROE(%)</th>
      <th>ROA(%)</th>
      <th>ROIC(%)</th>
      <th>EPS(원)</th>
      <th>BPS(원)</th>
      <th>SPS(원)</th>
      <th>PER(배)</th>
      <th>PBR(배)</th>
      <th>PSR(배)</th>
      <th>price</th>
      <th>price2</th>
      <th>rtn</th>
      <th>PER_score</th>
      <th>PBR_score</th>
    </tr>
    <tr>
      <th>ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AK홀딩스</th>
      <td>29218.310</td>
      <td>7.313</td>
      <td>4.563</td>
      <td>1333.223</td>
      <td>12.193</td>
      <td>5.091</td>
      <td>15.515</td>
      <td>5436.413</td>
      <td>48112.402</td>
      <td>220556.160</td>
      <td>10.301</td>
      <td>1.164</td>
      <td>0.254</td>
      <td>56000.000</td>
      <td>68500.000</td>
      <td>0.223</td>
      <td>5</td>
      <td>7</td>
    </tr>
    <tr>
      <th>BGF</th>
      <td>860.773</td>
      <td>9.315</td>
      <td>214.481</td>
      <td>1846.192</td>
      <td>21.624</td>
      <td>10.433</td>
      <td>8.015</td>
      <td>3703.577</td>
      <td>18648.623</td>
      <td>1737.263</td>
      <td>22.757</td>
      <td>4.519</td>
      <td>48.514</td>
      <td>42140.000</td>
      <td>15250.000</td>
      <td>-0.638</td>
      <td>8</td>
      <td>10</td>
    </tr>
    <tr>
      <th>CJ</th>
      <td>239541.970</td>
      <td>5.230</td>
      <td>2.379</td>
      <td>5698.234</td>
      <td>6.080</td>
      <td>2.253</td>
      <td>5.158</td>
      <td>6257.152</td>
      <td>114276.080</td>
      <td>672045.900</td>
      <td>28.181</td>
      <td>1.543</td>
      <td>0.262</td>
      <td>176334.000</td>
      <td>171148.000</td>
      <td>-0.029</td>
      <td>9</td>
      <td>8</td>
    </tr>
    <tr>
      <th>CJ CGV</th>
      <td>14322.454</td>
      <td>4.911</td>
      <td>0.393</td>
      <td>56.217</td>
      <td>3.105</td>
      <td>0.284</td>
      <td>2.919</td>
      <td>583.051</td>
      <td>17654.154</td>
      <td>67682.260</td>
      <td>120.744</td>
      <td>3.988</td>
      <td>1.040</td>
      <td>70400.000</td>
      <td>74200.000</td>
      <td>0.054</td>
      <td>10</td>
      <td>10</td>
    </tr>
    <tr>
      <th>DB</th>
      <td>2048.100</td>
      <td>5.324</td>
      <td>-10.113</td>
      <td>-207.128</td>
      <td>-13.052</td>
      <td>-8.434</td>
      <td>66.574</td>
      <td>-113.728</td>
      <td>881.178</td>
      <td>1124.549</td>
      <td>-6.454</td>
      <td>0.833</td>
      <td>0.653</td>
      <td>734.000</td>
      <td>658.000</td>
      <td>-0.104</td>
      <td>2</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div>



### aggreggation()


```python
g_df.groupby("PBR_score").agg(
    {
        "rtn": "mean", # =  np.mean
    }
)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rtn</th>
    </tr>
    <tr>
      <th>PBR_score</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>-0.001</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.020</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-0.021</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.161</td>
    </tr>
    <tr>
      <th>5</th>
      <td>-0.012</td>
    </tr>
    <tr>
      <th>6</th>
      <td>-0.043</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.150</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.058</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.139</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.054</td>
    </tr>
  </tbody>
</table>
</div>



---


```python
pbr_rtn_df = g_df.groupby("PBR_score").agg({'rtn': 'mean'})
per_rtn_df = g_df.groupby("PER_score").agg({'rtn': 'mean'})
```


```python
pbr_rtn_df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rtn</th>
    </tr>
    <tr>
      <th>PBR_score</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>-0.001</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.020</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-0.021</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.161</td>
    </tr>
    <tr>
      <th>5</th>
      <td>-0.012</td>
    </tr>
  </tbody>
</table>
</div>



---


```python
# 다양한 방법으로 진행하기 (같은 결과)
g_df.groupby("PER_score")['rtn'].agg('mean').head()
g_df.groupby("PER_score")['rtn'].agg(np.mean).head()
g_df.groupby("PER_score")['rtn'].mean().head()
```




    PER_score
    1   -0.062
    2   -0.083
    3   -0.038
    4    0.056
    5    0.000
    Name: rtn, dtype: float64






    PER_score
    1   -0.062
    2   -0.083
    3   -0.038
    4    0.056
    5    0.000
    Name: rtn, dtype: float64






    PER_score
    1   -0.062
    2   -0.083
    3   -0.038
    4    0.056
    5    0.000
    Name: rtn, dtype: float64



---


```python
# 단, return type이 다를 수 있음에 주의
g_df.groupby("PER_score")['rtn'].agg("mean").head(2)   # Series로 return
g_df.groupby("PER_score")[['rtn']].agg("mean").head(2)  # DataFrame으로 return
```




    PER_score
    1   -0.062
    2   -0.083
    Name: rtn, dtype: float64






<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rtn</th>
    </tr>
    <tr>
      <th>PER_score</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>-0.062</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.083</td>
    </tr>
  </tbody>
</table>
</div>



---


```python
# 2개 이상의 컬럼에 대해 aggregation
g_df.groupby("PER_score")[['rtn', 'PBR(배)']].agg("mean").head(2)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rtn</th>
      <th>PBR(배)</th>
    </tr>
    <tr>
      <th>PER_score</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>-0.062</td>
      <td>1.839</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.083</td>
      <td>1.323</td>
    </tr>
  </tbody>
</table>
</div>



---


```python
# 2개 이상의 aggregation
g_df.groupby("PER_score")[['rtn', 'PBR(배)']].agg(["mean", "std"]).head(2)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="2" halign="left">rtn</th>
      <th colspan="2" halign="left">PBR(배)</th>
    </tr>
    <tr>
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>mean</th>
      <th>std</th>
    </tr>
    <tr>
      <th>PER_score</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>-0.062</td>
      <td>0.328</td>
      <td>1.839</td>
      <td>2.215</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.083</td>
      <td>0.781</td>
      <td>1.323</td>
      <td>1.167</td>
    </tr>
  </tbody>
</table>
</div>



---


```python
# 2개 이상의 컬럼 & 각각에 대해 다른 aggregation
g_df.groupby("PBR_score").agg(
    {
        'rtn': ['mean', 'std'],
        'PER(배)': ['min']
        
    }
)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="2" halign="left">rtn</th>
      <th>PER(배)</th>
    </tr>
    <tr>
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
    </tr>
    <tr>
      <th>PBR_score</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>-0.001</td>
      <td>0.262</td>
      <td>-345.030</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.020</td>
      <td>0.280</td>
      <td>-319.356</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-0.021</td>
      <td>0.219</td>
      <td>-10.614</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.161</td>
      <td>0.770</td>
      <td>-938.983</td>
    </tr>
    <tr>
      <th>5</th>
      <td>-0.012</td>
      <td>0.265</td>
      <td>-62.397</td>
    </tr>
    <tr>
      <th>6</th>
      <td>-0.043</td>
      <td>0.251</td>
      <td>-310.606</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.150</td>
      <td>0.704</td>
      <td>-107.741</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.058</td>
      <td>0.472</td>
      <td>-27857.496</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.139</td>
      <td>0.669</td>
      <td>-352.735</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.054</td>
      <td>0.464</td>
      <td>-442.464</td>
    </tr>
  </tbody>
</table>
</div>



---


```python
# sqrt는 aggregation 방식의 연산이 아님!
np.sqrt([1, 2, 3, 4])
```




    array([1.        , 1.41421356, 1.73205081, 2.        ])



---


```python
# g_df.groupby("PER_score")['rtn'].agg(np.sqrt)
# error
```

---


```python
!pip install matplotlib
pbr_rtn_df.plot(kind='bar')
```


```python
pbr_rtn_df.plot(kind='bar');
per_rtn_df.plot(kind='bar');
```


    
![png](output_115_0.png)
    



    
![png](output_115_1.png)
    


---

## Example


```python
g_df1 = g_df.groupby(["PBR_score", "PER_score"])\
            .agg(
                {
                    'rtn': ['mean', 'std', 'min', 'max'],
                    'ROE(%)': [np.mean, 'size', 'nunique', 'idxmax'] 
                 }
            )
g_df1.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th colspan="4" halign="left">rtn</th>
      <th colspan="4" halign="left">ROE(%)</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>max</th>
      <th>mean</th>
      <th>size</th>
      <th>nunique</th>
      <th>idxmax</th>
    </tr>
    <tr>
      <th>PBR_score</th>
      <th>PER_score</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">1</th>
      <th>1</th>
      <td>-0.100</td>
      <td>0.072</td>
      <td>-0.196</td>
      <td>0.003</td>
      <td>-1.402</td>
      <td>5</td>
      <td>5</td>
      <td>한국수출포장공업</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.093</td>
      <td>0.266</td>
      <td>-0.482</td>
      <td>0.437</td>
      <td>154.967</td>
      <td>11</td>
      <td>11</td>
      <td>삼부토건</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.117</td>
      <td>0.359</td>
      <td>-0.556</td>
      <td>0.683</td>
      <td>6.952</td>
      <td>11</td>
      <td>11</td>
      <td>한국전력공사</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.106</td>
      <td>0.295</td>
      <td>-0.273</td>
      <td>0.882</td>
      <td>5.104</td>
      <td>11</td>
      <td>11</td>
      <td>한국공항</td>
    </tr>
    <tr>
      <th>5</th>
      <td>-0.039</td>
      <td>0.120</td>
      <td>-0.206</td>
      <td>0.113</td>
      <td>3.941</td>
      <td>7</td>
      <td>7</td>
      <td>성창기업지주</td>
    </tr>
  </tbody>
</table>
</div>



---


```python
a = g_df.groupby(["PBR_score", "PER_score"])['rtn', 'ROE(%)'].agg(['sum', 'mean'])
```

    C:\Users\TAEHYU~1\AppData\Local\Temp/ipykernel_10068/3376508614.py:1: FutureWarning: Indexing with multiple keys (implicitly converted to a tuple of keys) will be deprecated, use a list instead.
      a = g_df.groupby(["PBR_score", "PER_score"])['rtn', 'ROE(%)'].agg(['sum', 'mean'])
    

---


```python
# Multi-index라고 해서 쫄 것 없음!
a.loc[1]
a.loc[(1, 3)]
a.loc[[(1, 3), (1, 4 )]]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="2" halign="left">rtn</th>
      <th colspan="2" halign="left">ROE(%)</th>
    </tr>
    <tr>
      <th></th>
      <th>sum</th>
      <th>mean</th>
      <th>sum</th>
      <th>mean</th>
    </tr>
    <tr>
      <th>PER_score</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>-0.499</td>
      <td>-0.100</td>
      <td>-7.009</td>
      <td>-1.402</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-1.025</td>
      <td>-0.093</td>
      <td>1704.634</td>
      <td>154.967</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.290</td>
      <td>0.117</td>
      <td>76.477</td>
      <td>6.952</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.165</td>
      <td>0.106</td>
      <td>56.146</td>
      <td>5.104</td>
    </tr>
    <tr>
      <th>5</th>
      <td>-0.275</td>
      <td>-0.039</td>
      <td>27.590</td>
      <td>3.941</td>
    </tr>
    <tr>
      <th>6</th>
      <td>-0.666</td>
      <td>-0.333</td>
      <td>6.710</td>
      <td>3.355</td>
    </tr>
    <tr>
      <th>7</th>
      <td>-0.126</td>
      <td>-0.031</td>
      <td>11.435</td>
      <td>2.859</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.000</td>
      <td>NaN</td>
      <td>0.000</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>9</th>
      <td>-0.175</td>
      <td>-0.058</td>
      <td>3.039</td>
      <td>1.013</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.226</td>
      <td>0.032</td>
      <td>2.873</td>
      <td>0.410</td>
    </tr>
  </tbody>
</table>
</div>






    rtn     sum     1.290
            mean    0.117
    ROE(%)  sum    76.477
            mean    6.952
    Name: (1, 3), dtype: float64






<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th colspan="2" halign="left">rtn</th>
      <th colspan="2" halign="left">ROE(%)</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>sum</th>
      <th>mean</th>
      <th>sum</th>
      <th>mean</th>
    </tr>
    <tr>
      <th>PBR_score</th>
      <th>PER_score</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">1</th>
      <th>3</th>
      <td>1.290</td>
      <td>0.117</td>
      <td>76.477</td>
      <td>6.952</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.165</td>
      <td>0.106</td>
      <td>56.146</td>
      <td>5.104</td>
    </tr>
  </tbody>
</table>
</div>



---

* 주의: nan은 groupby시 자동으로 filter out 되기 때문에, 미리 전처리 다 하는게 좋음 


```python
df = pd.DataFrame({
    'a':['소형주', np.nan, '대형주', '대형주'],
    'b':[np.nan, 2,         3,     np.nan],
})
df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>a</th>
      <th>b</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>소형주</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>NaN</td>
      <td>2.000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>대형주</td>
      <td>3.000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>대형주</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>



---


```python
df.groupby(['a'])['b'].mean()
```




    a
    대형주   3.000
    소형주     NaN
    Name: b, dtype: float64



---

 * `as_index = False` : group cols들이 index가 아니라 하나의 col이 됨 (aggregate하고 reset_index()를 취한 것)


```python
a = g_df.groupby(["PER_score"]                ).agg({'rtn': ['mean', 'std']}).head(2)
b = g_df.groupby(["PER_score"], as_index=False).agg({'rtn': ['mean', 'std']}).head(2)
```


```python
a
b
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="2" halign="left">rtn</th>
    </tr>
    <tr>
      <th></th>
      <th>mean</th>
      <th>std</th>
    </tr>
    <tr>
      <th>PER_score</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>-0.062</td>
      <td>0.328</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.083</td>
      <td>0.781</td>
    </tr>
  </tbody>
</table>
</div>






<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th>PER_score</th>
      <th colspan="2" halign="left">rtn</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>mean</th>
      <th>std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>-0.062</td>
      <td>0.328</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>-0.083</td>
      <td>0.781</td>
    </tr>
  </tbody>
</table>
</div>



---


```python
a['rtn']
a[('rtn', 'mean')].head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
    </tr>
    <tr>
      <th>PER_score</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>-0.062</td>
      <td>0.328</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.083</td>
      <td>0.781</td>
    </tr>
  </tbody>
</table>
</div>






    PER_score
    1   -0.062
    2   -0.083
    Name: (rtn, mean), dtype: float64



---

## Example2


```python
a_df = pd.read_csv("data/Small_and_Big.csv", index_col=[0])
a_df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>종목명</th>
      <th>PBR(IFRS-연결)</th>
      <th>베타 (M,5Yr)</th>
      <th>수익률(%)</th>
      <th>시가총액 (보통)(평균)(원)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2000-07-31</td>
      <td>BYC</td>
      <td>0.210</td>
      <td>0.479</td>
      <td>-0.580</td>
      <td>27786000000.000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2000-07-31</td>
      <td>CJ</td>
      <td>0.510</td>
      <td>1.166</td>
      <td>-9.000</td>
      <td>1160889000000.000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2000-07-31</td>
      <td>CJ ENM</td>
      <td>6.560</td>
      <td>NaN</td>
      <td>17.400</td>
      <td>400467000000.000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2000-07-31</td>
      <td>CJ대한통운</td>
      <td>0.170</td>
      <td>1.314</td>
      <td>-7.960</td>
      <td>194962000000.000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2000-07-31</td>
      <td>CJ씨푸드</td>
      <td>NaN</td>
      <td>0.227</td>
      <td>32.000</td>
      <td>1987000000.000</td>
    </tr>
  </tbody>
</table>
</div>



---


```python
median_df = a_df.groupby(['date']).agg({'시가총액 (보통)(평균)(원)': 'median'})
median_df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>시가총액 (보통)(평균)(원)</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2000-07-31</th>
      <td>34947000000.000</td>
    </tr>
    <tr>
      <th>2000-08-31</th>
      <td>33684000000.000</td>
    </tr>
    <tr>
      <th>2000-09-30</th>
      <td>33684000000.000</td>
    </tr>
    <tr>
      <th>2000-10-31</th>
      <td>30523000000.000</td>
    </tr>
    <tr>
      <th>2000-11-30</th>
      <td>30798000000.000</td>
    </tr>
  </tbody>
</table>
</div>



---


```python
median_df.columns = ['시가총액_median']
median_df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>시가총액_median</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2000-07-31</th>
      <td>34947000000.000</td>
    </tr>
    <tr>
      <th>2000-08-31</th>
      <td>33684000000.000</td>
    </tr>
    <tr>
      <th>2000-09-30</th>
      <td>33684000000.000</td>
    </tr>
    <tr>
      <th>2000-10-31</th>
      <td>30523000000.000</td>
    </tr>
    <tr>
      <th>2000-11-30</th>
      <td>30798000000.000</td>
    </tr>
  </tbody>
</table>
</div>


