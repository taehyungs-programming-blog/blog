---
layout: default
title: "15. MySQL Crawling í›„ ë°ì´í„° ìŒ“ê¸°"
parent: (Django)
grand_parent: Python
nav_order: 2
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

{% raw %}

* [Get Code ğŸŒ](https://github.com/Arthur880708/python.example.use.mysql/tree/2)

```bash
$ pip install requests beautifulsoup4
```

```py
# main.py

from data_operations import add_or_update_property_listings, get_all_property_listings
from database import init_db

def main():
    # ****************
    # 1. í¬ë¡¤ë§
    # ****************
    from crawler import Crawler
    URL = "https://m.land.naver.com/complex/getComplexArticleList"
    param = {
        'hscpNo': '2591',   # ë¡¯ë°ì„ ê²½
        'tradTpCd': 'A1',
        'order': 'date_',
        'showR0': 'N',
    }
    c = Crawler(URL, param)
    return_item = c.start()

    # ****************
    # 2. db init
    # ****************
    init_db()

    # ****************
    # 3. ë°ì´í„° ìŒ“ê¸°
    # ****************
    add_or_update_property_listings(return_item)

    # ****************
    # 4. ë°ì´í„° ì½ì–´ì˜¤ê¸°
    # ****************
    # ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ëª¨ë“  PropertyListing ë ˆì½”ë“œë¥¼ ê°€ì ¸ì˜´
    property_listings = get_all_property_listings()

    # ê²°ê³¼ê°€ ì—†ì„ ê²½ìš°
    if not property_listings:
        print("No property listings found.")
        return

    # ê° PropertyListing ì¸ìŠ¤í„´ìŠ¤ì— ëŒ€í•´ ì •ë³´ ì¶œë ¥
    for property in property_listings:
        print(f"atclNo: {property.atclNo}, bildNm: {property.bildNm}, tradTpNm: {property.tradTpNm}, "
              f"spc1: {property.spc1}, spc2: {property.spc2}, flrInfo: {property.flrInfo}, "
              f"prcInfo: {property.prcInfo}, direction: {property.direction}")


if __name__ == "__main__":
    main()

```

```py
# models.py

class PropertyListing(Base):
    __tablename__ = 'property_listings'

    atclNo = Column(String(255), primary_key=True)  # ê¸°ë³¸ í‚¤ë¡œ ì„¤ì •
    bildNm = Column(String(255))
    tradTpNm = Column(String(255))
    spc1 = Column(Float)
    spc2 = Column(Float)
    flrInfo = Column(String(255))
    prcInfo = Column(String(255))
    direction = Column(String(255))
    atclFetrDesc = Column(Text)
    cfmYmd = Column(String(255))  # ì‹¤ì œ ì‚¬ìš© ì‹œ, ë‚ ì§œ íƒ€ì…ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
```

```py
# data_operations.py

def get_all_property_listings() -> list:
    db: Session = SessionLocal()
    try:
        # PropertyListing í…Œì´ë¸”ì˜ ëª¨ë“  ë ˆì½”ë“œë¥¼ ì¿¼ë¦¬
        all_properties = db.query(PropertyListing).all()
        return all_properties
    except Exception as e:
        print(f"Error occurred: {e}")
        return []
    finally:
        db.close()

def add_or_update_property_listings(items: list) -> list:
    db: Session = SessionLocal()
    created_or_updated_listings = []

    # PropertyListing ëª¨ë¸ì— ì •ì˜ëœ ëª¨ë“  í•„ë“œì˜ ì´ë¦„ì„ ì–»ìŒ
    model_fields = {c.key for c in inspect(PropertyListing).mapper.column_attrs}

    for item in items:
        # ëª¨ë¸ì— ì •ì˜ëœ í•„ë“œë§Œ í•„í„°ë§
        filtered_item = {k: v for k, v in item.items() if k in model_fields}
        atclNo = filtered_item.get('atclNo')

        if not atclNo:
            print("Item missing 'atclNo', skipping...")
            continue

        try:
            existing_property = db.query(PropertyListing).filter(PropertyListing.atclNo == atclNo).first()
            if existing_property:
                # í•­ëª©ì´ ì´ë¯¸ ì¡´ì¬í•˜ë©´, ëª¨ë“  í•„ë“œ ì—…ë°ì´íŠ¸
                for key, value in filtered_item.items():
                    setattr(existing_property, key, value)
                print(f"Updated existing PropertyListing: {atclNo}")
            else:
                # ìƒˆ í•­ëª© ì¶”ê°€
                new_property = PropertyListing(**filtered_item)
                db.add(new_property)
                print(f"Added new PropertyListing: {atclNo}")

            db.commit()
            created_or_updated_listings.append(existing_property if existing_property else new_property)

        except IntegrityError as e:
            db.rollback()
            print(f"Database integrity error for item {atclNo}: {e}")
        except Exception as e:
            db.rollback()
            print(f"Error occurred for item {atclNo}: {e}")

    db.close()
    return created_or_updated_listings
```

{% endraw %}