---
layout: default
title: "01-02. Packet Send / Recv"
parent: "(01. Client, Server Core)"
grand_parent: "(MMORPG ë§Œë“¤ì–´ ë³´ê¸° ğŸ¤©)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* [Get Code ğŸŒŸ](https://github.com/Arthur880708/LetMakeMMO/tree/1)

---

## Packet Send/Recv ì£¼ìš” ì½”ë“œ ì„¤ëª…

* ì„¤ëª… ì „ ì´ë²ˆ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©ë  Network System

```csharp
public abstract class Session
{
    // ...
}

public abstract class PacketSession : Session
{
    // ...

        public sealed override int OnRecv(ArraySegment<byte> buffer)
		{
            // ì—¬ê¸°ì„œëŠ” íŒ¨í‚·ì˜ ì²˜ë¦¬ë§Œ í•œë‹¤.

			int processLen = 0;

			while (true)
			{
				if (buffer.Count < HeaderSize)
					break;

				ushort dataSize = BitConverter.ToUInt16(buffer.Array, buffer.Offset);
				if (buffer.Count < dataSize)
					break;

				if (dataSize < HeaderSize)
					break;

				OnRecvPacket(new ArraySegment<byte>(buffer.Array, buffer.Offset, dataSize));

				processLen += dataSize;
				buffer = new ArraySegment<byte>(buffer.Array, buffer.Offset + dataSize, buffer.Count - dataSize);
			}

			return processLen;
		}

        public abstract void OnRecvPacket(ArraySegment<byte> buffer);
}
```

### Server

### Client

* Title Sceneì—ì„œ Loadingì™„ë£Œ ì‹œ ê¸°ë³¸ Packetì„ ì†¡ì‹ .

```cpp
public class UI_TitleScene : UI_Scene
{
    // ...

	private void OnAssetLoaded()
	{
		State = TitleSceneState.AssetLoaded;
		Managers.Data.Init();

		Debug.Log("Connecting To Server");
		State = TitleSceneState.ConnectingToServer;

		IPAddress ipAddr = IPAddress.Parse("127.0.0.1");
		IPEndPoint endPoint = new IPEndPoint(ipAddr, 7777);
		Managers.Network.GameServer.Connect(endPoint, OnConnectionSuccess, OnConnectionFailed);
	}

    private void OnConnectionSuccess()
	{
		Debug.Log("Connected To Server");
		State = TitleSceneState.ConnectedToServer;

		GetObject((int)GameObjects.StartButton).gameObject.SetActive(true);

		StartCoroutine(CoSendTestPackets());
	}

    IEnumerator CoSendTestPackets()
	{
		while (true)
		{
			yield return new WaitForSeconds(1);

			C_Test pkt = new C_Test();
			pkt.Temp = 1;
			Managers.Network.Send(pkt);
		}
	}
```

---

## Proto ë¬¸ë²• í™•ì¸

* Protoë¥¼ ì•„ë˜ì™€ ê°™ì´ ì„ ì–¸í–ˆë‹¤ ê°€ì •í•˜ì.

```csharp
syntax = "proto3";

package Protocol;
option csharp_namespace = "Google.Protobuf.Protocol";

import public "Enum.proto";
import public "Struct.proto";

message S_Connected 
{
}

message C_Test 
{
	int32 temp = 1;
}
```

```chsarp
public static void C_TestHandler(PacketSession session, IMessage packet)
{
	C_Test pkt = packet as C_Test;
	System.Console.WriteLine(pkt.Temp);
}
```

---

## Addressable

```csharp
public class UI_TitleScene : UI_Scene
{
    // ...

    protected override void Start()
    {
        base.Start();

        State = TitleSceneState.AssetLoading;

        Managers.Resource.LoadAllAsync<Object>("Preload", (key, count, totalCount) =>
        {
            GetText((int)Texts.StatusText).text = $"ë¡œë”©ì¤‘ : {key} {count}/{totalCount}";

            if (count == totalCount)
            {
                OnAssetLoaded();
            }
        });
    }
```
