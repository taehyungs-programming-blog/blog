---
layout: default
title: "02-01. ì…ì¥ ë° í‡´ì¥"
parent: "(02. ì´ë™ ë™ê¸°í™”)"
grand_parent: "(MMORPG ë§Œë“¤ì–´ ë³´ê¸° ğŸ¤©)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* [Get Code ğŸŒŸ](https://github.com/Arthur880708/LetMakeMMO/tree/2)

---

## TODO: ScriptableOjectData ë™ì‘

---

```csharp
// Client
public class GameScene : BaseScene
{
    protected override void Awake()
    {
        base.Awake();

#if UNITY_EDITOR
        gameObject.AddComponent<CaptureScreenShot>();
#endif

        Debug.Log("@>> GameScene Init()");
        SceneType = EScene.GameScene;

        // Map Loadí›„
        Managers.Map.LoadMap("MMO_edu_map");

        // EnterGame Packet
            // C_XXX : Clientê°€ ë³´ë‚´ëŠ” í–‰ìœ„
		C_EnterGame enterGame = new C_EnterGame();
		Managers.Network.Send(enterGame);
	}

    // ...
```

```csharp
public partial class ClientSession : PacketSession
{
    public void HandleEnterGame(C_EnterGame enterGamePacket)
    {

        Console.WriteLine("HandleEnterGame");

        MyHero = ObjectManager.Instance.Spawn<Hero>(1);
        {
            MyHero.ObjectInfo.PosInfo.State = EObjectState.Idle;
            MyHero.ObjectInfo.PosInfo.MoveDir = EMoveDir.Down;
            MyHero.ObjectInfo.PosInfo.PosX = 0;
            MyHero.ObjectInfo.PosInfo.PosY = 0;
            MyHero.Session = this;
        }

        // TODO : DB ì²˜ë¦¬
        GameLogic.Instance.Push(() =>
        {
            GameRoom room = GameLogic.Instance.Find(1);

            room?.Push(() =>
            {
                Hero hero = MyHero;
                room.EnterGame(hero, respawn:false, pos: null);
            });
        });
    }
}
```

* ì—¬ê¸°ì„œ ì£¼ì˜í•  ì  Pushì‹œ Lockì´ ì•„ë‹ˆë¼ Job ë°©ì‹

```csharp
public void Push(Action action) { Push(new Job(action)); }

public void Push(IJob job)
{
    lock (_lock)
    {
        _jobQueue.Enqueue(job);
    }
}
```

```csharp
public partial class GameRoom : JobSerializer
{
    // ...

    public void Update()
    {
        //Console.WriteLine($"TimerCount : {TimerCount}");
        //Console.WriteLine($"JobCount : {JobCount}");
        Flush();
    }
```

```
// propto.
message HeroInfo
{
	CreatureInfo creatureInfo = 1;
	string name = 2;
}

message MyHeroInfo
{
	HeroInfo heroInfo = 1;
	StatInfo baseStatInfo = 2;
}
```

```csharp
namespace GameServer
{
	public class Hero : Creature
	{
		public ClientSession Session { get; set; }
		public VisionCubeComponent Vision { get; protected set; }

		// ë‚¨í•œí…Œ ë³´ë‚¼ ë•Œ ì‚¬ìš©í•˜ëŠ” ì •ë³´
		public HeroInfo HeroInfo { get; private set; } = new HeroInfo();
		// ìŠ¤ìŠ¤ë¡œí•œí…Œ ë³´ë‚¼ ë•Œ ì‚¬ìš©í•˜ëŠ” ì •ë³´
		public MyHeroInfo MyHeroInfo { get; private set; } = new MyHeroInfo();

		// í”Œë ˆì´ì–´ ì •ë³´ ê´€ë ¨
		public string Name
		{
			get { return HeroInfo.Name; }
			set { HeroInfo.Name = value; }
		}

		// ì—¬ê¸° ë“¤ì–´ì˜¬ ë•Œ ID ë°œê¸‰ì€ ì•„ì§ ì•ˆëœ ìƒíƒœ
		public Hero()
		{
			// ì°¸ì¡° ì—°ê²°
			MyHeroInfo.HeroInfo = HeroInfo;
			HeroInfo.CreatureInfo = CreatureInfo;

			ObjectType = EGameObjectType.Hero;

			Vision = new VisionCubeComponent(this);
		}
	}
}
```

---

## BroadCast

```csharp
public partial class GameRoom : JobSerializer
{
    // ...
    
    public void Broadcast(Vector2Int pos, IMessage packet)
    {
        List<Zone> zones = GetAdjacentZones(pos);
        if (zones.Count == 0)
            return;

        byte[] packetBuffer = ClientSession.MakeSendBuffer(packet);

        foreach (Hero p in zones.SelectMany(z => z.Heroes))
        {
            int dx = p.CellPos.x - pos.x;
            int dy = p.CellPos.y - pos.y;
            if (Math.Abs(dx) > GameRoom.VisionCells)
                continue;
            if (Math.Abs(dy) > GameRoom.VisionCells)
                continue;

            p.Session?.Send(packetBuffer);
        }
    }
```