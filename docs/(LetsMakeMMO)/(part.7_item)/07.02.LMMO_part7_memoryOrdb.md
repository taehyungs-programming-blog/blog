---
layout: default
title: "07-02. ì•„ì´í…œ íšë“ ì‹œ ë©”ëª¨ë¦¬ì— ë¨¼ì € ì—…ë°ì´íŠ¸? DBì— ì—…ë°ì´íŠ¸?"
parent: "(07. ì•„ì´í…œ)"
grand_parent: "(MMORPG ë§Œë“¤ì–´ ë³´ê¸° ğŸ¤©)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* [Get Code ğŸŒŸ](https://github.com/Arthur880708/LetMakeMMO/tree/7)

---

```csharp
public override void OnDead(BaseObject attacker)
{
    if (attacker.IsValid() == false)
        return;
    
    BaseObject owner = attacker.GetOwner();
    if (owner.ObjectType == EGameObjectType.Hero)
    {
        Hero hero = owner as Hero;
        if (hero.Inven.IsInventoryFull() == false)
        {
            RewardData rewardData = GetRandomReward();
            if (rewardData != null)

                // í˜„ì¬ ì½”ë“œìƒìœ¼ë¡  DBì— ë¨¼ì €ì‘ì—…ì„ í•œë‹¤.
                // ê³¼ì—° ì´ê²Œ íš¨ìœ¨ì ì¼ê¹Œ?
                DBManager.RewardHero(hero, rewardData);
        }
        
        if (MonsterData.DropTable != null)
            hero.RewardExpAndGold(MonsterData.DropTable);
    }

    _ai.OnDead(attacker);
    base.OnDead(attacker);
}
```

```csharp
public static void RewardHero(Hero hero, RewardData rewardData)
{
    if (hero == null || rewardData == null || hero.Room == null || hero.Inven == null)
        return;
    if (hero.Inven.IsInventoryFull())
        return;
    if (rewardData.Count > rewardData.Item.MaxStack)
        return;

    int itemTemplateId = rewardData.Item.TemplateId;
    int remainingAddCount = 1;

    ItemDb newItemDb = null;
    ItemDb stackItemDb = null;
    int stackCount = 0;

    // ê¸°ì¡´ ì•„ì´í…œê³¼ ë³‘í•© ì‹œë„.
    if (rewardData.Item.Stackable)
    {
        remainingAddCount = rewardData.Count;
        
        Item stackItem = hero.Inven.GetAnyInventoryItemByCondition(stackItem => stackItem.TemplateId == itemTemplateId && stackItem.GetAvailableStackCount() > 0);
        if (stackItem != null)
        {
            stackCount = Math.Min(remainingAddCount, stackItem.GetAvailableStackCount());

            // ì•„ì´í…œ ìˆ˜ëŸ‰ ì¦ê°€.
            stackItemDb = new ItemDb
            {
                ItemDbId = stackItem.ItemDbId,
                Count = stackItem.Count + stackCount,
            };

            //  ì¹´ìš´íŠ¸ ì†Œëª¨.
            remainingAddCount -= stackCount;
        }
    }

    // ìƒˆë¡œ ìƒì„±.
    if (remainingAddCount > 0)
    {
        newItemDb = new ItemDb
        {
            TemplateId = rewardData.Item.TemplateId,
            EquipSlot = EItemSlotType.Inventory,
            Count = remainingAddCount,
            OwnerDbId = hero.HeroDbId,
        };
    }
    
    // ã…‹ã…‹ ê·¸ë˜ì„œ ì‚¬ì‹¤ DBì‘ì—…ê³¼ GameThreadì‘ì—…ì„ ë¶„ë¦¬í•¨.
    Instance.Push(RewardHero_Step2, hero, rewardData, newItemDb, stackItemDb, stackCount);
}
```