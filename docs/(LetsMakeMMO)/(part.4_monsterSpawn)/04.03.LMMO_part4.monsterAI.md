---
layout: default
title: "04-03. ëª¬ìŠ¤í„° AI êµ¬í˜„"
parent: "(04. ëª¬ìŠ¤í„° ìŠ¤í°)"
grand_parent: "(MMORPG ë§Œë“¤ì–´ ë³´ê¸° ğŸ¤©)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* [Get Code ğŸŒŸ](https://github.com/Arthur880708/LetMakeMMO/tree/4)

---

* ì¼ë°˜ì ìœ¼ë¡œ Monster AIêµ¬í˜„ì‹œ Unrealì˜ Behavior Treeë¥¼ ë§ì´ ê³ ë ¤í•˜ê² ì§€ë§Œ, ê°„ë‹¨í•œ AIì˜ êµ¬í˜„ì€ ì§ì ‘êµ¬í˜„ì´ ì˜¤íˆë ¤ í¸ë¦¬í•˜ë‹¤.
* ì´ë²ˆ êµ¬í˜„ì€ State Patternì„ í†µí•´ êµ¬í˜„í•´ ë³¼ ì˜ˆì •

```csharp
public class BaseAIController<OwnerType> where OwnerType : BaseObject
{
    public OwnerType Owner { get; protected set; }
    public int UpdateTick { get; set; } = 100;

    public BaseAIController(OwnerType owner)
    {
        Owner = owner;
    }

    protected IJob _job;
    public virtual void Update()
    {
        switch (Owner.State)
        {
            case EObjectState.Idle:
                UpdateIdle();
                break;
            case EObjectState.Move:
                UpdateMoving();
                break;
            case EObjectState.Skill:
                UpdateSkill();
                break;
            case EObjectState.Dead:
                UpdateDead();
                break;
        }

        if (Owner.Room != null)
            _job = Owner.Room.PushAfter(UpdateTick, Update);
    }

    public virtual void SetState(EObjectState State)
    {
        if (Owner.State == State)
            return;

        Owner.State = State;
    }

    protected virtual void UpdateIdle()
    {
    }

    protected virtual void UpdateMoving()
    {
    }

    protected virtual void UpdateSkill()
    {
    }

    protected virtual void UpdateDead()
    {
    }

    public virtual void OnDamaged(BaseObject attacker, float damage)
    {
    }

    public virtual void OnDead(BaseObject attacker)
    {

    }
}
```

```csharp
public class MonsterAIController : FSMController<Monster, Creature>
{
    public MonsterAIController(Monster owner) : base(owner)
    {
        DataManager.MonsterDict.TryGetValue(owner.TemplateId, out MonsterData monsterData);

        _searchCellDist = monsterData.SearchCellDist;
        _chaseCellDist = monsterData.ChaseCellDist;
        _patrolCellDist = monsterData.PatrolCellDist;


        SkillData skillData = monsterData.MainSkill;
        _mainSkillRange = skillData.SkillRange;
        _skillTemplateId = skillData.TemplateId;
    }

    public override void SetState(EObjectState state)
    {
        base.SetState(state);

        switch (state)
        {
            case EObjectState.Idle:
                UpdateTick = 1000;
                break;
            case EObjectState.Move:
                UpdateTick = 1000;
                break;
            case EObjectState.Skill:
                UpdateTick = 1000;
                break;
            case EObjectState.Dead:
                UpdateTick = 1000;
                break;
        }
    }

    protected override Creature FindTarget()
    {
        if (Owner.Room == null)
            return null;

        if (Owner.MonsterData.IsAggressive == false)
            return _target;

        return FindTargetForMonster();
    }

    Creature FindTargetForMonster()
    {
        List<Hero> heroes = Owner.Room.FindAdjacents<Hero>(Owner.CellPos, hero =>
        {
            if (hero.IsValid() == false)
                return false;

            return hero.GetDistance(Owner) <= _searchCellDist;
        });

        heroes.Sort((a, b) =>
        {
            int aDist = a.GetDistance(Owner);
            int bDist = b.GetDistance(Owner);
            return aDist - bDist;
        });

        foreach (Hero hero in heroes)
        {
            // ê¸°ë³¸ ìŠ¤í‚¬ ì‚¬ìš© ê°€ëŠ¥í•˜ë©´ ê·¸ëƒ¥ ê·¸ íƒ€ê²Ÿìœ¼ë¡œ ì„¤ì •
            int dist = hero.GetDistance(Owner);
            if (dist <= _mainSkillRange)
                return hero;

            List<Vector2Int> path = Owner.Room?.Map.FindPath(Owner, Owner.CellPos, hero.CellPos);
            if (path == null || path.Count < 2 || path.Count > _chaseCellDist)
                continue;

            return hero;
        }

        return null;
    }
}
```
