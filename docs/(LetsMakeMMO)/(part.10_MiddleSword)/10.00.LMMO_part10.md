---
layout: default
title: "(10. ì¤‘ê°„ì •ê²€ : ì½”ë“œë¦¬ë·°~)"
parent: "(MMORPG ë§Œë“¤ì–´ ë³´ê¸° ğŸ¤©)"
has_children: true
nav_order: 2
---

* [Get Code ğŸŒŸ](https://github.com/Arthur880708/LetMakeMMO/tree/10)
    * ê¸°íƒ€ ë²„ê·¸ë„ ë§ì´ ìˆ˜ì •ëìŠµë‹ˆë‹¤.

---

* Q/Aí˜•ì‹ìœ¼ë¡œ ì§„í–‰ ë©ë‹ˆë‹¤.

## Q1) ì§ˆë¬¸

```csharp
public class Monster : Creature
{
    public override bool OnDamaged(BaseObject attacker, float damage)
    {
        if (Room == null)
            return false;

        if (State == EObjectState.Dead)
            return false;

        // ì´ ì½”ë“œëŠ” ì–´ë–¤ê°€?
        if (damageByHero.ContainsKey(attacker.ObjectId))
            damageByHero[attacker.ObjectId] += damage;
        else
            damageByHero.Add(attacker.ObjectId, damage);

        // OnDamagedëŠ” AIì˜ Controllerê°€ ëˆ„êµ¬ì—ê²Œ ë°ë¯¸ì§€ë¥¼ ì…ì—ˆëŠ”ì§€ í™•ì¸ìš©ì¸ë°,
        // ì´ëŸ°ì‹ìœ¼ë¡œ ìˆ˜ì •ì´ ë˜ë©´ ì•ˆëœë‹¤.
        _ai.OnDamaged(GetTopDamager(), damage);

        return base.OnDamaged(attacker, damage);
    }
```

---

## A1) ìˆ˜ì •

```csharp
public class Monster : Creature
{
    public override bool OnDamaged(BaseObject attacker, float damage)
    {
        if (Room == null)
            return false;

        if (State == EObjectState.Dead)
            return false;

        // 1. ì–´ê·¸ë¡œ ë§¤ë‹ˆì €ì— ì „ë‹¬.
        if (attacker.ObjectType == EGameObjectType.Hero)
            Aggro.OnDamaged(attacker.ObjectId, damage);

        // 2. AI ë§¤ë‹ˆì €ì— ì „ë‹¬.
        AI.OnDamaged(attacker, damage);

        return base.OnDamaged(attacker, damage);
    }
```

* êµí›ˆ
    * ì˜ˆì™¸ ì²˜ë¦¬ê°€ ìˆë‹¤ë©´ ë  ìˆ˜ ìˆìœ¼ë©´ êµ¬ì¡°í™”ë¥¼ í•´ë¼ (ì½”ë“œìƒì— ë„£ì§€ë§ˆë¼)

---

## Q2) ì§ˆë¬¸

```csharp
public virtual void LeaveGame(int objectId, ELeaveType leaveType = ELeaveType.None)
{
    EGameObjectType type = ObjectManager.GetObjectTypeFromId(objectId);

    if (type == EGameObjectType.Hero)
    {
        if (_heroes.TryGetValue(objectId, out Hero hero) == false)
            return;

        if (hero.Room != null && hero.Room != this)
            return;

        Map.ApplyLeave(hero);

        _heroes.Remove(objectId);
        // ì´ê±´ ì•ˆì „í• ê¹Œ?
            // ì´í›„ here.Roomì— ì ‘ê·¼í•  ì¼ì´ ë§ì€ë° NullPtr Exceptionì¸ë°?
        hero.Room = null;
```

---

## A2) ë‹µë³€

* êµ¬ì¡°ì ìœ¼ë¡œ null exceptionì´ ì•ˆë‚˜ê²Œ ë§‰ì

```csharp
public partial class EmptyRoom : GameRoom
{
    public override IJob PushAfter(int tickAfter, IJob job)
    {
        // Do Nothing
        return null;
    }

    public override void Push(IJob job)
    {
        // Do Nothing
    }

    public override void EnterGame(BaseObject obj, Vector2Int cellPos, bool respawn = false)
    {
        // Do Nothing
    }

    public override void LeaveGame(int objectId, ELeaveType leaveType = ELeaveType.None)
    {
        // Do Nothing
    }

    public override void Broadcast(Vector2Int pos, IMessage packet)
    {
        // Do Nothing
    }
}
```

```csharp
public virtual void LeaveGame(int objectId, ELeaveType leaveType = ELeaveType.None)
{
    EGameObjectType type = ObjectManager.GetObjectTypeFromId(objectId);

    if (type == EGameObjectType.Hero)
    {
        if (_heroes.TryGetValue(objectId, out Hero hero) == false)
            return;

        if (hero.Room != null && hero.Room != this)
            return;

        Map.ApplyLeave(hero);

        _heroes.Remove(objectId);
        hero.Room = GameRoom.S_EmptyRoom;   // EmptyRoom!
```

---

## Q3) ì§ˆë¬¸

* Jobì— í• ì¼ì„ ë„£ì—ˆëŠ”ë° í•´ë‹¹ ìœ ì €ê°€ ë‚˜ê°€ë²„ë¦°ë‹¤ë©´? ê·¸ Jobì€ ì–´ë–»ê²Œ ì²˜ë¦¬í•˜ë©´ ì¢‹ì„ê¹Œ?

---

## A3) ë‹µë³€

```csharp
public abstract class IJob
{
    public abstract void Execute();

    // Cancelì„ í•˜ë‚˜ ìƒì„±í•´ ë‘ .
    public bool Cancel { get; set; } = false;
}

public override void Execute()
{
    // ì·¨ì†Œì‹œ ë¬´ì‹œ!
    if (Cancel == false)
        _action.Invoke(_t1);
}
```

* ë‹¤ë¥¸ ë°©ë²•ë„ ìˆë‹¤. LinkedListë¡œ ë§Œë“¤ì–´ Cancelì‹œ í•´ë‹¹ Jobì„ ì™ ë¹¼ë²„ë¦°ë‹¤.

