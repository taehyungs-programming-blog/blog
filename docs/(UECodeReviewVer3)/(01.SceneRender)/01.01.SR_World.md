---
layout: default
title: "Worldì—ì„œ SceneRenderì—°ê´€ ë¶€ë¶„ ì •ë¦¬ë¦¬"
parent: "(01. SceneRender)"
grand_parent: "(UE Code-Review ğŸ³)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## 1. Tickì„ ëŒë©° Controllerì˜ Updateë¥¼ ìœ ë„

```cpp
void Tick(ELevelTick TickType, float DeltaSeconds)
{    
    // ...
    for (FConstPlayerControllerIterator Iterator = GetPlayerControllerIterator(); Iterator; ++Iterator)
    {
        if (APlayerController* PlayerController = Iterator->Get())
        {
            // Tickì„ ëŒë©° Controllerì˜ Updateë¥¼ ìœ ë„í•©ë‹ˆë‹¤.
                // ì–´ë–»ê²Œ ì—…ë°ì´íŠ¸ í• ì§€ëŠ” ì´í›„ Controllerì—ì„œ ì„¤ëª…í•©ë‹ˆë‹¤.
            PlayerController->UpdateCameraManager(DeltaSeconds);
        }
    }
}
```

---

## 2. Componentì—ì„œ Updateê°€ í•„ìš”í•œ Componentë¥¼ ì°¾ê¸°ê¸°

```cpp
void MarkActorComponentForNeededEndOfFrameUpdate(UActorComponent* Component, bool bForceGameThread)
{
    // ActorComponentì—ì„œ Updateê°€ í•„ìš”í•œ Componentë¥¼ ì°¾ìŠµë‹ˆë‹¤.
        // ì´ ê³¼ì •ì´ í•„ìš”í•œ ì´ìœ ëŠ” í•„ìš”í• ë•Œë§ˆë‹¤ ì—…ë°ì´íŠ¸ë¥¼ ì§„í–‰ì‹œ ë¦¬ì†ŒìŠ¤ ë‚­ë¹„ê°€ ì‹¬í•´ì§€ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
        // ì–´ë–»ê²Œ ë§ˆí‚¹í•˜ëŠ”ì§€ëŠ” Componentì—ì„œ ì„¤ëª…í•©ë‹ˆë‹¤.
    uint32 CurrentState = Component->GetMarkedForEndOfFrameUpdateState();

    if (CurrentState == EComponentMarkedForEndOfFrameUpdateState::Marked && bForceGameThread)
    {
        const int32 ArrayIndex = FMarkComponentEndOfFrameUpdateState::GetArrayIndex(Component);
        ComponentsThatNeedEndOfFrameUpdate[ArrayIndex] = nullptr;
        CurrentState = EComponentMarkedForEndOfFrameUpdateState::Unmarked;
    }
    
    if (CurrentState == EComponentMarkedForEndOfFrameUpdateState::Unmarked)
    {
        bForceGameThread = bForceGameThread || !GIsThreadedRendering || !FApp::ShouldUseThreadingForPerformance();
        if (!bForceGameThread)
        {
            bForceGameThread = !CVarAllowAsyncRenderThreadUpdates.GetValueOnAnyThread();
        }

        if (bForceGameThread)
        {
            FMarkComponentEndOfFrameUpdateState::Set(Component, ComponentsThatNeedEndOfFrameUpdate_OnGameThread.Num(), EComponentMarkedForEndOfFrameUpdateState::MarkedForGameThread);
            ComponentsThatNeedEndOfFrameUpdate_OnGameThread.Add(Component);
        }
        else
        {
            FMarkComponentEndOfFrameUpdateState::Set(Component, ComponentsThatNeedEndOfFrameUpdate.Num(), EComponentMarkedForEndOfFrameUpdateState::Marked);
            ComponentsThatNeedEndOfFrameUpdate.Add(Component);
        }

        if (Component->RequiresPreEndOfFrameSync())
        {
            FMarkComponentEndOfFrameUpdateState::SetMarkedForPreEndOfFrameSync(Component);
            ComponentsThatNeedPreEndOfFrameSync.Add(Component);
        }
    }
}

```

---

## 3. Worldì—ì„œ ë Œë”ë§ ì›”ë“œë¡œ ë³€ê²½ì‚¬í•­ ì „íŒŒ

* ì—¬ê¸¸ ì´í•´í•˜ê¸° ìœ„í•´ ì•Œì•„ì•¼ í• ê²ƒ.

* ê¸°ë³¸ êµ¬ì¡°
    * WorldëŠ” Actorë“¤ì„ ì†Œìœ í•©ë‹ˆë‹¤
    * ActorëŠ” PrimitiveComponentë“¤ì„ ì†Œìœ í•©ë‹ˆë‹¤
    * Scene(RenderWorld)ì€ PrimitiveSceneInfoë“¤ì„ ì†Œìœ í•©ë‹ˆë‹¤
    * PrimitiveSceneInfoëŠ” PrimitiveSceneProxyë¥¼ ì†Œìœ í•©ë‹ˆë‹¤

```
[ê²Œì„ ì›”ë“œ]
- World
  - ë‚˜ë¬´ Actor
    - ë‚˜ë¬´ ëª¨ì–‘ PrimitiveComponent
  - ìë™ì°¨ Actor
    - ì°¨ì²´ PrimitiveComponent
    - ë°”í€´ PrimitiveComponent

[ë Œë”ë§ ì›”ë“œ]
- Scene
  - ë‚˜ë¬´ PrimitiveSceneInfo
    - ë‚˜ë¬´ PrimitiveSceneProxy
  - ì°¨ì²´ PrimitiveSceneInfo
    - ì°¨ì²´ PrimitiveSceneProxy
  - ë°”í€´ PrimitiveSceneInfo
    - ë°”í€´ PrimitiveSceneProxy
```

* ë™ì‘ ì˜ˆì‹œ:
    * ìë™ì°¨ê°€ ì›€ì§ì´ë©´ (ê²Œì„ ì›”ë“œì—ì„œ ë³€ê²½ ë°œìƒ)
    * ì°¨ì²´ì™€ ë°”í€´ PrimitiveComponentê°€ ì—…ë°ì´íŠ¸ ëª©ë¡ì— ì¶”ê°€ë¨
    * SendAllEndOfFrameUpdates() í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ë©´
    * ë³€ê²½ëœ ë‚´ìš©ì´ ê°ê°ì˜ PrimitiveSceneProxyì— ì „ë‹¬ë˜ì–´
    * ë Œë”ë§ ì›”ë“œì—ì„œë„ ìë™ì°¨ê°€ ìƒˆë¡œìš´ ìœ„ì¹˜ì— ê·¸ë ¤ì§
    * ì´ë ‡ê²Œ ê²Œì„ ì›”ë“œì˜ ë³€ê²½ì‚¬í•­ì´ ë Œë”ë§ ì›”ë“œì— ë°˜ì˜ë˜ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.

```cpp
void SendAllEndOfFrameUpdates()
{
    static TArray<UActorComponent*> LocalComponentsThatNeedEndOfFrameUpdate;
    {
        LocalComponentsThatNeedEndOfFrameUpdate.Append(ComponentsThatNeedEndOfFrameUpdate);
    }

    auto ParallelWork = [IsUsingParallelNotifyEvents](int32 Index)
    {
        UActorComponent* NextComponent = LocalComponentsThatNeedEndOfFrameUpdate[Index];
        if (NextComponent)
        {
            if (IsValid(NextComponent) && NextComponent->IsRegistered() && !NextComponent->IsTemplate())
            {
                NextComponent->DoDeferredRenderUpdates_Concurrent();
            }

            FMarkComponentEndOfFrameUpdateState::Set(NextComponent, INDEX_NONE, EComponentMarkedForEndOfFrameUpdateState::Unmarked);
        }
    };

    auto GTWork = [this]()
    {
        TArray<UActorComponent*> DeferredUpdates;
        DeferredUpdates.Reserve(ComponentsThatNeedEndOfFrameUpdate_OnGameThread.Num());

        for (UActorComponent* Component : ComponentsThatNeedEndOfFrameUpdate_OnGameThread)
        {
            if (Component)
            {
                if (Component->IsRegistered() && !Component->IsTemplate() && IsValid(Component))
                {
                    DeferredUpdates.Add(Component);
                }

                FMarkComponentEndOfFrameUpdateState::Set(Component, INDEX_NONE, EComponentMarkedForEndOfFrameUpdateState::Unmarked);
            }
        }

        ComponentsThatNeedEndOfFrameUpdate_OnGameThread.Reset();
        ComponentsThatNeedEndOfFrameUpdate.Reset();

        for (UActorComponent* Component : DeferredUpdates)
        {
            Component->DoDeferredRenderUpdates_Concurrent();
        }
    };

                                                         
    ParallelForWithPreWork(LocalComponentsThatNeedEndOfFrameUpdate.Num(), ParallelWork, GTWork);

    LocalComponentsThatNeedEndOfFrameUpdate.Reset();
}
```