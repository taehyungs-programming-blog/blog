---
layout: default
title: "10. Particle System (+Staging Buffer)"
parent: "(Computer Animation)"
grand_parent: "(Graphics ğŸ˜)"
nav_order: 2
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* [Get Code ğŸŒ](https://github.com/Arthur880708/Graphics_Part4/blob/main/Examples/Ex1501_ParticleSystem.h)

* êµ¬í˜„ìì²´ëŠ” ì‰½ê¸°ì— ì½”ë“œë¥¼ ë³´ë©´ ë˜ê³  í•µì‹¬ë˜ëŠ” ë¶€ë¶„ë§Œ ì •ë¦¬.

```cpp
bool Initialize() {

    // ...

    // Structed Bufferë¥¼ ë‘ì–´ shaderë¡œ ë„˜ê¸¸ì¤€ë¹„
    D3D11Utils::CreateStructuredBuffer(
        m_device, UINT(m_particlesCPU.size()), sizeof(Particle),
        m_particlesCPU.data(), m_particlesGPU, m_particlesSRV, m_particlesUAV);

    // GPUë©”ëª¨ë¦¬ë¡œ ê°€ëŠ” ì„ì‹œê±°ì²˜ì¸ Staging Bufferë¥¼ ìƒì„±
    D3D11Utils::CreateStagingBuffer(m_device, UINT(m_particlesCPU.size()),
                                    sizeof(Particle), m_particlesCPU.data(),
                                    m_particlesStagingGPU);
```

```cpp
// ì—…ë°ì´íŠ¸í•˜ë©° Staging Bufferì— ìˆë˜ ë°ì´í„°ë¥¼ Structed Bufferë¡œ ì˜®ê¸´ë‹¤
D3D11Utils::CopyToStagingBuffer(
    m_context, m_particlesStagingGPU,
    UINT(sizeof(Particle) * m_particlesCPU.size()), m_particlesCPU.data());
m_context->CopyResource(m_particlesGPU.Get(), m_particlesStagingGPU.Get());
```

* ì—¬ê¸°ì„œ ë“œëŠ” ê¶ê¸ˆì¦, ì™œ Stagingì´ ë” ë¹ ë¥´ì§€??

```cpp
void D3D11Utils::CreateStagingBuffer(ComPtr<ID3D11Device> &device,
                                     const UINT numElements,
                                     const UINT sizeElement,
                                     const void *initData,
                                     ComPtr<ID3D11Buffer> &buffer) {

    // ì˜µì…˜ì„ ë³´ë©´ ì•Œê² ì§€ë§Œ ê·¸ëŸ´ ëª©ì ìœ¼ë¡œ ë§Œë“  ë²„í¼ì„
    D3D11_BUFFER_DESC desc;
    ZeroMemory(&desc, sizeof(desc));
    desc.ByteWidth = numElements * sizeElement;
    desc.Usage = D3D11_USAGE_STAGING;
    desc.CPUAccessFlags = D3D11_CPU_ACCESS_WRITE | D3D11_CPU_ACCESS_READ;
    desc.StructureByteStride = sizeElement;

    if (initData) {
        D3D11_SUBRESOURCE_DATA bufferData;
        ZeroMemory(&bufferData, sizeof(bufferData));
        bufferData.pSysMem = initData;
        ThrowIfFailed(
            device->CreateBuffer(&desc, &bufferData, buffer.GetAddressOf()));
    } else {
        ThrowIfFailed(device->CreateBuffer(&desc, NULL, buffer.GetAddressOf()));
    }
}
```