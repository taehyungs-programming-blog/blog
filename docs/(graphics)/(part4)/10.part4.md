---
layout: default
title: "10. Particle System (+Staging Buffer)"
parent: "(Computer Animation)"
grand_parent: "(Graphics ğŸ˜)"
nav_order: 2
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* [Get Code ğŸŒ](https://github.com/Arthur880708/Graphics_Part4/blob/main/Examples/Ex1501_ParticleSystem.h)

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/graphics/part4/p4-10-1.gif"/>
</p>

## Staging Bufferì— ê´€í•´ì„œ

```cpp
bool Initialize() {

    // ...

    // Structed Bufferë¥¼ ë‘ì–´ shaderë¡œ ë„˜ê¸¸ì¤€ë¹„
    D3D11Utils::CreateStructuredBuffer(
        m_device, UINT(m_particlesCPU.size()), sizeof(Particle),
        m_particlesCPU.data(), m_particlesGPU, m_particlesSRV, m_particlesUAV);

    // GPUë©”ëª¨ë¦¬ë¡œ ê°€ëŠ” ì„ì‹œê±°ì²˜ì¸ Staging Bufferë¥¼ ìƒì„±
    D3D11Utils::CreateStagingBuffer(m_device, UINT(m_particlesCPU.size()),
                                    sizeof(Particle), m_particlesCPU.data(),
                                    m_particlesStagingGPU);
```

```cpp
// ì—…ë°ì´íŠ¸í•˜ë©° Staging Bufferì— ìˆë˜ ë°ì´í„°ë¥¼ Structed Bufferë¡œ ì˜®ê¸´ë‹¤
D3D11Utils::CopyToStagingBuffer(
    m_context, m_particlesStagingGPU,
    UINT(sizeof(Particle) * m_particlesCPU.size()), m_particlesCPU.data());
m_context->CopyResource(m_particlesGPU.Get(), m_particlesStagingGPU.Get());
```

* ì—¬ê¸°ì„œ ë“œëŠ” ê¶ê¸ˆì¦, ì™œ Stagingì´ ë” ë¹ ë¥´ì§€??

```cpp
void D3D11Utils::CreateStagingBuffer(ComPtr<ID3D11Device> &device,
                                     const UINT numElements,
                                     const UINT sizeElement,
                                     const void *initData,
                                     ComPtr<ID3D11Buffer> &buffer) {

    D3D11_BUFFER_DESC desc;
    ZeroMemory(&desc, sizeof(desc));
    desc.ByteWidth = numElements * sizeElement;
        // ì˜µì…˜ì„ ë³´ë©´ ì•Œê² ì§€ë§Œ ê·¸ëŸ´ ëª©ì ìœ¼ë¡œ ë§Œë“  ë²„í¼ì„
    desc.Usage = D3D11_USAGE_STAGING;
    desc.CPUAccessFlags = D3D11_CPU_ACCESS_WRITE | D3D11_CPU_ACCESS_READ;
    desc.StructureByteStride = sizeElement;

    if (initData) {
        D3D11_SUBRESOURCE_DATA bufferData;
        ZeroMemory(&bufferData, sizeof(bufferData));
        bufferData.pSysMem = initData;
        ThrowIfFailed(
            device->CreateBuffer(&desc, &bufferData, buffer.GetAddressOf()));
    } else {
        ThrowIfFailed(device->CreateBuffer(&desc, NULL, buffer.GetAddressOf()));
    }
}
```

* (ì¶”ê°€) ì™œ Staging ë²„í¼ë¥¼ ì“°ëƒ?
    * ìš°ì„  ì•Œì•„ì•¼ í•  ì ì€ **CPU -> GPUë¡œ ì“°ëŠ”ê²ƒì€ ë§¤ìš° ëŠë¦¬ë‹¤!** ì´ê±¸ ê¸°ì–µí•˜ê³  ë“¤ì–´ê°€ì
    * **ë¹„ë™ê¸° ë°ì´í„° ì „ì†¡**: Staging Bufferë¥¼ ì‚¬ìš©í•˜ë©´ CPUê°€ ë°ì´í„°ë¥¼ ë²„í¼ì— ì“°ëŠ” ë™ì•ˆ GPUëŠ” ë‹¤ë¥¸ ì‘ì—…ì„ ê³„ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” CPUì™€ GPUê°€ ë™ì‹œì— ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆê²Œ í•˜ì—¬ ì „ì²´ì ì¸ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤. ì§ì ‘ m_particlesGPUì— ì“°ëŠ” ê²½ìš°, GPUê°€ í•´ë‹¹ ë©”ëª¨ë¦¬ì— ì ‘ê·¼í•˜ì§€ ëª»í•˜ê²Œ ë˜ì–´ GPU ì‘ì—…ì´ ë¸”ë¡ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    * **ë©”ëª¨ë¦¬ ì ‘ê·¼ íŒ¨í„´**: GPUì— ì§ì ‘ ë°ì´í„°ë¥¼ ì“°ëŠ” ê²ƒì€ ì¼ë°˜ì ìœ¼ë¡œ ëŠë¦½ë‹ˆë‹¤. CPUì—ì„œ GPU ë©”ëª¨ë¦¬ë¡œì˜ ì§ì ‘ ì“°ê¸°ëŠ” ë©”ëª¨ë¦¬ ì ‘ê·¼ íŒ¨í„´ì´ ìµœì í™”ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ì„±ëŠ¥ ì €í•˜ë¥¼ ì´ˆë˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°˜ë©´, Staging Bufferë¥¼ ì‚¬ìš©í•˜ë©´ ì´ëŸ¬í•œ ë©”ëª¨ë¦¬ ì „ì†¡ì´ ë” íš¨ìœ¨ì ìœ¼ë¡œ ì´ë£¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    * **ë¦¬ì†ŒìŠ¤ ê´€ë¦¬**: DirectXì—ì„œëŠ” ë¦¬ì†ŒìŠ¤ì˜ ì‚¬ìš© ëª©ì ì— ë”°ë¼ ë‹¤ë¥¸ ìœ í˜•ì˜ ë©”ëª¨ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. Staging BufferëŠ” CPUì™€ GPUê°€ ëª¨ë‘ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë©”ëª¨ë¦¬ ìœ í˜•ì´ë©°, ì´ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” ê²ƒì´ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ ì¸¡ë©´ì—ì„œ ë” íš¨ìœ¨ì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    * **ë©€í‹°ìŠ¤ë ˆë”©ê³¼ ë™ì‹œì„±**: ë©€í‹°ìŠ¤ë ˆë”© í™˜ê²½ì—ì„œëŠ” Staging Bufferë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” íš¨ìœ¨ì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. CPUì—ì„œ ë°ì´í„°ë¥¼ ì¤€ë¹„í•˜ëŠ” ë™ì•ˆ GPUëŠ” ë‹¤ë¥¸ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ì „ì²´ ì‹œìŠ¤í…œì˜ ë™ì‹œì„±ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤.

---

## Particle Systemì— ê´€í•´ì„œ

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/graphics/part4/p4-10-1.jpg"/>
</p>

* ê³ ë ¤í•  ì ì€ DirectX11 Pipelineì—ì„œ
    * Vertex shader
    * Geometry shader
    * Pixel shader
    * ìˆœìœ¼ë¡œ í˜ëŸ¬ê°ì„ ê¸°ì–µ!

```cpp
void Ex1501_ParticleSystem::DrawSprites() {

    // ...

    // Vertex Shaderì— particleì˜ ì •ë³´(m_particlesSRV)ë¥¼ ë„˜ê²¨ì¤€ë‹¤
    m_context->VSSetShaderResources(0, 1, m_particlesSRV.GetAddressOf());
    m_context->Draw(UINT(m_particlesCPU.size()), 0);
}
```

```cpp
// Vertex Shader
StructuredBuffer<Particle> particles : register(t0);

PSInput main(uint vertexID : SV_VertexID)
{
    const float fadeLife = 0.2f;
    
    Particle p = particles[vertexID];
    
    PSInput output;
    
    output.position = float4(p.position.xyz, 1.0);
    output.color = p.color * saturate(p.life / fadeLife);
    output.life = p.life;
    output.size = p.size;

    return output;
}
```

```cpp
[maxvertexcount(4)]
void main(point GeometryShaderInput input[1], 
        uint primID : SV_PrimitiveID,
        inout TriangleStream<PixelShaderInput> outputStream)
{
    if (input[0].life < 0.0f)
        return;
    
    // ë„¤ ì ì„ ì°ì–´ì¤€ë‹¤
    float hw = input[0].radius;
    float3 up = float3(0, 1, 0);
    float3 right = float3(1, 0, 0);

    PixelShaderInput output;
    output.pos.w = 1;
    output.color = input[0].color;
    
    output.pos.xyz = input[0].pos.xyz - hw * right - hw * up;
    output.texCoord = float2(0.0, 1.0);
    output.primID = primID;
    
    outputStream.Append(output);

    output.pos.xyz = input[0].pos.xyz - hw * right + hw * up;
    output.texCoord = float2(0.0, 0.0);
    output.primID = primID;
    
    outputStream.Append(output);
    
    output.pos.xyz = input[0].pos.xyz + hw * right - hw * up;
    output.texCoord = float2(1.0, 1.0);
    output.primID = primID;
    
    outputStream.Append(output);
    
    output.pos.xyz = input[0].pos.xyz + hw * right + hw * up;
    output.texCoord = float2(1.0, 0.0);
    output.primID = primID;

    outputStream.Append(output);

    outputStream.RestartStrip(); 
}
```

* ì°¸ê³ 
    * `RestartStrip()` í•¨ìˆ˜ëŠ” ì§€ì˜¤ë©”íŠ¸ë¦¬ ì…°ì´ë”(Geometry Shader)ì—ì„œ ì‚¬ìš©ë˜ë©°, ì‚¼ê°í˜• ìŠ¤íŠ¸ë¦½(Triangle Strip)ì„ ë‹¤ì‹œ ì‹œì‘í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ í•¨ìˆ˜ì˜ ì£¼ìš” ëª©ì ì€ ì—°ì†ëœ ì‚¼ê°í˜•ë“¤ì„ êµ¬ì„±í•˜ëŠ” ë° ìˆì–´ì„œ ìƒˆë¡œìš´ ìŠ¤íŠ¸ë¦½ì„ ì‹œì‘í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
* **ì‚¼ê°í˜• ìŠ¤íŠ¸ë¦½(Triangle Strip)**ì€ ì»´í“¨í„° ê·¸ë˜í”½ìŠ¤ì—ì„œ ì‚¬ìš©ë˜ëŠ” íš¨ìœ¨ì ì¸ ë°©ë²•ìœ¼ë¡œ, ì—°ì†ì ì¸ ì‚¼ê°í˜•ë“¤ì„ ì •ì˜í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ë°©ì‹ì€ ì‚¼ê°í˜•ì„ ê°œë³„ì ìœ¼ë¡œ ì •ì˜í•˜ëŠ” ê²ƒë³´ë‹¤ ì ì€ ìˆ˜ì˜ ê¼­ì§“ì (vertex) ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ë§ì€ ì‚¼ê°í˜•ë“¤ì„ í‘œí˜„í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.