---
layout: default
title: "13. Stable Fluids"
parent: "(Computer Animation)"
grand_parent: "(Graphics ğŸ˜)"
nav_order: 2
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* [Get Code ğŸŒ](https://github.com/Arthur880708/Graphics_Part4/blob/main/Examples/Ex1601_StableFluids.h)

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/graphics/part4/p4-13-1.gif"/>
</p>

## ê°œìš”

* Smoothed Particle Hydrodynamics(SPH)ì˜ ë‹¨ì ì€ 
    * ë¬¼ì²´ì˜ ë°€ë„ë¥¼ ê³„ì‚°í•˜ê¸° ìœ„í•´ ëª¨ë“  ì…ìë¥¼ ê²€ìƒ‰í•´ì•¼ í•œë‹¤ëŠ” ê²ƒì´ë‹¤.
    * ì•ˆì •ì ì´ì§€ ëª»í•˜ë‹¤ëŠ” ê²ƒì´ë‹¤.
* ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ Stable Fluidsë¥¼ ì‚¬ìš©í•œë‹¤.

---

## ì…ì Vs ê²©ì

* **ì…ì**
    * ì•ì—ì„œ êµ¬í˜„í•œ `Particle`ê°ì²´ë¼ ìƒê°í•˜ë©´ í¸í•˜ë‹¤

```cpp
struct Particle {
    Vector3 position;
    Vector3 velocity;
    Vector3 color;
    float life = 0.0f;
    float radius = 1.0f;
};
```

* ìš°ë¦° ì…ìì— ìœ„ì™€ ê°™ì€ ë‹¤ì–‘í•œ ì •ë³´ë¥¼ ë„£ì—ˆì—ˆë‹¤.
* ì…ìëŠ” ê° ê°ì²´ê°€ ìì‹ ì˜ ìœ„ì¹˜ë¥¼ ê°–ëŠ”ë‹¤
    * ì–¸ì œë“  ìœ„ì¹˜ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆì§€ë§Œ í•­ìƒ ëª¨ë“  ì…ìì˜ ìœ„ì¹˜ë¥¼ ì•Œì•„ì•¼í•œë‹¤.

* **ê²©ì**
    * ê³ ì •ëœ Meshë¼ ìƒê°í•˜ë©´ í¸í•˜ë‹¤

```
* ì•„ë˜ í•œ ë„¤ëª¨ í•˜ë‚˜í•˜ë‚˜ë¥¼ ê²©ìë¼ ìƒê°í•˜ì
----------------------
|      |      |      |
|      |      |      |
|      |      |      |
----------------------
```

* ì˜ˆë¥¼ë“¤ì–´ ì´ë ‡ê²Œ ìƒê°í•´ ë³´ì.
* í•˜ë‚˜ì˜ ê²©ìì— 10ì´ ë“¤ì–´ì˜¤ê³  1ì´ ë‚˜ê°„ë‹¤ë©´?
* ì••ë ¥ì€ ì–´ë–»ê²Œ ë ê¹Œ?

```
      --------
      |      |
10 -> |      | -> 1
      |      |
      --------
```

* ì••ë ¥ì€ ëŠ˜ì–´ë‚˜ë©° ë‹¤ë¥¸ê²©ìì—ì„œ ì´ ê²©ìë¡œ ì´ë™í•˜ë ¤í•  ê²ƒì´ë‹¤.
* ê·¸ëŸ°ë° ìœ ì²´ì˜ ì´ë™ì„ ì–´ë–»ê²Œ ì˜ˆì¸¡í• ê¹Œ?
    * ì´ë ‡ê²Œ ìƒê°í•˜ë©´ í¸í•˜ë‹¤ í•´ë‹¹ pixelì˜ ì…ìì˜ ê¸°ì¡´ìœ„ì¹˜ì—ì„œ í”½ìƒì„ ë°›ì•„ì˜¨ë‹¤ (Semi-Lagrangian)

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/graphics/part4/p4-13-1.jfif"/>
</p>

```cpp
// ì˜¤íˆë ¤ ì½”ë“œë¥¼ ë³´ëŠ”ê²Œ í¸í•˜ë‹¤

[numthreads(32, 32, 1)]
void main(int3 gID : SV_GroupID, int3 gtID : SV_GroupThreadID,
          uint3 dtID : SV_DispatchThreadID)
{
    uint width, height;
    velocity.GetDimensions(width, height);
    float2 dx = float2(1.0 / width, 1.0 / height);
    float2 pos = (dtID.xy + 0.5) * dx; // ì´ ì“°ë ˆë“œê°€ ì²˜ë¦¬í•˜ëŠ” ì…€ì˜ ì¤‘ì‹¬
    
    // 1. velocityTempë¡œë¶€í„° ì†ë„ ìƒ˜í”Œë§í•´ì˜¤ê¸°
    float2 vel = velocityTemp.SampleLevel(linearWrapSS, pos, 0).xy;
    
    // 2. ê·¸ ì†ë„ë¥¼ ì´ìš©í•´ì„œ ì—­ì¶”ì  ìœ„ì¹˜ ê³„ì‚°
    float2 posBack = pos - vel * dt;

    // 3. ê·¸ ìœ„ì¹˜ì—ì„œ ìƒ˜í”Œë§ í•´ì˜¤ê¸°
    velocity[dtID.xy] = velocityTemp.SampleLevel(linearWrapSS, posBack, 0);
    density[dtID.xy] = densityTemp.SampleLevel(linearWrapSS, posBack, 0);
}
```

---

## Chorin's Projection Method

* ìœ ì²´ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•˜ëŠ” ë°©ë²• ì¤‘ í•˜ë‚˜

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/graphics/part4/p4-13-1.png"/>
</p>

* ì´ ì‹ì„ êµ¬í˜„í•´ì•¼í•˜ëŠ”ë° ë³´í†µì˜ ë°©ë²•ìœ¼ë¡  ì‰½ì§„ ì•Šë‹¤
* í•µì‹¬ì€ ì–´ë–»ê²Œ Compute Shaderë¥¼ ì´ìš©í•´ ì´ ì‹ì„ êµ¬í˜„í•  ê²ƒì¸ê°€ì´ë‹¤.

---

## ìœ í•œ ì°¨ë¶„ë²• (Finite Difference Method)

* ìœ í•œ ì°¨ë¶„ë²•ì€ ë¯¸ë¶„ë°©ì •ì‹ì„ ìˆ˜ì¹˜ì ìœ¼ë¡œ í’€ê¸° ìœ„í•œ ë°©ë²•ì´ë‹¤.

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/graphics/part4/p4-13-2.jpg"/>
</p>

```cpp
// Divergence êµ¬í•˜ê¸°
[numthreads(32, 32, 1)]
void main(int3 gID : SV_GroupID, int3 gtID : SV_GroupThreadID,
          uint3 dtID : SV_DispatchThreadID)
{
    uint width, height;
    divergence.GetDimensions(width, height);
    float2 dx = float2(1.0 / width, 1.0 / height);

    // ì¢Œ/ìš°/ìƒ/í•˜ì˜ indexë¥¼ êµ¬í•œë‹¤.
    uint2 left = uint2(dtID.x == 0 ? width - 1 : dtID.x - 1, dtID.y);
    uint2 right = uint2(dtID.x == width - 1 ? 0 : dtID.x + 1, dtID.y);
    uint2 up = uint2(dtID.x, dtID.y == height - 1 ? 0 : dtID.y + 1);
    uint2 down = uint2(dtID.x, dtID.y == 0 ? height - 1 : dtID.y - 1);
    
    divergence[dtID.xy] = 0.5 * (velocity[right].x - velocity[left].x +
                                velocity[up].y - velocity[down].y);
    
    pressure[dtID.xy] = 0.0;
    pressureTemp[dtID.xy] = 0.0;
}
```

```cpp
// Jacobi êµ¬í•˜ê¸°
[numthreads(32, 32, 1)]
void main(int3 gID : SV_GroupID, int3 gtID : SV_GroupThreadID,
          uint3 dtID : SV_DispatchThreadID)
{
    // Dirichlet boundary condition
    if (dtID.x == 0 && dtID.y == 0)
    {
        pressureOut[dtID.xy] = 0.0;
        return;
    }
    
    uint width, height;
    pressureOut.GetDimensions(width, height);
    float2 dx = float2(1.0 / width, 1.0 / height);

    // ì¢Œ/ìš°/ìƒ/í•˜ì˜ indexë¥¼ êµ¬í•œë‹¤.
    uint2 left = uint2(dtID.x == 0 ? width - 1 : dtID.x - 1, dtID.y);
    uint2 right = uint2(dtID.x == width - 1 ? 0 : dtID.x + 1, dtID.y);
    uint2 up = uint2(dtID.x, dtID.y == height - 1 ? 0 : dtID.y + 1);
    uint2 down = uint2(dtID.x, dtID.y == 0 ? height - 1 : dtID.y - 1);
    
    pressureOut[dtID.xy] = (-divergence[dtID.xy]
        + pressureTemp[left].x
        + pressureTemp[right].x
        + pressureTemp[up].x
        + pressureTemp[down].x) * 0.25;
}
```

```cpp
[numthreads(32, 32, 1)]
void main(int3 gID : SV_GroupID, int3 gtID : SV_GroupThreadID,
          uint3 dtID : SV_DispatchThreadID)
{
    uint width, height;
    velocity.GetDimensions(width, height);
    float2 dx = float2(1.0 / width, 1.0 / height);
    
    uint2 left = uint2(dtID.x == 0 ? width - 1 : dtID.x - 1, dtID.y);
    uint2 right = uint2(dtID.x == width - 1 ? 0 : dtID.x + 1, dtID.y);
    uint2 up = uint2(dtID.x, dtID.y == height - 1 ? 0 : dtID.y + 1);
    uint2 down = uint2(dtID.x, dtID.y == 0 ? height - 1 : dtID.y - 1);
    
    float2 dp = float2(pressure[right].x - pressure[left].x,
                       pressure[up].x - pressure[down].x);

    velocity[dtID.xy] -= dp * 0.5;
}
```

---

