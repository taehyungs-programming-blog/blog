---
layout: default
title: "07. Density Field"
parent: "(Computer Animation)"
grand_parent: "(Graphics ğŸ˜)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* [Get Code ğŸŒ](https://github.com/Arthur880708/Graphics_Part4/blob/main/Examples/Ex1406_DensityField.h)

* íŒŒí‹°í´ì„ ì¡°ê¸ˆ ë” ì´ì˜ê²Œ ë§Œë“¤ì–´ ë³´ì.
* ìš°ì„  Geometry Shaderì—ì„œ ë¬´ìŠ¨ì¼ì„ í•˜ëŠ”ì§€ ë¨¼ì € ë³´ì

```cpp
struct GeometryShaderInput
{
    float4 pos : SV_POSITION;
    float3 color : COLOR;
};

struct PixelShaderInput
{
    float4 pos : SV_POSITION; // not POSITION
    float2 texCoord : TEXCOORD;
    float3 color : COLOR;
    uint primID : SV_PrimitiveID;
};

[maxvertexcount(4)]
void main(point GeometryShaderInput input[1], 
        uint primID : SV_PrimitiveID,
        inout TriangleStream<PixelShaderInput> outputStream)
{
    const float width = 0.1;
    
    float hw = 0.3 * width;
    float3 up = float3(0, 1, 0);
    float3 right = float3(1, 0, 0);
    
    PixelShaderInput output;
    output.pos.w = 1;
    output.color = input[0].color;
    
    output.pos.xyz = input[0].pos.xyz - hw * right - hw * up;
    output.texCoord = float2(0.0, 1.0);
    output.primID = primID;
    
    outputStream.Append(output);

    output.pos.xyz = input[0].pos.xyz - hw * right + hw * up;
    output.texCoord = float2(0.0, 0.0);
    output.primID = primID;
    
    outputStream.Append(output);
    
    output.pos.xyz = input[0].pos.xyz + hw * right - hw * up;
    output.texCoord = float2(1.0, 1.0);
    output.primID = primID;
    
    outputStream.Append(output);
    
    output.pos.xyz = input[0].pos.xyz + hw * right + hw * up;
    output.texCoord = float2(1.0, 0.0);
    output.primID = primID;

    outputStream.Append(output);
    outputStream.RestartStrip(); 
}
```

* í•˜ê³ ì í•˜ëŠ” ê²ƒì€ ê°„ë‹¨í•˜ë‹¤
    * `point GeometryShaderInput input[1]`ë¡œ í•œ ì ì˜ ë°ì´í„°ê°€ ë“¤ì–´ì˜¤ë©´
    * `inout TriangleStream<PixelShaderInput> outputStream`ë¡œ Vertexë¡œ ë§Œë“¤ì–´ outí•´ì¤€ë‹¤
* ê·¸ëŸ¼ point ì •ë³´ëŠ” ì–´ë””ì„œ ë„£ì–´ì£¼ë‚˜
    * `m_context->VSSetShaderResources(0, 1, m_particles.GetAddressOfSRV());`ë¥¼ í†µí•´ CSë¥¼ í†µí•´ ë§Œë“  Vertexì •ë³´ë¥¼ ë„˜ê¸°ê²Œ ëœë‹¤.

---

## í•œë²ˆ ê·¸ë˜í”½ìŠ¤ ë””ë²„ê±°ë¥¼ ëŒë ¤ë³´ì

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/graphics/part4/p4-7-1.png"/>
</p>

* Dispatchê°€ ì¼ì–´ë‚¨ì„ ì•ˆë‹¤

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/graphics/part4/p4-7-2.png"/>
</p>

---

## Pixel Shader

```cpp
struct PixelShaderInput
{
    float4 pos : SV_POSITION; // not POSITION
    float2 texCoord : TEXCOORD;
    float3 color : COLOR;
    uint primID : SV_PrimitiveID;
};

// https://en.wikipedia.org/wiki/Smoothstep
    // ëŒ€ëµ ì¤‘ì‹¬ì—ì„œ ë©€ì–´ì§ˆìˆ˜ë¡ ìƒ‰ì„ ì¤„ì¸ë‹¤ ìƒê°€í•˜ì
float smootherstep(float x, float edge0 = 0.0f, float edge1 = 1.0f)
{
    x = clamp((x - edge0) / (edge1 - edge0), 0, 1);

    return x * x * x * (3 * x * (2 * x - 5) + 10.0f);
}

float4 main(PixelShaderInput input) : SV_TARGET
{
    float dist = length(float2(0.5, 0.5) - input.texCoord) * 2;
    float scale = smootherstep(1 - dist);
    return float4(input.color.rgb * scale, 1);
}
```

---

## í•µì‹¬! Render!

```cpp
void Render() {
    
    // ì•„ë˜ ì„¸ ë‹¨ê³„ë¥¼ ê±°ì¹˜ê²Œ ëœë‹¤.
    DissipateDensity();
    AdvectParticles();
    DrawSprites();

    ComPtr<ID3D11Texture2D> backBuffer;
    ThrowIfFailed(
        m_swapChain->GetBuffer(0, IID_PPV_ARGS(backBuffer.GetAddressOf())));
    m_context->CopyResource(backBuffer.Get(), m_densityTex.GetTexture());
}
```

```cpp
void DissipateDensity() { // Density Fieldì˜ Dissipation
                                               // (Compute Shader)
    m_context->CSSetUnorderedAccessViews(0, 1, m_densityTex.GetAddressOfUAV(),
                                         NULL);
    m_context->CSSetShader(m_densityDissipationCS.Get(), 0, 0);
    m_context->Dispatch(UINT(ceil(m_screenWidth / 32.0f)),
                        UINT(ceil(m_screenHeight / 32.0f)), 1);
    AppBase::ComputeShaderBarrier();
}
```

* DensityDissipationCS

```cpp
RWTexture2D<float4> densityField : register(u0);

[numthreads(32, 32, 1)]
void main(int3 gID : SV_GroupID, int3 gtID : SV_GroupThreadID,
          uint3 dtID : SV_DispatchThreadID)
{
    const float dissipation = 0.1f; 

    float3 color = densityField[dtID.xy].rgb - dissipation;
    color = max(0, color);

    densityField[dtID.xy] = float4(color.rgb, 1.0);
}

```

```cpp
void AdvectParticles() {

    // ì…ìë“¤ì´ Density fieldì— ìƒ‰ìƒ ì¶”ê°€ sourcing (Compute Shader)
    // ì£¼ì˜: ComputeShaderë²„ì „ì€ Thread-safe í•˜ì§€ ì•ŠìŒ -> Draw() ì‚¬ìš©

    ID3D11UnorderedAccessView *uavs2[2] = {m_particles.GetUAV(),
                                           m_densityTex.GetUAV()};
    m_context->CSSetUnorderedAccessViews(0, 2, uavs2, NULL);
    m_context->CSSetShader(m_densitySourcingCS.Get(), 0, 0);
    m_context->Dispatch(UINT(ceil(m_particles.m_cpu.size() / 256.0f)), 1, 1);
    AppBase::ComputeShaderBarrier();
}

void DrawSprites() {

    // Geometry Shaderë¡œ Particle Sprites ê·¸ë¦¬ê¸°

    AppBase::SetMainViewport();

    // ì‹œê°„ì— ë”°ë¥¸ ëˆ„ì  íš¨ê³¼(ëª¨ì…˜ ë¸”ëŸ¬)ë¥¼ ì›í• ë•ŒëŠ” Clear ìƒëµ
    // const float clearColor[4] = {0.0f, 0.0f, 0.0f, 1.0f};
    // m_context->ClearRenderTargetView(m_densityTex.GetRTV(), clearColor);

    m_context->OMSetRenderTargets(1, m_densityTex.GetAddressOfRTV(), NULL);
    m_context->VSSetShader(m_vertexShader.Get(), 0, 0);
    m_context->GSSetShader(m_spriteGS.Get(), 0, 0);
    m_context->PSSetShader(m_pixelShader.Get(), 0, 0);
    m_context->CSSetShader(NULL, 0, 0);
    // TODO: m_context->OMSetBlendState(...)

    m_context->IASetPrimitiveTopology(D3D11_PRIMITIVE_TOPOLOGY_POINTLIST);
    m_context->VSSetShaderResources(0, 1, m_particles.GetAddressOfSRV());
    m_context->Draw(UINT(m_particles.m_cpu.size()), 0);
}
```