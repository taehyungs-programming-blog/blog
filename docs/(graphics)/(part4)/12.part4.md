---
layout: default
title: "12. Smoothed Particle Hydrodynamics(SPH)"
parent: "(Computer Animation)"
grand_parent: "(Graphics ğŸ˜)"
nav_order: 2
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* [Get Code ğŸŒ](https://github.com/Arthur880708/Graphics_Part4/blob/main/Examples/Ex1503_SphWater.h)

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/graphics/part4/p4-12-1.gif"/>
</p>

* ì›ë¦¬ëŠ” ê°„ë‹¨í•˜ë‹¤. ì£¼ë³€ì˜ ì…ì(Particle)ë¥¼ ë¶„ì„í›„ ê°€ê¹Œì´ ìˆë‹¤ë©´ ì„œë¡œë¥¼ ë°€ì–´ë‚´ê²Œ ë§Œë“¤ì.
    * ì¶”ê°€ì ìœ¼ë¡œ ê±°ê¸°ë‹¤ ì ì„±ì„ ë” í•¨.
    * ì ì„±ì´ë¼ í•¨ì€ ... ì…ìê°„ì˜ ì†ë„ê°€ ë‹¤ë¥¼ë•Œ ë¹ ë¥¸ì†ë„ëŠ” ì†ë„ë¥¼ ëŠ¦ì¶”ê³  ëŠë¦°ì†ë„ëŠ” ì†ë„ë¥¼ ë”í•˜ë©´ ì ì„±ì´ êµ¬í˜„ëœë‹¤.
* ì½”ë“œë¡œ ë³´ìë©´ ...

```cpp
class SphSimulation {
  public:
    struct Particle {
        Vector3 position = Vector3(0.0f);
        Vector3 velocity = Vector3(0.0f);
        Vector3 force = Vector3(0.0f);
        // ì…ìì— densityì™€ pressureê°€ ìˆë‹¤ëŠ”ê²ƒì— ì£¼ëª©í•˜ì
        float density = 0.0f;
        float pressure = 0.0f;

        Vector3 color = Vector3(1.0f);
        float life = 0.0f;
        float size = 1.0f;
    };

    void Update(float dt);
    void UpdateDensity();
    void UpdateForces();

    vector<Particle> m_particlesCpu;
    float m_radius = 1.0f / 16.0f;
    float m_mass = 1.0f;

    // ì…ìê°„ ì–¼ë§ˆë‚˜ ë°€ì–´ë‚´ëŠ”ì§€ë¥¼ ì˜ë¯¸
    float m_pressureCoeff = 1.0f;
    float m_density0 = 1.0f;
    float m_viscosity = 0.1f;


    // ...
```

```cpp
void SphSimulation::UpdateDensity() {

#pragma omp parallel for
    for (int i = 0; i < m_particlesCpu.size(); i++) {

        // particleì˜ lifeê°€ 0ì´ë¼ë©´ continue
        if (m_particlesCpu[i].life < 0.0f)
            continue;

        // ë°€ë„ë¥¼ êµ¬í•´ë³¸ë‹¤
        m_particlesCpu[i].density = 0.0f;

        for (size_t j = 0; j < m_particlesCpu.size(); j++) {

            if (m_particlesCpu[j].life < 0.0f)
                continue;

            const float dist =
                (m_particlesCpu[i].position - m_particlesCpu[j].position)
                    .Length();

            // ë„ˆë¬´ ë¨¼ particleì€ ë¬´ì‹œ
            if (dist >= m_radius)
                continue;

            // ì…ìê°„ì˜ ë°€ë„ë¥¼ êµ¬í•œë‹¤
            m_particlesCpu[i].density +=
                m_mass * SphKernels::CubicSpline(dist * 2.0f / m_radius);
        }

        // densityë¡œ ë¶€í„° ì••ë ¥êµ¬í•˜ê¸°
        m_particlesCpu[i].pressure =
            m_pressureCoeff *
            (pow(m_particlesCpu[i].density / m_density0, 7.0f) - 1.0f);
    }
}
```

```cpp
static float CubicSpline(const float q) {

    assert(q >= 0.0f);

    constexpr float coeff = 3.0f / (2.0f * 3.141592f);

    if (q < 1.0f)
        return coeff * (2.0f / 3.0f - q * q + 0.5f * q * q * q);
    else if (q < 2.0f)
        return coeff * pow(2.0f - q, 3.0f) / 6.0f;
    else // q >= 2.0f
        return 0.0f;
}
```

* ì´ì œ ìœ„í•´ì„œ êµ¬í•œ ì…ìì˜ Pressureì™€ ì ì„±ì„ ì´ìš©í•˜ì—¬ ì…ìì— í˜ì„ ê°€í•´ë³´ì.

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/graphics/part4/p4-12-1.png"/>
</p>

* Pressureì˜ í¸ë¯¸ë¶„
* ì ì„± 2ì°¨ í¸ë¯¸ë¶„??
    * ì´ê±¸ ì–´ë–»ê²Œ êµ¬í˜„í•˜ì§€?
    * ì´ ë¶€ë¶„ì€ ë…¼ë¬¸ì„ ë´ì•¼í•˜ëŠ”ë°, í•„ìš”í•œ ê²½ìš° ì°¾ì•„ë³´ì (...ã… )
    * êµ¬í˜„ì€ ì•„ë˜ì™€ ê°™ë‹¤

```cpp
const Vector3 gradPressure =
    rho_i * m_mass *
    (p_i / (rho_i * rho_i) + p_j / (rho_j * rho_j)) *
        SphKernels::CubicSplineGrad(dist * 2.0f / m_radius) *
            (x_i - x_j) / dist;

const Vector3 laplacianVelocity =
    2.0f * m_mass / rho_i * (v_i - v_j) /
        (x_ij.LengthSquared() + 0.01f * m_radius * m_radius) *
            SphKernels::CubicSplineGrad(dist * 2.0f / m_radius) *
                x_ij.Dot(x_ij / dist);

pressureForce -= m_mass / rho_i * gradPressure;
viscosityForce += m_mass * m_viscosity * laplacianVelocity;
```