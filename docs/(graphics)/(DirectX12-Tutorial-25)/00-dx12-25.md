---
layout: default
title: "(DirectX12 25년 Tutorial)"
parent: "(Graphics 😎)"
has_children: true
nav_order: 2
---

* 이 강의는 재정리 하는 강의 입니다.
    * 기초적 내용은 없다는 말 ㅋ
* 참조하면 좋은 강의 -> [Link](youtube.com/live/wr8PHg-g4ns?si=4TKtJldg0JwH8DTO)

---

## Debug Layer

### 사전 준비사항

* **중요**: Debugging을 위해서 Debug Layer를 활성화하는 것을 잊지 말자!

#### Windows 설정
1. **시스템** → **개발자용** → **개발자 모드** (켜두기)
2. **시스템** → **선택적 기능** → **Graphics Tools** 설치

### Debug Layer란?

Debug Layer는 D3D12 애플리케이션 개발 시 다양한 오류를 검출하고 디버깅하는 데 도움을 주는 검증 레이어입니다.

#### 기본 Debug Layer
- 기본적으로 **CPU 타임라인에서만 검증** 수행
- API 호출의 유효성을 검증
- 잘못된 파라미터, 상태 전환 오류 등을 검출

**제약사항:**
- 전달받은 GPU 리소스의 주소가 정상인지 확인할 수 없음
- GPU에서 실제 실행되는 시점의 상태는 확인할 수 없음

#### GPU-Based Validation (GBV)

GPU-Based Validation은 더욱 강력한 검증 기능을 제공합니다:

**주요 기능:**
- **GPU 타임라인에서 Validation 수행** - GPU 리소스의 무결성을 실시간으로 확인
- **Shader 코드의 런타임 체크** - Out-of-bounds access, uninitialized data 등을 검출
- Descriptor heap 오버플로우, 리소스 바인딩 오류 등을 감지

**주의사항:**
- 드라이버 및 GPU 하드웨어에 따라 다른 증상을 보일 수 있음
- NVIDIA, AMD의 dGPU가 아닌 내장 GPU 제품들에서는 정상 작동을 보장할 수 없음
- **그래도 일단 켜두는 게 이득이 크다** - 치명적인 버그를 조기에 발견 가능

**성능 영향:**
- GBV를 활성화하면 **상당한 성능 저하**가 발생함
- 개발/디버깅 빌드에서만 사용하고, 릴리스 빌드에서는 비활성화해야 함

### Debug Layer 활성화 코드

#### 기본 Debug Layer 활성화

```cpp
#if defined(_DEBUG)
    // Debug Layer 활성화
    Microsoft::WRL::ComPtr<ID3D12Debug> debugController;
    if (SUCCEEDED(D3D12GetDebugInterface(IID_PPV_ARGS(&debugController))))
    {
        debugController->EnableDebugLayer();
    }
#endif

// Device 생성
Microsoft::WRL::ComPtr<ID3D12Device> device;
D3D12CreateDevice(nullptr, D3D_FEATURE_LEVEL_11_0, IID_PPV_ARGS(&device));
```

#### GPU-Based Validation 활성화

```cpp
#if defined(_DEBUG)
    Microsoft::WRL::ComPtr<ID3D12Debug> debugController;
    if (SUCCEEDED(D3D12GetDebugInterface(IID_PPV_ARGS(&debugController))))
    {
        debugController->EnableDebugLayer();

        // GPU-Based Validation 활성화
        Microsoft::WRL::ComPtr<ID3D12Debug1> debugController1;
        if (SUCCEEDED(debugController.As(&debugController1)))
        {
            debugController1->SetEnableGPUBasedValidation(TRUE);
        }
    }
#endif
```

#### DRED (Device Removed Extended Data) 활성화

DRED는 GPU hang이나 Device Removed 상황에서 추가 정보를 제공합니다:

```cpp
#if defined(_DEBUG)
    Microsoft::WRL::ComPtr<ID3D12DeviceRemovedExtendedDataSettings> dredSettings;
    if (SUCCEEDED(D3D12GetDebugInterface(IID_PPV_ARGS(&dredSettings))))
    {
        // AutoBreadcrumbs와 Page Fault 정보 활성화
        dredSettings->SetAutoBreadcrumbsEnablement(D3D12_DRED_ENABLEMENT_FORCED_ON);
        dredSettings->SetPageFaultEnablement(D3D12_DRED_ENABLEMENT_FORCED_ON);
    }
#endif
```

### Debug Layer 메시지 필터링

개발 중 불필요한 경고를 필터링할 수 있습니다:

```cpp
#if defined(_DEBUG)
    Microsoft::WRL::ComPtr<ID3D12InfoQueue> infoQueue;
    if (SUCCEEDED(device.As(&infoQueue)))
    {
        // Break on Severity
        infoQueue->SetBreakOnSeverity(D3D12_MESSAGE_SEVERITY_CORRUPTION, TRUE);
        infoQueue->SetBreakOnSeverity(D3D12_MESSAGE_SEVERITY_ERROR, TRUE);
        
        // 특정 메시지 필터링
        D3D12_MESSAGE_ID denyIds[] = {
            D3D12_MESSAGE_ID_CLEARRENDERTARGETVIEW_MISMATCHINGCLEARVALUE,
            // 추가 필터링할 메시지 ID
        };

        D3D12_INFO_QUEUE_FILTER filter = {};
        filter.DenyList.NumIDs = _countof(denyIds);
        filter.DenyList.pIDList = denyIds;
        infoQueue->AddStorageFilterEntries(&filter);
    }
#endif
```

---

## D3D12 Agility SDK

### Agility SDK란?

D3D12는 **OS 업데이트 주기**와 **D3D12 업데이트 주기**가 다릅니다. 이로 인해:
- 최신 D3D12 기능을 사용하려면 Windows Update를 기다려야 함
- 구형 OS에서 최신 기능을 사용할 수 없음

**Agility SDK**는 이 문제를 해결하여:
- 애플리케이션과 함께 최신 D3D12 런타임을 배포 가능
- OS 버전과 무관하게 최신 D3D12 기능 사용 가능
- Windows 10 버전 1909 이상에서 지원

### 설치 방법

#### 방법 1: NuGet Package 설치 (권장)

1. Visual Studio에서 프로젝트 열기
2. **도구** → **NuGet 패키지 관리자** → **솔루션용 NuGet 패키지 관리**
3. **찾아보기** 탭에서 `Microsoft.Direct3D.D3D12` 검색
4. 패키지 설치

#### 방법 2: 수동 다운로드

[Download Link](https://devblogs.microsoft.com/directx/directx12agility/)

### Agility SDK 설정

#### 1. 코드에 SDK 버전 선언

```cpp
// D3D12 Agility SDK export
extern "C" { __declspec(dllexport) extern const UINT D3D12SDKVersion = 614; }
extern "C" { __declspec(dllexport) extern const char* D3D12SDKPath = u8".\\D3D12\\"; }
```

- `D3D12SDKVersion`: 사용할 Agility SDK 버전 번호
- `D3D12SDKPath`: D3D12Core.dll 및 d3d12SDKLayers.dll의 상대 경로

#### 2. DLL 파일 배포

실행 파일과 같은 디렉토리에 `D3D12` 폴더를 생성하고 다음 파일들을 복사:
- `D3D12Core.dll`
- `d3d12SDKLayers.dll` (Debug 빌드용)

```
YourApp.exe
└── D3D12/
    ├── D3D12Core.dll
    └── d3d12SDKLayers.dll
```

#### 3. 버전 확인

```cpp
// Agility SDK가 제대로 로드되었는지 확인
Microsoft::WRL::ComPtr<ID3D12Device> device;
HRESULT hr = D3D12CreateDevice(nullptr, D3D_FEATURE_LEVEL_11_0, IID_PPV_ARGS(&device));
if (SUCCEEDED(hr))
{
    // Device의 기능 체크
    D3D12_FEATURE_DATA_D3D12_OPTIONS12 options12 = {};
    device->CheckFeatureSupport(D3D12_FEATURE_D3D12_OPTIONS12, &options12, sizeof(options12));
}
```

### 주의사항

1. **릴리스 빌드**: 반드시 최종 배포 패키지에 D3D12 폴더와 DLL 파일을 포함해야 함
2. **버전 관리**: 새 SDK 버전이 나오면 `D3D12SDKVersion`을 업데이트하고 새 DLL로 교체
3. **호환성**: 최소 Windows 10 버전 1909 (build 18363) 이상 필요

### Agility SDK의 장점

- ✅ 최신 D3D12 기능을 즉시 사용 가능 (Enhanced Barriers, Work Graphs 등)
- ✅ OS 업데이트와 무관하게 버그 수정 및 성능 개선 적용
- ✅ 다양한 Windows 버전에서 일관된 동작 보장
- ✅ 개발 주기 단축

---

## 추가 참고 자료

### 공식 문서
- [D3D12 Programming Guide](https://docs.microsoft.com/en-us/windows/win32/direct3d12/directx-12-programming-guide)
- [DirectX Developer Blog](https://devblogs.microsoft.com/directx/)
- [PIX on Windows](https://devblogs.microsoft.com/pix/documentation/)

### 디버깅 도구
- **PIX**: GPU 디버깅 및 프로파일링 도구
- **RenderDoc**: 크로스 플랫폼 그래픽 디버거
- **Visual Studio Graphics Debugger**: VS 통합 그래픽 디버거

### 성능 최적화
- GPU Memory 관리에 주의 (Committed Resources vs Placed Resources)
- Resource Barrier를 최소화
- Command List 재사용 및 멀티스레딩 활용
- PSO (Pipeline State Object) 사전 생성

