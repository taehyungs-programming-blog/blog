---
layout: default
title: "(21. ServerListen ê³¼ì •ìœ¼ë¡œ ë³´ëŠ” UEì—”ì§„ ì´í•´í•˜ê¸°)"
parent: "(UE Code-Review ğŸ¤–)"
has_children: true
nav_order: 3
permalink: docs/review/ue/ver4/21/ServerListen
---

## Entry Point

```cpp
// UGameInstanceë¥¼ Createí•˜ëŠ” ê³¼ì •ì—ì„œ ì‹œì‘í•œë‹¤.
UGameInstance* EditorEngine::CreateInnerProcessPIEGameInstance(
    FRequestPlaySessionParams& InParams, 
    const FGameInstancePIEParameters& InPIEParameters, 
    int32 InPIEInstanceIndex)
{
    FSoftClassPath GameInstanceClassName = GetDefault<UGameMapsSettings>()->GameInstanceClass;

    UClass* GameInstanceClass = GameInstanceClassName.TryLoadClass<UGameInstance>();
    if (!GameInstanceClass)
    {
        GameInstanceClass = UGameInstance::StaticClass();
    }

    UGameInstance* GameInstance = NewObject<UGameInstance>(this, GameInstanceClass);

    // ...

    StartResult = GameInstance->StartPlayInEditorGameInstance(NewLocalPlayer, InPIEParameters);
    
    // ...

    return GameInstance;
}
```

---

## ê·¼ë³¸ì  ì§ˆë¬¸ GameInstanceê°€ ë­˜ê¹Œ?

* GameInstanceëŠ” ê²Œì„ì˜ ìµœìƒìœ„ ê´€ë¦¬ì ì—­í• 
* GameInstanceì˜ ì—­í• ë¡œ ì„¤ëª…í•´ ë³´ì

### ê²Œì„ ì„¸ì…˜ì˜ ìƒëª…ì£¼ê¸° ê´€ë¦¬

```cpp
// GameInstanceëŠ” ê²Œì„ì´ ì‹œì‘ë¶€í„° ì¢…ë£Œê¹Œì§€ ì‚´ì•„ìˆëŠ” ìœ ì¼í•œ ê°ì²´
class UGameInstance : public UObject
{
    // ì›”ë“œê°€ ë°”ë€Œì–´ë„ GameInstanceëŠ” ìœ ì§€ë¨
    TObjectPtr<UWorld> CurrentWorld;
    TArray<ULocalPlayer*> LocalPlayers;
};
```

### ì›”ë“œ ì „í™˜ ì‹œ ë°ì´í„° ë³´ì¡´

```cpp
// ì›”ë“œê°€ ë°”ë€” ë•Œë§ˆë‹¤ í˜¸ì¶œ
void OnWorldChanged(UWorld* OldWorld, UWorld* NewWorld)
{
    // í”Œë ˆì´ì–´ ë°ì´í„°, ê²Œì„ ì„¤ì • ë“±ì„ ë³´ì¡´
    // ì˜ˆ: í”Œë ˆì´ì–´ ë ˆë²¨, ì¸ë²¤í† ë¦¬, ê²Œì„ ì„¤ì • ë“±
}
```

### í”Œë ˆì´ì–´ ê´€ë¦¬

```cpp
// LocalPlayerë“¤ì„ ê´€ë¦¬ (ë©€í‹°í”Œë ˆì´ì–´ì—ì„œ ì—¬ëŸ¬ í”Œë ˆì´ì–´ ê°€ëŠ¥)
TArray<ULocalPlayer*> LocalPlayers;

ULocalPlayer* GetFirstGamePlayer()
{
    return LocalPlayers.Num() > 0 ? LocalPlayers[0] : nullptr;
}
```

### Engine Vs GameInstance

```
// EditorEngine: ì—ë””í„° ê´€ë ¨ ì‘ì—…
// â”œâ”€â”€ PIE ìš”ì²­ ì²˜ë¦¬
// â”œâ”€â”€ ì›”ë“œ ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬
// â””â”€â”€ GameInstance ìƒì„±

// GameInstance: ê²Œì„ ê´€ë ¨ ì‘ì—…  
// â”œâ”€â”€ ê²Œì„ ì´ˆê¸°í™”
// â”œâ”€â”€ í”Œë ˆì´ì–´ ê´€ë¦¬
// â””â”€â”€ ì›”ë“œ ê´€ë¦¬
```

---

> ë‹¤ì‹œ, ë³¸ë¡ ìœ¼ë¡œ

## StartPlayInEditorGameInstance

* ì¼ë‹¨ ë³„ë„ì˜ ì„¤ëª…(ì£¼ì„)ì´ ì—†ëŠ”ë° ê¹Œì§„ ê·¸ëƒ¥ ë”°ë¼ê°€ì.

```cpp
virtual FGameInstancePIEResult GameInstance::StartPlayInEditorGameInstance(
    ULocalPlayer* LocalPlayer, 
    const FGameInstancePIEParameters& Params)
{
    UEditorEngine* const EditorEngine = CastChecked<UEditorEngine>(GetEngine());
    {
        if (Params.NetMode == PIE_Client)
        {
            // ...
        }
        else 
        {
            UWorld* const PlayWorld = GetWorld();

            FURL URL;
            {
                //...
            }

            PlayWorld->SetGameMode(URL);
            PlayWorld->InitializeActorsForPlay(URL);

            if (LocalPlayer)
            {
                FString Error;

                if (!LocalPlayer->SpawnPlayActor(URL.ToString(1), Error, PlayWorld))
                {
                    return FGameInstancePIEResult::Failure(FText::Format(NSLOCTEXT("UnrealEd", "Error_CouldntSpawnPlayer", "Couldn't spawn player: {0}"), FText::FromString(Error)));
                }
            }

            if (Params.NetMode == PIE_ListenServer)
            {
                uint32 ListenPort = 0;
                uint16 ServerPort = 0;
                if (Params.EditorPlaySettings->GetServerPort(ServerPort))
                {
                    ListenPort = ServerPort;
                }

                EnableListenServer(true, ListenPort);
            }

            PlayWorld->BeginPlay();
        }
    }
}
```

```cpp
virtual bool GameInstance::EnableListenServer(
    bool bEnable, int32 PortOverride = 0)
{
    UWorld* World = GetWorld();
    ENetMode ExistingMode = World->GetNetMode();

    if (ExistingMode == NM_Client)
    {
        return false;
    }

    int32 DefaultListenPort = FURL::UrlConfig.DefaultPort;
    if (bEnable)
    {
        if (PortOverride != 0)
        {
            WorldContext->LastURL.Port = PortOverride;
        }
        WorldContext->LastURL.AddOption(TEXT("Listen"));

        if (!World->GetNetDriver())
        {
            FURL ListenURL = WorldContext->LastURL;

            // ì–´ë–»ê²Œ ë³´ë©´ ì—¬ê¸°ì„œ ë¶€í„° ì½”ë“œì˜ ì‹œì‘ì´ë‹¤.
            return World->Listen(ListenURL);
        }
        else
        {
            return true;
        }
    }
    else
    {
        //...

        return true;
    }
}
```

### Q) Engineì´ ì•„ë‹ˆë¼ Worldì—ì„œ NetDriverë¥¼ ê´€ë¦¬í•œë‹¤ê³ ?

* 1. ë„¤íŠ¸ì›Œí¬ì™€ ê²Œì„ ì›”ë“œì˜ ë°€ì ‘í•œ ì—°ê´€ì„±
* ì›”ë“œë³„ë¡œ ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ í™˜ê²½:
    * ì—ë””í„° ì›”ë“œ: ë„¤íŠ¸ì›Œí¬ ì—†ìŒ (NM_Standalone)
    * PIE ì„œë²„ ì›”ë“œ: ë¦¬ìŠ¨ ì„œë²„ (NM_ListenServer)
    * PIE í´ë¼ì´ì–¸íŠ¸ ì›”ë“œ: í´ë¼ì´ì–¸íŠ¸ (NM_Client)


```cpp
// 2. ì•¡í„° ë³µì œ(Replication)ì™€ì˜ ì§ì ‘ì  ì—°ê²°

// ì›”ë“œ ë‚´ì˜ ëª¨ë“  ì•¡í„°ëŠ” í•´ë‹¹ ì›”ë“œì˜ NetDriverë¥¼ í†µí•´ ë³µì œë¨
class AActor : public UObject
{
    void CallPreReplication(UNetDriver* NetDriver)
    {
        // ì´ ì•¡í„°ê°€ ì†í•œ ì›”ë“œì˜ NetDriverë¥¼ ì‚¬ìš©
        UWorld* World = GetWorld();
        if (World && World->GetNetDriver() == NetDriver)
        {
            // ì•¡í„°ì˜ ì†ì„±ë“¤ì„ ë„¤íŠ¸ì›Œí¬ë¡œ ë³µì œ
            PreReplication(NetDriver->GetReplicationDriver());
        }
    }
};
```

```cpp
// 3. ì›”ë“œë³„ ë…ë¦½ì ì¸ ë„¤íŠ¸ì›Œí¬ ê´€ë¦¬

// PIEì—ì„œ ì—¬ëŸ¬ ì›”ë“œê°€ ë™ì‹œì— ì¡´ì¬í•˜ëŠ” ê²½ìš°
void UEditorEngine::Tick(float DeltaSeconds, bool bIdleMode)
{
    for (FWorldContext& PieContext : WorldList)
    {
        if (PieContext.WorldType == EWorldType::PIE)
        {
            UWorld* PIEWorld = PieContext.World();
            
            // ê° ì›”ë“œê°€ ë…ë¦½ì ì¸ NetDriverë¥¼ ê°€ì§
            if (PIEWorld->GetNetDriver())
            {
                // ì´ ì›”ë“œë§Œì˜ ë„¤íŠ¸ì›Œí¬ ì²˜ë¦¬
                PIEWorld->GetNetDriver()->TickDispatch(DeltaSeconds);
            }
        }
    }
}
```

> Packet Handling ê³¼ì •ì€ ë‚´ìš©ì´ ê¸¸ì–´ì ¸ ì´í›„ë¡œ ë¶„ë¦¬.