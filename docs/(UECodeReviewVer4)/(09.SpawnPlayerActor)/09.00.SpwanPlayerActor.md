---
layout: default
title: "(09. NMT_Joinì„ í†µí•œ SpawnPlayerActor)"
parent: "(UE Code-Review ğŸ¤–)"
has_children: true
nav_order: 1
permalink: docs/review/ue/ver4/09/SpawnPlayerActor
---

## NMT_Joinì„ í†µí•œ SpawnPlayerActor

```cpp
virtual void NotifyControlMessage(UNetConnection* Connection, uint8 MessageType, class FInBunch& Bunch) override
{
    // ...

    case NMT_Join:
    {
        if (Connection->PlayerController == NULL)
        {
            FString ErrorMsg;

            FURL InURL(NULL, *Connection->RequestURL, TRAVEL_Absolute);
            if (!InURL.Valid)
            {
                Bunch.SetError();
                break;
            }

            Connection->PlayerController = SpawnPlayActor(
                                                    Connection, 
/*
* ROLE_Authority: owned by the sever
* ROLE_AutonomousProxy: owned by the server, but controlled by the client
* ROLE_SimulatedProxy: controlled by other client remotely
*/
                                                    ROLE_AutonomousProxy, 
                                                    InURL, 
                                                    Connection->PlayerId, 
                                                    ErrorMsg);

            //...

            Connection->QueuedBits = 0;
        }
    }
}
```

* **ROLE_AutonomousProxy** ì— ëŒ€í•œ ë³´ì¶©
    * ëŒ€ëµ ì•„ë´ì™€ ê°™ì€ ê°œë…ì´ë¼ ìƒê°í•˜ë©´ ëœë‹¤.

```
//   â”Œâ”€â”€Server==Worldâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                
//   â”‚                                           â”‚                                    â”Œâ”€Client0â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       
//   â”‚                                           â”‚                                    â”‚                                   â”‚       
//   â”‚      Actor0:â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â–ºActor0:                       â”‚       
//   â”‚       â”‚                                   â”‚             â”‚                      â”‚      â”‚                            â”‚       
//   â”‚       â”œâ”€Role:ROLE_Authority               â”‚             â”‚                      â”‚      â”œâ”€Role:ROLE_AutonomousProxy  â”‚       
//   â”‚       â”‚                                   â”‚             â”‚                      â”‚      â”‚                            â”‚       
//   â”‚       â””â”€RemoteRole:ROLE_AutonomousProxy   â”‚             â”‚                      â”‚      â””â”€RemoteRole:ROLE_Authority  â”‚       
//   â”‚                                           â”‚             â”‚                      â”‚                                   â”‚       
//   â”‚                                           â”‚             â”‚                      â”‚                                   â”‚       
//   â”‚      Actor1:â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â–ºActor1:                       â”‚       
//   â”‚       â”‚                                   â”‚             â”‚      â”‚               â”‚      â”‚                            â”‚       
//   â”‚       â”œâ”€Role:ROLE_Authority               â”‚             â”‚      â”‚               â”‚      â”œâ”€Role:ROLE_SimulatedProxy   â”‚       
//   â”‚       â”‚                                   â”‚             â”‚      â”‚               â”‚      â”‚                            â”‚       
//   â”‚       â””â”€RemoteRole:ROLE_AutonomousProxy   â”‚             â”‚      â”‚               â”‚      â””â”€RemoteRole:ROLE_Authority  â”‚       
//   â”‚                                           â”‚             â”‚      â”‚               â”‚                                   â”‚       
//   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚      â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       
//                                                             â”‚      â”‚                                                           
//                                                             â”‚      â”‚                                                           
//                                                             â”‚      â”‚               â”Œâ”€Client1â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       
//                                                             â”‚      â”‚               â”‚                                   â”‚       
//                                                             â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â–ºActor0:                       â”‚       
//                                                                    â”‚               â”‚      â”‚                            â”‚       
//                                                                    â”‚               â”‚      â”œâ”€Role:ROLE_SimulatedProxy   â”‚       
//                                                                    â”‚               â”‚      â”‚                            â”‚       
//                                                                    â”‚               â”‚      â””â”€RemoteRole:ROLE_Authority  â”‚       
//                                                                    â”‚               â”‚                                   â”‚       
//                                                                    â”‚               â”‚                                   â”‚       
//                                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â–ºActor1:                       â”‚       
//                                                                                    â”‚      â”‚                            â”‚       
//                                                                                    â”‚      â”œâ”€Role:ROLE_AutonomousProxy  â”‚       
//                                                                                    â”‚      â”‚                            â”‚       
//                                                                                    â”‚      â””â”€RemoteRole:ROLE_Authority  â”‚       
//                                                                                    â”‚                                   â”‚       
//                                                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       
//                                                                                                                        
//                                                                                                                  
```

```cpp
APlayerController* SpawnPlayActor(
    class UPlayer* NewPlayer,           // Q1) ë‚œ UNetConnectionë¥¼ ë„˜ê²¼ëŠ”ë°? UPlayerë¡œ ë°›ì•„ë„ ë ê¹Œ?
    ENetRole RemoteRole,                // ìš”ê±´ ìœ„ì—ì„œ í•´ê²°
    const FURL& InURL, 
    const FUniqueNetIdRepl& UniqueId,
    FString& Error, 
    uint8 InNetPlayerIndex = 0
    )
{
    FString Options;
    for (int32 i = 0; i < InURL.Op.Num(); ++i)
    {
        Options += TEXT("?");
        Options += InURL.Op[i];
    }

    if (AGameModeBase* const GameMode = GetAuthGameMode())
    {
        APlayerController* const NewPlayerController = GameMode->Login(NewPlayer, RemoteRole, *InURL.Portal, Options, UniqueId, Error);
        if (NewPlayerController == NULL)
        {
            UE_LOG(LogSpawn, Warning, TEXT("Login failed: %s"), *Error);
            return NULL;
        }
        
        NewPlayerController->NetPlayerIndex = InNetPlayerIndex;
        NewPlayerController->SetRole(ROLE_Authority);


        NewPlayerController->SetReplicates(RemoteRole != ROLE_None);
        if (RemoteRole == ROLE_AutonomousProxy)
        {
            NewPlayerController->SetAutonomousProxy(true);
        }

        NewPlayerController->SetPlayer(NewPlayer);

        GameMode->PostLogin(NewPlayerController);
        
        return NewPlayerController;
    }

    return nullptr;
}
```

---

## Q1) ë‚œ UNetConnectionë¥¼ ë„˜ê²¼ëŠ”ë°? UPlayerë¡œ ë°›ì•„ë„ ë ê¹Œ?

* UPlayerëŠ” UNetConnectionì˜ ë¶€ëª¨ í´ë˜ìŠ¤ì´ë‹¤.

```cpp
class UNetConnection : public UPlayer
{
    UNetConnection()
        : Driver(nullptr)
        , bInternalAck(0)
        , DefaultMaxChannelSize(32767)
        , MaxChannelSize(0)
        , InPacketId(-1)
        , OutPacketId(0)
        , OutAckPacketId(-1)
    {}
```

### UNetConnectionì˜ ì£¼ìš” ì—­í• 
* ë„¤íŠ¸ì›Œí¬ ì—°ê²° ê´€ë¦¬
    * í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ê°„ì˜ ì—°ê²° ìƒíƒœ ê´€ë¦¬ (USOCK_Invalid, USOCK_Closed, USOCK_Pending, USOCK_Open)
    * ì—°ê²° ì´ˆê¸°í™” ë° ì¢…ë£Œ ì²˜ë¦¬
* ì±„ë„ ê´€ë¦¬
    * ë‹¤ì–‘í•œ ìœ í˜•ì˜ ì±„ë„(Control, Voice, Actor ë“±) ìƒì„± ë° ê´€ë¦¬
    * ì±„ë„ì„ í†µí•œ ë°ì´í„° ì „ì†¡ ê´€ë¦¬
* íŒ¨í‚· ì²˜ë¦¬
    * íŒ¨í‚· ì†¡ìˆ˜ì‹  ì²˜ë¦¬
    * íŒ¨í‚· ì‹œí€€ìŠ¤ ë²ˆí˜¸ ê´€ë¦¬
    * ACK/NAK ì²˜ë¦¬ë¥¼ í†µí•œ ì‹ ë¢°ì„± ìˆëŠ” ë°ì´í„° ì „ì†¡ ë³´ì¥
* ë²ˆì¹˜(Bunch) ì²˜ë¦¬
    * ë°ì´í„°ë¥¼ ë²ˆì¹˜ë¡œ ë¶„í• í•˜ì—¬ ì „ì†¡
    * ì‹ ë¢°ì„± ìˆëŠ”/ì—†ëŠ” ë²ˆì¹˜ ì²˜ë¦¬
* í•¸ë“œì…°ì´í¬ ì²˜ë¦¬
    * ì—°ê²° ì„¤ì • ê³¼ì •ì—ì„œì˜ Challenge/Login ë©”ì‹œì§€ ì²˜ë¦¬

```cpp
// ì±„ë„ ìƒì„±
UChannel* CreateChannelByName(const FName& ChName, EChannelCreateFlags CreateFlags, int32 ChIndex = INDEX_NONE);

// íŒ¨í‚· ìˆ˜ì‹  ì²˜ë¦¬
virtual void ReceivedPacket(FBitReader& Reader, bool bIsReinjectedPacket=false, bool bDispatchPacket=true);

// íŒ¨í‚· ë¶„ì„ ë° ë²ˆì¹˜ ì²˜ë¦¬
virtual void DispatchPacket(FBitReader& Reader, int32 PacketId, bool& bOutSkipAck, bool& bOutHasBunchErrors);

// ACK ì²˜ë¦¬
void ReceivedAck(int32 AckPacketId, FChannelsToClose& OutChannelsToClose);

// NAK ì²˜ë¦¬
void ReceivedNak(int32 NakPacketId);

// Challenge ë©”ì‹œì§€ ì „ì†¡ (í•¸ë“œì…°ì´í¬ ê³¼ì •)
void SendChallengeControlMessage();
```

### UPlayerë¥¼ ìƒì†ë°›ëŠ” ì´ìœ ëŠ”?

* í”Œë ˆì´ì–´ ê°œë…ì˜ í™•ì¥
    * UPlayerëŠ” ê²Œì„ ë‚´ í”Œë ˆì´ì–´ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê¸°ë³¸ í´ë˜ìŠ¤
    * ë„¤íŠ¸ì›Œí¬ ì—°ê²°ëœ í”Œë ˆì´ì–´ë„ ê²°êµ­ ê²Œì„ ë‚´ í”Œë ˆì´ì–´ì´ë¯€ë¡œ ì´ ê°œë…ì„ í™•ì¥í•˜ëŠ” ê²ƒì´ ë…¼ë¦¬ì 
* PlayerControllerì™€ì˜ ì—°ê²°
    * UPlayerëŠ” APlayerControllerì— ëŒ€í•œ ì°¸ì¡°ë¥¼ ê°€ì§€ê³  ìˆë‹¤
    * UNetConnectionì´ UPlayerë¥¼ ìƒì†ë°›ìŒìœ¼ë¡œì¨ ì—°ê²°ëœ í´ë¼ì´ì–¸íŠ¸ì˜ PlayerControllerì— ì‰½ê²Œ ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤
    * ì´ë¥¼ í†µí•´ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ê³¼ ê²Œì„ ë‚´ í”Œë ˆì´ì–´ ì œì–´ë¥¼ ì—°ê²°í•œë‹¤
* ì•„í‚¤í…ì²˜ ì„¤ê³„
    * ì–¸ë¦¬ì–¼ ì—”ì§„ì—ì„œëŠ” ë¡œì»¬ í”Œë ˆì´ì–´(ULocalPlayer)ì™€ ë„¤íŠ¸ì›Œí¬ í”Œë ˆì´ì–´(UNetConnection)ë¥¼ ëª¨ë‘ UPlayerì˜ í•˜ìœ„ í´ë˜ìŠ¤ë¡œ ì²˜ë¦¬í•¨
    * ì´ë ‡ê²Œ í•¨ìœ¼ë¡œì¨ í”Œë ˆì´ì–´ê°€ ë¡œì»¬ì¸ì§€ ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ì—°ê²°ë˜ì—ˆëŠ”ì§€ì— ê´€ê³„ì—†ì´ ì¼ê´€ëœ ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤
* ê²Œì„ ë¡œì§ê³¼ ë„¤íŠ¸ì›Œí¬ ë¡œì§ì˜ ë¶„ë¦¬
    * UPlayerëŠ” ê²Œì„ ë¡œì§ì— ê´€ë ¨ëœ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤
    * UNetConnectionì€ ì—¬ê¸°ì— ë„¤íŠ¸ì›Œí¬ ê´€ë ¨ ê¸°ëŠ¥ì„ ì¶”ê°€í•œë‹¤
    * ì´ëŸ¬í•œ ìƒì† êµ¬ì¡°ë¥¼ í†µí•´ ê´€ì‹¬ì‚¬ë¥¼ ë¶„ë¦¬í•˜ê³  ì½”ë“œë¥¼ ë” ëª¨ë“ˆí™”í•  ìˆ˜ ìˆë‹¤

```cpp
class UPlayer : public UObject, public FExec
{
    /** the actor this player controls */
    TObjectPtr<APlayerController> PlayerController;
};
```

---

## Loginì— ëŒ€í•´ ë‹¤ë¤„ë³´ì.

```cpp
virtual APlayerController* Login(
                            UPlayer* NewPlayer, 
                            ENetRole InRemoteRole, 
                            const FString& Portal, 
                            const FString& Options, 
                            const FUniqueNetIdRepl& UniqueId, 
                            FString& ErrorMessage)
{
    // ì½”ë“œê°€ ì§ê´€ì ì´ë¼ ë³„ë„ì˜ ì…œëª…ì€ ì—†ìŒ.
    if (GameSession == nullptr)
    {
        return nullptr;
    }

    ErrorMessage = GameSession->ApproveLogin(Options);
    if (!ErrorMessage.IsEmpty())
    {
        return nullptr;
    }

    APlayerController* const NewPlayerController = SpawnPlayerController(InRemoteRole, Options);
    if (NewPlayerController == nullptr)
    {
        return nullptr;
    }

    ErrorMessage = InitNewPlayer(NewPlayerController, UniqueId, Options, Portal);
    if (!ErrorMessage.IsEmpty())
    {
        NewPlayerController->Destroy();
        return nullptr;
    }

    return NewPlayerController;
}
```

```cpp
virtual APlayerController* GameModeBse::SpawnPlayerController(ENetRole InRemoteRole, const FString& Options)
{
    FActorSpawnParameters SpawnInfo;
    SpawnInfo.Instigator = GetInstigator();

    SpawnInfo.bDeferConstruction = true;

    SpawnInfo.ObjectFlags |= RF_Transient;

    // SpawnActorì— ëŒ€í•œ ì„¤ëª…ì€ ì•„ë˜ë¥¼ ì°¸ì¡°.
    APlayerController* NewPC = GetWorld()->SpawnActor<APlayerController>(PlayerControllerClass, FVector::ZeroVector, FRotator::ZeroRotator, SpawnInfo);

    if (NewPC)
    {
        if (InRemoteRole == ROLE_SimulatedProxy)
        {
            NewPC->SetAsLocalPlayerController();
        }

        NewPC->FinishSpawning(FTransform(FVector::ZeroVector, FRotator::ZeroRotator), false, nullptr, ESpawnActorScaleMethod::MultiplyWithRoot);
    }

    return NewPC;
}
```

---

## SpawnActor

* ì„¤ëª…ì´ ê¸¸ì–´ì§ˆë“¯ í•˜ì—¬ ë³„ë„ë¡œ ëºŒ

```cpp
AActor* World::SpawnActor(UClass* Class, FTransform const* UserTransformPtr, const FActorSpawnParameters& SpawnParameters = FActorSpawnParameters())
{
    ULevel* CurrentLevel = PersistentLevel;

#pragma region SpawnActor_Condition Check
    if (!Class->IsChildOf(AActor::StaticClass()))
    {
        return NULL;
    }
    if (Class->HasAnyClassFlags(CLASS_Deprecated))
    {
        return NULL;
    }
#pragma endregion

    ULevel* LevelToSpawnIn = SpawnParameters.OverrideLevel;
    if (LevelToSpawnIn == NULL)
    {
        LevelToSpawnIn = (SpawnParameters.Owner != NULL) ? SpawnParameters.Owner->GetLevel() : ToRawPtr(CurrentLevel);
    }

    AActor* Template = SpawnParameters.Template ? SpawnParameters.Template : Class->GetDefaultObject<AActor>();
    check(Template);

    bool bNeedGloballyUniqueName = false;
    FName NewActorName = SpawnParameters.Name;
    if (NewActorName.IsNone())
    {
        const FName BaseName = Template->HasAnyFlags(RF_ClassDefaultObject) ? Class->GetFName() : *Template->GetFName().GetPlainNameString();
        NewActorName = FActorSpawnUtils::MakeUniqueActorName(LevelToSpawnIn, Template->GetClass(), BaseName, bNeedGloballyUniqueName);
    }
    else if (StaticFindObjectFast(nullptr, LevelToSpawnIn, NewActorName) 
        || (bNeedGloballyUniqueName != FActorSpawnUtils::IsGloballyUniqueName(NewActorName))
    {
        NewActorName = FActorSpawnUtils::MakeUniqueActorName(LevelToSpawnIn, Template->GetClass(), FActorSpawnutils::GetBaseName(NewActorName), bNeedGloballyUniqueName);
    }

#if WITH_EDITOR || 1
    // PackageëŠ” ê·¸ëƒ¥ íŒŒì¼ì´ë¼ ë³´ë©´ ëœë‹¤.
    UPackage* ExternalPackage = nullptr;
    if (bNeedGloballyUniqueName && !ExternalPackage)
    {
        TStringBuilderWithBuffer<TCHAR, NAME_SIZE> ActorPath;
        ActorPath += LevelToSpawnIn->GetPathName();
        ActorPath += TEXT(".");
        ActorPath += NewActorName.ToString();

        // Actor is stored separate package file for supporting the OFPA(One File Per Actor)
        // Diagram:
        //                                                          
        //  [Level-Actor]                   [External Actor Files]  
        //                        â”Œâ”€â”                               
        //                        â”‚ â”‚                               
        //      Level0            â”‚ â”‚                               
        //       â”‚                â”‚ â”‚                               
        //       â”œâ”€â”€Actor0 â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¼â”€â”€â”€â”€â”€â”€â”€â–º External_Actor0       
        //       â”‚                â”‚ â”‚                               
        //       â”œâ”€â”€Actor1 â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¼â”€â”€â”€â”€â”€â”€â”€â–º External_Actor1       
        //       â”‚                â”‚ â”‚                               
        //       â””â”€â”€Actor2 â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¼â”€â”€â”€â”€â”€â”€â”€â–º External_Actor2       
        //                        â”‚ â”‚                               
        //                        â”‚ â”‚                               
        //                        â”‚ â”‚                               
        //                        â”‚ â”‚                               
        //      Level1            â”‚ â”‚                               
        //       â”‚                â”‚ â”‚                               
        //       â”œâ”€â”€Actor3 â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¼â”€â”€â”€â”€â”€â”€â”€â–º External_Actor3       
        //       â”‚                â”‚ â”‚                               
        //       â”œâ”€â”€Actor4 â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¼â”€â”€â”€â”€â”€â”€â”€â–º External_Actor4       
        //       â”‚                â”‚ â”‚                               
        //       â””â”€â”€Actor5 â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¼â”€â”€â”€â”€â”€â”€â”€â–º External_Actor5       
        //                        â”‚ â”‚                               
        //                        â””â”€â”˜                               
        //                 OFPA(One-File-Per-Actor)                 
        //   
        // Why do we need the OFPA?
        // - it can break dependencies between level and actors
        // - by separating actors and levels, multiple users can modify same level at the same time
        // - see the diagram:
        //                                                                                                                                                   
        //  [Previous]                                                              [Current]                                                                
        //                                                                                                                                                   
        //    â”Œâ”€Level0â”€â”€â”€â”€â”€â”€â”                                                          â”Œâ”€Level0â”€â”€â”€â”€â”€â”€â”                                                       
        //    â”‚             â”‚                                                          â”‚             â”‚                                                       
        //    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”    â”‚                                                          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  
        //    â”‚ â”‚Actor0â”‚ â—„â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ User0                                        â”‚ â”‚Actor0â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤External Actor0â”‚â—„â”€â”€â”€â”€â”€â”€â”€User0                     
        //    â”‚ â””â”€â”€â”€â”€â”€â”€â”˜    â”‚                                                          â”‚ â””â”€â”€â”€â”€â”€â”€â”˜    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  
        //    â”‚             â”‚                                                          â”‚             â”‚                                                       
        //    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”    â”‚                                                          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  
        //    â”‚ â”‚Actor1â”‚ â—„â”€â”€â”¼â”€â”€â”€[X]â”€â”€â”€â”€â”€â”€ User1                                        â”‚ â”‚Actor1â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤External Actor1â”‚â—„â”€â”€â”€â”€â”€â”€â”€User1                     
        //    â”‚ â””â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚                                                     â”‚ â””â”€â”€â”€â”€â”€â”€â”˜    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  
        //    â”‚             â”‚    â”‚                                                     â”‚             â”‚                                                       
        //    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            ***Using OFPA, User0 and User1 can modify  
        //                     User1 can NOT modify Level0                                                                                                   
        //                                                                                                                                                   
        //                                                                                                                                                   
        //                   â”‚                                                                                                                               
        //                   â”‚                                                                                                                               
        //   To modify Actor0 and Actor1 by separate users (User0 and User1)                                                                                 
        //                   â”‚                                                                                                                               
        //                   â”‚                                                                                                                               
        //                   â–¼                                                                                                                               
        //                                                                                                                                                   
        //    â”Œâ”€Level0â”€â”€â”€â”€â”€â”€â”                                                                                                                                
        //    â”‚             â”‚                                                                                                                                
        //    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”    â”‚                                                                                                                                
        //    â”‚ â”‚Actor0â”‚â—„â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ User0                                                                                                               
        //    â”‚ â””â”€â”€â”€â”€â”€â”€â”˜    â”‚                                                                                                                                
        //    â”‚             â”‚                                                                                                                                
        //    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                                                                
        //                               ***Now User0 and User1 can modify Actor0 and Actor1                                                                 
        //    â”Œâ”€Level1â”€â”€â”€â”€â”€â”€â”                by separting Actors to Level0 and Level1                                                                        
        //    â”‚             â”‚                                                                                                                                
        //    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”    â”‚                                                                                                                                
        //    â”‚ â”‚Actor1â”‚â—„â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ User1                                                                                                               
        //    â”‚ â””â”€â”€â”€â”€â”€â”€â”˜    â”‚                                                                                                                                
        //    â”‚             â”‚                                                                                                                                
        //    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                                                                
        //                                                                                                                                                               
        ExternalPackage = ULevel::CreateActorPackage(LevelToSpawnIn->GetPackage(), LevelToSpawnIn->GetActorPackagingScheme(), *ActorPath);
    }
#endif

    FTransform const UserTransform = UserTransformPtr ? *UserTransformPtr : FTransform::Identity;

    ESpawnActorCollisionHandlingMethod CollisionHandlingOverride = SpawnParameters.SpawnCollisionHandlingOverride;

    ESpawnActorCollisionHandlingMethod const CollisionHandlingMethod = (CollisionHandlingOverride == ESpawnActorCollisionHandlingMethod::Undefined) ? Template->SpawnCollisionHandlingMethod : CollisionHandlingOverride;

    if (CollisionHandlingMethod == ESpawnActorCollisionHandlingMethod::DontSpawnIfColliding)
    {
    }

    EObjectFLags ActorFlags = SpawnParameters.ObjectFlags;
    AActor* const Actor = NewObject<AActor>(LevelToSpawnIn, Class, NewActorName, ActorFlags, Template, false/*bCopyTransientsFromClassDefaults*/, nullptr/*InInstanceGraph*/, ExternalPackage);
    check(Actor);
    check(Actor->GetLevel() == LevelToSpawnIn);

    LevelToSpawnIn->Actors.Add(Actor);
    LevelToSpawnIn->ActorsForGC.Add(Actor);

    // tell the actor what method to use, in case it was overriden
    Actor->SpawnCollisionHandlingMethod = CollisionHandlingMethod;

    Actor->PostSpawnInitialize(UserTransform, SpawnParameters.Owner, SpawnParameter.Instigator, SpawnParameters.IsRemoteOwned(), SpawnParameters.bNoFail, SpawnParameters.bDeferConstruction, SpawnParameters.TransformScaleMethod);

    // if we are spawning an external actor, mark this package dirty
    if (ExternalPackage)
    {
        ExternalPackage->MarkPackageDirty();
    }

    // broadcast notification of spawn
    OnActorsSpawned.Broadcast(Actor);

    AddNetworkActor(Actor);

    return Actor;
}
```

```cpp
void AddNetworkActor(AActor* Actor)
{
    // Dormancyì— ëŒ€í•œ ê°œë…ì„ ì•Œì•„ì•¼ í•œë‹¤.
    if (!IsDormInitialStartupActor(Actor))
    {
        GetNetworkObjectList().FindOrAdd(Actor, this);
    }
}
```

### Dormancy

* ENetDormancyëŠ” ì–¸ë¦¬ì–¼ ì—”ì§„ì—ì„œ ì•¡í„°ì˜ ë„¤íŠ¸ì›Œí¬ ë³µì œ(replication) ë™ì‘ì„ ì œì–´í•˜ëŠ” ì—´ê±°í˜•(enum)ê°ì²´. ì´ëŠ” ì•¡í„°ê°€ ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ì–¼ë§ˆë‚˜ ìì£¼ ì—…ë°ì´íŠ¸ë˜ì–´ì•¼ í•˜ëŠ”ì§€ë¥¼ ê²°ì •

```cpp
enum ENetDormancy
{
    DORM_Never,              // ì ˆëŒ€ íœ´ë©´ ìƒíƒœê°€ ë˜ì§€ ì•ŠìŒ (í•­ìƒ ë³µì œë¨)
    DORM_Awake,              // í˜„ì¬ ê¹¨ì–´ìˆìŒ (ë³µì œ ì¤‘)
    DORM_DormantAll,         // ëª¨ë“  ì—°ê²°ì— ëŒ€í•´ íœ´ë©´ ìƒíƒœ
    DORM_DormantPartial,     // ì¼ë¶€ ì—°ê²°ì— ëŒ€í•´ íœ´ë©´ ìƒíƒœ
    DORM_Initial,            // ì´ˆê¸° ìƒíƒœ (ì•„ì§ ë³µì œë˜ì§€ ì•ŠìŒ)
    DORM_MAX,
};
```

* ë„¤íŠ¸ì›Œí¬ íœ´ë©´ ìƒíƒœ(Dormancy)ì˜ ëª©ì 
    * ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ ìµœì í™”: ëª¨ë“  ì•¡í„°ë¥¼ í•­ìƒ ë³µì œí•˜ëŠ” ê²ƒì€ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ì„ ë§ì´ ì†Œëª¨. 
    * íœ´ë©´ ìƒíƒœë¥¼ ì‚¬ìš©í•˜ë©´ ì¤‘ìš”í•˜ì§€ ì•Šì€ ì•¡í„°ì˜ ë³µì œë¥¼ ì¼ì‹œ ì¤‘ì§€í•˜ì—¬ ëŒ€ì—­í­ì„ ì ˆì•½.
    * ì„±ëŠ¥ í–¥ìƒ: ì„œë²„ëŠ” íœ´ë©´ ìƒíƒœì˜ ì•¡í„°ì— ëŒ€í•´ ë³µì œ ê³„ì‚°ì„ ìˆ˜í–‰í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ CPU ì‚¬ìš©ëŸ‰ì´ ê°ì†Œ.

### DormancyëŠ” ì–´ë–»ê²Œ Notifyë ê¹Œ?

```cpp
void AddNetworkActor(AActor* Actor)
{
    if (!IsDormInitialStartupActor(Actor))
    {
        // ì—¬ê¸°ì„œ Add -> class FNetworkObjectListì— ì˜í•´ ê´€ë¦¬ëœë‹¤.
        GetNetworkObjectList().FindOrAdd(Actor, this);
    }
}
```

* ëŒ€ëµ ì•„ë˜ì™€ ê°™ì€ êµ¬ì¡°

```
//     World                                                                                                                                                            
//      â”‚                                                                                                                                                               
//      â””â”€â”€NetworkObjects: FNetworkObjectList                                                                                                                           
//            â”‚                                                                                                                                                         
//            â””â”€â”€SubObjectChannelReferences:TSet<FActorSubObjectReferences>                                                                                             
//                                                                                                                                                                      
//               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                               
//               â”‚ SubObjectChannelRefs_0 â”‚ SubObjectChannelRefs_1 â”‚ SubObjectChannelRefs_2 â”‚ ...       â”‚                                                               
//               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                               
//                      â”‚                                                                                                                                               
//                      â”‚                                                                                                                                               
//                      â”œâ”€â”€â”€ActorKey:FObjectKey                                                                                                                         
//                      â”‚                                                                                                                                               
//                      â”‚                                                                                                                                               
//                      â”œâ”€â”€â”€ActiveSubObjectChannelReferences:TSet<FSubObjectChannelReference>                                                                           
//                      â”‚                                         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                            
//                      â”‚                                                                                                                                               
//                      â””â”€â”€â”€InvalidSubObjectChannelReferences:TArray<FSubObjectChannelReference>                                                                        
//                                                                   â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                         
//                                                                     â”‚                                                                                                
//                                                                     â”œâ”€â”€SubObjectPtr:TWeakObjectPtr<UObject> â—„â”€â”€â”€â”€â”€â”€â”€â”€ what is subobject of AActor?                   
//                                                                     â”‚                                                 *** representative example is UActorComponent! 
//                                                                     â”œâ”€â”€ChannelRefCount:uint16                                                                        
//                                                                     â”‚                                                                                                
//                                                                     â””â”€â”€Status:ENetSubObjectStatus                                                                    
//                                                                               â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                    
//                                                                                 â”‚                                                                                    
//                                                                                 â”œâ”€â”€Active                                                                            
//                                                                                 â”‚                                                                                    
//                                                                                 â”œâ”€â”€TearOff                                                                           
//                                                                                 â”‚                                                                                    
//                                                                                 â””â”€â”€Delete                                                                            
//                                                                                                 
```

* ì¢€ ë” ì‰½ê²Œ ì„¤ëª…
    * NetworkObjectëŠ” Actorë¥¼ ì†Œìœ í•˜ë©° ê° Actorë³„ Dormant ë¦¬ìŠ¤íŠ¸ë¥¼ ê´€ë¦¬í•´ Dormant ì²˜ë¦¬ì—¬ë¶€ë¥¼ ê²°ì •

```
//   World                                                                                          
//    â”‚                                                                                             
//    â””â”€â”€NetworkObjects: FNetworkObjectList                                                         
//          â”‚                                                                                       
//          â””â”€â”€AllNetworkObjects: FNetworkObjectSet: TSet<TSharedPtr<FNetworkObjectInfo>>           
//                                                                                                  
//             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      
//             â”‚ NetworkObjectInfo_0 â”‚ NetworkObjectInfo_1 â”‚ NetworkObjectInfo_2 â”‚ ...       â”‚      
//             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      
//                    â”‚                                                                             
//                    â”‚                                                                             
//                    â”œâ”€â”€â”€Actor: Actor*                                                             
//                    â”‚                                                                             
//                    â”‚                                                                             
//                    â””â”€â”€â”€DormantConnections: TSet<TSharedPtr<UNetConnection>>                      
//                                                    
// ì´ëŸ°ì²˜ë¦¬ë„ ê°€ëŠ¥í•´ ì§„ë‹¤.                                              
//                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            
//           â”Œâ”€â”€Worldâ”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Client_0 â”‚                                            
//           â”‚              â”‚      â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            
//           â”‚              â”‚      â”‚                                                                
//           â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   dormant                                  
//           â”‚ â”‚ Actor_0 â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Client_1 â”‚â—„â”€â”€xâ”€â”€â”                                     
//           â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚                                     
//           â”‚              â”‚      â”‚                          â”‚                                     
//           â”‚              â”‚      â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚                                     
//           â”‚              â”‚      â””â”€â”€xâ”€â”€â”€â”€â–ºâ”‚ Client_2 â”œâ—„â”€â”€â”€â”€â”€â”¤                                     
//           â”‚              â”‚      dormant  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚                                     
//           â”‚              â”‚                                 â”‚                                     
//           â”‚              â”‚                                 â”‚                                     
//           â”‚              â”‚                                 â”‚                                     
//           â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                 â”‚                                     
//           â”‚ â”‚ Actor_1 â”œâ”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     
//           â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                                                       
//           â”‚              â”‚                                                                       
//           â”‚              â”‚                                                                       
//           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                       
//                                                                                                                                                                                                        
```

---

