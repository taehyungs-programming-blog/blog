---
layout: default
title: "(19. FClassNetCacheMgr)"
parent: "(UE Code-Review ðŸ¤–)"
has_children: true
nav_order: 2
permalink: docs/review/ue/ver4/19/FClassNetCacheMgr
---

## FClassNetCacheMgr

* ëª©ì ì€ ë„¤íŠ¸ì›Œí¬ ë³µì œ(Replication)ë¥¼ ìœ„í•œ í´ëž˜ìŠ¤ ì •ë³´ë¥¼ ìºì‹±í•˜ê³  ê´€ë¦¬í•˜ëŠ” í´ëž˜ìŠ¤
* Netdriverì—ì„œ ê´€ë¦¬ ëœë‹¤.

### ì£¼ìš” ê¸°ëŠ¥:

* ë³µì œ ê°€ëŠ¥í•œ UClassë“¤ì˜ ì†ì„±(Property)ì„ ìºì‹±í•˜ì—¬ ì„±ëŠ¥ ìµœì í™”
* í´ëž˜ìŠ¤ì˜ ë„¤íŠ¸ì›Œí¬ ë³µì œ ê´€ë ¨ ë©”íƒ€ë°ì´í„°ë¥¼ ì €ìž¥
* í´ëž˜ìŠ¤ ê³„ì¸µ êµ¬ì¡°ë¥¼ ë”°ë¼ ì†ì„±ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì°¾ì„ ìˆ˜ ìžˆê²Œ í•¨
* ì²´í¬ì„¬(Checksum)ì„ í†µí•´ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ê°„ í´ëž˜ìŠ¤ êµ¬ì¡° ì¼ì¹˜ ì—¬ë¶€ í™•ì¸

```cpp
// 1. RPC í˜¸ì¶œ ì‹œ FClassNetCacheMgr ì‚¬ìš© ì˜ˆì‹œ
void UNetDriver::ProcessRemoteFunction(AActor* Actor, UFunction* Function, void* Parameters, FOutParmRec* OutParms, FFrame* Stack)
{
    // Actorì˜ í´ëž˜ìŠ¤ì— ëŒ€í•œ ë„¤íŠ¸ì›Œí¬ ìºì‹œ ê°€ì ¸ì˜¤ê¸°
    const FClassNetCache* ClassCache = NetCache->GetClassNetCache(Actor->GetClass());
    if (!ClassCache)
    {
        // ìºì‹œê°€ ì—†ìœ¼ë©´ RPC í˜¸ì¶œ ë¶ˆê°€
        return;
    }
    
    // Functionì— ëŒ€í•œ í•„ë“œ ìºì‹œ ê°€ì ¸ì˜¤ê¸°
    const FFieldNetCache* FieldCache = ClassCache->GetFromField(Function);
    if (!FieldCache)
    {
        // í•„ë“œ ìºì‹œê°€ ì—†ìœ¼ë©´ RPC í˜¸ì¶œ ë¶ˆê°€
        return;
    }
    
    // ì´ì œ FieldCacheì˜ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì—¬ RPC í˜¸ì¶œ ì²˜ë¦¬
    // ...
}

// 2. ì†ì„± ë³µì œ ì‹œ ì‚¬ìš© ì˜ˆì‹œ
void UActorChannel::ReplicateActor()
{
    AActor* Actor = GetActor();
    
    // Actor í´ëž˜ìŠ¤ì˜ ë„¤íŠ¸ì›Œí¬ ìºì‹œ ê°€ì ¸ì˜¤ê¸°
    const FClassNetCache* ClassCache = Connection->Driver->NetCache->GetClassNetCache(Actor->GetClass());
    
    // ìºì‹œëœ ì†ì„±ë“¤ì„ ìˆœíšŒí•˜ë©° ë³µì œ
    for (const FFieldNetCache& Field : ClassCache->Fields)
    {
        FProperty* Property = Field.Field.Get<FProperty>();
        if (Property)
        {
            // ì†ì„± ë³µì œ ì²˜ë¦¬
            // ...
        }
    }
}

// 3. ìƒˆë¡œìš´ í´ëž˜ìŠ¤ ìºì‹œ ìƒì„± ì˜ˆì‹œ
const FClassNetCache* FClassNetCacheMgr::GetClassNetCache(UClass* Class)
{
    // ì´ë¯¸ ìºì‹œê°€ ìžˆëŠ”ì§€ í™•ì¸
    FClassNetCache* Result = ClassFieldIndices.FindRef(Class);
    if (!Result)
    {
        // í´ëž˜ìŠ¤ì˜ ë³µì œ ë°ì´í„° ì„¤ì •
        Class->SetUpRuntimeReplicationData();
        
        // ìƒˆ ìºì‹œ ìƒì„±
        Result = ClassFieldIndices.Add(Class, new FClassNetCache(Class));
        
        // ë¶€ëª¨ í´ëž˜ìŠ¤ ìºì‹œ ì„¤ì •
        if (Class->GetSuperClass())
        {
            Result->Super = GetClassNetCache(Class->GetSuperClass());
            Result->FieldsBase = Result->Super->GetMaxIndex();
        }
        
        // ë³µì œ ê°€ëŠ¥í•œ ì†ì„±ë“¤ ì¶”ê°€
        for (int32 i = Class->FirstOwnedClassRep; i < Class->ClassReps.Num(); ++i)
        {
            FProperty* Property = Class->ClassReps[i].Property;
            
            // ì†ì„±ì˜ ì²´í¬ì„¬ ê³„ì‚°
            const uint32 Checksum = GetPropertyChecksum(Property, 0, false);
            
            // ì¸ë±ìŠ¤ í• ë‹¹
            const int32 ThisIndex = Result->GetMaxIndex();
            
            // ìºì‹œì— í•„ë“œ ì¶”ê°€
            Result->Fields.Add(FFieldNetCache(Property, ThisIndex, Checksum));
            
            // ë°°ì—´ ì†ì„± ì²˜ë¦¬
            i += (Property->ArrayDim - 1);
        }
        
        // í•´ì‹œë§µì— í•„ë“œ ì¶”ê°€
        for (auto& Field : Result->Fields)
        {
            Result->FieldMap.Add(Field.Field.GetRawPointer(), &Field);
            Result->FieldChecksumMap.Add(Field.FieldChecksum, &Field);
        }
    }
    
    return Result;
}
```

> ëŒ€ëžµ... ë³µì œê°€ ë  Net Classë¥¼ ê´€ë¦¬í•´ ì¤€ë‹¤ëŠ” ë§ì¸ë°, 
> * í´ëž˜ìŠ¤ ê³„ì¸µ êµ¬ì¡°ë¥¼ ë”°ë¼ ì†ì„±ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì°¾ì„ ìˆ˜ ìžˆê²Œ í•¨
> * ì²´í¬ì„¬(Checksum)ì„ í†µí•´ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ê°„ í´ëž˜ìŠ¤ êµ¬ì¡° ì¼ì¹˜ ì—¬ë¶€ í™•ì¸
> ì´ ë‘ ê°€ì§€ê°€ ìž˜ ì´í•´ê°€ ì•ˆë˜ëŠ”ë°?

---

## í´ëž˜ìŠ¤ ê³„ì¸µ êµ¬ì¡° ê²€ìƒ‰ì´ í•„ìš”í•œ ì´ìœ :

* ìƒì† êµ¬ì¡°ì—ì„œ ì†ì„±/í•¨ìˆ˜ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ì°¾ê¸° ìœ„í•¨
* ì¤‘ë³µ ì½”ë“œ ì—†ì´ ë¶€ëª¨ í´ëž˜ìŠ¤ì˜ ë„¤íŠ¸ì›Œí¬ ì†ì„±ì„ ìžì‹ í´ëž˜ìŠ¤ì—ì„œ ì‚¬ìš© ê°€ëŠ¥
* ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì í™” (ê° í´ëž˜ìŠ¤ë§ˆë‹¤ ëª¨ë“  ì†ì„±ì„ ë‹¤ì‹œ ì €ìž¥í•  í•„ìš” ì—†ìŒ)

```cpp
   const FFieldNetCache* FClassNetCache::GetFromField(FFieldVariant Field) const
   {
       FFieldNetCache* Result = NULL;
       
       // í˜„ìž¬ í´ëž˜ìŠ¤ë¶€í„° ì‹œìž‘í•´ì„œ ë¶€ëª¨ í´ëž˜ìŠ¤ë¡œ ì˜¬ë¼ê°€ë©° ê²€ìƒ‰
       for (const FClassNetCache* C = this; C; C = C->Super)
       {
           if ((Result = C->FieldMap.FindRef(Field.GetRawPointer())) != NULL)
           {
               break;
           }
       }
       
       return Result;
   }
```

---

## ì²´í¬ì„¬ ê²€ì¦ì´ í•„ìš”í•œ ì´ìœ :

* ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ ê°„ í´ëž˜ìŠ¤ ì •ì˜ ë¶ˆì¼ì¹˜ ê°ì§€
* ë²„ì „ ì°¨ì´ë‚˜ ëª¨ë“œ ë¶ˆì¼ì¹˜ë¡œ ì¸í•œ í¬ëž˜ì‹œ ë°©ì§€
* ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ ê°•í™” (ì¡°ìž‘ëœ RPC í˜¸ì¶œ ë°©ì§€)

```cpp
   uint32 FClassNetCacheMgr::GetPropertyChecksum(const FProperty* Property, uint32 Checksum) const
   {
       // ì†ì„± ì´ë¦„ìœ¼ë¡œ ì²´í¬ì„¬ ê³„ì‚°
       Checksum = FCrc::StrCrc32(*Property->GetName().ToLower(), Checksum);
       
       // ì†ì„± íƒ€ìž…ìœ¼ë¡œ ì²´í¬ì„¬ ê³„ì‚°
       Checksum = FCrc::StrCrc32(*Property->GetCPPType(), Checksum);
       
       // ë°°ì—´ í¬ê¸°ë¡œ ì²´í¬ì„¬ ê³„ì‚°
       Checksum = FCrc::StrCrc32(*FString::Printf(TEXT("%u"), Property->ArrayDim), Checksum);
       
       return Checksum;
   }
```