---
layout: default
title: "(12. Unreal Networkì—ì„œ ActorëŠ” ì–´ë–»ê²Œ Updateë ê¹Œ?)"
parent: "(UE Code-Review ğŸ¤–)"
has_children: true
nav_order: 2
permalink: docs/review/ue/ver4/12/NetActorUpdate
---

```cpp
virtual bool CallRemoteFunction(UFunction* Function, void* Parameters, FOutParmRec* OutParms, FFrame* Stack) override
{
    bool bProcessed = false;
    if (UWorld* MyWorld = GetWorld())
    {
        if (FWorldContext* const Context = GEngine->GetWorldContextFromWorld(MyWorld))
        {
            for (FNamedNetDriver& Driver : Context->ActiveNetDrivers)
            {
                if (Driver.NetDriver != nullptr && Driver.NetDriver->ShouldReplicateFunction(this, Function))
                {
                    Driver.NetDriver->ProcessRemoteFunction(this, Function, Parameters, OutParms, Stack, nullptr);
                    bProcessed = true;
                }
            }
        }
    }
    return bProcessed;
}
```

```cpp
virtual void ProcessRemoteFunction(class AActor* Actor, 
                                    class UFunction* Function, 
                                    void* Parameters, 
                                    struct FOutParmRec* OutParms, 
                                    struct FFrame* Stack, 
                                    class UObject* SubObject = nullptr)
{
    const bool bIsServer = IsServer();
    const bool bIsServerMulticast = bIsServer && (Function->FunctionFlags & FUNC_NetMulticast);

    UNetConnection* Connection = nullptr;
    if (bIsServerMulticast)
    {
        // @todo
    }

    Connection = Actor->GetNetConnection();
    if (Connection)
    {
        EProcessRemoteFunctionFlags UnusedFlags = EProcessRemoteFunctionFlags::None;
        InternalProcessRemoteFunctionPrivate(Actor, SubObject, Connection, Function, Parms, OutParms, Stack, bIsServer, UnusedFlags);
    }
}
```

---

### tip) fframe

* FFrameì˜ ëª©ì 
    * í•¨ìˆ˜ ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ ìœ ì§€: í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ í•¨ìˆ˜ì˜ ìƒíƒœ ì •ë³´ ì €ì¥
    * ì½”ë“œ í¬ì¸í„° ê´€ë¦¬: í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œì˜ ìœ„ì¹˜ ì¶”ì 
    * ë¡œì»¬ ë³€ìˆ˜ ì ‘ê·¼: í•¨ìˆ˜ ë‚´ ë¡œì»¬ ë³€ìˆ˜ì™€ ë§¤ê°œë³€ìˆ˜ì— ëŒ€í•œ ì ‘ê·¼ ì œê³µ
    * í˜¸ì¶œ ìŠ¤íƒ ê´€ë¦¬: í•¨ìˆ˜ í˜¸ì¶œ ìŠ¤íƒ ì •ë³´ ìœ ì§€

```cpp
struct FFrame
{
    // í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ í•¨ìˆ˜
    UFunction* Node;
    
    // í•¨ìˆ˜ë¥¼ ì†Œìœ í•œ ê°ì²´
    UObject* Object;
    
    // í˜„ì¬ ì½”ë“œ í¬ì¸í„°
    uint8* Code;
    
    // ë¡œì»¬ ë³€ìˆ˜ ì €ì¥ ê³µê°„
    uint8* Locals;
    
    // ì´ì „ í”„ë ˆì„ (í˜¸ì¶œ ìŠ¤íƒ)
    FFrame* PreviousFrame;
    
    // ì¶œë ¥ ë§¤ê°œë³€ìˆ˜
    void* OutParms;
    
    // ê¸°íƒ€ ë©¤ë²„...
};
```

```cpp
void UObject::ProcessEvent(UFunction* Function, void* Parms)
{
    // ìƒˆ í”„ë ˆì„ ìƒì„±
    FFrame NewStack(this, Function, Parms);
    
    // í•¨ìˆ˜ ì‹¤í–‰
    Function->Invoke(this, NewStack, Result);
}
```

#### ufunctionì—ì„œ í•˜ë©´ ë êº¼ ê°™ì€ ì¼ì„ ì™œ fframeì„ ë‘”ê±¸ê¹Œ?

* ì •ì  ì •ì˜ì™€ ë™ì  ì‹¤í–‰ì˜ ë¶„ë¦¬
* UFunction: í•¨ìˆ˜ì˜ ì •ì  ì •ì˜(ë©”íƒ€ë°ì´í„°)ë¥¼ ë‹´ë‹¹
    * í•¨ìˆ˜ ì´ë¦„, ë§¤ê°œë³€ìˆ˜ ìœ í˜•, ë°˜í™˜ ìœ í˜• ë“± í•¨ìˆ˜ì˜ "ë¬´ì—‡"ì— ê´€í•œ ì •ë³´
    * **í•œ ë²ˆ ì •ì˜ë˜ë©´ ë³€ê²½ë˜ì§€ ì•ŠëŠ” ì •ë³´**
* FFrame: í•¨ìˆ˜ì˜ ë™ì  ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë‹´ë‹¹
    * í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì½”ë“œ ìœ„ì¹˜, ë¡œì»¬ ë³€ìˆ˜ ìƒíƒœ ë“± í•¨ìˆ˜ ì‹¤í–‰ì˜ "ì–´ë–»ê²Œ"ì— ê´€í•œ ì •ë³´
    * í•¨ìˆ˜ í˜¸ì¶œë§ˆë‹¤ ìƒˆë¡œ ìƒì„±ë˜ëŠ” ì„ì‹œ ì •ë³´

```cpp
// UFunctionì€ í•¨ìˆ˜ ì •ì˜ë¥¼ ë‚˜íƒ€ëƒ„
UFunction* Function = FindFunction("MyFunction");

// FFrameì€ íŠ¹ì • ì‹¤í–‰ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë‚˜íƒ€ëƒ„
FFrame Stack(Object, Function, Parameters);
```

```cpp
// ë™ì¼í•œ í•¨ìˆ˜ë¥¼ ì—¬ëŸ¬ ê°ì²´ì—ì„œ í˜¸ì¶œ
UFunction* SameFunction = FindFunction("CommonFunction");

// ê° í˜¸ì¶œì€ ê³ ìœ í•œ FFrameì„ ê°€ì§
FFrame StackA(ObjectA, SameFunction, ParamsA);
FFrame StackB(ObjectB, SameFunction, ParamsB);
```

```cpp
void ExecuteNestedCalls()
{
    // ì²« ë²ˆì§¸ í•¨ìˆ˜ í˜¸ì¶œ
    FFrame OuterFrame(Object, OuterFunction, OuterParams);
    
    // ì¤‘ì²© í˜¸ì¶œ - PreviousFrameìœ¼ë¡œ ì—°ê²°ë¨
    FFrame InnerFrame(Object, InnerFunction, InnerParams);
    InnerFrame.PreviousFrame = &OuterFrame;
    
    // í˜¸ì¶œ ìŠ¤íƒì„ í†µí•´ ì™¸ë¶€ ì»¨í…ìŠ¤íŠ¸ì— ì ‘ê·¼ ê°€ëŠ¥
}
```

```cpp
// ì„œë²„ì—ì„œ RPC í˜¸ì¶œ
void ServerFunction_Implementation(int32 Value)
{
    // ì²˜ë¦¬ ë¡œì§
}

// í´ë¼ì´ì–¸íŠ¸ì—ì„œ í˜¸ì¶œ ì‹œ
void AMyActor::CallServerFunction(int32 Value)
{
    // UFunctionì€ í•¨ìˆ˜ ì •ì˜
    UFunction* Function = FindFunction("ServerFunction");
    
    // ë§¤ê°œë³€ìˆ˜ ì„¤ì •
    FMyFunctionParams Params;
    Params.Value = Value;
    
    // FFrameì€ í˜¸ì¶œ ì»¨í…ìŠ¤íŠ¸ (í˜¸ì¶œì ì •ë³´ í¬í•¨)
    FFrame TempStack(this, Function, &Params);
    
    // RPC ì²˜ë¦¬ ì‹œìŠ¤í…œìœ¼ë¡œ ì „ë‹¬
    GetNetDriver()->ProcessRemoteFunction(this, Function, &Params, nullptr, &TempStack);
}
```

---

## ê³„ì†..1

```cpp
void InternalProcessRemoteFunctionPrivate(
    class AActor* Actor,
    class UObject* SubObject,
    class UNetConnection* Connection,
    class UFunction* Function,
    void* Parms,
    FOutParmRec* OutParms,
    FFrame* Stack,
    const bool bIsServer,
    EProcessRemoteFunctionFlags& RemoteFunctionFlags)
{
    //...

    UObject* TargetObj = SubObject ? SubObject : Actor;

    const FClassNetCache* ClassCache = NetCache->GetClassNetCache(TargetObj->GetClass());
    if (!ClassCache)
    {
        return;
    }
    
    const FFieldNetCache* FieldCache = ClassCache->GetFromField(Function);
    if (!FieldCache)
    {
        return;
    }

    UActorChannel* Ch = Connection->FindActorChannelRef(Actor);
    if (!Ch)
    {
        if (bIsServer)
        {
            if (IsLevelInitializedForActor(Actor, Connection))
            {
                Ch = Cast<UActorChannel>(Connection->CreateChannelByName(NAME_Actor, EChannelCreateFlags::OpenedLocally));
            }
            else
            {
                return;
            }
        }

        if (!Ch)
        {
            return;
        }

        if (bIsServer)
        {
            Ch->SetChannelActor(Actor, ESetChannelActorFlags::None);
        }
    }

    ProcessRemoteFunctionForChannelPrivate(Ch, ClassCache, FieldCache, TargetObj, Connection, Function, Parms, OutParms, Stack, bIsServer, ERemoteFunctionSendPolicy::Default, Flags);
}
```

### tips) FClassNetCache

* ë³µì œ(Replication)ì™€ RPC í˜¸ì¶œì— í•„ìš”í•œ í´ë˜ìŠ¤ ì •ë³´ë¥¼ ìºì‹±í•˜ì—¬ ì„±ëŠ¥ì„ ìµœì í™”

* ì†ì„± ë³µì œ ìµœì í™”: í´ë˜ìŠ¤ì˜ ë³µì œ ê°€ëŠ¥í•œ ì†ì„±ë“¤ì— ëŒ€í•œ ì •ë³´ë¥¼ ìºì‹±í•˜ì—¬ ë§¤ë²ˆ ë¦¬í”Œë ‰ì…˜ì„ í†µí•´ ì°¾ì§€ ì•Šë„ë¡ í•œë‹¤
* RPC í˜¸ì¶œ ê²€ì¦: ì›ê²© í•¨ìˆ˜ í˜¸ì¶œì´ ìœ íš¨í•œì§€ í™•ì¸
* ë„¤íŠ¸ì›Œí¬ ì¸ë±ìŠ¤ ê´€ë¦¬: ê° ì†ì„±ê³¼ í•¨ìˆ˜ì— ê³ ìœ í•œ ë„¤íŠ¸ì›Œí¬ ì¸ë±ìŠ¤ë¥¼ í• ë‹¹
* ì²´í¬ì„¬ ê³„ì‚°: í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ê°„ì˜ í´ë˜ìŠ¤ í˜¸í™˜ì„±ì„ í™•ì¸í•˜ê¸° ìœ„í•œ ì²´í¬ì„¬ì„ ê´€ë¦¬

* ë³µì œ(Replicable)ê°€ëŠ¥í•œ ê°ì²´ëŠ” ActorChannelë“± Channelì„ í†µí•´ ê´€ë¦¬ë¨ì„ ê¸°ì–µí•˜ì.

```cpp
UCLASS()
class GAME_API AMyCharacter : public ACharacter
{
    GENERATED_BODY()

public:
    // ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œ ë³µì œë˜ëŠ” ì†ì„±
    UPROPERTY(Replicated)
    float Health;
    
    // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ë¡œ í˜¸ì¶œí•˜ëŠ” RPC
    UFUNCTION(Server, Reliable)
    void ServerRequestAction(int32 ActionID);
    
    // ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œ í˜¸ì¶œí•˜ëŠ” RPC
    UFUNCTION(Client, Reliable)
    void ClientNotifyActionResult(bool bSuccess);
    
    // ë³µì œ ì„¤ì •
    virtual void GetLifetimeReplicatedProps(TArray<FLifetimeProperty>& OutLifetimeProps) const override;
};

// ë³µì œ ì†ì„± ì„¤ì •
void AMyCharacter::GetLifetimeReplicatedProps(TArray<FLifetimeProperty>& OutLifetimeProps) const
{
    Super::GetLifetimeReplicatedProps(OutLifetimeProps);
    
    DOREPLIFETIME(AMyCharacter, Health);
}

// ì„œë²„ RPC êµ¬í˜„
void AMyCharacter::ServerRequestAction_Implementation(int32 ActionID)
{
    // ì•¡ì…˜ ì²˜ë¦¬ ë¡œì§
    bool bActionSuccess = ProcessAction(ActionID);
    
    // ê²°ê³¼ë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì•Œë¦¼
    ClientNotifyActionResult(bActionSuccess);
}

// í´ë¼ì´ì–¸íŠ¸ RPC êµ¬í˜„
void AMyCharacter::ClientNotifyActionResult_Implementation(bool bSuccess)
{
    // ê²°ê³¼ì— ë”°ë¥¸ í´ë¼ì´ì–¸íŠ¸ ë¡œì§ ì²˜ë¦¬
    if (bSuccess)
    {
        PlaySuccessAnimation();
    }
    else
    {
        PlayFailAnimation();
    }
}
```

```cpp
// ì„œë²„ì—ì„œ NetDriver ì´ˆê¸°í™” ì‹œ
void UNetDriver::PostInitProperties()
{
    // ... ê¸°ì¡´ ì½”ë“œ ...
    NetCache = TSharedPtr<FClassNetCacheMgr>(new FClassNetCacheMgr());
}
```

```cpp
// í´ë¼ì´ì–¸íŠ¸ê°€ ì—°ê²°ë˜ê³  ìºë¦­í„°ê°€ ìƒì„±ë  ë•Œ
AMyCharacter* Character = SpawnCharacterForPlayer(Connection);

// ë‚´ë¶€ì ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ê³¼ì •ì´ ë°œìƒ
// 1. ìºë¦­í„° í´ë˜ìŠ¤ì— ëŒ€í•œ FClassNetCache ìƒì„±
const FClassNetCache* ClassCache = NetDriver->NetCache->GetClassNetCache(AMyCharacter::StaticClass());

// 2. ì´ ê³¼ì •ì—ì„œ AMyCharacterì˜ ë³µì œ ì†ì„±(Health)ê³¼ RPC í•¨ìˆ˜ë“¤ì´ ìºì‹±ë¨
// - Health ì†ì„±ì— ë„¤íŠ¸ì›Œí¬ ì¸ë±ìŠ¤ í• ë‹¹
// - ServerRequestActionê³¼ ClientNotifyActionResultì— ë„¤íŠ¸ì›Œí¬ ì¸ë±ìŠ¤ í• ë‹¹
```

```cpp
// ì„œë²„ì—ì„œ ìºë¦­í„°ì˜ Healthê°€ ë³€ê²½ë  ë•Œ
Character->Health = 80.0f;

// ë³µì œ ê³¼ì •ì—ì„œ ë‚´ë¶€ì ìœ¼ë¡œ ë‹¤ìŒì´ ë°œìƒ
void UNetDriver::ReplicateActor(AActor* Actor)
{
    // FClassNetCacheë¥¼ ì‚¬ìš©í•˜ì—¬ ë³€ê²½ëœ ì†ì„± ì°¾ê¸°
    const FClassNetCache* ClassCache = NetCache->GetClassNetCache(Actor->GetClass());
    
    // Health ì†ì„±ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê³  í´ë¼ì´ì–¸íŠ¸ì— ì „ì†¡
    // ClassCacheë¥¼ í†µí•´ Health ì†ì„±ì˜ ë„¤íŠ¸ì›Œí¬ ì¸ë±ìŠ¤ì™€ ì²´í¬ì„¬ì„ ë¹ ë¥´ê²Œ ì¡°íšŒ
}
```

---

## ê³„ì†..2

```cpp
void InternalProcessRemoteFunctionPrivate(
    class AActor* Actor,
    class UObject* SubObject,
    class UNetConnection* Connection,
    class UFunction* Function,
    void* Parms,
    FOutParmRec* OutParms,
    FFrame* Stack,
    const bool bIsServer,
    EProcessRemoteFunctionFlags& RemoteFunctionFlags)
{
    //...

    UObject* TargetObj = SubObject ? SubObject : Actor;

    // ìºì‹±ì²´í¬
    const FClassNetCache* ClassCache = NetCache->GetClassNetCache(TargetObj->GetClass());
    if (!ClassCache)
    {
        return;
    }
    const FFieldNetCache* FieldCache = ClassCache->GetFromField(Function);
    if (!FieldCache)
    {
        return;
    }
    
    // ì±„ë„ì´ ìˆëŠ”ì§€ ì²´í¬
    UActorChannel* Ch = Connection->FindActorChannelRef(Actor);
    if (!Ch)
    {
        if (bIsServer)
        {
            if (IsLevelInitializedForActor(Actor, Connection))
            {
                Ch = Cast<UActorChannel>(Connection->CreateChannelByName(NAME_Actor, EChannelCreateFlags::OpenedLocally));
            }
            else
            {
                return;
            }
        }

        if (!Ch)
        {
            return;
        }

        if (bIsServer)
        {
            Ch->SetChannelActor(Actor, ESetChannelActorFlags::None);
        }
    }

    ProcessRemoteFunctionForChannelPrivate(Ch, ClassCache, FieldCache, TargetObj, Connection, Function, Parms, OutParms, Stack, bIsServer, ERemoteFunctionSendPolicy::Default, Flags);
}
```

```cpp
virtual bool ClientHasInitializedLevel(const ULevel* TestLevel) const
{
    //
    //                                                          Client0:UWorld                                                           
    //                                                              â”‚                                                                    
    //                                                              â”‚                                                                    
    //                                                              â”œâ”€â”€â”€Level0:in-loading...                                             
    //                                                              â”‚                                                                    
    //                                                              â””â”€â”€â”€ServerConnection â—„â”€â”€â”€â”€â”                                          
    //                                                                                        â”‚                                          
    //         Server:UWorld                                                                  â”‚                                          
    //           â”‚                                              Client1:UWorld                â”‚                                          
    //           â”‚                                                  â”‚                         â”‚                                          
    //           â”œâ”€â”€â”€Level0:UPackage                                â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚                                          
    //           â”‚    â”‚                                             â””â”€â”¼â”€Level0:UPackage â”‚     â”‚                                          
    //           â”‚    â”‚                                               â”‚  â”‚              â”‚     â”‚ ***Level0 is still in-loading phase,     
    //           â”‚    â”œâ”€â”€â”€Actor0                                      â”‚  â”œâ”€â”€â”€Actor0     â”‚     â”‚    so Level0's Visibility is 'false'     
    //           â”‚    â”‚                                               â”‚  â”‚              â”‚     â”‚       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     
    //           â”‚    â””â”€â”€â”€Actor1                                      â”‚  â””â”€â”€â”€Actor1     â”‚     â”‚                  â”‚                       
    //           â”‚                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚                  â”‚                       
    //           â”‚                                                              â–²             â”‚                  â”‚                       
    //           â””â”€â”€â”€NetDriver                                                  â”‚             â”‚                  â”‚                       
    //                â”‚                                                         â”‚             â”‚                  â”‚                       
    //                â”œâ”€â”€â”€Connection0â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚                       
    //                â”‚    â”‚                                                    â”‚                                â”‚                       
    //                â”‚    â””â”€â”€â”€ClientVisibleActorOuters:TMap<FName, bool>       â”‚                                â”‚                       
    //                â”‚          â”‚                                              â”‚                                â”‚                       
    //                â”‚          â””â”€â”€â”€(Level0, false) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       
    //                â”‚                                                         â”‚                                                        
    //                â”‚                                                         â”‚                                                        
    //                â””â”€â”€â”€Connection1                                           â”‚                                                        
    //                     â”‚                                                    â”‚                                                        
    //                     â””â”€â”€â”€ClientVisibleActorOuters:TMap<FName, bool>       â”‚                                                        
    //                           â”‚                                              â”‚                                                        
    //                           â””â”€â”€â”€(Level0, true)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        
    //                                                               ***Client1 has loaded Level0 successfully already!                  
    //                                                                                                                                   
    const FName PackageName = TestLevel->GetPackage()->GetFName();

    if (const bool* bIsVisible = ClientVisibleActorOuters.Find(PackageName))
    {
        return *bIsVisible;
    }
    
    return UpdateCachedLevelVisibility(PackageName);
}
```