---
layout: default
title: "(04. Network ë³µì œ ì‹œìŠ¤í…œ êµ¬ì¡°ì¡° ì„¤ëª…ëª…)"
parent: "(UE Code-Review ğŸ¤–)"
has_children: true
nav_order: 1
permalink: docs/review/ue/ver4/04/NetReplicator
---

## ê°„ë‹¨í•œ ì˜ˆì‹œë¡œ ì‹œì‘í•´ ë³´ì

```cpp
// UE ë„¤íŠ¸ì›Œí¬ë¡œ ì•„ë˜ í´ë˜ìŠ¤ë¥¼ ë³µì‚¬í•˜ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œ?

class AMyCharacter : public ACharacter
{
    GENERATED_BODY()
    
public:
    // ë¶ˆë¦¬ì–¸ ì†ì„±ë“¤
    UPROPERTY(Replicated)
    bool bIsRunning;
    
    UPROPERTY(Replicated)
    bool bIsCrouching;
    
    // ì •ìˆ˜ ì†ì„±
    UPROPERTY(Replicated)
    int32 Health;
    
    // êµ¬ì¡°ì²´ ì†ì„±
    UPROPERTY(Replicated)
    FWeaponInfo EquippedWeapon;
};

// ë¬´ê¸° ì •ë³´ë¥¼ ë‹´ëŠ” êµ¬ì¡°ì²´
struct FWeaponInfo
{
    FString WeaponName;
    int32 Ammo;
    float Damage;
    bool bIsAutomatic;
};
```

* ë³µì‚¬ë¥¼ ìœ„í•´ì„œ ë³´í†µ ì´ëŸ°ì‹ìœ¼ë¡œ ì½”ë“œë¥¼ êµ¬ì„±í•  ê²ƒì´ë‹¤.

```cpp
// MyCharacter.h
UCLASS()
class GAME_API AMyCharacter : public ACharacter
{
    GENERATED_BODY()
    
public:
    AMyCharacter();
    
    // ë³µì œë  ì†ì„±ë“¤
    UPROPERTY(Replicated)
    float Health;
    
    UPROPERTY(ReplicatedUsing=OnRep_IsRunning)
    bool bIsRunning;
    
    // ë³µì œ í›„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ í˜¸ì¶œë  í•¨ìˆ˜
    UFUNCTION()
    void OnRep_IsRunning();
    
    // ì„œë²„ì—ì„œ ì‹¤í–‰ë  í•¨ìˆ˜
    UFUNCTION(Server, Reliable)
    void ServerStartRunning();
    
    // ë³µì œ ì†ì„± ë“±ë¡ í•¨ìˆ˜
    virtual void GetLifetimeReplicatedProps(TArray<FLifetimeProperty>& OutLifetimeProps) const override;
};

// MyCharacter.cpp
AMyCharacter::AMyCharacter()
{
    // ë³µì œ í™œì„±í™”
    bReplicates = true;
    
    // ì´ˆê¸°ê°’ ì„¤ì •
    Health = 100.0f;
    bIsRunning = false;
}

void AMyCharacter::GetLifetimeReplicatedProps(TArray<FLifetimeProperty>& OutLifetimeProps) const
{
    Super::GetLifetimeReplicatedProps(OutLifetimeProps);
    
    // ë³µì œ ì†ì„± ë“±ë¡
    DOREPLIFETIME(AMyCharacter, Health);
    DOREPLIFETIME(AMyCharacter, bIsRunning);
}

void AMyCharacter::OnRep_IsRunning()
{
    // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì‹¤í–‰ë  ì½”ë“œ
    if (bIsRunning)
    {
        // ë‹¬ë¦¬ê¸° ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ
        GetCharacterMovement()->MaxWalkSpeed = 600.0f;
    }
    else
    {
        // ê±·ê¸° ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ
        GetCharacterMovement()->MaxWalkSpeed = 300.0f;
    }
}

void AMyCharacter::ServerStartRunning_Implementation()
{
    // ì„œë²„ì—ì„œ ì‹¤í–‰ë  ì½”ë“œ
    bIsRunning = true;
    
    // ë³µì œëŠ” ìë™ìœ¼ë¡œ ì²˜ë¦¬ë¨
}
```

```cpp
// GameMode.cpp (ì„œë²„ì—ì„œ ì‹¤í–‰)
ACharacter* AMyGameMode::SpawnDefaultPawnFor_Implementation(AController* NewPlayer, AActor* StartSpot)
{
    // ìºë¦­í„° ìŠ¤í°
    FActorSpawnParameters SpawnParams;
    SpawnParams.SpawnCollisionHandlingOverride = ESpawnActorCollisionHandlingMethod::AdjustIfPossibleButAlwaysSpawn;
    
    AMyCharacter* NewCharacter = GetWorld()->SpawnActor<AMyCharacter>(
        DefaultPawnClass, 
        StartSpot->GetTransform(), 
        SpawnParams
    );
    
    // ì´ ì‹œì ì—ì„œëŠ” ì•„ì§ ì‹¤ì œ ë„¤íŠ¸ì›Œí¬ ë³µì œê°€ ì‹œì‘ë˜ì§€ ì•ŠìŒ
    // bReplicates = trueë¡œ ì„¤ì •ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— ì—”ì§„ì´ ì•Œì•„ì„œ ë³µì œ ì˜ˆì•½
    
    return NewCharacter;
}
```

---

## ê·¸ëŸ¼ ì´ ë³µì‚¬ëŠ” ì–´ë–»ê²Œ ì´ë£¨ì–´ ì§ˆê¹Œ?

* ë³µì‚¬ê°€ ì‹œì‘ì‹œ ë©”ëª¨ë¦¬ì— í• ë‹¹ëœ ì˜¤í”„ì…‹ ìœ„ì¹˜ë¥¼ í™•ì¸í•œë‹¤ë‹¤

```
[AMyCharacter ë©”ëª¨ë¦¬ ë ˆì´ì•„ì›ƒ]
ë² ì´ìŠ¤ ì£¼ì†Œ: 0x1000 (ì˜ˆì‹œ)
+100: bIsRunning (1ë¹„íŠ¸)  â”€â” 
+100: bIsCrouching (1ë¹„íŠ¸) â”˜ ê°™ì€ ë°”ì´íŠ¸ì˜ ë‹¤ë¥¸ ë¹„íŠ¸ ì‚¬ìš©
+104: Health (4ë°”ì´íŠ¸)
+108: EquippedWeapon (êµ¬ì¡°ì²´ ì‹œì‘)
  +108: WeaponName (FString, í¬ì¸í„° + ë©”íƒ€ë°ì´í„°)
  +124: Ammo (4ë°”ì´íŠ¸)
  +128: Damage (4ë°”ì´íŠ¸)
  +132: bIsAutomatic (1ë°”ì´íŠ¸)
```

* ì´ êµ¬ì¡°ë¥¼ FRepLayoutìœ¼ë¡œ êµ¬ì„±í•œë‹¤

```cpp
// ë‚´ë¶€ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ” Parents ë°°ì—´
TArray<FRepParentCmd> Parents = {
    // ì¸ë±ìŠ¤ 0: bIsRunning
    { 
        Property: [bIsRunningì— ëŒ€í•œ í¬ì¸í„°],
        Offset: 100,               // ê°ì²´ ì‹œì‘ì ìœ¼ë¡œë¶€í„°ì˜ ë°”ì´íŠ¸ ì˜¤í”„ì…‹
        CmdStart: 0,               // Cmds ë°°ì—´ì—ì„œì˜ ì‹œì‘ ì¸ë±ìŠ¤
        CmdEnd: 1                  // Cmds ë°°ì—´ì—ì„œì˜ ë ì¸ë±ìŠ¤ (ë°°íƒ€ì )
    },
    
    // ì¸ë±ìŠ¤ 1: bIsCrouching
    { 
        Property: [bIsCrouchingì— ëŒ€í•œ í¬ì¸í„°],
        Offset: 100,               // ê°™ì€ ë°”ì´íŠ¸ì— ìˆê¸° ë•Œë¬¸ì— ë™ì¼í•œ ì˜¤í”„ì…‹
        CmdStart: 1,
        CmdEnd: 2
    },
    
    // ì¸ë±ìŠ¤ 2: Health
    { 
        Property: [Healthì— ëŒ€í•œ í¬ì¸í„°],
        Offset: 104,
        CmdStart: 2,
        CmdEnd: 3
    },
    
    // ì¸ë±ìŠ¤ 3: EquippedWeapon
    { 
        Property: [EquippedWeaponì— ëŒ€í•œ í¬ì¸í„°],
        Offset: 108,
        CmdStart: 3,               // êµ¬ì¡°ì²´ëŠ” ì—¬ëŸ¬ ëª…ë ¹ì–´ í•„ìš”
        CmdEnd: 7                  // 4ê°œì˜ ëª…ë ¹ì–´(3,4,5,6)ë¥¼ í¬í•¨
    }
};
```

### ë‹¤ìŒì€ ë³µì œ ëª…ë ¹ì„ ìœ„í•´ FRepLayoutCmdë¥¼ ë§Œë“ ë‹¤

```cpp
// ë‚´ë¶€ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ” Cmds ë°°ì—´
TArray<FRepLayoutCmd> Cmds = {
    // ì¸ë±ìŠ¤ 0: bIsRunningì— ëŒ€í•œ ëª…ë ¹
    {
        Type: PropertyBool,
        ElementSize: 1,            // í¬ê¸° (ë°”ì´íŠ¸)
        Offset: 100,               // ê°ì²´ ì‹œì‘ì ìœ¼ë¡œë¶€í„°ì˜ ë°”ì´íŠ¸ ì˜¤í”„ì…‹
        RelativeHandle: 1,         // ë„¤íŠ¸ì›Œí¬ ìƒì—ì„œì˜ í•¸ë“¤
        ParentIndex: 0             // Parents ë°°ì—´ì—ì„œì˜ ì¸ë±ìŠ¤
    },
    
    // ì¸ë±ìŠ¤ 1: bIsCrouchingì— ëŒ€í•œ ëª…ë ¹
    {
        Type: PropertyBool,
        ElementSize: 1,
        Offset: 100,               // ê°™ì€ ë°”ì´íŠ¸ì— ìˆìŒ
        RelativeHandle: 2,
        ParentIndex: 1
    },
    
    // ì¸ë±ìŠ¤ 2: Healthì— ëŒ€í•œ ëª…ë ¹
    {
        Type: PropertyInt,
        ElementSize: 4,
        Offset: 104,
        RelativeHandle: 3,
        ParentIndex: 2
    },
    
    // ì¸ë±ìŠ¤ 3: EquippedWeapon (êµ¬ì¡°ì²´ ì „ì²´)ì— ëŒ€í•œ ëª…ë ¹
    {
        Type: PropertyStruct,
        ElementSize: 28,           // êµ¬ì¡°ì²´ ì „ì²´ í¬ê¸°
        Offset: 108,
        RelativeHandle: 4,
        ParentIndex: 3
    },
    
    // ì¸ë±ìŠ¤ 4: WeaponNameì— ëŒ€í•œ ëª…ë ¹
    {
        Type: PropertyString,
        ElementSize: 16,           // FString í¬ê¸°
        Offset: 108,
        RelativeHandle: 5,
        ParentIndex: 3             // ë¶€ëª¨ëŠ” ì—¬ì „íˆ EquippedWeapon
    },
    
    // ì¸ë±ìŠ¤ 5: Ammoì— ëŒ€í•œ ëª…ë ¹
    {
        Type: PropertyInt,
        ElementSize: 4,
        Offset: 124,
        RelativeHandle: 6,
        ParentIndex: 3             // ë¶€ëª¨ëŠ” ì—¬ì „íˆ EquippedWeapon
    },
    
    // ì¸ë±ìŠ¤ 6: Damageì— ëŒ€í•œ ëª…ë ¹
    {
        Type: PropertyFloat,
        ElementSize: 4,
        Offset: 128,
        RelativeHandle: 7,
        ParentIndex: 3             // ë¶€ëª¨ëŠ” ì—¬ì „íˆ EquippedWeapon
    },
    
    // ì¸ë±ìŠ¤ 7: bIsAutomaticì— ëŒ€í•œ ëª…ë ¹
    {
        Type: PropertyBool,
        ElementSize: 1,
        Offset: 132,
        RelativeHandle: 8,
        ParentIndex: 3             // ë¶€ëª¨ëŠ” ì—¬ì „íˆ EquippedWeapon
    }
};
```

## ë³µì‚¬ì‹œ ì´ë ‡ê²Œ ì ‘ê·¼ì„ í•˜ê²Œ ëœë‹¤.

```cpp
// ê°ì²´ ì£¼ì†Œê°€ baseAddressë¼ê³  ê°€ì •
AMyCharacter* Character = ...; // ë² ì´ìŠ¤ ì£¼ì†Œ ì–»ê¸°
uint8* BasePtr = (uint8*)Character;

// Health ì†ì„±ì— ì ‘ê·¼ (Offset: 104)
int32* HealthPtr = (int32*)(BasePtr + 104);
int32 CurrentHealth = *HealthPtr;

// ë˜ëŠ” ì†ì„±ê°’ ë³€ê²½
*HealthPtr = 100;
```

---

## ê·¸ëŸ°ë° ì´ê²Œ ì™œ íš¨ìœ¨ì ì¼ê¹Œ?

### ë©”ëª¨ë¦¬ ì‚¬ìš© ìµœì í™”

* FRepLayoutì€ í´ë˜ìŠ¤ë‹¹ í•œ ë²ˆë§Œ ìƒì„±ë˜ë©°, ë™ì¼í•œ í´ë˜ìŠ¤ì˜ ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ê°€ ì´ë¥¼ ê³µìœ 

```cpp
// ê²Œì„ì— 1000ê°œì˜ ë™ì¼í•œ ëª¬ìŠ¤í„°ê°€ ìˆë‹¤ê³  ê°€ì •
class AMonster : public AActor { ... };

// ë¹„íš¨ìœ¨ì  ì ‘ê·¼ ë°©ì‹: ê° ëª¬ìŠ¤í„°ë§ˆë‹¤ ë³µì œ êµ¬ì¡° ìƒì„±
// íš¨ìœ¨ì  ì ‘ê·¼ ë°©ì‹(FRepLayout): í´ë˜ìŠ¤ë‹¹ í•œ ë²ˆë§Œ êµ¬ì¡° ë¶„ì„
```

* ë³€ê²½ëœ ì†ì„±ë§Œ ë³µì œ

```cpp
// ì „ì²´ ê°ì²´ê°€ ì•„ë‹Œ ë³€ê²½ëœ ì†ì„±ë§Œ ì „ì†¡
bool FRepLayout::CompareProperties(
    FSendingRepState* RepState,
    FRepChangelistState* RepChangelistState,
    const uint8* Data,
    const FReplicationFlags& RepFlags) const
{
    // ì´ì „ ê°’ê³¼ í˜„ì¬ ê°’ ë¹„êµ
    for (int32 i = 0; i < Parents.Num(); i++)
    {
        if (ì´ì „_ê°’ != í˜„ì¬_ê°’)
        {
            // ë³€ê²½ëœ ì†ì„±ë§Œ ChangedListì— ì¶”ê°€
            Changed.Add(i);
        }
    }
}
```

### ë°ì´í„° ì••ì¶•

```cpp
// ì†ì„± í•¸ë“¤ ì••ì¶•
static void WritePropertyHandle(FNetBitWriter& Writer, uint16 Handle, bool bDoChecksum)
{
    // 8ë¹„íŠ¸ ë˜ëŠ” 16ë¹„íŠ¸ë¡œ ì••ì¶•
    if (Handle < 128)
    {
        Writer.WriteBit(1);  // ë‹¨ì¼ ë°”ì´íŠ¸ í‘œì‹œ
        Writer.SerializeInt(Handle, 7);  // 7ë¹„íŠ¸ë§Œ ì‚¬ìš©
    }
    else
    {
        Writer.WriteBit(0);  // ë‘ ë°”ì´íŠ¸ í‘œì‹œ
        Writer.SerializeInt(Handle, 16);  // 16ë¹„íŠ¸ ì‚¬ìš©
    }
}
```

### íŒ¨í‚· ìµœì í™”

```cpp
// ë³€ê²½ëœ ì†ì„±ë§Œ í¬í•¨í•˜ëŠ” ê°„ê²°í•œ íŒ¨í‚· ìƒì„±
void FRepLayout::SendProperties(
    FSendingRepState* RepState,
    const uint8* Data,
    FNetBitWriter& Writer,
    TArray<uint16>& Changed) const
{
    // íŒ¨í‚· ì‹œì‘ ìœ„ì¹˜ í‘œì‹œ
    FBitWriterMark Mark(Writer);
    
    // ì‹œì‘ ë¶€ë¶„ ë¹„íŠ¸ ìˆ˜
    const int64 NumBits = Writer.GetNumBits();
    
    // ë³€ê²½ëœ ì†ì„±ë§Œ ì „ì†¡
    FChangelistIterator ChangelistIterator(Changed, 0);
    FRepHandleIterator HandleIterator(...);
    
    SendProperties_r(RepState, Writer, HandleIterator, Data);
    
    // íŒ¨í‚·ì— ì‹¤ì œ ë³€ê²½ ì‚¬í•­ì´ ì—†ìœ¼ë©´ ë¡¤ë°±
    if (NumBits == Writer.GetNumBits())
    {
        Mark.Pop(Writer);
    }
}
```