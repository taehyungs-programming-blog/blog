---
layout: default
title: "(22. FWorldContext, PendingNetGame ê´€ê³„)"
parent: "(UE Code-Review ğŸ¤–)"
has_children: true
nav_order: 3
permalink: docs/review/ue/ver4/22/tFWorldContext_PendingNetGame
---

## FWorldContext ê°œë…

* **FWorldContext**ëŠ” ì—”ì§„ ë ˆë²¨ì—ì„œ UWorldë¥¼ ê´€ë¦¬í•˜ëŠ” ì»¨í…Œì´ë„ˆ 
* ì›”ë“œ ìì²´ê°€ ì•„ë‹ˆë¼ ì›”ë“œë¥¼ ë‘˜ëŸ¬ì‹¼ ì»¨í…ìŠ¤íŠ¸ ì •ë³´ë¥¼ ë‹´ê³  ìˆë‹¤

```cpp
struct FWorldContext
{
    // ì›”ë“œ íƒ€ì… (Editor, Game, PIE)
    TEnumAsByte<EWorldType::Type> WorldType;
    
    // ì»¨í…ìŠ¤íŠ¸ ê³ ìœ  ì´ë¦„
    FName ContextHandle;
    
    // ì´ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì†Œìœ í•˜ëŠ” GameInstance
    TObjectPtr<class UGameInstance> OwningGameInstance;
    
    // ì‹¤ì œ ì›”ë“œ ì°¸ì¡°
    TObjectPtr<UWorld> ThisCurrentWorld;
    
    // ë·°í¬íŠ¸ í´ë¼ì´ì–¸íŠ¸
    TObjectPtr<UGameViewportClient> GameViewport;
    
    // PIE ì¸ìŠ¤í„´ìŠ¤ ë²ˆí˜¸
    int32 PIEInstance;
    
    // ë„¤íŠ¸ì›Œí‚¹ ê´€ë ¨
    TArray<FNamedNetDriver> ActiveNetDrivers;
    TObjectPtr<UPendingNetGame> PendingNetGame;
};
```

```cpp
// UEngine::Init()ì—ì„œ ì—ë””í„° ì›”ë“œ ìƒì„±
virtual void Init(IEngineLoop* InEngineLoop)
{
    if (GIsEditor)
    {
        // ì—ë””í„°ìš© WorldContext ìƒì„±
        FWorldContext& InitialWorldContext = CreateNewWorldContext(EWorldType::Editor);
        
        // ì—ë””í„° ì›”ë“œ ìƒì„± ë° ì„¤ì •
        InitialWorldContext.SetCurrentWorld(UWorld::CreateWorld(EWorldType::Editor, true));
        GWorld = InitialWorldContext.World();
    }
}
```

```cpp
// PIE ì‹œì‘ ì‹œ ìƒˆë¡œìš´ WorldContext ìƒì„±
virtual void CreateNewPlayInEditorInstance(FRequestPlaySessionParams &InRequestParams, 
                                         const bool bInDedicatedInstance, 
                                         const EPlayNetMode InNetMode)
{
    // PIEìš© WorldContext ìƒì„±
    FWorldContext& PieWorldContext = CreateNewWorldContext(EWorldType::PIE);
    
    // PIE ì¸ìŠ¤í„´ìŠ¤ ë²ˆí˜¸ í• ë‹¹ (ë©€í‹°í”Œë ˆì´ì–´ì—ì„œ ì¤‘ìš”)
    PieWorldContext.PIEInstance = PlayInEditorSessionInfo->PIEInstanceCount++;
    
    // ê²Œì„ ì¸ìŠ¤í„´ìŠ¤ íŒŒë¼ë¯¸í„° ì„¤ì •
    FGameInstancePIEParameters GameInstancePIEParameters;
    GameInstancePIEParameters.bRunAsDedicated = bInDedicatedInstance;
    GameInstancePIEParameters.NetMode = InNetMode;
}
```

---

## PendingNetGame ê°œë…

* UPendingNetGameì€ í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì— ì—°ê²°í•˜ëŠ” ë™ì•ˆì˜ ì„ì‹œ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” ê°ì²´
* ì‹¤ì œ ê²Œì„ ì›”ë“œê°€ ë¡œë“œë˜ê¸° ì „ê¹Œì§€ì˜ "ëŒ€ê¸°ì‹¤" ì—­í• 

```cpp
// UPendingNetGameì˜ ì£¼ìš” êµ¬ì¡°ì™€ ê¸°ëŠ¥ ì˜ˆì‹œ

class UPendingNetGame : public UObject
{
public:
    // ì„œë²„ ì—°ê²° URL ì •ë³´
    FURL URL;
    
    // ì„œë²„ì™€ì˜ í†µì‹ ì„ ìœ„í•œ NetDriver
    TObjectPtr<UNetDriver> NetDriver;
    
    // ì—°ê²° ìƒíƒœ í”Œë˜ê·¸ë“¤
    bool bSuccessfullyConnected;     // ì„œë²„ ì—°ê²° ì„±ê³µ ì—¬ë¶€
    bool bSentJoinRequest;           // Join ìš”ì²­ ì „ì†¡ ì—¬ë¶€  
    bool bLoadedMapSuccessfully;     // ë§µ ë¡œë”© ì„±ê³µ ì—¬ë¶€
    
    // ì—°ê²° ì˜¤ë¥˜ ë©”ì‹œì§€
    FString ConnectionError;
    
    // ì„œë²„ë¡œë¶€í„° ë°›ì€ ê²Œì„ ì •ë³´
    FString GameName;
    FString LevelName;
    
    // ì£¼ìš” ë©”ì„œë“œë“¤
    void Initialize(const FURL& InURL);              // ì´ˆê¸°í™”
    void InitNetDriver();                            // NetDriver ìƒì„±
    void Tick(float DeltaSeconds);                   // ë§¤ í”„ë ˆì„ ì²˜ë¦¬
    void NotifyControlMessage(uint8 MessageType, class FInBunch& Bunch);  // ì»¨íŠ¸ë¡¤ ë©”ì‹œì§€ ì²˜ë¦¬
    bool LoadMapCompleted(UEngine* Engine, FWorldContext& Context, bool bLoadSuccess, const FString& Error);
    void TravelCompleted(UEngine* Engine, FWorldContext& Context);
};

// 1. ì´ˆê¸°í™” ê³¼ì •
void UPendingNetGame::Initialize(const FURL& InURL)
{
    URL = InURL;
    bSuccessfullyConnected = false;
    bSentJoinRequest = false;
    bLoadedMapSuccessfully = false;
    ConnectionError = TEXT("");
    
    // ì„œë²„ ì •ë³´ íŒŒì‹±
    GameName = URL.GetOption(TEXT("Game="), TEXT(""));
    LevelName = URL.Map;
}

// 2. NetDriver ìƒì„±
void UPendingNetGame::InitNetDriver()
{
    // "PendingNetDriver" ì´ë¦„ìœ¼ë¡œ NetDriver ìƒì„±
    UEngine* Engine = GetEngine();
    if (Engine->CreateNamedNetDriver(this, NAME_PendingNetDriver, NAME_GameNetDriver))
    {
        NetDriver = Engine->FindNamedNetDriver(this, NAME_PendingNetDriver);
        if (NetDriver)
        {
            // í´ë¼ì´ì–¸íŠ¸ ëª¨ë“œë¡œ ì„¤ì •
            NetDriver->SetWorld(nullptr);  // ì•„ì§ ì›”ë“œ ì—†ìŒ
            NetDriver->InitConnect(this, URL, ConnectionError);
        }
    }
}

// 3. ë§¤ í”„ë ˆì„ ì²˜ë¦¬
void UPendingNetGame::Tick(float DeltaSeconds)
{
    if (NetDriver)
    {
        // ë„¤íŠ¸ì›Œí¬ íŒ¨í‚· ì²˜ë¦¬
        NetDriver->TickDispatch(DeltaSeconds);
        NetDriver->TickFlush(DeltaSeconds);
        
        // ì—°ê²° ìƒíƒœ í™•ì¸
        if (NetDriver->ServerConnection)
        {
            if (NetDriver->ServerConnection->State == USOCK_Closed)
            {
                ConnectionError = TEXT("Connection closed");
            }
        }
    }
}

// 4. ì»¨íŠ¸ë¡¤ ë©”ì‹œì§€ ì²˜ë¦¬ (ê°€ì¥ ì¤‘ìš”!)
void UPendingNetGame::NotifyControlMessage(uint8 MessageType, FInBunch& Bunch)
{
    switch (MessageType)
    {
        case NMT_Hello:
        {
            // ì„œë²„ë¡œë¶€í„° Hello ë©”ì‹œì§€ ìˆ˜ì‹ 
            FString ServerGameName;
            Bunch << ServerGameName;
            
            // ê²Œì„ í˜¸í™˜ì„± í™•ì¸
            if (ServerGameName != GameName)
            {
                ConnectionError = TEXT("Game mismatch");
                return;
            }
            break;
        }
        
        case NMT_Welcome:
        {
            // ì„œë²„ë¡œë¶€í„° Welcome ë©”ì‹œì§€ ìˆ˜ì‹  (ê°€ì¥ ì¤‘ìš”!)
            FString ServerLevelName;
            FString ServerGameName;
            
            Bunch << ServerLevelName;
            Bunch << ServerGameName;
            
            // ì„œë²„ ë§µ ì •ë³´ ì—…ë°ì´íŠ¸
            URL.Map = ServerLevelName;
            LevelName = ServerLevelName;
            
            // ì—°ê²° ì„±ê³µ í”Œë˜ê·¸ ì„¤ì •
            bSuccessfullyConnected = true;
            
            break;
        }
        
        case NMT_Upgrade:
        {
            // ì—…ê·¸ë ˆì´ë“œ ìš”ì²­ ì²˜ë¦¬
            break;
        }
        
        case NMT_Failure:
        {
            // ì—°ê²° ì‹¤íŒ¨ ì²˜ë¦¬
            FString FailureMessage;
            Bunch << FailureMessage;
            ConnectionError = FailureMessage;
            break;
        }
    }
}

// 5. ë§µ ë¡œë”© ì™„ë£Œ ì²˜ë¦¬
bool UPendingNetGame::LoadMapCompleted(UEngine* Engine, FWorldContext& Context, bool bLoadSuccess, const FString& Error)
{
    if (bLoadSuccess)
    {
        bLoadedMapSuccessfully = true;
        return true;
    }
    else
    {
        ConnectionError = Error;
        return false;
    }
}

// 6. ì—¬í–‰(ì „í™˜) ì™„ë£Œ ì²˜ë¦¬
void UPendingNetGame::TravelCompleted(UEngine* Engine, FWorldContext& Context)
{
    // NetDriverë¥¼ ì‹¤ì œ ì›”ë“œë¡œ ì´ì „
    Engine->MovePendingLevel(Context);
    
    // ì •ë¦¬ ì‘ì—…
    NetDriver = nullptr;  // ì†Œìœ ê¶Œ ì´ì „ë¨
}
```

---

## FWorldContext, PendingNetGame ê´€ê³„

### ì›”ë“œ ì „í™˜ì˜ ì—°ì†ì„± ë³´ì¥

* PendingNetGameì€ "ì›”ë“œ ì—†ëŠ” ìƒíƒœ"ì—ì„œ "ìƒˆë¡œìš´ ì›”ë“œ"ë¡œì˜ ì „í™˜ì„ ë‹´ë‹¹. 
* ì´ ê³¼ì •ì—ì„œ FWorldContextê°€ ì „ì²´ ì „í™˜ ê³¼ì •ì„ ê´€ë¦¬

```cpp
// ì „í™˜ ê³¼ì •ì˜ ìƒíƒœ ë³€í™”
FWorldContext Context;

// 1ë‹¨ê³„: ì—°ê²° ì‹œì‘ - ì•„ì§ ì›”ë“œ ì—†ìŒ
Context.ThisCurrentWorld = nullptr;
Context.PendingNetGame = NewObject<UPendingNetGame>();  // ì„ì‹œ ìƒíƒœ ì‹œì‘

// 2ë‹¨ê³„: ì„œë²„ ì •ë³´ ìˆ˜ì‹  - ì—¬ì „íˆ ì›”ë“œ ì—†ìŒ
Context.PendingNetGame->bSuccessfullyConnected = true;  // ì–´ë–¤ ë§µì„ ë¡œë“œí• ì§€ ì•Œê²Œ ë¨

// 3ë‹¨ê³„: ìƒˆ ì›”ë“œ ìƒì„± - ì „í™˜ ê³¼ì •
UWorld* NewWorld = CreateWorldFromServerInfo();
Context.SetCurrentWorld(NewWorld);                     // ìƒˆ ì›”ë“œ ì„¤ì •

// 4ë‹¨ê³„: NetDriver ì´ì „ - ì „í™˜ ì™„ë£Œ
MovePendingLevel(Context);                              // PendingNetGame â†’ World
Context.PendingNetGame = nullptr;                       // ì„ì‹œ ìƒíƒœ ì¢…ë£Œ
```

### NetDriver ì†Œìœ ê¶Œ ê´€ë¦¬

* NetDriverì˜ ì†Œìœ ê¶Œì´ PendingNetGameì—ì„œ UWorldë¡œ ì´ì „ë˜ëŠ” ê³¼ì •ì„ FWorldContextê°€ ê´€ë¦¬

```cpp
// NetDriver ì†Œìœ ê¶Œ ì´ì „ ê³¼ì •
void MovePendingLevel(FWorldContext& Context)
{
    // 1. PendingNetGameì´ ê°€ì§€ê³  ìˆë˜ NetDriverë¥¼ ê°€ì ¸ì˜´
    UNetDriver* NetDriver = Context.PendingNetGame->NetDriver;
    
    // 2. ìƒˆë¡œìš´ ì›”ë“œì— NetDriver ì„¤ì •
    Context.World()->SetNetDriver(NetDriver);
    
    // 3. NetDriver ì´ë¦„ ë³€ê²½: "PendingNetDriver" â†’ "GameNetDriver"
    NetDriver->SetNetDriverName(NAME_GameNetDriver);
    
    // 4. NetDriverê°€ ìƒˆ ì›”ë“œë¥¼ ì°¸ì¡°í•˜ë„ë¡ ì„¤ì •
    NetDriver->SetWorld(Context.World());
    
    // 5. WorldContextì˜ ActiveNetDriversì— ì¶”ê°€
    Context.ActiveNetDrivers.Add(FNamedNetDriver(NetDriver, Definition));
}
```

### ë©€í‹° ì¸ìŠ¤í„´ìŠ¤ ê´€ë¦¬

* PIEì—ì„œ ì—¬ëŸ¬ í´ë¼ì´ì–¸íŠ¸ê°€ ë™ì‹œì— ì—°ê²°í•  ë•Œ, ê°ê°ì˜ WorldContextê°€ ë…ë¦½ì ì¸ PendingNetGameì„ ê´€ë¦¬

```cpp
// 2í´ë¼ì´ì–¸íŠ¸ PIE ì˜ˆì‹œ
TArray<FWorldContext> WorldList;

// í´ë¼ì´ì–¸íŠ¸ 1
WorldList[1].PIEInstance = 1;
WorldList[1].PendingNetGame = NewObject<UPendingNetGame>();  // í´ë¼ì´ì–¸íŠ¸1ì˜ ì—°ê²° ìƒíƒœ
WorldList[1].PendingNetGame->URL = "127.0.0.1:7777/TestMap";

// í´ë¼ì´ì–¸íŠ¸ 2  
WorldList[2].PIEInstance = 2;
WorldList[2].PendingNetGame = NewObject<UPendingNetGame>();  // í´ë¼ì´ì–¸íŠ¸2ì˜ ì—°ê²° ìƒíƒœ
WorldList[2].PendingNetGame->URL = "127.0.0.1:7777/TestMap";

// ê°ê° ë…ë¦½ì ìœ¼ë¡œ ì—°ê²° ì§„í–‰
for (FWorldContext& Context : WorldList)
{
    if (Context.PendingNetGame)
    {
        Context.PendingNetGame->Tick(DeltaSeconds);  // ê°œë³„ ì²˜ë¦¬
    }
}
```