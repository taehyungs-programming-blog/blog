---
layout: default
title: "(14. FObjectReplicatorê°€ Replicateì„ í•˜ëŠ” ë°©ë²•)"
parent: "(UE Code-Review ğŸ¤–)"
has_children: true
nav_order: 2
permalink: docs/review/ue/ver4/14/HowFObjectReplicatorReplicate
---

```cpp
TSharedRef<FObjectReplicator>& UActorChannel::CreateReplicator(UObject* Obj, bool bCheckDormantReplicators)
{
    // ...

    TSharedRef<FObjectReplicator>& NewRef = ReplicationMap.Add(Obj, NewReplicator.ToSharedRef());

    NewRef->StartReplicating(this);

    // ...
}
```

```cpp
void FObjectReplicator::StartReplicating(class UActorChannel* InActorChannel)
{
    UObject* const Object = GetObject();
    if (Object == nullptr)
    {
        return;
    }

    if (UClass* const ObjectPtrClass = Object->GetClass())
    {
        ObjectClass = ObjectPtrClass;
    }

    OwningChannel = InActorChannel;

    UNetDriver* const ConnectionNetDriver = Connection->GetDriver();

    // NetGUID ê°œë…ì˜ ì´í•´ê°€ í•„ìš”í•˜ë‹¤ (ì•„ë˜ ì°¸ê³ ,)
    ObjectNetGUID = ConnectionDriver->GuidCache->GetOrAssignNetGUID(Object);

    bOpenAckCalled = false;


    // ...
```

---


### FNetGUIDCache

* ì¼ë‹¨ ë³€ìˆ˜ë¥¼ ì‚´í´ë³¼ê¹Œ?

```cpp
// ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë²„ ì°¸ì¡° - ì„œë²„ì¸ì§€ í´ë¼ì´ì–¸íŠ¸ì¸ì§€ í™•ì¸í•˜ëŠ” ë° ì‚¬ìš©ë¨
UNetDriver* Driver;

// ì •ì (1)ê³¼ ë™ì (0) ê°ì²´ë¥¼ ìœ„í•œ ë‘ ê°œì˜ ì¸ë±ìŠ¤ ì¹´ìš´í„°
// - ì •ì  ê°ì²´: NetworkGuidIndex[1] ì‚¬ìš© (IsStatic==true)
// - ë™ì  ê°ì²´: NetworkGuidIndex[0] ì‚¬ìš© (IsStatic==false)
// - ê° íƒ€ì…ë³„ë¡œ ìƒˆ NetGUIDë¥¼ ìƒì„±í•  ë•Œë§ˆë‹¤ í•´ë‹¹ ì¸ë±ìŠ¤ê°€ ì¦ê°€í•¨
uint64 NetworkGuidIndex[2];

// ë‘ ê°œì˜ í•µì‹¬ ë£©ì—… í…Œì´ë¸”:
// 1. ObjectLookup: NetGUIDë¡œ ê°ì²´ ì •ë³´(FNetGuidCacheObject) ì°¾ê¸°
// 2. NetGUIDLookup: ê°ì²´ í¬ì¸í„°ë¡œ NetGUID ì°¾ê¸°
TMap<FNetworkGUID, FNetGuidCacheObject> ObjectLookup;
TMap<TWeakObjectPtr<UObject>, FNetworkGUID> NetGUIDLookup;

// í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ë¡œë¶€í„° ê°€ì ¸ì˜¨ NetGUID ëª©ë¡
TSet<FNetworkGUID> ImportedNetGuids;

// í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ê°ì²´ ë¡œë”© ì‹œ ë¹„ë™ê¸° ë¡œë”© ì‚¬ìš© ì—¬ë¶€ ì„¤ì •
// - ê¸°ë³¸ê°’ì€ EAsyncLoadMode::UseCVar (CVar ì„¤ì • ì‚¬ìš©)
// - "CVarAllowAsyncLoading"ì€ ê¸°ë³¸ì ìœ¼ë¡œ í™œì„±í™”ë˜ì–´ ìˆìŒ
enum class EAsyncLoadMode : uint8
{
    UseCVar     = 0,    // CVar(net.AllowAsyncLoading) ì„¤ì •ì— ë”°ë¼ ë¹„ë™ê¸° ë¡œë”© ì—¬ë¶€ ê²°ì •
    ForceDisable = 1,   // ë¹„ë™ê¸° ë¡œë”© ê°•ì œ ë¹„í™œì„±í™”
    ForceEnable = 2,    // ë¹„ë™ê¸° ë¡œë”© ê°•ì œ í™œì„±í™”
};
EAsyncLoadMode AsyncLoadMode;
```

* ê°ì²´-GUID ë§¤í•‘: ê²Œì„ ê°ì²´(UObject)ì™€ ë„¤íŠ¸ì›Œí¬ GUID ê°„ì˜ ë§¤í•‘ì„ ê´€ë¦¬
* ê°ì²´ ì°¸ì¡° í•´ê²°: ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ì „ì†¡ëœ ê°ì²´ ì°¸ì¡°ë¥¼ í•´ê²°
* ë™ì  ê°ì²´ ì¶”ì : ê²Œì„ ì¤‘ì— ìƒì„±ë˜ê³  íŒŒê´´ë˜ëŠ” ê°ì²´ë¥¼ ì¶”ì 

```cpp
// ì„œë²„ ì¸¡ ì½”ë“œ
void AMyGameMode::SpawnNetworkedActor()
{
    // ì•¡í„° ìŠ¤í°
    AMyActor* NewActor = GetWorld()->SpawnActor<AMyActor>(MyActorClass, Location, Rotation);
    
    // ë„¤íŠ¸ì›Œí¬ GUID í• ë‹¹
    UNetDriver* NetDriver = GetNetDriver();
    if (NetDriver && NetDriver->GuidCache.IsValid())
    {
        // ìƒˆ GUID í• ë‹¹ (ì„œë²„ì—ì„œë§Œ ìˆ˜í–‰)
        FNetworkGUID NetGUID = NetDriver->GuidCache->AssignNewNetGUID(NewActor);
        
        // ë¡œê·¸ ì¶œë ¥
        UE_LOG(LogNet, Log, TEXT("ì•¡í„° %sì— ë„¤íŠ¸ì›Œí¬ GUID %s í• ë‹¹ë¨"), 
            *NewActor->GetName(), *NetGUID.ToString());
    }
}
```

```cpp
// í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì½”ë“œ
void AMyPlayerController::HandleReceivedReference(FNetworkGUID InNetGUID)
{
    UNetDriver* NetDriver = GetNetDriver();
    if (NetDriver && NetDriver->GuidCache.IsValid())
    {
        // GUIDë¡œ ê°ì²´ ì°¾ê¸°
        UObject* ReferencedObject = NetDriver->GuidCache->GetObjectFromNetGUID(InNetGUID);
        
        if (ReferencedObject)
        {
            // ê°ì²´ê°€ ì´ë¯¸ ì¡´ì¬í•¨
            AMyActor* Actor = Cast<AMyActor>(ReferencedObject);
            if (Actor)
            {
                // ì°¾ì€ ì•¡í„° ì‚¬ìš©
                UE_LOG(LogNet, Log, TEXT("GUID %së¡œ ì•¡í„° %s ì°¾ìŒ"), 
                    *InNetGUID.ToString(), *Actor->GetName());
            }
        }
        else
        {
            // ê°ì²´ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•ŠìŒ - ë‚˜ì¤‘ì— í•´ê²°ë  ê²ƒì„
            UE_LOG(LogNet, Log, TEXT("GUID %sì— í•´ë‹¹í•˜ëŠ” ê°ì²´ê°€ ì•„ì§ ì—†ìŒ, ë‚˜ì¤‘ì— í•´ê²°ë  ì˜ˆì •"), 
                *InNetGUID.ToString());
        }
    }
}
```

```cpp
// ê°ì²´ ì¶”ì  ë° ê´€ë¦¬
void AMyNetworkManager::TrackNetworkObject(UObject* Object)
{
    UNetDriver* NetDriver = GetNetDriver();
    if (!NetDriver || !NetDriver->GuidCache.IsValid() || !Object)
    {
        return;
    }
    
    // ê°ì²´ì— GUIDê°€ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
    FNetworkGUID ExistingGUID = NetDriver->GuidCache->GetNetGUIDFromObject(Object);
    
    if (ExistingGUID.IsValid())
    {
        // ì´ë¯¸ ì¶”ì  ì¤‘ì¸ ê°ì²´
        UE_LOG(LogNet, Verbose, TEXT("ê°ì²´ %sëŠ” ì´ë¯¸ GUID %së¡œ ì¶”ì  ì¤‘"), 
            *Object->GetName(), *ExistingGUID.ToString());
    }
    else if (NetDriver->ServerConnection == nullptr) // ì„œë²„ì—ì„œë§Œ ìƒˆ GUID í• ë‹¹
    {
        // ìƒˆ GUID í• ë‹¹
        FNetworkGUID NewGUID = NetDriver->GuidCache->AssignNewNetGUID(Object);
        UE_LOG(LogNet, Log, TEXT("ìƒˆ ê°ì²´ %sì— GUID %s í• ë‹¹ë¨"), 
            *Object->GetName(), *NewGUID.ToString());
    }
}
```

#### server clientê°„ syncë¥¼ ì–´ë–»ê²Œ ë§ì¶˜ë‹¤ëŠ” ê±¸ê¹Œ?

* ì„œë²„ ì¸¡ NetGUID í• ë‹¹

```
ì„œë²„:
- ëª¨ë“  ë³µì œ ê°€ëŠ¥í•œ ê°ì²´ì— ëŒ€í•´ ê³ ìœ í•œ NetGUID ìƒì„±
- ì •ì  ê°ì²´: í™€ìˆ˜ ID (ë§ˆì§€ë§‰ ë¹„íŠ¸ê°€ 1)
- ë™ì  ê°ì²´: ì§ìˆ˜ ID (ë§ˆì§€ë§‰ ë¹„íŠ¸ê°€ 0)
```

* ì„œë²„ëŠ” AssignNewNetGUID_Server()ë¥¼ í†µí•´ ê°ì²´ë§ˆë‹¤ ê³ ìœ í•œ NetGUIDë¥¼ ìƒì„±í•˜ê³ , ì´ë¥¼ ObjectLookupê³¼ NetGUIDLookupì— ë“±ë¡
* í´ë¼ì´ì–¸íŠ¸ë¡œ NetGUID ì „ì†¡

```
ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸:
- ê°ì²´ ë³µì œ ì‹œ í•´ë‹¹ ê°ì²´ì˜ NetGUID í•¨ê»˜ ì „ì†¡
    - ì •ì  ê°ì²´: ê²½ë¡œëª…(PathName)ë„ í•¨ê»˜ ì „ì†¡
    - ë™ì  ê°ì²´: ì „ì²´ ê°ì²´ ìƒíƒœ ì „ì†¡
```

* ì„œë²„ê°€ ê°ì²´ë¥¼ ë³µì œí•  ë•Œ, í•´ë‹¹ ê°ì²´ì˜ NetGUIDë¥¼ í•¨ê»˜ ì „ì†¡í•©ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ëŠ” RegisterNetGUIDFromPath_Client()ë¥¼ í†µí•´ ì´ ì •ë³´ë¥¼ ìì‹ ì˜ ìºì‹œì— ë“±ë¡
* í´ë¼ì´ì–¸íŠ¸ì˜ ê°ì²´ ë¡œë“œ/ìƒì„±

```
í´ë¼ì´ì–¸íŠ¸:
- ì •ì  ê°ì²´: PathNameìœ¼ë¡œ ë¡œì»¬ì—ì„œ ë¡œë“œ
- ë™ì  ê°ì²´: ì„œë²„ì—ì„œ ì „ì†¡í•œ ë°ì´í„°ë¡œ ìƒì„±
```

* í´ë¼ì´ì–¸íŠ¸ëŠ” GetObjectFromNetGUID()ë¥¼ ì‚¬ìš©í•˜ì—¬:
    * ì •ì  ê°ì²´: íŒ¨í‚¤ì§€ ê²½ë¡œë¥¼ í†µí•´ ë¡œì»¬ì—ì„œ ë¡œë“œ
    * ë™ì  ê°ì²´: ì„œë²„ì—ì„œ ì „ì†¡ëœ ë°ì´í„°ë¡œ ìƒì„±

```
ê°ì²´ ê³„ì¸µ êµ¬ì¡°:
World â†’ Level â†’ Actor â†’ Component
```

* ê° ê°ì²´ëŠ” OuterGUIDë¥¼ í†µí•´ ë¶€ëª¨ ê°ì²´ì™€ ì—°ê²°ë©ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ëŠ” ì´ ê³„ì¸µ êµ¬ì¡°ë¥¼ ë”°ë¼ ì¬ê·€ì ìœ¼ë¡œ ê°ì²´ë¥¼ ë¡œë“œ/ìƒì„±
* ì˜ˆì‹œ

```
ì„œë²„:                           í´ë¼ì´ì–¸íŠ¸:
NetGUID=5 â†’ Actor0             NetGUID=5 â†’ Actor0
NetGUID=7 â†’ Level0             NetGUID=7 â†’ Level0
```

```cpp
// ëŒ€ëµ ì´ëŸ°ì‹ì´ê² ì§€?

void RegisterNetGUID_Server(const FNetworkGUID& NetGUID, UObject* Object)
{
    check(IsValid(Object));
    check(IsNetGUIDAuthority());			// Only the server should call this
    check(!NetGUID.IsDefault());
    check(!ObjectLookup.Contains(NetGUID));	// Server should never add twice

    // - how OuterGUID looks like for LyraPlayerController?
    //                                                                                                                                   
    //                   â”Œâ”€â”€â–ºFNetGuidCacheObject: NetworkGUID(ObjectId==9)                                                               
    //                   â”‚    â”‚                                                                                                          
    //                   â”‚    â”œâ”€â”€PathName: "/ShooterCore/Maps/UEDPIE_0_L_ShooterGym"                                                     
    //                   â”‚    â”‚                                                                                                          
    //                   â”‚    â””â”€â”€OuterGUID: ObjectId==0                                                                                  
    //                   â”‚                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                                 
    // point to UPackage â”‚                   *** invalid NetGUID and default NetGUID                                                     
    //                   â”‚                                                                                                               
    //                   â”‚   FNetGuidCacheObject: NetworkGUID(ObjectId==7)â—„â”€â”€â”                                                           
    //                   â”‚    â”‚                                              â”‚                                                           
    //                   â”‚    â”œâ”€â”€PathName: "L_ShooterGym"                    â”‚                                                           
    //                   â”‚    â”‚                                              â”‚                                                           
    //                   â”‚    â””â”€â”€OuterGUID: ObjectId==9                      â”‚                                                           
    //                   â”‚                  â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€                      â”‚                                                           
    //                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚                                                           
    //                                                                       â”‚ point to UWorld                                           
    //                   â”Œâ”€â–º FNetGuidCacheObject: NetworkGUID(ObjectId==5)   â”‚                                                           
    //                   â”‚    â”‚                                              â”‚                                                           
    //                   â”‚    â”œâ”€â”€PathName: "PersistentLevel"                 â”‚                                                           
    //                   â”‚    â”‚                                              â”‚                                                           
    //                   â”‚    â””â”€â”€OuterGUID: ObjectId==7                      â”‚                                                           
    //                   â”‚                  â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€                      â”‚                                                           
    //                   â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                           
    //   point to ULevel â”‚                                                                                                               
    //                   â”‚   FNetGuidCacheObject: NetworkGUID(ObjectId==2)                                                               
    //                   â”‚    â”‚                              â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€                                                                
    //                   â”‚    â”œâ”€â”€PathName: "LyraPlayerController_0"  â”‚                                                                   
    //                   â”‚    â”‚                                      â”‚                                                                   
    //                   â”‚    â””â”€â”€OuterGUID: ObjectId==5              â”‚                                                                   
    //                   â”‚                  â”€â”€â”€â”¬â”€â”€â”¬â”€â”€â”€â”€              â”‚                                                                   
    //                   â”‚                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º 0th bit indicates whether the object is static/dynamic: 
    //                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  - if ObjectId is odd, it means static object           
    //                                                                            - if ObjectId is even, it means dynamic object         
    //                                                                                                                                   
    FNetGuidCacheObject CacheObject;
    CacheObject.Object				= MakeWeakObjectPtr(const_cast<UObject*>(Object));
    CacheObject.OuterGUID			= GetOrAssignNetGUID(Object->GetOuter());
    CacheObject.PathName			= Object->GetFName();
    CacheObject.NetworkChecksum		= GetNetworkChecksum(Object);
    CacheObject.bNoLoad				= !CanClientLoadObject(Object, NetGUID);
    CacheObject.bIgnoreWhenMissing	= CacheObject.bNoLoad;

    RegisterNetGUID_Internal(NetGUID, CacheObject);
}
```

---

## NetGUIDì˜ Asssign

```cpp
FNetworkGUID FNetGUIDCache::GetOrAssignNetGUID(UObject* Object, const TWeakObjectPtr<UObject>* WeakObjectPtr = nullptr)
{
    const TWeakObjectPtr<UObject>& WeakObject = WeakObjectPtr ? *WeakObjectPtr : MakeWeakObjectPtr(const_cast<UObject*>(Object));

    const bool bNetGUIDAuthority = IsNetGUIDAuthority();

    FNetworkGUID NetGUID = NetGUIDLookup.FindRef(WeakObject);
    if (NetGUID.IsValid())
    {
        return NetGUID;
    }

    if (!bIsNetGUIDAuthority)
    {
        return FNetworkGUID::GetDefault();
    }

    return AssignNewNetGUID_Server(Object);
}
```