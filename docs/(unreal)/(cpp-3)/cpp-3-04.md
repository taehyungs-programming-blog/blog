---
layout: default
title: "04. GameMode"
parent: "(Unreal C++ Part3 - 3D Tank)"
grand_parent: "(Unreal ğŸš€)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* GameModeëŠ” ë­˜ ë‹´ë‹¹í• ê¹Œ?
    * Pawn Classë¥¼ ì§€ì •
    * Death, Game Start/End ê´€ë¦¬
    * ë“± ê²Œì„ì˜ ì „ë°˜ì„ ê´€ë¦¬í•œë‹¤

---

## ì¼ë‹¨ ë§Œë“¤ì–´ ë³´ì

* C++ì—ì„œ ìƒì„±

```cpp
UCLASS()
class TOONTANKS_API AToonTanksGameMode : public AGameModeBase
{
	GENERATED_BODY()
	
};
```

* ë‹¤ì‹œ Blueprintë¡œ ìƒì†

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/unreal/unreal_cpp_3/ucpp3-4-1.png"/>
</p>

* Levelì— Player Startë¥¼ í•˜ë‚˜ ì¶”ê°€í•˜ê³ 
* ê¸°ì¡´ì— ì¶”ê°€ëœ Tank BlueprintëŠ” ì‚­ì œí•œë‹¤

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/unreal/unreal_cpp_3/ucpp3-4-2.png"/>
</p>

* ì—¬ê¸°ê¹Œì§€í•˜ë©´ ìƒì„±ì€ ëë‚¬ë‹¤

---

## Death

```cpp
UCLASS()
class TOONTANKS_API AToonTanksGameMode : public AGameModeBase
{
	GENERATED_BODY()

public:

	void ActorDied(AActor* DeadActor);

protected:

	virtual void BeginPlay() override;

private:

	class ATank* Tank;

};
```

```cpp
void AToonTanksGameMode::ActorDied(AActor *DeadActor)
{
    if (DeadActor == Tank)
    {
        Tank->HandleDestruction();
        if (Tank->GetTankPlayerController())
        {
            Tank->DisableInput(Tank->GetTankPlayerController());
            Tank->GetTankPlayerController()->bShowMouseCursor = false;
        }
    }
    else if (ATower* DestroyedTower = Cast<ATower>(DeadActor))
    {
        DestroyedTower->HandleDestruction();
    }
}

void AToonTanksGameMode::BeginPlay()
{
    Super::BeginPlay();

    Tank = Cast<ATank>(UGameplayStatics::GetPlayerPawn(this, 0));
}
```

* ì£½ìŒê³¼ ê´€ë ¨ëœ ì²˜ë¦¬ëŠ” ì—­ì‹œ Healthì—ì„œ

```cpp
UCLASS(ClassGroup = (Custom), meta = (BlueprintSpawnableComponent))
class TOONTANKS_API UHealthComponent : public UActorComponent
{
	GENERATED_BODY()

    // ...

	class AToonTanksGameMode* ToonTanksGameMode;
```

```cpp
void UHealthComponent::DamageTaken(AActor *DamagedActor, float Damage, const UDamageType *DamageType, class AController *Instigator, AActor *DamageCauser)
{
	if (Damage <= 0.f) return;

	Health -= Damage;
	if (Health <= 0.f && ToonTanksGameMode)
	{
		ToonTanksGameMode->ActorDied(DamagedActor);
	}
}
```

* ê° Objectì˜ ì£½ìŒ ì²˜ë¦¬

```cpp
void ATower::HandleDestruction()
{
    Super::HandleDestruction();
    Destroy();
}
```

```cpp
void ATank::HandleDestruction()
{
    Super::HandleDestruction();
    SetActorHiddenInGame(true);
    SetActorTickEnabled(false);
}
```

---

## Custom Player Controller ë¶™ì´ê¸°

* ìš°ì„  C++ë¡œ PlayerControllerë¥¼ í•˜ë‚˜ ë§Œë“¤ì

```cpp
UCLASS()
class TOONTANKS_API AToonTanksPlayerController : public APlayerController
{
	GENERATED_BODY()
	
public:

	void SetPlayerEnabledState(bool bPlayerEnabled);
};
```

```cpp
void AToonTanksPlayerController::SetPlayerEnabledState(bool bPlayerEnabled)
{
    if (bPlayerEnabled)
    {
        GetPawn()->EnableInput(this);
    }
    else
    {
        GetPawn()->DisableInput(this);
    }
    bShowMouseCursor = bPlayerEnabled;
}
```

* GameModeì—ì„œëŠ” Blueprintë¥¼ ì‚¬ìš©í• êº¼ê¸°ì— Blueprintë„ í•˜ë‚˜ë§Œë“ ë‹¤

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/unreal/unreal_cpp_3/ucpp3-4-3.png"/>
</p>

```cpp
void AToonTanksGameMode::ActorDied(AActor *DeadActor)
{
    if (DeadActor == Tank)
    {
        Tank->HandleDestruction();
        if (ToonTanksPlayerController)
        {
            ToonTanksPlayerController->SetPlayerEnabledState(false);
        }
    }
    else if (ATower* DestroyedTower = Cast<ATower>(DeadActor))
    {
        DestroyedTower->HandleDestruction();
    }
}
```

---

## Game Start

```cpp
void AToonTanksGameMode::BeginPlay()
{
    Super::BeginPlay();
    HandleGameStart();
}

void AToonTanksGameMode::HandleGameStart()
{
    Tank = Cast<ATank>(UGameplayStatics::GetPlayerPawn(this, 0));
    ToonTanksPlayerController = Cast<AToonTanksPlayerController>(UGameplayStatics::GetPlayerController(this, 0));

    if (ToonTanksPlayerController)
    {
        ToonTanksPlayerController->SetPlayerEnabledState(false);

        // íƒ€ì´ë¨¸ë¥¼ ë‘ê³  3ì´ˆí›„ ì…ë ¥ì´ ê°€ëŠ¥í•˜ê²Œ ìˆ˜ì •
        FTimerHandle PlayerEnableTimerHandle;
        FTimerDelegate PlayerEnableTimerDelegate = FTimerDelegate::CreateUObject(
            ToonTanksPlayerController,
            &AToonTanksPlayerController::SetPlayerEnabledState,
            true
        );
        GetWorldTimerManager().SetTimer(PlayerEnableTimerHandle,
            PlayerEnableTimerDelegate,
            StartDelay,
            false
        );
    }
}
```

---

### Game Start Widgetì„ ë„ì›Œë³´ì

* 

```cpp
UCLASS()
class TOONTANKS_API AToonTanksGameMode : public AGameModeBase
{
	GENERATED_BODY()

    // ...

	UFUNCTION(BlueprintImplementableEvent)
	void StartGame();
```

```cpp
void AToonTanksGameMode::HandleGameStart()
{
    Tank = Cast<ATank>(UGameplayStatics::GetPlayerPawn(this, 0));
    ToonTanksPlayerController = Cast<AToonTanksPlayerController>(UGameplayStatics::GetPlayerController(this, 0));

    StartGame();

    // ...
```

* Widgetì€ Blueprintë¡œë§Œ ìƒì„±ê°€ëŠ¥í•˜ê¸°ì—, Blueprintìƒì„±

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/unreal/unreal_cpp_3/ucpp3-4-5.png"/>
</p>

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/unreal/unreal_cpp_3/ucpp3-4-4.png"/>
</p>

---

### ì‹œì‘ ì „ ì¹´ìš´íŠ¸ ë‹¤ìš´ ë„£ê¸°

* ìš°ì„  UserWidgetì— Graphì°½ìœ¼ë¡œ ì´ë™í•˜ì

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/unreal/unreal_cpp_3/ucpp3-4-6.png"/>
</p>

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/unreal/unreal_cpp_3/ucpp3-4-7.png"/>
</p>

---

## ìŠ¹/íŒ¨ ì¡°ê±´ ë„£ê¸°

```cpp
int32 AToonTanksGameMode::GetTargetTowerCount()
{
    TArray<AActor*> Towers;
    UGameplayStatics::GetAllActorsOfClass(this, ATower::StaticClass(), Towers);
    return Towers.Num();
}
```

```cpp
void AToonTanksGameMode::ActorDied(AActor *DeadActor)
{
    if (DeadActor == Tank)
    {
        Tank->HandleDestruction();
        if (ToonTanksPlayerController)
        {
            ToonTanksPlayerController->SetPlayerEnabledState(false);
        }
        GameOver(false);
    }
    else if (ATower* DestroyedTower = Cast<ATower>(DeadActor))
    {
        DestroyedTower->HandleDestruction();
        --TargetTowers;
        if (TargetTowers == 0)
        {
            GameOver(true);
        }
    }

    FTimerDelegate TimerDel = FTimerDelegate::CreateUObject(this, &AToonTanksGameMode::BeginPlay);
}
```