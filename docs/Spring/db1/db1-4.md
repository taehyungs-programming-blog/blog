---
layout: default
title: "04. íŠ¸ëœì­ì…˜ì˜ ë³µì¡ì„±ì„ Springìœ¼ë¡œ í•´ê²°"
parent: "(DB1)"
grand_parent: "Spring ğŸ"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## ê¸°ì¡´ ì½”ë“œì˜ ë¬¸ì œ

```java
@Slf4j
@RequiredArgsConstructor
public class MemberServiceV2 {

    private final DataSource dataSource;
    private final MemberRepositoryV2 memberRepository;

    public void accountTransfer(String fromId, String toId, int money) throws SQLException {
        // Q1. ë¹„ì§€ë‹ˆìŠ¤ ë¡œì§ì¸ accountTransferì—ì„œ dbë¥¼ ì§ì ‘ ê°€ì ¸ë‹¤ ì“´ë‹¤.
        // ë§Œì•½ jdbcì—ì„œ ìƒˆë¡œë‚˜ì˜¨ dbë¡œ ë°”ê¾¸ë ¤í•œë‹¤ë©´? ë¹„ì§€ë‹ˆìŠ¤ ë¡œì§ì„ ë‹¤ ë°”ê¿”ì•¼ í• ê¹Œ?
        Connection con = dataSource.getConnection();
        try {
            con.setAutoCommit(false);//íŠ¸ëœì­ì…˜ ì‹œì‘
            //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
            bizLogic(con, fromId, toId, money);

            // Q2. commit, rollbackì€ í•­ìƒ ë°˜ë³µë í…ë° ì´ê±¸ ë§¤ë²ˆ ë„£ì–´ì•¼ í• ê¹Œ?
            con.commit();
        } catch (Exception e) {
            con.rollback();
            throw new IllegalStateException(e);
        } finally {
            release(con);
        }

    }

    private void bizLogic(Connection con, String fromId, String toId, int money) throws SQLException {
        Member fromMember = memberRepository.findById(con, fromId);
        Member toMember = memberRepository.findById(con, toId);

        memberRepository.update(con, fromId, fromMember.getMoney() - money);
        validation(toMember);
        memberRepository.update(con, toId, toMember.getMoney() + money);
    }

    // ...
```

---

## íŠ¸ëœì­ì…˜ì„ ì¶”ìƒí™” í•˜ì—¬ ì²˜ë¦¬í•´ë³´ì

```java
class MemberServiceV3_1Test {

    public static final String MEMBER_A = "memberA";
    public static final String MEMBER_B = "memberB";
    public static final String MEMBER_EX = "ex";

    private MemberRepositoryV3 memberRepository;
    private MemberServiceV3_1 memberService;

    @BeforeEach
    void before() {
        // dataSourceë¥¼ ìƒì„±
        DriverManagerDataSource dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);
        memberRepository = new MemberRepositoryV3(dataSource);
        PlatformTransactionManager transactionManager = new DataSourceTransactionManager(dataSource);
        memberService = new MemberServiceV3_1(transactionManager, memberRepository);
    }
```

```java
@Slf4j
public class MemberRepositoryV3 {

    private final DataSource dataSource;

    // ë°ì´í„° ì†ŒìŠ¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ Repository í´ë˜ìŠ¤ ìƒì„±
    public MemberRepositoryV3(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    // ...

    // DataSourceUtilsë¼ëŠ” Objectë¡œ commit, releaseë¥¼ í•¨ì„ ì£¼ëª©.

    private void close(Connection con, Statement stmt, ResultSet rs) {
        JdbcUtils.closeResultSet(rs);
        JdbcUtils.closeStatement(stmt);
        //ì£¼ì˜! íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ DataSourceUtilsë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
        DataSourceUtils.releaseConnection(con, dataSource);
    }


    private Connection getConnection() throws SQLException {
        //ì£¼ì˜! íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ DataSourceUtilsë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
        Connection con = DataSourceUtils.getConnection(dataSource);
        log.info("get connection={}, class={}", con, con.getClass());
        return con;
    }

}
```

```java
@Slf4j
@RequiredArgsConstructor
public class MemberServiceV3_1 {

    private final PlatformTransactionManager transactionManager;
    private final MemberRepositoryV3 memberRepository;

    public void accountTransfer(String fromId, String toId, int money) throws SQLException {
        //íŠ¸ëœì­ì…˜ ì‹œì‘
        TransactionStatus status = transactionManager.getTransaction(new DefaultTransactionDefinition());

        try {
            //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
            bizLogic(fromId, toId, money);
            transactionManager.commit(status); //ì„±ê³µì‹œ ì»¤ë°‹
        } catch (Exception e) {
            transactionManager.rollback(status); //ì‹¤íŒ¨ì‹œ ë¡¤ë°±
            throw new IllegalStateException(e);
        }

    }
```

---

## try ~ catch ë°˜ë³µë˜ëŠ” íŒ¨í„´ì„ ì œê±°í•˜ì

```java
// ê¸°ì¡´ì½”ë“œ

public void accountTransfer(String fromId, String toId, int money) throws SQLException {
    //íŠ¸ëœì­ì…˜ ì‹œì‘
    TransactionStatus status = transactionManager.getTransaction(new DefaultTransactionDefinition());

    try {
        //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
        bizLogic(fromId, toId, money);
        transactionManager.commit(status); //ì„±ê³µì‹œ ì»¤ë°‹
    } catch (Exception e) {
        transactionManager.rollback(status); //ì‹¤íŒ¨ì‹œ ë¡¤ë°±
        throw new IllegalStateException(e);
    }

}
```

```java
// ìˆ˜ì •ëœ ì½”ë“œ

public void accountTransfer(String fromId, String toId, int money) throws SQLException {
    // ë‚´ë¶€ì ìœ¼ë¡œ ì˜ ì²˜ë¦¬ë˜ë©´ commit
    // ì˜ˆì™¸ê°€ í„°ì§€ë©´ rollback
    txTemplate.executeWithoutResult((status) -> {
        //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
        try {
            bizLogic(fromId, toId, money);
        } catch (SQLException e) {
            throw new IllegalStateException(e);
        }
    });
}
```

---

## ì•„ë‹ˆ ê·¸ëŸ°ë°??? ë¹„ì§€ë‹ˆìŠ¤ë¡œì§ì— íŠ¸ëœì­ì…˜ì„ ë¹¼ìë©´ì„œ ì˜¤íˆë ¤ ë„£ëŠ”ë‹¤ê³ ?? ì´ê²Œ ë§ë‚˜?

```java
package hello.jdbc.service;

import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepositoryV3;
import lombok.extern.slf4j.Slf4j;
import org.springframework.transaction.annotation.Transactional;

import java.sql.SQLException;

/**
 * íŠ¸ëœì­ì…˜ - @Transactional AOP
 */
@Slf4j
public class MemberServiceV3_3 {

    private final MemberRepositoryV3 memberRepository;

    public MemberServiceV3_3(MemberRepositoryV3 memberRepository) {
        this.memberRepository = memberRepository;
    }

    // ì—¬ê¸° ë“¤ì–´ì˜¬ë•Œ transactionì„ ê±¸ê² ë‹¤ëŠ” ë§.
    // ì„±ê³µì‹œ Commit, ì‹¤íŒ¨ì‹œ rollback
    @Transactional
    public void accountTransfer(String fromId, String toId, int money) throws SQLException {
        bizLogic(fromId, toId, money);
    }

    private void bizLogic(String fromId, String toId, int money) throws SQLException {
        Member fromMember = memberRepository.findById(fromId);
        Member toMember = memberRepository.findById(toId);

        memberRepository.update(fromId, fromMember.getMoney() - money);
        validation(toMember);
        memberRepository.update(toId, toMember.getMoney() + money);
    }

    private void validation(Member toMember) {
        if (toMember.getMemberId().equals("ex")) {
            throw new IllegalStateException("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ");
        }
    }

}
```

```java
@Slf4j
// Spring AOPë¥¼ ì‚¬ìš©í•˜ë ¤ë©´
// ëª¨ë‘ Spring beanìœ¼ë¡œ ë“±ë¡í•´ì•¼ í•œë‹¤.
@SpringBootTest
class MemberServiceV3_4Test {

    public static final String MEMBER_A = "memberA";
    public static final String MEMBER_B = "memberB";
    public static final String MEMBER_EX = "ex";

    @Autowired
    private MemberRepositoryV3 memberRepository;
    @Autowired
    private MemberServiceV3_3 memberService;
```