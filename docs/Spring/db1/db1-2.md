---
layout: default
title: "02. Connection Pool"
parent: "(DB1)"
grand_parent: "Spring ðŸ"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## Connection Poolì˜ í•„ìš”ì„±

* ë§¤ë²ˆ ì»¤ë„¥ì…˜ì„ ìƒˆë¡œ ë§Œë“œëŠ” ê²ƒì€ ê³¼ì •ë„ ë³µìž¡í•˜ê³  ì‹œê°„ë„ ë§Žì´ ë§Žì´ ì†Œëª¨ë˜ëŠ” ì¼ì´ë‹¤. 
* DBëŠ” ë¬¼ë¡ ì´ê³  ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„ì—ì„œë„ TCP/IP ì»¤ë„¥ì…˜ì„ ìƒˆë¡œ ìƒì„±í•˜ê¸° ìœ„í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ë§¤ë²ˆ ì‚¬ìš©í•´ì•¼ í•œë‹¤. 
* ì§„ì§œ ë¬¸ì œëŠ” ê³ ê°ì´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‚¬ìš©í•  ë•Œ, SQLì„ ì‹¤í–‰í•˜ëŠ” ì‹œê°„ ë¿ë§Œ ì•„ë‹ˆë¼ ì»¤ë„¥ì…˜ì„ * ìƒˆë¡œ ë§Œë“œëŠ” ì‹œê°„ì´ ì¶”ê°€ë˜ê¸° ë•Œë¬¸ì— ê²°ê³¼ì ìœ¼ë¡œ ì‘ë‹µ ì†ë„ì— ì˜í–¥ì„ ì¤€ë‹¤. 
* ì´ê²ƒì€ ì‚¬ìš©ìžì—ê²Œ ì¢‹ì§€ ì•Šì€ ê²½í—˜ì„ ì¤„ ìˆ˜ ìžˆë‹¤

* ì´ëŸ° ë¬¸ì œë¥¼ í•œë²ˆì— í•´ê²°í•˜ëŠ” ì•„ì´ë””ì–´ê°€ ë°”ë¡œ ì»¤ë„¥ì…˜ì„ ë¯¸ë¦¬ ìƒì„±í•´ë‘ê³  ì‚¬ìš©í•˜ëŠ” ì»¤ë„¥ì…˜ í’€ì´ë¼ëŠ” ë°©ë²•ì´ë‹¤. 
* ì»¤ë„¥ì…˜ í’€ì€ ì´ë¦„ ê·¸ëŒ€ë¡œ ì»¤ë„¥ì…˜ì„ ê´€ë¦¬í•˜ëŠ” í’€(ìˆ˜ì˜ìž¥ í’€ì„ ìƒìƒí•˜ë©´ ëœë‹¤.)ì´ë‹¤.

* ëŒ€í‘œì ì¸ ì»¤ë„¥ì…˜ í’€ ì˜¤í”ˆì†ŒìŠ¤ëŠ” commons-dbcp2 , tomcat-jdbc pool , HikariCP ë“±ì´ ìžˆë‹¤. 
* ì„±ëŠ¥ê³¼ ì‚¬ìš©ì˜ íŽ¸ë¦¬í•¨ ì¸¡ë©´ì—ì„œ ìµœê·¼ì—ëŠ” hikariCP ë¥¼ ì£¼ë¡œ ì‚¬ìš©í•œë‹¤. 
* ìŠ¤í”„ë§ ë¶€íŠ¸ 2.0 ë¶€í„°ëŠ” ê¸°ë³¸ ì»¤ë„¥ì…˜ í’€ë¡œ hikariCP ë¥¼ ì œê³µí•œë‹¤. ì„±ëŠ¥, ì‚¬ìš©ì˜ íŽ¸ë¦¬í•¨, ì•ˆì „ì„± ì¸¡ë©´ì—ì„œ ì´ë¯¸ ê²€ì¦ì´ ë˜ì—ˆê¸° ë•Œë¬¸ì— ì»¤ë„¥ì…˜ í’€ì„ ì‚¬ìš©í•  ë•ŒëŠ” ê³ ë¯¼í•  ê²ƒ ì—†ì´ hikariCP ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤. 
* ì‹¤ë¬´ì—ì„œë„ ë ˆê±°ì‹œ í”„ë¡œì íŠ¸ê°€ ì•„ë‹Œ ì´ìƒ ëŒ€ë¶€ë¶„ hikariCP ë¥¼ ì‚¬ìš©í•œë‹¤.

---

## Example

```java

@Slf4j
public class ConnectionTest {

    // ê¸°ë³¸ - DriverManager ì‚¬ìš©(ì»¤ë„¥ì…˜ í’€ì„ ì‚¬ìš©í•˜ì§„ ì•ŠìŒ)
    @Test
    void driverManager() throws SQLException {
        Connection con1 = DriverManager.getConnection(URL, USERNAME, PASSWORD);
        Connection con2 = DriverManager.getConnection(URL, USERNAME, PASSWORD);
        log.info("connection={}, class={}", con1, con1.getClass());
        log.info("connection={}, class={}", con2, con2.getClass());
    }

    // ê¸°ë³¸2 - DriverManagerDataSource ì‚¬ìš©(ì—­ì‹œ ì»¤ë„¥ì…˜ í’€ì„ ì‚¬ìš©í•˜ì§„ ì•ŠìŒ)
    @Test
    void dataSourceDriverManager() throws SQLException {
        //DriverManagerDataSource - í•­ìƒ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì„ íšë“
        DriverManagerDataSource dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);
        useDataSource(dataSource);
    }

    private void useDataSource(DataSource dataSource) throws SQLException { 
        Connection con1 = dataSource.getConnection(); 
        Connection con2 = dataSource.getConnection(); 
        log.info("connection={}, class={}", con1, con1.getClass()); 
        log.info("connection={}, class={}", con2, con2.getClass()); 
    }



    // ì»¤ë„¥ì…˜ í’€ ì‚¬ìš©
    @Test
    void dataSourceConnectionPool() throws SQLException, InterruptedException {
        //ì»¤ë„¥ì…˜ í’€ë§
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setJdbcUrl(URL);
        dataSource.setUsername(USERNAME);
        dataSource.setPassword(PASSWORD);
        dataSource.setMaximumPoolSize(10);
        dataSource.setPoolName("MyPool");

        useDataSource(dataSource);
        Thread.sleep(1000);
    }
}
```

---

## Connection Poolì„ ì´ìš©í•œ CRUD

```java
/**
 * JDBC - DataSource ì‚¬ìš©, JdbcUtils ì‚¬ìš©
 */
@Slf4j
public class MemberRepositoryV1 {

    private final DataSource dataSource;

    public MemberRepositoryV1(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    public Member save(Member member) throws SQLException {
        String sql = "insert into member(member_id, money) values (?, ?)";

        Connection con = null;
        PreparedStatement pstmt = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1, member.getMemberId());
            pstmt.setInt(2, member.getMoney());
            pstmt.executeUpdate();
            return member;
        } catch (SQLException e) {
            log.error("db error", e);
            throw e;
        } finally {
            close(con, pstmt, null);
        }

    }

    public Member findById(String memberId) throws SQLException {
        String sql = "select * from member where member_id = ?";

        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1, memberId);

            rs = pstmt.executeQuery();
            if (rs.next()) {
                Member member = new Member();
                member.setMemberId(rs.getString("member_id"));
                member.setMoney(rs.getInt("money"));
                return member;
            } else {
                throw new NoSuchElementException("member not found memberId=" + memberId);
            }

        } catch (SQLException e) {
            log.error("db error", e);
            throw e;
        } finally {
            close(con, pstmt, rs);
        }

    }


    public void update(String memberId, int money) throws SQLException {
        String sql = "update member set money=? where member_id=?";

        Connection con = null;
        PreparedStatement pstmt = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setInt(1, money);
            pstmt.setString(2, memberId);
            int resultSize = pstmt.executeUpdate();
            log.info("resultSize={}", resultSize);
        } catch (SQLException e) {
            log.error("db error", e);
            throw e;
        } finally {
            close(con, pstmt, null);
        }

    }


    public void delete(String memberId) throws SQLException {
        String sql = "delete from member where member_id=?";

        Connection con = null;
        PreparedStatement pstmt = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1, memberId);
            pstmt.executeUpdate();
        } catch (SQLException e) {
            log.error("db error", e);
            throw e;
        } finally {
            close(con, pstmt, null);
        }

    }

    private void close(Connection con, Statement stmt, ResultSet rs) {
        JdbcUtils.closeResultSet(rs);
        JdbcUtils.closeStatement(stmt);
        JdbcUtils.closeConnection(con);
    }


    private Connection getConnection() throws SQLException {
        Connection con = dataSource.getConnection();
        log.info("get connection={}, class={}", con, con.getClass());
        return con;
    }


}
```

* Test

```java
@Slf4j
class MemberRepositoryV1Test {

    MemberRepositoryV1 repository;

    @BeforeEach
    void beforeEach() {
        //ê¸°ë³¸ DriverManager - í•­ìƒ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì„ íšë“
//        DriverManagerDataSource dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);

        //ì»¤ë„¥ì…˜ í’€ë§
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setJdbcUrl(URL);
        dataSource.setUsername(USERNAME);
        dataSource.setPoolName(PASSWORD);
        repository = new MemberRepositoryV1(dataSource);
    }

    @Test
    void crud() throws SQLException {
        //save
        Member member = new Member("memberV100", 10000);
        repository.save(member);

        //findById
        Member findMember = repository.findById(member.getMemberId());
        log.info("findMember={}", findMember);
        assertThat(findMember).isEqualTo(member);

        //update: money: 10000 -> 20000
        repository.update(member.getMemberId(), 20000);
        Member updatedMember = repository.findById(member.getMemberId());
        assertThat(updatedMember.getMoney()).isEqualTo(20000);

        //delete
        repository.delete(member.getMemberId());
        assertThatThrownBy(() -> repository.findById(member.getMemberId()))
                .isInstanceOf(NoSuchElementException.class);

        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
```