---
layout: default
title: "10. TLS(Thread Local Storage)"
parent: (IOCP)
grand_parent: C++
nav_order: 2
---

* Threadë§ˆë‹¤ ê°ìì˜ ìŠ¤íƒì˜ì—­ì´ ì¡´ì¬í•˜ë©°
* Heap(new), ë°ì´í„°(static)ì€ ê³µìœ í•´ì„œ ì“´ë‹¤.
* í•˜ì§€ë§Œ ì—¬ê¸°ì„œ ë¹ ì§„ ì˜ì—­ì´ í•˜ë‚˜ìˆëŠ”ë° ê·¸ ì˜ì—­ì´ Thread Local Storage(TLS)ì´ë‹¤.

<Br>

* TLSëŠ” ì–´ë– í•œ ê²½ìš°ì— ì“¸ê¹Œ?
* Heap, ë°ì´í„° ì˜ì—­ì— ë°ì´í„°ë¥¼ í•­ìƒ ì½ì–´ì“°ê¸°ì—ëŠ” ê²½í•©ì´ ìì£¼ë°œìƒí•´ ì†ë„ê°€ ëŠë¦´ìˆ˜ ìˆë‹¤.
* TLSì— Heap, ë°ì´í„° ì˜ì—­ì˜ ë°ì´í„°ë¥¼ ë¯¸ë¦¬ ë³µì‚¬í•´ ë†“ê³  ì‚¬ìš©í•˜ê²Œ ëœë‹¤.

<Br>

* ê·¸ëŸ¼ ìŠ¤íƒê³¼ ë¬´ìŠ¨ì°¨ì´ì¸ê°€?
* ìŠ¤íƒì€ í•¨ìˆ˜ë‚´ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë¶ˆì•ˆì •ì ì¸ ë°ì´í„°ì´ë‹¤.
* í•œ Threadì—ì„œ ì‚¬ìš©í•  ë°ì´í„°ì˜ ì €ì¥ì€ TLSì— ì €ì¥í•´ ë‘ëŠ”ê²ƒì´ ë§ë‹¤

```cpp
// __declspec(thread) int32 value;  // ì´ì „ë°©ì‹
thread_local int32 LThreadId = 0;   // TLS ì„ ì–¸

void ThreadMain(int32 threadId)
{
    LThreadId = threadId;
    while(true)
    {
        cout << "Hi I am Thread " << LThreadId << endl;
        this_thread::sleep_for(1s);
    }
}

int main()
{
    vector<thread> threads;
    for(int32 i = 0; i < 10; i++)
    {
        int32 threadId = i + 1;
        threads.push_back(thread(ThreadMain, threadId));
    }
    for(thread& t : threads)
        t.join();
}
```

<br>

---

ğŸ˜º ì¡°ê¸ˆë” ì˜ˆì œë¥¼ ì›í• ê²½ìš°? [ì˜ˆì „ ì •ë¦¬ìë£Œ ğŸŒ](https://easycoding-7.github.io/blog/cpp/concurrency-new/9/#/)

```cpp
#include <iostream>
#include <thread>
#include <string_view>

int next3times()
{
    // ì‹±ê¸€ìŠ¤ë ˆë“œì¼ë•ŒëŠ” ì •ìƒì ìœ¼ë¡œ ë™ì‘
    static int n = 0;
    n = n + 3;
    return n;
}

void foo(std::string_view name)
{
    std::cout << name << " : " << next3times() << std::endl;
    std::cout << name << " : " << next3times() << std::endl;
    std::cout << name << " : " << next3times() << std::endl;
}

int main()
{
    foo("A");
    // ë§Œì•½ ë©€í‹°ìŠ¤ë ˆë“œí™˜ê²½ì´ë¼ë©´?
    std::thread t1(foo, "A");
    std::thread t2(foo, "\tB");
    t1.join();
    t2.join();
    // ê²°ê³¼ë¶€í„° ë§í•˜ë©´ 3 6 9 12 15 18 ì´ë‚˜ì˜¤ê²Œëœë‹¤.
    // ë§Œì•½ ìŠ¤ë ˆë“œë³„ë¡œ 3 6 9 ë¥¼ ì¶œë ¥í•˜ê³  ì‹¶ë‹¤ë©´?
    // ê°ê° ìŠ¤ë ˆë“œë³„ë¡œ ë³€ìˆ˜ë¥¼ ê°–ê³ ì‹¶ë‹¤(TLS : Thread Local Storage) : ìŠ¤ë ˆë“œë³„ë¡œ ìŠ¤íƒì„ ë§Œë“¤ì–´ì¤˜
}
```

* ì˜ˆì „ì—ëŠ” ì´ë ‡ê²Œ TLSë¥¼ ì‚¬ìš©í–ˆë‹¤.
    * linux(gcc) : `_thread static int x`
    * windows(cl) : `__declspec(thread)`
    * C++í‘œì¤€ì´ ë‚˜ì˜¤ê³  ë¶€í„° : `thread_local`
    
```cpp
int next3times()
{
    thread_local int n = 0;
    // thread_local static int n = 0;
    // staticì´ ì•”ì‹œì ìœ¼ë¡œ ì„ ì–¸ì´ ë˜ê¸°ì— ìƒëµí•´ë„ ëœë‹¤.
    n = n + 3;
    return n;
}
```