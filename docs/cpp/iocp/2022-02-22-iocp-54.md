---
layout: default
title: "54. JobQueue-4"
parent: (IOCP)
grand_parent: C++
nav_order: 6
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

ğŸ±â€ğŸ‘¤ ì•„ì§ ëª¨ë“  ë¬¸ì œê°€ í•´ê²°ëœ ê²ƒì€ ì•„ë‹ˆë‹¤

```cpp
// Jobì„ Flushí• ë•Œ ë©”ì¸ Threadì—ì„œ í•˜ê³ ìˆëŠ”ë°
    // ì—¬ëŸ¬ Thread í˜¹ì€ ì—¬ëŸ¬ ê°ì²´ì—ì„œ ë³„ë„ë¡œ Jobì„ ì²˜ë¦¬í•´ì•¼ í• ë•Œê°€ ìˆë‹¤.
while (true)
{
    GRoom->FlushJob();
    this_thread::sleep_for(1ms);
}
```

---

ğŸ±â€ğŸ‘¤ êµ¬í˜„ì€ ì‰½ê¸°ì— ë³„ë„ì˜ ì„¤ëª…ì€ ìƒëµ

```cpp
void JobQueue::Push(JobRef&& job)
{
	const int32 prevCount = _jobCount.fetch_add(1);
	_jobs.Push(job); // WRITE_LOCK

	// ì²«ë²ˆì§¸ Jobì„ ë„£ì€ ì“°ë ˆë“œê°€ ì‹¤í–‰ê¹Œì§€ ë‹´ë‹¹
	if (prevCount == 0)
	{
		Execute();
	}
}

// 1) ì¼ê°ì´ ë„ˆ~ë¬´ ëª°ë¦¬ë©´?
// 2) DoAsync íƒ€ê³  íƒ€ê³  ê°€ì„œ~ ì ˆëŒ€ ëë‚˜ì§€ ì•ŠëŠ” ìƒí™© (ì¼ê°ì´ í•œ ì“°ë ˆë“œí•œí…Œ ëª°ë¦¼)
void JobQueue::Execute()
{
	while (true)
	{
		Vector<JobRef> jobs;
		_jobs.PopAll(OUT jobs);

		const int32 jobCount = static_cast<int32>(jobs.size());
		for (int32 i = 0; i < jobCount; i++)
			jobs[i]->Execute();

		// ë‚¨ì€ ì¼ê°ì´ 0ê°œë¼ë©´ ì¢…ë£Œ
		if (_jobCount.fetch_sub(jobCount) == jobCount)
		{
			return;
		}
	}
}
```

```cpp
bool Handle_C_CHAT(PacketSessionRef& session, Protocol::C_CHAT& pkt)
{
	std::cout << pkt.msg() << endl;

	Protocol::S_CHAT chatPkt;
	chatPkt.set_msg(pkt.msg());
	auto sendBuffer = ClientPacketHandler::MakeSendBuffer(chatPkt);

	GRoom->DoAsync(&Room::Broadcast, sendBuffer);

	return true;
}
```