---
layout: default
title: "18. ë©”ëª¨ë¦¬ Allocator"
parent: (IOCP)
grand_parent: C++
nav_order: 2
---

ğŸ˜º ë©”ëª¨ë¦¬ë¥¼ ë‹¨ìˆœ new, deleteë¡œ ê´€ë¦¬í•˜ì§€ë§ê³  ë¯¸ë¦¬ Allocateí•´ë‘” í›„ ê´€ë¦¬í•´ ë³´ì.

* ì™œ ê·¸ë ‡ê²Œ í•´ì•¼í• ê¹Œ?
    * ìš°ì„  Windowsê¸°ë°˜ì—ì„œëŠ” ë©”ëª¨ë¦¬ê´€ë¦¬ë¥¼ OSì—ì„œ í•´ì¤€ë‹¤.
    * í• ë‹¹í•´ì•¼í•  ë©”ëª¨ë¦¬ê°€ ë§ì•„ì§„ë‹¤ë©´ OSì˜ ì»¤ë„ì˜ì—­ì—ì„œ ìƒˆë¡œìš´ ë©”ëª¨ë¦¬ í• ë‹¹ì„ í•˜ë©° ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ë¹„ìš©ì´ ë°œìƒí•˜ëŠ”ë° ê·¸ ë¹„ìš©ì„ ê°ì†Œì‹œí‚¤ê¸° ìœ„í•¨ì´ ìˆê³ 
    * ë˜í•œ ë©”ëª¨ë¦¬ íŒŒí¸í™” í˜„ìƒì„ ë°©ì§€í•˜ëŠ”ë° ë‚´ê°€ ë©”ëª¨ë¦¬ë¥¼ Allocateí•´ì„œ ê´€ë¦¬í•˜ë©´ ì¢‹ê¸° ë•Œë¬¸ì´ë‹¤.

* ìš°ì„  ì´ë²ˆê°•ì—ì„œëŠ” ìœ„ ë¬¸ì œë¥¼ í•´ê²°í•œìˆœ ì—†ë‹¤. ë‹¨, new, deleteë¥¼ ì´ë ‡ê²Œ ê°œë°œìê°€ ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥í•˜ë‹¤ëŠ” ê²ƒì„ ì´í•´í•˜ì

ğŸ˜º ê·¸ëŸ¼ êµ¬í˜„ì„ í•´ë³´ì.

```cpp
// new, deleteë¥¼ ì–´ë–»ê²Œ ì»¤ìŠ¤í„°ë§ˆì´ì§• í• ê¹Œ

// new operator overloading (Global)
void* operator new(size_t size)
{
	cout << "new! " << size << endl;
	void* ptr = ::malloc(size);
	return ptr;
}

void operator delete(void* ptr)
{
	cout << "delete!" << endl;
	::free(ptr);
}

void* operator new[](size_t size)
{
	cout << "new[]! " << size << endl;
	void* ptr = ::malloc(size);
	return ptr;
}

void operator delete[](void* ptr)
{
	cout << "delete![]" << endl;
	::free(ptr);
}

// ìƒê°ë³´ë‹¤ ê°„ë‹¨...
// ë‹¨, ì´ë ‡ê²Œ ì „ì—­ìœ¼ë¡œ êµ¬í˜„í•˜ë©´ ì˜ë„ì¹˜ ì•Šì€ newì™€ deleteì—ë„ ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆë‹¤.
```

<br>

ğŸ˜º ê·¸ëŸ¼ classë‚´ì—ì„œ ë§Œë“¤ì–´ì•¼ í• ê¹Œ?

```cpp
class Knight
{
public:
	Knight()
	{
		cout << "Knight()" << endl;
	}

	Knight(int32 hp) : _hp(hp)
	{
		cout << "Knight(hp)" << endl;
	}

	~Knight()
	{
		cout << "~Knight()" << endl;
	}

    // ì´ë ‡ê²Œ ê°ì²´ì•ˆì— ë„£ì–´ì„œë„ êµ¬í˜„ê°€ëŠ¥
	static void* operator new(size_t size)
	{
		cout << "Knight new! " << size << endl;
		void* ptr = ::malloc(size);
		return ptr;
	}

	static void operator delete(void* ptr)
	{
		cout << "Knight delete!" << endl;
		::free(ptr);
	}

	int32 _hp = 100;
	int32 _mp = 10;
};
```

<br>

ğŸ™€ ëª¨ë“  í´ë˜ìŠ¤ì— ë„£ëŠ”ê±´ ì¢€...

```cpp
// ìƒˆë¡œìš´ new, deleteë¥¼ ë§Œë“¤ì–´ ë³´ì

#ifdef _DEBUG
#define xalloc(size)		BaseAllocator::Alloc(size)
#define xrelease(ptr)		BaseAllocator::Release(ptr)
#else
#define xalloc(size)		BaseAllocator::Alloc(size)
#define xrelease(ptr)		BaseAllocator::Release(ptr)
#endif
```

```cpp
void* BaseAllocator::Alloc(int32 size)
{
	return ::malloc(size);
}

void BaseAllocator::Release(void* ptr)
{
	::free(ptr);
}
```

```cpp
#pragma once
#include "Allocator.h"

template<typename Type, typename... Args>
Type* xnew(Args&&... args)
{
	Type* memory = static_cast<Type*>(xalloc(sizeof(Type)));
	new(memory)Type(forward<Args>(args)...); // placement new - ì—¬ê¸°ê°€ í—·ê°ˆë¦°ë‹¤(ì§€ì—° ìƒì„±)
    // new(memory) : ë©”ëª¨ë¦¬ëŠ” ì´ë¯¸í• ë‹¹ë˜ì–´ ìˆìœ¼ë‹ˆ í• ë‹¹í•˜ì§€ë§ê³ 
    // Type(forward<Args>(args)...) : ìš”ë ‡ê²Œ ìƒì„±ìë§Œ í˜¸ì¶œí•´ ì¤˜
	return memory;
}

template<typename Type>
void xdelete(Type* obj)
{
	obj->~Type();
	xrelease(obj);
}
```

* ì°¸ê³ ë¡œ placement newë¥¼ êµ³ì´ í•˜ëŠ” ì´ìœ ëŠ” malloc/freeì€ ìƒì„±ì/ì†Œë©¸ìì˜ í˜¸ì¶œì´ ì—†ë‹¤([ì°¸ê³ ì‚¬ì´íŠ¸ ğŸŒ](https://rieulpost.tistory.com/52))

<br>

ğŸ˜º ì‹¤ì‚¬ìš©ì€ ì´ë ‡ê²Œ

```cpp
int main()
{	
	Knight* knight = xnew<Knight>(100);

	xdelete(knight);
}
```