---
layout: default
title: "12. Lock-Free Stack êµ¬í˜„ - 1"
parent: (IOCP)
grand_parent: C++
nav_order: 2
---

ğŸ™€ êµ¬í˜„ì„ ë‘ ë²ˆì— ë‚˜ëˆ ì„œ í•œë‹¤. ì²« êµ¬í˜„ ì´í›„ í•„ìš”ì„±ì„ ì„¤ëª…í•˜ê³  ì¶”ê°€í•˜ëŠ” ë°©í–¥ì´ ì´í•´í•˜ê¸°ê°€ ì‰¬ì›€!

```cpp
template<typename T>
class LockFreeStack
{
	struct Node
	{
		Node(const T& value) : data(value)
		{

		}

		T data;
		Node* next;
	};

public:
	
	/*
		ì´ë ‡ê²Œ í•  ì˜ˆì •
		(Push)
		node->nextì— ê¸°ì¡´ì˜ nodeì •ë³´ë¥¼ ë„£ê³ 
		headì— ìƒˆë¡œ ìƒì„±í•œ nodeë¥¼ ë„£ì„ì˜ˆì •

		(Pop)
		headì˜ nodeë¥¼ ê°€ì ¸ì˜¤ê³ 
		head->nextë¥¼ ë‹¤ì‹œ headë¡œ ì—°ê²°
	*/

	// 1) ìƒˆ ë…¸ë“œë¥¼ ë§Œë“¤ê³ 
	// 2) ìƒˆ ë…¸ë“œì˜ next = head
	// 3) head = ìƒˆ ë…¸ë“œ

	// [ ][ ][ ][ ][ ][ ][ ]
	// [head]
	void Push(const T& value)
	{
		Node* node = new Node(value);
		node->next = _head;
        // atomic<Node*> _head;

        // _headì— ìƒˆë¡œì¶”ê°€ëœ nodeì˜ ì£¼ì†Œë¥¼ ë„£ê³ ì‹¶ë‹¤
        // ë‹¨, _headëŠ” ë©€í‹° ì“°ë ˆë“œì— ì˜í•´ ìœ„í—˜ì„±ì´ ì¡´ì¬

		/*
        * compare_exchange_weakì˜ ë™ì‘, ì•„ë˜ë™ì‘ì„ atomicí•˜ê²Œ ì²˜ë¦¬í•´ì¤€ë‹¤.

		if (_head == node->next)
		{
            // ì •ìƒì ì´ë¼ë©´ ì—¬ê¸°ì— ë“¤ì–´ì™€ì•¼í•¨
            // ìœ„ì—ì„œ node->next = _head; í•´ì¤¬ê¸° ë•Œë¬¸
			_head = node;
			return true;
		}
		else
		{
            // ë‹¤ë¥¸ ì“°ë ˆë“œì— ì˜í•´ _headê°€ ë³€ê²½ë˜ì—ˆë‹¤ë©´ ì—¬ê¸°ë¡œ ì˜¤ê²Œëœë‹¤.
			node->next = _head;
			return false;
		}
		*/

		// (ì£¼ì˜) ë§ì€ ì“°ë ˆë“œê°€ ì—¬ê¸°ì— ëª°ë¦¬ë©°, ì—¬ê¸°ì„œ ê²½í•©ì´ ë„ˆë¬´ ì‹¬í•´ì„œ ë¼ì´ë¸Œ ë½ì´ ë°œìƒí•  ìˆ˜ ìˆìŒ
		while (_head.compare_exchange_weak(node->next, node) == false)
		{
            /*
                _headì—ëŠ” ìƒˆë¡œìƒì„±ëœ nodeì˜ ì£¼ì†Œê°€
                node->nextì—ëŠ” ì´ì „ nodeì˜ ì£¼ì†Œê°€ ë“¤ì–´ê°„ë‹¤(<-ì´ë¦„ë•Œë¬¸ì— ì´ê²Œ í—·ê°ˆë¦¼)
            */
			//node->next = _head;
		}

		// ì´ ì‚¬ì´ì— ìƒˆì¹˜ê¸° ë‹¹í•˜ë©´?
		//_head = node;
	}
	
	// 1) head ì½ê¸°
	// 2) head->next ì½ê¸°
	// 3) head = head->next
	// 4) data ì¶”ì¶œí•´ì„œ ë°˜í™˜
	// 5) ì¶”ì¶œí•œ ë…¸ë“œë¥¼ ì‚­ì œ

	// [ ][ ][ ][ ][ ][ ]
	// [head]
	bool TryPop(T& value)
	{
		Node* oldHead = _head;

		/*
		if (_head == oldHead)
		{
			_head = oldHead->next;
			return true;
		}
		else
		{
			oldHead = _head;
			return false;
		}
		*/

		while (oldHead && _head.compare_exchange_weak(oldHead, oldHead->next) == false)
		{
            /*
                ì—¬ê¸°ë„ ë§ë¡œ ì„¤ëª…í•˜ìë©´
                oldHeadì—ëŠ” Popí•  nodeì£¼ì†Œë¥¼ ë„£ê³ 
                oldHead->nextì—ëŠ” ì´ì „ ë…¸ë“œ ì£¼ì†Œê°€ ë“¤ì–´ê°„ë‹¤
            */
			//oldHead = _head;
		}

		if (oldHead == nullptr)
			return false;

		// Exception X
		value = oldHead->data;

		// ì ì‹œ ì‚­ì œ ë³´ë¥˜
		//delete oldHead;
        // ì§€ìš°ëŠ”ê²Œ ë¬¸ì œì´ë‹¤. ë‚´ê°€ ì§€ìš°ëŠ” ìˆœê°„ì— ë‹¤ë¥¸ ì“°ë ˆë“œì—ì„œ ì“°ê³ ìˆì„ ìˆ˜ ìˆë‹¤ëŠ”ê²Œ ì–´ë ¤ìš´ë¶€ë¶„
        // ë‹¤ìŒê°•ì—ì„œ í•´ê²°í•œë‹¤.

		// C#, Java ê°™ì´ GCê°€ ìˆìœ¼ë©´ ì‚¬ì‹¤ ì—¬ê¸°ì„œ ë

		return true;
	}

private:
	// [ ][ ][ ][ ][ ][ ]
	// [head]
	atomic<Node*> _head;	// atomicì€ ì´ˆê¸°ê°’ì´ nullptr(0)ì„
};
```