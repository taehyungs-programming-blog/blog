---
layout: default
title: "19. ë©”ëª¨ë¦¬ ì˜¤ì—¼ì— ê´€í•˜ì—¬"
parent: (IOCP)
grand_parent: C++
nav_order: 2
---

ğŸ˜º ë©”ëª¨ë¦¬ ì˜¤ì—¼ì˜ ë¬¸ì œ Exampleì„ í™•ì¸í•´ë³´ì

```cpp
// ë©”ëª¨ë¦¬ ì˜¤ì—¼ ì˜ˆì‹œ1

Knight k1 = new Knight();

k1->hp = 200;
k1->mp = 150;

delete k1

// ...

k1->hp = 100;       // ??? -> ì—¬ê¸°ì„œ crashê°€ ë‚  ìˆ˜ë„ ì•ˆ ë‚  ìˆ˜ë„ ìˆë‹¤.

// ë§Œì•½ k1->hp ë©”ëª¨ë¦¬ ê³µê°„ì— ë‹¤ë¥¸ ë©”ëª¨ë¦¬ê°€ ì¨ì§„ë‹¤ë©´??? -> ê·¸ ë°ì´í„°ë¥¼ ì˜¤ì—¼ì‹œí‚¬ ìˆ˜ ìˆë‹¤.
```

```cpp
// ë©”ëª¨ë¦¬ ì˜¤ì—¼ ì˜ˆì‹œ2

vector<int32> v{1,2,3,4,5};

for(int32 i = 0; i < 5; i++)
{
    int32 value = v[i];

    // ...

    if(/*something*/)
    {
        v.clear();
        // break;   // ê¹œë¹¡í•˜ê³  breakë¥¼ ì•ˆí•¨
        // clearí–ˆëŠ”ë° breakë¥¼ ì•ˆí•´ì„œ forë¬¸ì— ë‹¤ì‹œ ëŒì•„ê°€ ì˜ëª»ëœ ë©”ëª¨ë¦¬ì— ì ‘ê·¼
    }
}
```

```cpp
// ë©”ëª¨ë¦¬ ì˜¤ì—¼ ì˜ˆì‹œ3

class Player
{

};

class Knight : public Player
{

};

Player* p = new Player();
Knight* k = static_cast<Knight*>(p);    
// dynamic_castë¡œ ì¡ì•„ì•¼í•˜ì§€ë§Œ ì„±ëŠ¥ì´ìŠˆë¡œ static_castë¡œ ì¡ì•˜ëŠ”ë° ì˜ëª» ìºìŠ¤íŒ…í•¨.
```

<br>

---

ğŸ˜º ë‹¤ì–‘í•œ ë¬¸ì œê°€ ìˆêµ¬ë‚˜? ì–´ë–»ê²Œ í•´ê²°í•´ì•¼ í• ê¹Œ?

ğŸ˜º ìš°ì„  OSì˜ ë©”ëª¨ë¦¬ì— ëŒ€í•´ ì´í•´í•´ì•¼í•œë‹¤.

```cpp
// ê°€ìƒ ë©”ëª¨ë¦¬ ê¸°ë³¸!

int* num = new int;
int64 add = reinterpret_cast<int64>(num);   

// ì—¬ê¸°ì„œ ë‚˜ì˜¨ì£¼ì†ŒëŒ€ë¡œ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì ‘ê·¼ì´ ê°€ëŠ¥í• ê¹Œ?
// ë‹¹ì—°í•˜ì§€ë§Œ ì•ˆëœë‹¤. ë©”ëª¨ë¦¬ ì£¼ì†Œ(ê°€ìƒì£¼ì†Œ)ëŠ” ê° í”„ë¡œì„¸ìŠ¤ë§ˆë‹¤ ê´€ë¦¬í•˜ê²Œ ëœë‹¤.

delete num;
```

```cpp
// ì–´ë–¤ í”„ë¡œì„¸ìŠ¤ì—ì„œ 2GBë©”ëª¨ë¦¬ë¥¼ ì“´ë‹¤ê³  ê°€ì •í•´ë³´ì.
// 2GB [                                     ]
// ê·¸ëŸ¼ ê°€ìƒë©”ëª¨ë¦¬ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ì„œ ë©”ëª¨ë¦¬ì£¼ì†Œê°€ ëª‡ê°œê°€ í•„ìš”í• ê¹Œ?
// 1ë°”ì´íŠ¸ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ 1ë°”ì´íŠ¸ê°€ í•„ìš”í•˜ë‹¤ë©´ í•´ë‹¹í”„ë¡œì„¸ìŠ¤ì— 2GBë©”ëª¨ë¦¬í• ë‹¹ì„ ìœ„í•´ ì ‘ê·¼ì„ ìœ„í•œ ë©”ëª¨ë¦¬ë¥¼ 2GBí• ë‹¹í•´ì•¼í•˜ëŠ” ë°”ë³´ ê°™ì€ ì¼ì´ ë°œìƒí•œë‹¤.
// ë”°ë¼ì„œ ë©”ëª¨ë¦¬ ê³µê°„ë³´ë‹¤ í¬ê²Œ ì ‘ê·¼ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•˜ëŠ”ë° ì´ë¥¼ í˜ì´ì§•ì´ë¼í•œë‹¤.
// -> ë³´í†µ 4kbì´ë‹¤.
// í˜ì´ì§• ë§ˆë‹¤ read/write ê¶Œí•œì„ ì¤„ ìˆ˜ ìˆë‹¤.
// ì‹¤ì œë¡œ í™•ì¸í•´ë³´ì.

SYSTEM_INFO info;
::GetSystemInfo(&info);
info.dwPageSize;                // 4KB
info.dwAllocationGranularity;   // 64KB
```

```cpp
class StompAllocator
{
    enum { PAGE_SIZE = 0x1000 };        // 4096
    //...

void* StompAllocator::Alloc(int32 size)
{
    const int64 pageCount = (size + PAGE_SIZE - 1) / PAGE_SIZE; // ëª‡ê°œì˜ í˜ì´ì§€ë¥¼ í• ë‹¹í• ê¹Œ?
    const int64 dataOffset = pageCount * PAGE_SIZE - size;      // ë©”ëª¨ë¦¬ ì˜¤ë²„í”Œë¡œ ë°©ì§€ìš©
    void* baseAddress = ::VirtualAlloc(NULL,            // ì•Œì•„ì„œ ë©”ëª¨ë¦¬ ê³µê°„ì„ ì¡ì•„ë‹¬ë¼
                        pageCount * PAGE_SIZE,          // ë©”ëª¨ë¦¬ í¬ê¸°
                        MEM_RESERVE | MEM_COMMIT,       // MEM_RESERVE(ì˜ˆì•½), MEM_COMMIT(ì‚¬ìš©)
                        PAGE_READWRITE);                // ê¶Œí•œ

    return static_cast<void*>(static_cast<int8*>(baseAddress) + dataOffset);
    // ì‹¤ì œ ë©”ëª¨ë¦¬ ì‚¬ìš©ì€ í• ë‹¹ëœ ë©”ëª¨ë¦¬ì˜ ë§ˆì§€ë§‰ ë¶€ë¶„ë§Œ ì“°ê²Œ í•œë‹¤.
    // [               [ ì—¬ê¸°ë§Œ ì“´ë‹¤ ]]
}

void StompAllocator::Release(void* ptr)
{
    const int64 address = reinterpret_cast<int64>(ptr);
    const int64 baseAddress = address - (address % PAGE_SIZE);
    ::VirtualFree(reinterpret_cast<void*>(baseAddress), 0, MEM_RELEASE);
}

// new, deleteì™€ ì°¨ì´ì ì€?
// VirtualFreeëŠ” ì‹¤ì œë¡œ ë©”ëª¨ë¦¬ ê³µê°„ì„ ë°€ì–´ë²„ë¦°ë‹¤.
    // ë©”ëª¨ë¦¬ ì˜¤ì—¼ë¬¸ì œë¥¼ ë°©ì§€í•  ìˆ˜ ìˆë‹¤.
```

<br>

* `VirtualAlloc`, `VirtualFree`ë¥¼ ì‚¬ìš©ì‹œ ë©”ëª¨ë¦¬ ì˜¤ì—¼ì˜ ë¬¸ì œëŠ” í•´ê²°ëì§€ë§Œ
    * ë©”ëª¨ë¦¬ íŒŒí¸í™”, ì¬ì‚¬ìš©ì˜ ë¬¸ì œëŠ” í•´ê²°ë˜ì§€ ì•Šì•˜ë‹¤.
    * ì—­ì‹œ ë’¤ì—ì„œ ë‹¤ì‹œ ì„¤ëª…í•œë‹¤.