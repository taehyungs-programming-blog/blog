---
layout: default
title: "13. Proxy Pattern"
parent: (Desing Pattern)
grand_parent: C++
nav_order: 2
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## Proxy Pattern

ğŸ• ì–´ë–¤ ê°ì²´ì— ëŒ€í•œ ì ‘ê·¼ì„ ì œì–´í•˜ê¸° ìœ„í•œ ìš©ë„ë¡œ ëŒ€ë¦¬ì¸ì´ë‚˜ ëŒ€ë³€ì¸ì— í•´ë‹¹í•˜ëŠ” ê°ì²´ë¥¼ ì œê³µ

```cpp
// Server ì¸¡

#include <iostream>
#include "ecourse_dp.hpp"
using namespace std;
using namespace ecourse;

class Calc
{
public:
    int Add(int a, int b) { return a + b; }
    int Sub(int a, int b) { return a - b; }
};
Calc calc;

int dispatch(int code, int x, int y)
{
    printf("[DEBUG] %d, %d, %d\n", code, x, y);

    switch(code)
    {
        case 1: return calc.Add(x, y);
        case 2: return calc.Sub(x, y);
    }
    return -1;
}

int main()
{
    // ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ec_start_serverë¼ëŠ” í•¨ìˆ˜ê°€ ìˆê³ 
    // ì‚¬ìš©ìëŠ” ë§¤ê°œë³€ìˆ˜ë§Œ ë³´ê³  ì–´ë–¤ ì¼ì„ í•˜ëŠ”ì§€ ë§ì¶°ì•¼í•œë‹¤ -> ë¶ˆí¸ì‚¬í•­
    ec_start_server("CalcService", dispatch);
}
```

```cpp
// Client ì¸¡

#include <iostream>
#include "ecourse_dp.hpp"
using namespace std;
using namespace ecourse;

int main()
{
    int server = ec_find_server("CalcService");

    int ret = ec_send_server(server, 1, 10, 20);
    // ë¬¸ì œ1) ì—°ì‚°ëª…ë ¹ì´ ìˆ«ìì´ë‹ˆ ì‚¬ìš©ì ì…ì¥ì—ì„œ í—·ê°ˆë¦°ë‹¤.
}
```

```cpp
class Calc      // ìš”ë†ˆì´ Proxyì´ë‹¤.(ì¼ì¢…ì˜ Wrappingì´ë¼ ìƒê°í•˜ë©´ í¸í•˜ê² êµ°!)
{
    int server;
public:
    Calc() { server = ec_find_server("CalcService"); }

    int Add(int a, int b) { return ec_send_server(server, 1, a, b); }
    int Sub(int a, int b) { return ec_send_server(server, 2, a, b); }
};

int main()
{
    Calc* pCalc = new Calc;

    cout << pCalc->Add(1, 2) << endl;
}
```

* Proxy ì¥ì 
    * ëª…ë ¹ ì½”ë“œ ëŒ€ì‹  í•¨ìˆ˜ í˜¸ì¶œ ì‚¬ìš©ê°€ëŠ¥
    * ì˜ëª»ëœ ëª…ë ¹ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê²Œ ëœë‹¤.
    * ClientëŠ” IPCì— ëŒ€í•´ì„œ ì•Œ í•„ìš”ê°€ ì—†ë‹¤.

---

ğŸ• ì½”ë“œì •ë¦¬

```cpp
struct ICalc
{
    virtual int Add(int a, int b) = 0;
    virtual int Sub(int a, int b) = 0;
    virtual ~ICalc();
}

// client
class Calc : public ICalc       
{
    int server;
public:
    Calc() { server = ec_find_server("CalcService"); }

    virtual int Add(int a, int b) { return ec_send_server(server, 1, a, b); }
    virtual int Sub(int a, int b) { return ec_send_server(server, 2, a, b); }
};

int main()
{
    Calc* pCalc = new Calc;

    cout << pCalc->Add(1, 2) << endl;
}

// server
class Calc : public ICalc       
{
public:
    int Add(int a, int b) { return a + b; }
    int Sub(int a, int b) { return a - b; }
};
```

ğŸ• ì´ë ‡ê²Œ ë§Œë“¤ë©´ ì„œë²„, í´ë¼ì´ì–¸íŠ¸ ì¸¡ ë˜‘ê°™ì€ ì´ë¦„ì˜ í•¨ìˆ˜ë¥¼ ë§Œë“¤ê²Œ ê°•ì œí•  ìˆ˜ ìˆë‹¤. -> ì´ë¦„ì„ í†µì¼í•´ì•¼ í›—ë‚  ë””ë²„ê¹…ì´ ìˆ˜ì›”

```cpp
struct IRefCount
{
    virtual void AddRef() = 0;
    virtual void Release() = 0;
    virtual ~IRefCount() {}
};

struct ICalc : public IRefCount
{
    virtual int Add(int a, int b) = 0;
    virtual int Sub(int a, int b) = 0;

    virtual ~ICalc();
}
```

```cpp
// CalcProxy.cpp
#include "ecourse_dp.hpp"
#include "ICalc.h"
using namespace std;

class Calc : public ICalc
{
    int server;
    int count = 0;
public:
    Calc() { server = ec_find_server("CalcService"); }

    void AddRef() {++count;}
    void Release() {if(--count == 0) delete this;}

    int Add(int a, int b) { return ec_send_server(server, 1, a, b); }
    int Sub(int a, int b) { return ec_send_server(server, 2, a, b); }
};

extern "C" __declspec(dllexport)        // dllë¡œ ìƒì„±í•˜ê³  í•¨ìˆ˜ ì‚¬ìš©ì¤€ë¹„
ICalc* CreateCalc()
{
    return new Calc;
}
```

```cpp
typedef ICalc* (*F)();

int main()
{
    // ë™ì  ëª¨ë“ˆ load
    void* addr = ec_load_module("CalcProxy.dll");
    F f = (F)ec_get_function_address(addr, "CreateCalc");

    ICalc* pCalc = f();     // CreateCalc()
    pCalc->AddRef();

    cout << pCalcs->Add(1, 2);

    pCalc->Release();
}
```