---
layout: default
title: "14. Kernel Objectì˜ ìƒì†"
parent: (Windows API)
grand_parent: C++
nav_order: 2
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

ğŸ˜º pingì„ ë³´ë‚´ê³  ping ê¸°ë¡ì„ ë‚¨ê¸°ëŠ” í”„ë¡œê·¸ë¨ì„ ë§Œë“¤ë©° Kernel objectì— ëŒ€í•´ ì„¤ëª…í•˜ê³ ì í•œë‹¤. 

```cpp
// ë°ìŠ¤í¬í†± ì–´í”Œë¦¬ì¼€ì´ì…˜ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±

#include <stdio.h>
#include <Windows.h>
#include <tchar.h>

LRESULT __stdcall WndProc(HWND hwnd UINT message, UINT message, WPARAM wParam, LPARAM lParam)
{
    static HWND hEdit;

    switch(message)
    {
    case WM_CREATE:
        // ìì‹ ìœˆë„ìš°ë¡œ ì—ë””íŠ¸ ë°•ìŠ¤ í•˜ë‚˜ ìƒì„±
        hEdit = CreateWindowEx(0, _T("edit"), _T(""), 
                ES_MULTILINE | WS_CHILD | WS_VISIBLE | WS_BORDER,
                10, 10, 300, 500, hwnd, (HMENU)1, 0, 0);
        break;
    case WM_DESTROY:
        PostQuitMessage(0);
        break;
    }
    return DefWindowProc(hwnd, message, wParam, lParam);
}

// ...
```

<br>

ğŸ˜º ë§ˆìš°ìŠ¤ë¥¼ í´ë¦­ì‹œ í•‘ì„ ë³´ë‚´ëŠ” í”„ë¡œê·¸ë¨ì„ ë§Œë“¤ì–´ ë³´ì

```cpp
#include <stdio.h>
#include <Windows.h>
#include <tchar.h>

LRESULT __stdcall WndProc(HWND hwnd UINT message, UINT message, WPARAM wParam, LPARAM lParam)
{
    static HWND hEdit;

    switch(message)
    {
    case WM_CREATE:
        hEdit = CreateWindowEx(0, _T("edit"), _T(""), 
                ES_MULTILINE | WS_CHILD | WS_VISIBLE | WS_BORDER,
                10, 10, 300, 500, hwnd, (HMENU)1, 0, 0);
        break;
    case WM_LBUTTONDOWN:
        STARTUPINFO si = { 0 };
        si.cb = sizeof(si);

        PROCESS_INFORMATION pi = { 0 };

        TCHAR name[] = _T("ping www.microsoft.com");

        // CreateProcessë¥¼ í†µí•´ì„œ ping.exeë¥¼ ì‹¤í–‰
        BOOL b = CreatePrcess(0, name, 0, 0, FALSE, 0, 0, 0, &si, &pi);

        // ì½˜ì†”ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ pingì„ ì‹¤í–‰

        if(b)
        {
            CloseHandle(pi.hProcess);
            CloseHandle(pi.hTread);
        }
        break;
    case WM_DESTROY:
        PostQuitMessage(0);
        break;
    }
    return DefWindowProc(hwnd, message, wParam, lParam);
}

// ...
```

<Br>

ğŸ˜º pingì€ ì½˜ì†” ì–´í”Œë¦¬ì¼€ì´ì…˜ì¸ë° a.txtì— ì¶œë ¥ì„ í•˜ê²Œ ë³€ê²½í•´ë³´ì. (ì´ê±¸ ì–´ë ¤ìš´ ë§ë¡œ, í‘œì¤€ ì…ì¶œë ¥ Redirectë¼ í•œë‹¤.)

```cpp
case WM_LBUTTONDOWN:
    // íŒŒì¼ ìƒì„±
    HANDLE hFile = CreateFile(_T("a.txt"), GENERIC_READ | GENERIC_WRITE,
                    FILE_SHARE_READ | FILE_SHARE_WRITE, 0, CREATE_ALWAYS,
                    FILE_ATTRIBUTE_NORMAL, 0);

    STARTUPINFO si = { 0 };
    si.cb = sizeof(si);

    // Redirection ì¶”ê°€ - ping.exeì—ì„œ std::coutìœ¼ë¡œ ë³´ë‚´ì§€ ë§ê³  redirectionëœ ê³³ìœ¼ë¡œ outí•´ë‹¬ë¼
    si.hStdOutput = hFile;      // ì´ë ‡ê²Œ ì£¼ë©´ ìì‹ í”„ë¡œì„¸ìŠ¤ ê¸°ì¤€ì—ì„œ hFile(HANDLE)ì˜ ë‚´ìš©ì„ ëª¨ë¦„
    si.dwFlags = STARTF_USESTDHANDLES;  // hStdOutputì„ ê¼­ ì¨ë‹¬ë¼ëŠ” í”Œë˜ê·¸

    PROCESS_INFORMATION pi = { 0 };
    TCHAR name[] = _T("ping www.microsoft.com");

    // ìƒì„±ëœ í”„ë¡œì„¸ìŠ¤ëŠ” ìë…€í”„ë¡œì„¸ìŠ¤ê°€ ëœë‹¤
    BOOL b = CreatePrcess(0, name, 0, 0, FALSE, 0, 0, 0, &si, &pi);

    if(b)
    {
        CloseHandle(pi.hProcess);
        CloseHandle(pi.hTread);
    }
    break;
```

<br>

ğŸ˜º ë¶€ëª¨ Processê°€ ìì‹ ì´ ì‚¬ìš©í•˜ë˜ HANDLEì„ ìƒì† ê°€ëŠ¥

```cpp
case WM_LBUTTONDOWN:
    HANDLE hFile = CreateFile(_T("a.txt"), GENERIC_READ | GENERIC_WRITE,
                    FILE_SHARE_READ | FILE_SHARE_WRITE, 0, CREATE_ALWAYS,
                    FILE_ATTRIBUTE_NORMAL, 0);

    // hFileìì²´ë„ ìƒì†ì´ ê°€ëŠ¥í•˜ê²Œ ë³€ê²½í•´ì•¼ í•œë‹¤.(ë””í´íŠ¸ëŠ” FILEì€ ìƒì†ì´ ë¶ˆê°€ëŠ¥í•¨)
    SetHandleInformation(hFile, HANDLE_FLAG_INGERIT,    // ìƒì†ê°€ëŠ¥ ì—¬ë¶€ë¥¼
                                HANDLE_FLAG_INGERIT);   // ìƒì†ê°€ëŠ¥í•˜ê²Œ í•´ë‹¬ë¼

    STARTUPINFO si = { 0 };
    si.cb = sizeof(si);
    si.hStdOutput = hFile;
    si.dwFlags = STARTF_USESTDHANDLES;

    PROCESS_INFORMATION pi = { 0 };
    TCHAR name[] = _T("ping www.microsoft.com");

    BOOL b = CreatePrcess(0, name, 0, 0, TRUE, // FALSE -> TRUE ë³€ê²½ (ë¶€ëª¨ì˜ Kernel Objectë¥¼ ìƒì† ë°›ê² ë‹¤.)
                        0, 0, 0, &si, &pi);
```

<br>

ğŸ˜º ì—¬ê¸°ì„œ í—·ê°ˆë¦¬ëŠ”ê²Œ ì•ì—ì„œ `DuplicateHandle`ë¡œ í•¸ë“¤ê°’ì„ ë„˜ê¸°ëŠ” ë°©ë²•ì„ ë°°ìš°ì§€ ì•Šì•˜ë‚˜??

ğŸ˜º `DuplicateHandle`ë¡œ ë„˜ê¸¸ê²½ìš° ìë…€ PKOì—ì„œ ê´€ë¦¬ì¤‘ì¸ í•¸ë“¤ê°’ê³¼ ë¶€ëª¨ PKOì—ì„œ ê´€ë¦¬í•˜ëŠ” í•¸ë“¤ê°’ì´ ë‹¬ë¼ í•¸ë“¤ì„ ë³„ë„ë¡œ ì¨ì•¼í•¨. Kernel Objectìƒì†ì„ í•  ê²½ìš° ë™ì¼í•œ í•¸ë“¤ì„ ì‚¬ìš©ê°€ëŠ¥í•˜ê¸°ì— ì¶”ì²œ

* ìƒì†ì„¤ì • ë³€ê²½ì€ ë‘ ê°€ì§€ ë°©ë²•ì´ ìˆìŒ
    * `SetHandleInformation` ì‚¬ìš©í•˜ê¸° - ìœ„ì—ì„œ ì„¤ëª…í•œ ë°©ë²•
    * `SECURITY_ATTRIBUTES` ë¥¼ ë³€ê²½ - ì•„ë˜ì„œ ì„¤ëª…

## Kernel Objectë¥¼ ìƒì„± ì‹œ SECURITY_ATTRIBUTESë¥¼ ì „ë‹¬í•œë‹¤.

```cpp
SECURITY_ATTRIBUTES sa = { 0 };
sa.bInheritHandle = TRUE;       // ìƒì†ê°€ëŠ¥ì—¬ë¶€
sa.lpSecurityDescriptor = 0;
sa.nLength = sizeof(sa);

HANDLE hFile = CreateFile(_T("b.txt"), GENERIC_READ | GENERIC_WRITE,
                FILE_SHARE_READ | FILE_SHARE_WRITE, &sa, // saë¥¼ ì „ë‹¬
                CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, 0);

// Kernel Objectë¥¼ ë§Œë“¤ë©´ì„œ ìƒì†ê°€ëŠ¥í•˜ê²Œ í•œë‹¤
```

<br>

ğŸ˜º ì—¬ê¸°ì„œë¶€í„´ ì½”ë“œ ê°œì„ ì‘ì—…

ğŸ˜º a.txtì— ë‚˜ì˜¤ëŠ” ì¶œë ¥ê²°ê³¼ë¥¼ edit boxë¡œ ì˜®ê²¨ë³´ì

```cpp
#undef UNICODE
#undef _UNICODE

// ..

case WM_LBUTTONDOWN:
    HANDLE hFile = CreateFile(_T("a.txt"), GENERIC_READ | GENERIC_WRITE,
                    FILE_SHARE_READ | FILE_SHARE_WRITE, 0, CREATE_ALWAYS,
                    FILE_ATTRIBUTE_NORMAL, 0);

    SetHandleInformation(hFile, HANDLE_FLAG_INGERIT, HANDLE_FLAG_INGERIT);

    STARTUPINFO si = { 0 };
    si.cb = sizeof(si);
    si.hStdOutput = hFile;
    si.dwFlags = STARTF_USESTDHANDLES;

    PROCESS_INFORMATION pi = { 0 };
    TCHAR name[] = _T("ping www.microsoft.com");

    BOOL b = CreatePrcess(0, name, 0, 0, TRUE, CREATE_NO_WINDOW // ì½˜ì†”ì°½ ë§Œë“¤ì§€ ë§ì•„ ë‹¬ë¼
                          , 0, 0, &si, &pi);

    if(b)
    {
        WaitForSingleObject(pi.hProcess, INFINITE);

        // íŒŒì¼ í¬ì¸í„°ë¥¼ ì œì¼ ì•ìœ¼ë¡œ ì˜®ê¸´ë‹¤.
        // ì´ê±¸ í•˜ì§€ ì•Šìœ¼ë©´ íŒŒì¼ í¬ì¸í„°ê°€ íŒŒì¼ì˜ ëì—ê°€ê¸°ì— íŒŒì¼ì„ ì½ì–´ì˜¤ì§€ ëª»í•¨.
        SetFilePointer(hFile, 0, 0, FILE_BEGIN);

        DWORD len;
        char buff[4096] = { 0 };

        // íŒŒì¼ì—ì„œ buffë¡œ ì½ì–´ë‚´ê³ 
        BOOL b1 = ReadFile(hFile, buff, 4096, &len, 0);

        // buffì˜ ë‚´ìš©ì„ editì— ì¶œë ¥
        SendMessage(hEdit, EM_REPLACESEL, 0, (LPARAM)buff);

        CloseHandle(pi.hProcess);
        CloseHandle(pi.hTread);
    }
    break;
```

<br>

ğŸ˜º pingì˜ ì¶œë ¥ì„ ì¤„ ë‹¨ìœ„ë¡œ ì½ì–´ì˜¤ê²Œ í•˜ì -> íŒŒì¼ë¡œ ì“°ì§€ë§ê³  pipeë¥¼ ì“°ì

```cpp
case WM_LBUTTONDOWN:
    HANDLE hRead, hWrite;

    // íŒŒì´í”„ë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”
    CreatePipe(&hRead, &hWrite, 0, 1024);

    /* ì°¸ê³ 
        BOOL CreatePipe(
        PHANDLE               hReadPipe,
        PHANDLE               hWritePipe,
        LPSECURITY_ATTRIBUTES lpPipeAttributes,
        DWORD                 nSize
        );
    */

    SetHandleInformation(hWrite, HANDLE_FLAG_INGERIT, HANDLE_FLAG_INGERIT);

    STARTUPINFO si = { 0 };
    si.cb = sizeof(si);
    si.hStdOutput = hWrite;
    si.dwFlags = STARTF_USESTDHANDLES;

    PROCESS_INFORMATION pi = { 0 };
    TCHAR name[] = _T("ping www.microsoft.com");

    BOOL b = CreatePrcess(0, name, 0, 0, TRUE, CREATE_NO_WINDOW, 0, 0, &si, &pi);

    if(b)
    {
        CloseHandle(hWrite);    // ì“°ê¸° í•¸ë“¤ì€ ì´ì œ í•„ìš”ì—†ê¸°ì—

        while(1)
        {
            DWORD len;
            char buff[4096] = { 0 };

            // í•‘ì´ ì“°ë©´ ì½ê³ , ì•ˆì“°ë©´ ì—¬ê¸°ì„œ ëŒ€ê¸°í•œë‹¤
            BOOL b1 = ReadFile(hRead, buff, 4096, &len, 0);

            if(len <= 0) // pipeê°€ ëŠì–´ì¡ŒìŒ, í•‘ì´ ëë‚¨
                break;

            SendMessage(hEdit, EM_REPLACESEL, 0, (LPARAM)buff);
        }


        CloseHandle(pi.hProcess);
        CloseHandle(pi.hTread);
    }
    break;
```