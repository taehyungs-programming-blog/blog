---
layout: default
title: "15. Thread ê¸°ì´ˆ"
parent: (Windows API)
grand_parent: (C++)
nav_order: 2
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## í”„ë¡œì„¸ìŠ¤ì™€ ìŠ¤ë ˆë“œ

* í”„ë¡œì„¸ìŠ¤
    * ì»´í“¨í„°ì—ì„œ ì—°ì†ì ìœ¼ë¡œ ì‹¤í–‰ë˜ê³  ìˆëŠ” í”„ë¡œê·¸ë¨ì„ ì˜ë¯¸
    * ê°€ìƒì˜ì£¼ì†Œ ê³µê°„ + í”„ë¡œì„¸ìŠ¤ ì»¤ë„ ì˜¤ë¸Œì íŠ¸(PKO)
    * ì§ì ‘ë™ì‘í•˜ì§„ ì•ŠëŠ”ë‹¤ ì •ì ì¸ ì¡´ì¬
* ìŠ¤ë ˆë“œ
    * í”„ë¡œì„¸ìŠ¤ë‚´ì—ì„œ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ì‹¤í–‰íë¦„(ë™ì ì¸ ì¡´ì¬)
    * ìŠ¤ë ˆë“œì—­ì‹œ OSì…ì¥ì—ì„  ê´€ë¦¬ì˜ ëŒ€ìƒì´ê¸°ì— TKO(Thread Kernel Object)ê°€ ì¡´ì¬
    * TKOë‚´ì— ì°¸ì¡°ê³„ìˆ˜, ë³´ì•ˆì„¤ì •, ID ë“±ì´ ê´€ë¦¬ëœë‹¤.

---

### (ì¤‘ìš”) Quantum Time

```
 A    B    Thred
 |    |
 | -> |
 |    |
```

ğŸ˜º ìœ„ ê·¸ë¦¼ê³¼ ê°™ì´ í•˜ë‚˜ì˜ CPUì—ì„œ ë‘ ê°œì˜ Threadë¥¼ ë™ì‘í•œë‹¤ë©´ A Threadì—ì„œ íŠ¹ì • ì‹œê°„ í›„ B Threadë¡œ ì ìœ ê¶Œì„ ì´ì „í•´ì•¼í•  ê²ƒì´ë‹¤. ì´ ë•Œ ì´ì „í•˜ëŠ” íŠ¹ì • ì‹œê°„ì„ **Quantum Time**ì´ë¼ í•œë‹¤.

ğŸ˜º Threadë¥¼ ì´ì „í•˜ëŠ” í–‰ìœ„ ìì²´ëŠ” **Context Switch**ë¼ í•˜ë©° ì´ë•Œ ë§í•˜ëŠ” Contextì˜ ì˜ë¯¸ëŠ” ì•„ë˜ì— ì„¤ëª….

ğŸ˜º ë˜í•œ Threadê°€ ì´ì „ ì‹œ ì§ì „ì— ì‚¬ìš© ë˜ë˜ Threadì˜ ì •ë³´(ì‹¤í–‰ì£¼ì†Œ, ìŠ¤íƒì£¼ì†Œ ë“±)ì„ Kernel Objectì— ë‹´ê³  ìˆì–´ì•¼ í•˜ê³ , ì´ ì •ë³´ë¥¼ Thread Kernel Objectì˜ CONTEXTì— ì €ì¥í•˜ë©° ì €ì¥ë˜ëŠ” ì •ë³´ëŠ”

* EIP ë ˆì§€ìŠ¤í„° ì •ë³´ : ì‹¤í–‰ì£¼ì†Œ
* ESP ë ˆì§€ìŠ¤í„° ì •ë³´ : ìŠ¤íƒì£¼ì†Œ

ë¥¼ ëŒ€í‘œì ìœ¼ë¡œ ì €ì¥í•˜ê²Œ ëœë‹¤.

---

## Thread ìƒì„±

```cpp
#include <stdio.h>
#include <Windows.h>
#include <tchar.h>

DWORD __stdcall foo(void* p)
{
    return 0;
}

int _tmain()
{
    DWORD tid;

    HANDLE handle = CreateThread(0, 0, foo, 0, 0, &tid);

    getchar();

    CloseHandle(handle);
}
```

```cpp
HANDLE CreateThread(
  LPSECURITY_ATTRIBUTES   lpThreadAttributes,       // Kernel Objectì˜ ë³´ì•ˆì†ì„±
  SIZE_T                  dwStackSize,              // Kernel Objectì˜ Stack Size(ê¸°ë³¸ì€ 1M)
  LPTHREAD_START_ROUTINE  lpStartAddress,           // ì‹¤í–‰ í•¨ìˆ˜ ì£¼ì†Œ
  __drv_aliasesMem LPVOID lpParameter,              // ë§¤ê°œë³€ìˆ˜
  DWORD                   dwCreationFlags,          // Thread í”Œë˜ê·¸
  LPDWORD                 lpThreadId                // Thread ID
);
```

* ëª¨ë“  ThreadëŠ” ìƒì„± ì‹œ ì°¸ì¡° ê°œìˆ˜ê°€ í•­ìƒ 2ê°œë‹¤(ìê¸°ìì‹ , ë¶€ëª¨ Thread)
* ë”°ë¼ì„œ ë¶€ëª¨ì—ì„œ `CloseHandle`í•´ì¤˜ì•¼ ëœë‹¤.
    * ë§Œì•½ í•´ì£¼ì§€ ì•Šìœ¼ë©´ ì“°ë ˆë“œê°€ ë‚¨ì•„ìˆê²Œ ëœë‹¤.

Threadì˜ ë¬¸ì œì ì€?

```cpp
#include <stdio.h>
#include <Windows.h>
#include <tchar.h>

DWORD __stdcall foo(void* p)
{
    // ì—¬ê¸°ì„œ C í‘œì¤€ í•¨ìˆ˜ ì‚¬ìš©ì‹œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
    // ì´ëŸ° ë¬¸ì œì˜ í•´ê²°ì„ ìœ„í•´ _beginthreadexë¥¼ ì“°ëŠ”ê²ƒì„ ì¶”ì²œí•œë‹¤
    // ìì„¸í•œì„¤ëª…ì€ ì´í›„ì— _beginthreadexë¥¼ ì„¤ëª…í•˜ë©° í•˜ê² ìŒ
    return 0;
}

int _tmain()
{
    DWORD tid;

    HANDLE handle = CreateThread(0, 0, foo, 0, 0, &tid);

    getchar();

    CloseHandle(handle);
}
```

í•´ê²°ì±…?

```cpp
#include <stdio.h>
#include <Windows.h>
#include <tchar.h>
#include <process.h>

// ìˆœìˆ˜ cì˜ ìë£Œí˜•ìœ¼ë¡œ ë¦¬í„´ë°›ëŠ”ë‹¤
unsigned int __stdcall foo(void* p)
{
    // Cí•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë”ë¼ë„ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ê°€ ì—†ë‹¤.
    return 0;
}

int _tmain()
{
    unsigned int tid;

    // í•´ê²°ì±… : _beginthreadexì‚¬ìš©
    HANDLE handle = (HANDLE)_beginthreadex(0, 0, foo, 0, 0, &tid);

    getchar();

    CloseHandle(handle);
}
```

---

## Thread ì¢…ë£Œ

```cpp
#include <stdio.h>
#include <Windows.h>
#include <process.h>

struct Test
{
    Test() { printf("Test()\n"); }
    ~Test() { printf("~Test()\n"); }
};

UINT __stdcall foo(void* p)
{
    Test t;

    _endthreadex(0);
    ExitThread(0);  // ì´ë ‡ê²Œ Threadë¥¼ ì¢…ë£Œí•  ìˆ˜ìˆë‹¤.
    // ë‹¨, ì´ë ‡ê²Œ ì¢…ë£Œì‹œ Testì˜ ì†Œë©¸ìê°€ í˜¸ì¶œë˜ì§€ ì•ŠìŒ.

    return 0;
}

int main()
{
    HANDLE hThread  = (HANDLE)_beginthreadex(0, 0, foo, 0, 0, 0);

    TerminateThread(hTread, 200);   // ì™¸ë¶€ì—ì„œ í˜¸ì¶œê°€ëŠ¥, 
    // ì´ê²ƒë„ ì—­ì‹œ ë‚´ë¶€ ì˜¤ë¸Œì íŠ¸(Test)ì˜ ì†Œë©¸ìê°€ í˜¸ì¶œë˜ì§€ ì•ŠëŠ”ë‹¤.

    getchar();
}
```

```cpp
#include <stdio.h>
#include <Windows.h>
#include <process.h>

UINT __stdcall foo(void* p)
{
    _tprintf(_T("start foo\n"));

    Sleep(5000);

    _tprintf(_T("end foo\n"));
    return 0;
}

int main()
{
    HANDLE hThread  = (HANDLE)_beginthreadex(0, 0, foo, 0, 0, 0);

    return 0;   // ë°”ë¡œì¢…ë£Œ?
    // ì£¼ ìŠ¤ë ˆë“œ main í•¨ìˆ˜ê°€ return ë  ì‹œ í”„ë¡œì„¸ìŠ¤ ë‚´ ëª¨ë“  ìŠ¤ë ˆë“œê°€ ê°•ì œ ì¢…ë£Œ ëœë‹¤.

    ExitThread(0);  // ë©”ì¸ìŠ¤ë ˆë“œë§Œ ì£½ì¸ë‹¤, ìƒì„±ëœ ìŠ¤ë ˆë“œëŠ” ì‚´ì•„ìˆìŒ.
}
```

ìƒˆë¡œë§Œë“  Threadë¥¼ ëŒ€ê¸°í•˜ê²Œ ë³€ê²½í•´ë³´ì.

```cpp
int main()
{
    HANDLE hThread  = (HANDLE)_beginthreadex(0, 0, foo, 0, 0, 0);

    DWORD ret = WaitForSingleObject(hThread, INFINITE);

    if(ret == WAIT_OBJECT_0)
    {
        DWORD code;
        GetExitCodeThread(hTread, &code);   // ì¢…ë£Œì½”ë“œë¥¼ ë°›ëŠ”ë‹¤
    }
    else if (ret == WAIT_TIMEOUT)
    {

    }

    return 0;
}
```