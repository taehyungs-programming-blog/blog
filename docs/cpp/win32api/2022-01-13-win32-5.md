---
layout: default
title: "5. stack frame"
parent: (Windows API)
grand_parent: (C++)
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## Stack Frameì´ë€

ğŸ˜º ìš°ì„ , ê¸°ì¡´ì½”ë“œì˜ ë¬¸ì œê°€ ìˆë‹¤

```cpp
// main.c
#include <stdio.h>
int asm_main();
int main()
{
    int ret = asm_main();
    printf("result : %d\n", ret);
}
```

```
; stackframe.asm
.model flat
public _asm_main
.code
_asm_main:
    ; _add(1, 2)
    push    2
    push    1
    call    _add
    add     esp, 8
    ret
_add:
    ; ë§Œì•½ ì—¬ê¸°ì„œ ìŠ¤íƒì„ í•œ ë²ˆ ì‚¬ìš©í•´ë²„ë¦°ë‹¤ë©´??
    push    100     ; espê°€ ë³€ê²½ë˜ê²Œ ëœë‹¤
    ; ì´ëŸ¬ë©´ ë¹Œë“œì—ëŸ¬ê°€ ë˜ê³  ê³ ì •ëœ ì–´ë–¤ ë³€ìˆ˜ë¥¼ espë¥¼ ê¸°ì–µí•˜ê²Œ í•˜ì
    mov     eax, dword ptr[esp+4]
    add     eax, dword ptr[esp+8]
    ret
end
```

<br>

ğŸ˜º `esp`ë ˆì§€ìŠ¤í„°ì˜ ê°’ì„ ì„ì‹œë¡œ ë‹´ê³  ìˆì„ ë ˆì§€ìŠ¤í„°ë¥¼ `ebp`(Extened Base Pointer)ë ˆì§€ìŠ¤í„°ë¼ í•œë‹¤

```
; ...
_add:
    mov     ebp, esp    ; ebpì— espê°’ì„ ê¸°ì–µí•œë‹¤
    push    100         ; ìŠ¤íƒì„ ì‚¬ìš©í•´ë„ ì´ˆê¸° espê°’ì„ ê¸°ì–µí•˜ê³  ìˆìŒ
    mov     eax, dword ptr[ebp+4]   ; ì´ì œ ebpë¥¼ ì‚¬ìš©í•˜ì
    add     eax, dword ptr[ebp+8]
    ret
end
```

<br>

ğŸ˜º ê·¸ëŸ°ë° ë§Œì•½ í•¨ìˆ˜ í˜¸ì¶œì „ `ebp`ë¥¼ ë‹¤ë¥¸ê³³ì—ì„œ ì“°ê³ ìˆì—ˆë‹¤ë©´?? ğŸ‘‰ `ebp`ë¥¼ ë¯¸ë¦¬ ìŠ¤íƒì— ì˜¬ë ¤ë‘ì

ğŸ˜º ì´ ë°©ë²•ì´ ë§ˆì¹˜ ë£¨í‹´ ì²˜ëŸ¼ ì‚¬ìš©ëœë‹¤.

```
; ...
_add:
    push    ebp         ; ebpê°’ì„ ìŠ¤íƒì— ë¯¸ë¦¬ì˜¬ë ¤ë‘”ë‹¤(ebpê°€ ì‚¬ìš©ì¤‘ì¼ì§€ ëª¨ë¥´ê¸° ë•Œë¬¸)
    mov     ebp, esp
    push    100
    mov     eax, dword ptr[ebp+4]
    add     eax, dword ptr[ebp+8]
    pop     ebp         ; ê¸°ì¡´ê°’ì„ ë³µì›í•´ ì¤€ë‹¤
    ret
end
```

ì¢€ ì •ë¦¬í•˜ìë©´

```
_func:
    ; í•¨ìˆ˜ í˜¸ì¶œì‹œ ì‹œì‘ë˜ëŠ” êµ¬ë¬¸
    push    ebp
    mov     ebp, esp
    ; ... (í•¨ìˆ˜ë‚´ìš©)
    ; í•¨ìˆ˜ í˜¸ì¶œ ì¢…ë£Œ ì‹œ êµ¬ë¬¸
    pop     ebp
    ret
end
```

ğŸ˜º ìœ„ì™€ ê°™ì€ í˜¸ì¶œì½”ë“œë¥¼ **Stack Frame**ì´ë¼ í•œë‹¤

---

## í•¨ìˆ˜ë‚´ì˜ ì§€ì—­ë³€ìˆ˜ ì²˜ë¦¬ë°©ë²•

```
; ì§€ì—­ë³€ìˆ˜ ìƒì„±
_func:
    push    ebp
    mov     ebp, esp
    sub     esp, 8  ; ì§€ì—­ë³€ìˆ˜ í• ë‹¹(espì—ì„œ 8ë§Œí¼ ëº€ë‹¤ë¥¼ ê¸°ì–µ)
    move    dwrod ptr[ebp-4], 100   ; ë³€ìˆ˜ì— 100 ì‚½ì…
    move    dwrod ptr[ebp-8], 200   ; ë³€ìˆ˜ì— 200 ì‚½ì…
    pop     ebp
    ret
end
```

```
; ì§€ì—­ë³€ìˆ˜ í•´ì œ
_func:
    push    ebp
    mov     ebp, esp
    sub     esp, 8
    move    dwrod ptr[ebp-4], 100
    move    dwrod ptr[ebp-8], 200
    mov     esp, ebp        ; espì˜ ê°’ì„ ebpë¡œ ì˜®ê²¨ë‹¬ë¼(ì§€ì—­ë³€ìˆ˜ë¥¼ ì—†ì• ë‹¬ë¼)
    pop     ebp
    ret
end
```

<br>

ğŸ˜º ì§€ì—­ë³€ìˆ˜ ì²˜ë¦¬ê¹Œì§€ í¬í•¨í•œ Stack Frameì˜ êµ¬ì¡°ëŠ” ì•„ë˜ì™€ ê°™ë‹¤

```
_func:
    ; ì—¬ê¸°ë¥¼ í•¨ìˆ˜ Prologueë¼ í•œë‹¤
    push    ebp
    mov     ebp, esp
    sub     esp, [í•„ìš”í•œ ì§€ì—­ë³€ìˆ˜ í¬ê¸°]
    ; í•¨ìˆ˜ ë‚´ë¶€
    ; ì—¬ê¸°ë¥¼ í•¨ìˆ˜ Epilogueë¼ í•œë‹¤
    mov     esp, ebp
    pop     ebp
    ret
end
```

ì•ì„  ì½”ë“œë¥¼ ê°œì„ í•´ë³´ì

```
; stackframe.asm
.model flat
public _asm_main
.code
_asm_main:
    ; _add(1, 2)
    push    ebp
    mov     ebp, esp
    ; ì§€ì—­ë³€ìˆ˜ëŠ” ì—†ì—ˆê¸°ì— ìƒëµí•¨
    push    2
    push    1
    call    _add
    add     esp, 8
    mov     esp, ebp
    pop     ebp
    ret
x = -8
_add:
    push    ebp
    mov     ebp, esp
    
    ; addì—ì„œëŠ” ì§€ì—­ë³€ìˆ˜ë¥¼ ì“´ë‹¤ê³  ê°€ì •í•˜ì
    sub     esp, 8
    mov     dwrod ptr (-4)[ebp], 100    ; (-4)[ebp] == [ebp-4]ì™€ ë™ì¼í•œ í‘œí˜„
    mov     dwrod ptr x[ebp], 200       ; ì´ë ‡ê²Œ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ í‘œí˜„í•´ë„ ì‚¬ìš©ê°€ëŠ¥
    mov     eax, dword ptr[esp+4]
    add     eax, dword ptr[esp+8]
    mov     esp, ebp
    pop     ebp
    ret
end
```

---

## Example) ë‹¤ìŒì„ ì–´ì…ˆë¸”ë¦¬ì½”ë“œë¡œ ë³€ê²½í•´ë³´ì

```cpp
// sample.c
int add(int a, int b)
{
    int c = 0;
    int d = 0;
    c = a + b;
    return c;
}
int main()
{
    int n = add(1, 2);
}
```

```
; sample_asm.asm
.model flat
public _add
public _main
.code
_add:
    ; í•¨ìˆ˜ í”„ë¡¤ë¡œê·¸
    push    ebp
    mov     ebp, esp
    
    sub     esp, 8      ; ì§€ì—­ë³€ìˆ˜ 8ë°”ì´íŠ¸
    mov     dword ptr[ebp-4], 0
    mov     dword ptr[ebp-8], 0
    ; ì—°ì‚°ê³¼ì •
    mov     eax, dword ptr[ebp+8]
    add     eax, dword ptr[ebp+12]
    mov     dword ptr[ebp-4], eax
    mov     eax, dword ptr[ebp-4]
    ; í•¨ìˆ˜ ì• í•„ë¡œê·¸
    mov     esp, ebp
    pop     ebp
    ret
_main:
    push    ebp
    mov     ebp, esp
    ; sub     esp, 4 ; ì´ë ‡ê²Œë„ ê°€ëŠ¥í•˜ì§€ë©´ ì•„ë¬´ ë ˆì§€ìŠ¤í„°ê°’ì´ë‚˜ ìŠ¤íƒì— í•˜ë‚˜ ì¶”ê°€í•´ë„ ë™ì¼í•¨
    push    ecs     ; ì§€ì—­ë³€ìˆ˜ê°€ 4ë°”ì´íŠ¸ì¼ ê²½ìš° ì´ê²Œ ë” ë¹ ë¦„.
    push    2
    push    1
    call    _add
    add     esp, 8
    mov     eax, dword ptr[ebp-4], 
    
    ; mov    eax, 0     ; return 0 ì˜ í‘œí˜„ì¸ë° ì´ê±°ë³´ë‹¤ ì•„ë˜ê°€ ë¹ ë¥´ë‹¤
    xor     eax, eax    ; return 0ì„ ì´ë ‡ê²Œë„ í‘œí˜„ê°€ëŠ¥
    mov     esp, ebp
    pop     ebp
    ret
end
```

<br>

### ë¹Œë“œí•´ë³´ê¸°

ğŸ˜º ê³¼ì—° sample_asm.asmë¥¼ ë¹Œë“œí•˜ë©´ ë¹Œë“œê°€ ë ê¹Œ? ğŸ‘‰ Nope! mainì„ ì •ì˜í•˜ì§€ ì•ŠìŒ

* ë‚´ê°€ ë§Œë“  .asmíŒŒì¼ì˜ mainì„ ì •ì˜í•˜ëŠ” ë°©ë²•
    * `_mainCRTStartup` ì„ í•¨ìˆ˜ ì¶”ê°€
    * `/entry` ì˜µì…˜ì„ ì‚¬ìš©í•´ ì‹œì‘í•¨ìˆ˜ë¥¼ ì§€ì • : `$ ml sample_asm.asm /link /entry:main`