---
layout: default
title: "11. Kernel Object ë€?"
parent: (Windows API)
grand_parent: (C++)
nav_order: 2
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## í”„ë¡œì„¸ìŠ¤ê°„ ì»¨íŠ¸ë¡¤ ì§ˆë¬¸?

* A, Bë¼ëŠ” ë³„ë„ì˜ í”„ë¡œì„¸ìŠ¤ê°€ ì¡´ì¬í•  ì‹œ<br>
    * Aì˜ í•¸ë“¤ì„ Bì—ì„œ ë°›ì•„ì„œ ì‚¬ì´ì¦ˆ ì¡°ì •ì´ ê°€ëŠ¥í• ê¹Œ? ğŸ‘‰ ê°€ëŠ¥(ìœˆë„ìš° í•¸ë“¤ì€ public to all processes)
    * Aì—ì„œ ë§Œë“  GUI íŒ¬ì„ Bì—ì„œ ê·¸ë¦¼ê·¸ë¦¬ê¸°ê°€ ê°€ëŠ¥í• ê¹Œ? ğŸ‘‰ ë¶ˆê°€ëŠ¥(private to a process)
    * Aì—ì„œ ë§Œë“  íŒŒì¼ì„ Bì—ì„œ íŒŒì¼í•¸ë“¤ì„ í†µí•´ ì ‘ê·¼ì´ ê°€ëŠ¥í• ê¹Œ ğŸ‘‰ ìƒí™©ì— ë”°ë¼ ë‹¤ë¦„(process specific) ì–´ë–»ê²Œ í•¸ë“¤ì„ ì „ë‹¬í–ˆëŠëƒì— ë”°ë¼ ë‹¤ë¥´ë‹¤

ğŸ˜º ìœ„ì˜ ì˜ˆì‹œë¡œ ë³´ë©´ ì•Œê² ì§€ë§Œ í”„ë¡œì„¸ìŠ¤ì˜ ì»¨íŠ¸ë¡¤ì€ ì„¸ ê°€ì§€ ì ‘ê·¼ ê¶Œí•œì´ ìˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.

* ìœˆë„ìš° í•¸ë“¤ì€ public to all processes
* private to a process
* process specific

ğŸ˜º ì„¸ ê°€ì§€ ì ‘ê·¼ ê¶Œí•œì— ëŒ€í•´ ì¡°ê¸ˆ ë” ìì„¸íˆ ì„¤ëª…í•œë‹¤.

---

* Win32ì—ì„œ ìƒì„±í•˜ëŠ” ObjectëŠ” ëª¨ë‘ `CreateXXX`ì„ í†µí•´ ë§Œë“ ë‹¤
* `CreateXXX`ë¡œ ìƒì„±í•  ê²½ìš° Window Objectê°€ ìƒì„±ë˜ë©° ì„¸ ê°€ì§€ ì¢…ë¥˜ë¡œ ë‚˜ë‰œë‹¤

* User Object
    * ìœˆë„ìš°ì™€ ê´€ë ¨ëœ Object (ìœˆë„ìš° ì°½, ë©”ë‰´ ì°½ ë“±)
    * **public to all processes**
    * íŒŒê´´ í•¨ìˆ˜ : DestroyXXX()
    * ê´€ë ¨ DLL : User32.dll
* GDI Object
    * ê·¸ë˜í”½ ê´€ë ¨ Object (í°íŠ¸, í”„ëŸ¬ì‰¬ ë“±)
    * **private to a process**
    * íŒŒê´´ í•¨ìˆ˜ : DeleteXXX()
    * ê´€ë ¨ DLL : Gdi32.dll
* Kernel Object
    * íŒŒì¼, ë©”ëª¨ë¦¬, í”„ë¡œì„¸ìŠ¤ë“± UI ì´ì™¸ì˜ ì‘ì—…ì— ê´€ë ¨ëœ Object
    * **process specific**
    * íŒŒê´´ í•¨ìˆ˜ : CloseHandleXXX()
    * ê´€ë ¨ DLL : Kernel.dll

* [ì°¸ê³ ì‚¬ì´íŠ¸](https://docs.microsoft.com/en-us/windows/win32/sysinfo/object-categories)

---

## Kernel Object

* ì»¤ë„(Kernel Object)ëŠ” ì•„ë˜ì™€ ê°™ì´ êµ¬ì„±ë˜ì–´ìˆë‹¤
    * ë³´ì•ˆ ì†ì„±(Security Attribute)
    * ì´ë¦„
    * ì°¸ì¡° ê³„ìˆ˜(Reference Counting)
    * SIGNAL
    * WAIT LIST
    * ...(ê¸°íƒ€)

ğŸ˜º ëŒ€í‘œì ì¸ ì˜ˆë¡œ `CreateWaitableTimerEx`ë¥¼ ë³´ìë©´ ì´ê²Œ User, GDI, Kernel Objectì¤‘ ë­ì¸ì§€ í—·ê°ˆë¦´ìˆ˜ ìˆëŠ”ë° ë³´ì•ˆì„¤ì •ì„ ì„¤ì •í•¨ì„ ë´ì„  Kernel Objectì„ì„ ì•ˆë‹¤

ğŸ˜º User Object, GDI ObjectëŠ” ë³„ë„ì˜ ë³´ì•ˆì†ì„±ì´ ì—†ë‹¤(ì‚¬ì‹¤ í•„ìš”ê°€ ì—†ë‹¤ê°€ ë” ë§ìŒ)

```cpp
HANDLE CreateWaitableTimerExW(
  LPSECURITY_ATTRIBUTES lpTimerAttributes,      // ë³´ì•ˆì†ì„±ì„ ì„¤ì •í•¨ì„ ë³¼ìˆ˜ìˆìŒ
  LPCWSTR               lpTimerName,
  DWORD                 dwFlags,
  DWORD                 dwDesiredAccess
);
```

<br>

ğŸ˜º ì»¤ë„ì˜¤ë¸Œì íŠ¸ í•¸ë“¤ì„ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì— ë„˜ê¸¸ìˆ˜ ìˆì„ê¹Œ?

```cpp
#include <stdio.h>
#include <Windows.h>
#include <tchar.h>

int _tmain()
{
    HANDLE hFile = CreateFile(_T("a.txt"), /* ... */);
    _tprintf(_T("FILE HANDLE : %x\n"), hFile);

    // ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì— íŒŒì¼ í•¸ë“¤ ì „ë‹¬?
    HWND hwnd = FindWindow(0, _T("Friend"));
    SendMessage(hwnd, WM_APP+100, 0, (LPARAM)hFile);
}
```

<br>

ğŸ˜º ìš°ì„  ì²« ë²ˆì§¸ ë¬¸ì œëŠ” **ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì—ì„œ íŒŒì¼ì˜ í•¸ë“¤ì„ ì‚¬ìš©í•˜ì§€ ëª»í•œë‹¤.** ë„˜ê²¨ì¤€ í•¸ë“¤ì€ ì‹¤ì œ ë¬¼ë¦¬ì  ì£¼ì†Œê°’ì„ ì˜ë¯¸í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ Kernelë‚´ë¶€ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” Object Tableë‚´ì˜ indexì´ë‹¤.

ğŸ˜º í•´ë‹¹ indexì—ì„œ íŒŒì¼ì´ ì ‘ê·¼ ê°€ëŠ¥í•œì§€ ì“¸ ìˆ˜ ìˆëŠ”ì§€ ë“±ì„ OSì—ì„œ ì•Œë ¤ì£¼ê³  íŒŒì¼ì— ì ‘ê·¼í•˜ê²Œ ëœë‹¤.<br>
ë”°ë¼ì„œ íŒŒì¼ì˜ í•¸ë“¤(ë‹¨ìˆœ index)ë§Œìœ¼ë¡  íŒŒì¼ì— ì ‘ê·¼ì´ ë¶ˆê°€ëŠ¥ í•˜ë‹¤.

---

### PKO(Process Kernel Object)

ğŸ˜º ì¢€ ë” ìì„¸íˆ ì„¤ëª…í•˜ìë©´ í”„ë¡œì„¸ìŠ¤ë§ˆë‹¤ PKO(Process Kernel Object)ë¥¼ ê´€ë¦¬í•œë‹¤. 

* `CreateFile`ì„ í• ê²½ìš° File Kernel Objectê°€ ìƒì„±ë˜ë©° ë‚´ë¶€ì— ì°¸ì¡°ê³„ìˆ˜ë¥¼ 1 ì˜¬ë¦°ë‹¤
* File Kernel Objectë¥¼ ìƒì„±í•œ í”„ë¡œì„¸ìŠ¤ëŠ” PKOì—ì„œ ìƒì„±ëœ File Kernel Objectë¥¼ ë“±ë¡í•˜ê³  ë¬¼ë¦¬ì£¼ì†Œë¥¼ ê¸°ë¡í•œë‹¤.
* ë”°ë¼ì„œ ê·¸ëƒ¥ HANDLEì„ ì „ë‹¬í•œë‹¤ë©´ ì „ë‹¬ë°›ì€ í”„ë¡œì„¸ìŠ¤ëŠ” ìì‹ ì˜ PKOì—ì„œ  HANDLEì„ ì°¾ì•„ë³´ê³  ì—†ë‹¤ë©´ ì‚¬ìš©ë¶ˆê°€!

* ê·¸ë˜ë„ í•˜ê³ ì‹¶ë‹¤ë©´? -> `DuplicateHandle()`ê³¼ ê°™ì€ Win32ì—ì„œ ì œê³µí•˜ëŠ” APIë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
* `DuplicateHandle()`ëŠ” PKO ì£¼ì†Œìì²´ë¥¼ ë³µì‚¬í•´ì¤€ë‹¤
* ê·¸ë ‡ê²Œ ë˜ëŠ”ìˆœê°„ File Kernel Objectì˜ ì°¸ì¡°ê³„ìˆ˜ëŠ” 1ì¦ê°€í•œë‹¤

* ì°¸ê³ ) ì°¸ì¡° ê³„ìˆ˜ë¡œ ê´€ë¦¬ë˜ëŠ” Kernel ObjectëŠ” í”„ë¡œì„¸ìŠ¤ì˜ ìƒëª…ì£¼ê¸°ì™€ ì¼ì¹˜í•˜ì§€ ì•Šê¸°ì— **OSê°€ ì†Œìœ **í•œë‹¤ê³  í•œë‹¤
* ì°¸ê³ ) `CloseHandle()`ì„ í†µí•´ì„œ ì°¸ì¡° ê³„ìˆ˜ì˜ ì¹´ìš´íŠ¸ë¥¼ 1ì¤„ì´ê²Œ ëœë‹¤(Handleì„ ì‚¬ìš©í•˜ê³  CloseHandleì„ í•˜ëŠ” ì´ìœ !)

```cpp
#include <stdio.h>
#include <Windows.h>
#include <tchar.h>

int _tmain()
{
    HANDLE hFile = CreateFile(_T("a.txt"), /* ... */);
    _tprintf(_T("FILE HANDLE : %x\n"), hFile);

    // DuplicateHandle ì¨ë³´ê¸°
    HWND hwnd = FindWindow(0, _T("Friend"));

    // FILEì˜ í•¸ë“¤ì„ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì— ë³µì‚¬í•˜ê¸°
    // 1. í”„ë¡œì„¸ìŠ¤ IDêµ¬í•˜ê¸°
    DWORD pid;
    DWORD tid = GetWindowThreadProcessId(hwnd, &pid);

    // 2. í”„ë¡œì„¸ìŠ¤ IDë¥¼ ê°€ì§€ê³  í•¸ë“¤ ì–»ê¸°
    HANDLE hProcess = OpenProcess(PROCESS_DUP_HANDLE, 0, pid);

    // 3. DuplicateHandle() í•¨ìˆ˜ë¡œ í•¸ë“¤ ë³µì‚¬
    HANDLE handle;  // ìƒëŒ€ë°© í…Œì´ë¸”ì˜ í•¸ë“¤
    DuplicateHandle(GetCurrentProcess(), hFile,
                    hProcess, &handle,
                    DUPLICATE_SAME_ACCESS, 0, 0);

    SendMessage(hwnd, WM_APP + 100, 0, (LPARAM)handle);
}
```

```cpp
LRESULT __stdcall WndProc(HWND /* ... */)
{
    switch(message)
    {
    case WM_APP + 100;
    {
        HANDLE hFile = (HANDLE)lParam;

        DWORD len;
        char data[256] = "hello";

        BOOL b = WriteFile(hFile, data, 256, &len);

        CloseHandle(hFile);
    }
    }
}
```

<br>

### PKOë¥¼ ì§ì ‘í™•ì¸í•  ë°©ë²•ì€?

ğŸ˜º [ProcessExplorer.exe](https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer)ë¥¼ ì´ìš©í•˜ì(ì£¼ì˜í•  ì ì€ ê´€ë¦¬ì ëª¨ë“œë¡œ ì‹¤í–‰)

```cpp
int _tmain()
{
    getchar();
    HANDLE h1 = CreateFile(_T("a.txt"),
                GENERIC_READ | GENERIC_WRITE,
                FILE_SHARE_READ | FILE_SHARE_WRITE,
                0, CREATE_ALWAYS,
                FILE_ATTRIBUTE_NORMAL, 0);

    getchar();
    HANDLE h2 = CreateEvent(0, 0, 0, _T("MyEvent"));

    getchar();
    HANDLE h3 = CreateMutex(0, 0, _T("MyMutex"));

    getchar(); CloseHandle(h3);
    getchar(); CloseHandle(h2);
    getchar(); CloseHandle(h1);
}
```

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/cpp/win32api/win32-11-1.png" style="border-radius:5%;border:1px solid #e6e1e8"/>
</p>
