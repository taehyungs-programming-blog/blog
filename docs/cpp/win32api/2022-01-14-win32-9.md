---
layout: default
title: "9. Dynamic Library ë§Œë“¤ê¸° & ì‚¬ìš©í•˜ê¸°(ê¸°ì´ˆ)"
parent: (Windows API)
grand_parent: C++
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## Dynamic Library ë§Œë“¤ê¸°

```cpp
// mymath.c

int add(int a, int b)
{
    return a + b;
}

int __stdcall sub(int a, int b)
{
    return a - b;
}
```

```s
$ cl mymath.c /c
$ link mymath.obj /DLL  # DLLì´ ìƒì„±ë¨

# or

$ cl mymath.c /LD  # DLLì´ ìƒì„±ë¨
```

---

## DLLì˜ ë‚´ë¶€ êµ¬ì¡°(PE Format)?

ğŸ˜º DLLë„ ê²°êµ­ PE í¬ë§·ì´ê³  ë‚´ë¶€ì ìœ¼ë¡ 

```
PE Header
===
Section .text(_addí•¨ìˆ˜(Code))
Section .edata(_addí•¨ìˆ˜ì˜ exportì •ë³´)
...
```

<br>

ğŸ˜º ë”°ë¼ì„œ DLLì„ callí•˜ëŠ” exeëŠ” DLLì˜ .edataì •ë³´ë¥¼ ë³´ê³  DLLì˜ í•¨ìˆ˜ë¥¼ ë¶ˆëŸ¬ì˜¨ë‹¤.

ğŸ˜º ì°¸ê³ ë¡œ ë¦´ë¦¬ì¦ˆì—ì„œëŠ” ìµœì í™”ë¥¼ ìœ„í•´ .edataë¥¼ ë”°ë¡œ ë‘ê¸°ë³´ë‹¨, .rdata .textì— .edata(DLLí•¨ìˆ˜ì •ë³´)ë¥¼ í¬í•¨ë˜ëŠ” ê²½ìš°ê°€ ë§ë‹¤

* .edataì— í•¨ìˆ˜ ì •ë³´ë¥¼ ì¶”ê°€í•˜ê¸° ìœ„í•´ì„œ, í•¨ìˆ˜ ì•ì— `__declspec(dllexport)` ì§€ì‹œì–´ ì¶”ê°€
* ëª¨ë“ˆ ì •ì˜ íŒŒì¼(.def) ì‚¬ìš©(ë‚˜ì¤‘ì— ì •ë¦¬)

```cpp
// mymath.c

__declspec(dllexport) int add(int a, int b)
{
    return a + b;
}

__declspec(dllexport) int __stdcall sub(int a, int b)
{
    return a - b;
}
```

<br>

ğŸ˜º DLLë¥¼ ìƒì„±í•´ë³´ë©´ .dll ë¿ë§Œ ì•„ë‹ˆë¼ .libë„ ìƒì„±ëœë‹¤? 

* .libíŒŒì¼ì˜ ì¢…ë¥˜
    * ì •ì  ë¼ì´ë¸ŒëŸ¬ë¦¬ : í•¨ìˆ˜ì˜ ê¸°ê³„ì–´ ì½”ë“œë¥¼ ë‹´ê³ ìˆëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬
    * DLLìƒì„±ì‹œ ë§Œë“¤ì–´ì§€ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ : exportë˜ëŠ” í•¨ìˆ˜ì˜ ë§í¬ ì •ë³´(ë§í‚¹í• ë•Œ í•„ìš”í•œ ì •ë³´)ë§Œì„ ë‹´ì€ íŒŒì¼

---

## Dynamic Library ë°°í¬

ğŸ˜º í—¤ë”ë¥¼ ì•„ë˜ì™€ ê°™ì´ êµ¬ì„±

```cpp
// mymath.h
#pragma once

#ifdef __cplusplus
extern "C" {
#endif

    // ê°€ì ¸ì˜¬ ì •ë³´ë¥¼ importí•œë‹¤
    // ë¬¼ë¡  __declspec(dllimport)ë¥¼ ìƒëµí•´ë„ ë˜ì§€ë§Œ ë¶™ì´ëŠ”ê²Œ íš¨ìœ¨ì 
    __declspec(dllimport) int add(int a, int b);
    __declspec(dllimport) int sub(int a, int b);

#ifdef __cplusplus
}
#endif
```

<br>

* ì‚¬ìš©ì¤‘ì¸ DLL í•¨ìˆ˜ í™•ì¸í•˜ê¸°
    * PEView.exe : ì‚¬ìš©ì¤‘ì¸ exeí™•ì¸
    * `$ dumpbin.exe íŒŒì¼ì´ë¦„ /import` : ì‚¬ìš©ì¤‘ì¸ DLL í•¨ìˆ˜ í™•ì¸ê°€ëŠ¥

```cpp
#include <stdio.h>
#include <mymath.h>

// ë§í‚¹ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤
#pragma comment(lib, "mydynamic.lib")

int main()
{
    int ret = add(1, 2)
    printf("result  %d\n", ret);
}
```

<br>

---

## MessageBoxì™€ ê°™ì€ Win32 ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ë™ì , ì •ì  ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¤‘ ë­˜ê¹Œ?

```cpp
#include <stdio.h>
#include <Windows.h>

int main()
{
    MeesageBoxA(0, "A", "B", MB_OK);
    // Windows APIëŠ” DLLë¡œ ì œê³µì´ ëœë‹¤.
    // ê·¸ëŸ¼ dll, lib, hì˜ ì¶”ê°€ëŠ” ì–´ë””ì„œ ì§„í–‰ì´ ë ê¹Œ?

    printf("hello\n");
}
```

<br>

* ì¼ë‹¨ .hëŠ” `#include <Windows.h>`
* libëŠ”? **í”„ë¡œì íŠ¸ ì†ì„± -> ë§ì»¤**ì— ë””í´íŠ¸ë¡œ ì¶”ê°€ ë˜ì–´ìˆë‹¤.
    * ìœ„ ë°©ì‹ì€ IDEì—ì„œ ë¹Œë“œí•œ ë°©ì‹ì´ê³  ëª…ë ¹í”„ë¡¬í”„íŠ¸ì—ì„œ ë¹Œë“œí•˜ë ¤ë©´
    * `$ cl main.c user32.lib`
    * ì‚¬ìš©í•˜ëŠ” DLLì„ ë„£ì–´ì¤˜ì•¼í•¨

---

## printfì™€ ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ë™ì , ì •ì  ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¤‘ ë­˜ê¹Œ?

ğŸ˜º ê·¸ëŸ¼ `printf`ëŠ”?

ğŸ˜º ì´ëŸ° Cí‘œì¤€ í•¨ìˆ˜ë¥¼ **CRTí•¨ìˆ˜**ë¼ í•œë‹¤. CRTí•¨ìˆ˜ëŠ” ì •ì /ë™ì  ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ëª¨ë‘ ì œê³µí•œë‹¤.

* ë‚´ ì‹¤í–‰íŒŒì¼ì— Cí‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í¬í•¨í•´ ë‹¬ë¼
    * ì •ì ë¼ì´ë¸ŒëŸ¬ë¦¬(libucrt.lib) : `/MT`(Multi-Threaded)
    * ì •ì ë¼ì´ë¸ŒëŸ¬ë¦¬ ë””ë²„ê·¸(libucrtd.lib) : `/MTd`
    * Cí‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‹¤í–‰íŒŒì¼ì— í¬í•¨
    * ë‚´ ì‹¤í–‰íŒŒì¼ HEAPì— Cí‘œì¤€ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì˜¬ë¼ê°„ë‹¤
* ë‚´ ì‹¤í–‰íŒŒì¼ì— Cí‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¯¸í¬í•¨
    * ë™ì ë¼ì´ë¸ŒëŸ¬ë¦¬(ucrtbase.dll) : `/MD`(Multi-Threaded DLL)
    * ë™ì ë¼ì´ë¸ŒëŸ¬ë¦¬ ë””ë²„ê·¸(ucrtbased.dll) : `/MDd`
    * Cí‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ DLLí˜•íƒœë¡œ ì œê³µ(Cí‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ì•Šë‹¤ë©´ ë…ë¦½ì  ì‹¤í–‰ë¶ˆê°€)

* ë§Œì•½ ë‚´ ì‹¤í–‰íŒŒì¼(.exe) + ë‹¤ë¥¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ (.dll)ì„ ì¨ì•¼í•˜ëŠ” ìƒí™©ì´ë¼ë©´
    * `/MT` : ë‚´ ì‹¤í–‰íŒŒì¼(.exe) + ë‹¤ë¥¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ (.dll) ê°ê° heapì— crtë¥¼ ì˜¬ë¦°ë‹¤
    * `/MD` : ë³„ë„ì˜ crtìš© ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹
    * ì´ê²Œ ë¬¸ì œê°€ `/MT`ì—ì„œ crt ë©”ëª¨ë¦¬ í•´ì œì‹œ ë‹¤ë¥¸ heapì˜ crtë©”ëª¨ë¦¬ ë©”ëª¨ë¦¬ë¥¼ í•´ì œí•˜ë ¤ê³  í•˜ë‹¤ ì£½ëŠ” í˜„ìƒì´ ë°œìƒí•  ìˆ˜ ìˆê¸°ì— ì£¼ì˜í•´ì•¼í•œë‹¤

ğŸ˜º ì¼ë°˜ì ìœ¼ë¡œ IDEë¥¼ ì“°ë©´ **ë™ì ë¼ì´ë¸ŒëŸ¬ë¦¬**(`/MD`) ë²„ì „ì„ ì‚¬ìš©í•˜ê²Œ ë¨.

* [/MT /MD ì°¨ì´ ğŸŒ](https://blog.naver.com/PostView.naver?blogId=ppusarida&logNo=40167344277&redirect=Dlog&widgetTypeCall=true&directAccess=false)


---

### CRT ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ì¶©ëŒ

```cpp
// main.exe

int main()
{
    void* p = Alloc(100);
    free(p);
    // main.exeì—ì„œëŠ” CRT ë™ì  ë¼ì´ë¸ŒëŸ¬ë¦¬(/MD) ì‚¬ìš©
}
```

```cpp
// Sample.dll

void * Alloc(int size)
{
    return malloc(size);
    // Sample.dllì—ì„œëŠ” CRT ì •ì  ë¼ì´ë¸ŒëŸ¬ë¦¬(/MT) ì‚¬ìš©
}
```

* CRT ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „ì„ ë§ì¶”ì–´ì•¼ í•œë‹¤
* DLL ë‚´ì—ì„œ ìì› í• ë‹¹ í•œ ê²½ìš° DLL ì—ì„œ ìì› í•´ì§€í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.

---

## DLL ëª…ì‹œì  ì—°ê²°ì˜ ë¬¸ì œì (Explicit Linking)

```cpp
#include <stdio.h>
#include <Windows.h>
#include <tchar.h>

#include "mydynamic.h"

#pragma comment(lib, "mydynamic.lib")

int main()
{
    int ret = add(1, 2);
    printf("result : %d\n", ret);
}
```

* ì•”ì‹œì  ì—°ê²°(implicit linking) : ì‹¤í–‰íŒŒì¼ ì‹¤í–‰ ì‹œ ë™ì‹œì— DLLì— Load(.idata ì„¹ì…˜ì— ì˜¬ë¼ê°€ê²Œ ëœë‹¤)
* ëª…ì‹œì  ì—°ê²°(explicit linking) : DLLì´ í•„ìš”í• ë•Œ `LoadLibrary` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ DLL ë¡œë“œ

```cpp
#include <stdio.h>
#include <Windows.h>
#include <tchar.h>

typedef int (*F)(int, int);

int main()
{
    getchar();
    // 1. DLL ë¡œë“œ
    HMODULE hDll = LoadLibrary(_T("MyDynamic.dll"));
    printf("DLL ì£¼ì†Œ : %p\n", hDll);

    // 2. DLL ì•ˆì—ì„œ í•¨ìˆ˜ ì°¾ê¸°
    F f = (F)GetProcAddress(hDll, "add");
    // hDllì—ì„œ addë¥¼ ì°¾ì•„ë‹¬ë¼
    printf("í•¨ìˆ˜ ì£¼ì†Œ : %p\n", f);

    int ret = f(1, 2);
    printf("result : %d\n", ret);

    // 3. DLL ì–¸ë¡œë“œ
    FreeLibrary(hDll);
}
```

```cpp
// ë‹¨, ì½œë§ ì»¨ë²¤ì…˜ìœ¼ë¡œ ì¸í•´ì„œ
F f = (F)GetProcAddress(hDll, "sub");       // ëª»ì°¾ìŒ(subëŠ” __stdcallë¡œ ë§Œë“¤ì–´ì§Š)
F f2 = (F)GetProcAddress(hDll, "_sub@8");   // ì°¾ìŒ, ì½œë§ ì»¨ë²¤ì…˜ì— ë”°ë¼ ì´ë¦„ì„ ë°”ê¿”ì„œ ì°¾ì•„ì•¼ í•¨ì„ ê¸°ì–µ
printf("í•¨ìˆ˜ ì£¼ì†Œ : %p\n", f);               // 0
printf("í•¨ìˆ˜ ì£¼ì†Œ : %p\n", f2);

int ret = f2(1, 2);             // Error - ì½œë§ ì»¨ë²¤ì…˜ì´ ë‹¬ë¼ ë©”ëª¨ë¦¬í•´ì§€ ì•ˆë¨.
printf("result : %d\n", ret);
```

ğŸ˜º í•´ê²°ì±…?

```cpp
typedef int (__stdcall *F2)(int, int);

F2 f2 = (F2)GetProcAddress(hDll, "_sub@8");

int ret = f2(1, 2);     // ok
```