---
layout: default
title: "25. API Hooking"
parent: (Windows API)
grand_parent: C++
nav_order: 3
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## API Hooking ì´ë€

```cpp
#include <Windows.h>
#include <stdio.h>

int main()
{
    MessageBoxA(0, "API Hooking", "AAA", 0);
}
```

<br>

ğŸ˜º ìœ„ ì½”ë“œ ì²˜ëŸ¼ `MessageBoxA` APIë¥¼ ë¶€ë¥´ê¸° ì§ì „ `foo`ë¼ëŠ” í•¨ìˆ˜ë¥¼ ë¼ì›Œ ë„£ê³ ì‹¶ë‹¤? ğŸ‘‰ API Hooking

---

## API Hooking ê¸°ìˆ 

* IAT Hook (ìš°ë¦¬ê°€ ì‚¬ìš©í•  ê²ƒ)
* Detour
* Debugging API
* Trojan horse

---

## IAT Hook

ğŸ˜º ì¼ë‹¨ DLL í•¨ìˆ˜ì˜ í˜¸ì¶œ ì›ë¦¬ë¥¼ ë¨¼ì € ì•Œì•„ì•¼ í•œë‹¤.

```

# mainì—ì„œ MessageBoxAì€ ì–´ë–»ê²Œ ë¶€ë¥¼ê¹Œ?

|----------------------------|
|                            |
|                            |
|                            |
|                            |
|------(user32.dll))---------|
|                            |
|    MessageBoxA()           | <- 0x7717 0F40
|                            |
|                            |
|                            |
|                            |
|-----------(.exe)-----------|
|    int main()              |
|      MessageBoxA()         | <- call 0x7717 0F40ì„ í• ê¹Œ?
|                            |
|                            |
|                            |
 Process Virtual Address Space

```

<br>

ğŸ˜º ì•Œê³  ì‹¶ì€ì ì´ `MessageBoxA()`ë¥¼ í˜¸ì¶œí•˜ë©´ ë¬´ì¡°ê±´ `0x7717 0F40`ë¥¼ ì½œí•˜ëƒëŠ” ë¬¸ì œì´ë‹¤.

ğŸ˜º ìš°ì„  .exeì—ì„œ `MessageBoxA()`ê°€ `0x7717 0F40`ì— ìˆì„êº¼ë¼ëŠ” ë³´ì¥ì´ ì—†ë‹¤.

ğŸ˜º DLLì´ í˜¸ì¶œë˜ë‹¤ ë©”ëª¨ë¦¬ ê³µê°„ì˜ ë¶€ì¡±ìœ¼ë¡œ Relocationë˜ì—ˆì„ í™•ë¥ ì´ ìˆê¸° ë•Œë¬¸ì´ë‹¤.

ğŸ˜º ë”°ë¼ì„œ DLLë‚´ì˜ í•¨ìˆ˜ì˜ ì£¼ì†ŒëŠ” exeê°€ ì‹¤í–‰ë˜ê³  DLLì´ ì™„ì „íˆ ë¡œë“œ ëœ í›„ ê²°ì •ëœë‹¤.

* DLLì—ëŠ” ìì‹ ì´ ë…¸ì¶œí•˜ëŠ” **í•¨ìˆ˜**ì˜ Offset ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆë‹¤(Export Address Table)
    * PEí¬ë§·ì˜ `.edata`ë¥¼ í™•ì¸ì‹œ í•¨ìˆ˜ Offsetì •ë³´ê°€ ë‚˜ì˜¤ëŠ”ë° .dllì˜ ì‹œì‘ì ì—ì„œ ì–¼ë§ˆë‚˜ ë–¨ì–´ì ¸ ìˆëŠ”ì§€ì— ëŒ€í•œ ì •ë³´ì´ë‹¤.
    * ì°¸ê³ ë¡œ `.edata`ê°€ ì—†ë‹¤ë©´ `.rdata`ë¥¼ ì°¾ì•„ë³¼ ê²ƒ
* DLLì„ ì‚¬ìš©í•˜ëŠ” ëª¨ë“ˆ(exe)ì—ëŠ” DLLì˜ ì´ë¦„ê³¼ í•¨ìˆ˜ ì´ë¦„, í•¨ìˆ˜ ì£¼ì†Œë¥¼ ë‹´ì„ ìˆ˜ ìˆëŠ” í…Œì´ë¸”ì„ ê°€ì§€ê³  ìˆë‹¤.
    * `.idata`ë¥¼ í™•ì¸ ë‹¨, íŒŒì¼ë¡œ ìˆì„ë•ŒëŠ” ì˜ë¯¸ì—†ëŠ” ì •ë³´ë¥¼ ì±„ì›Œ ë„£ìŒ ì´í›„ì— ì‹¤í–‰ë  ì‹œ ì‹¤ì œ í•¨ìˆ˜ì˜ ì£¼ì†Œê°€ ë“¤ì–´ê°„ë‹¤.

ğŸ˜º **ì´ê±¸ ì™œ ì´ë¦¬ ê¸¸ê²Œ ì„¤ëª…í•˜ëƒë©´,**

* ê²°êµ­ exeì—ëŠ” ì‚¬ìš©í•˜ëŠ” DLL í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ í…Œì´ë¸”ë¡œ ê´€ë¦¬
* exeì—ì„œ DLLì˜ í•¨ìˆ˜ë¥¼ ì‚¬ìš©ì‹œ ê´€ë¦¬ì¤‘ì¸ í…Œì´ë¸”ì—ì„œ ì£¼ì†Œë¥¼ êº¼ë‚´ì–´ ì‚¬ìš©
* ë§Œì•½ ì´ êº¼ë‚´ëŠ” ì£¼ì†Œë¥¼ ê°€ë¡œì±Œ ìˆ˜ ìˆë‹¤ë©´??? -> **IAT Hook(Import Addres Table Hook)**ì´ ê°€ëŠ¥í•˜ë‹¤

---

## Example

* í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ëª‡ê°€ì§€ ì œì•½ì‚¬í•­ì„ ë‘”ë‹¤.
	* 32bit debug
	* í”„ë¡œì íŠ¸ -> ì†ì„± -> ë§ì»¤ -> ê³ ê¸‰ -> ì„ì˜ ê¸°ì¤€ ì£¼ì†Œ -> ì•„ë‹ˆìš”
		* dll, exeì£¼ì†Œë¥¼ ì‹¤í–‰ë§ˆë‹¤ ë°”ê¾¸ëŠ”ì§€ ì—¬ë¶€ë¥¼ ì•„ë‹ˆì˜¤ë¡œ ì„¤ì •

```cpp
// 32bit debug ëª¨ë“œ
#include <Windows.h>
#include <stdio.h>

// MessageBoxAë¥¼ í›„í‚¹í•  í•¨ìˆ˜ëŠ” í•¨ìˆ˜ì˜ ëª¨ì–‘ì´ ë™ì¼í•´ì•¼ í•œë‹¤.
UINT _stdcall foo(HWND hwnd, const char* s1, const char* s2, UINT btn)
{
    printf("foo : %s, %s\n", s1, s2);
    return 0;
}

int main()
{
    MessageBoxA(0, "API Hook", "AAA", 0);   // ì—¬ê¸° ë¸Œë ˆì´í¬ í¬ì¸íŠ¸ë¥¼ ê±¸ê³ 
    // í”„ë¡œì íŠ¸ -> ì†ì„± -> ë§ì»¤ -> ê³ ê¸‰ -> ì„ì˜ ê¸°ì¤€ ì£¼ì†Œ -> ì•„ë‹ˆìš”(dll, exeì£¼ì†Œë¥¼ ì‹¤í–‰ë§ˆë‹¤ ë°”ê¾¸ëŠ”ì§€ ì—¬ë¶€)
    // Ctrl + Alt + d : ë””ìŠ¤ ì–´ì…ˆë¸”ë¦¬ì°½
    // call dword ptr [__import__MessageBoxA@16(0D4b098h)]
    // Ctrl + Alt + m : ë©”ëª¨ë¦¬ì°½
    // ë©”ëª¨ë¦¬ ì°½ì—ì„œ í™•ì¸ëœ ì£¼ì†Œê°€ MessageBoxAì˜ ì£¼ì†Œì´ë‹¤.
}
```

<br>

* ì°¸ê³ ë¡œ ASLR(Address Space Layout Randomization) ì‹¤í–‰ì‹œ exe, dll, stack, hepì˜ ì£¼ì†Œë¥¼ ì„ì˜ë¡œ ë³€ê²½í•˜ëŠ” ë³´ì•ˆê°œë…ì„ ì•Œê³ ìˆì

ğŸ˜º ì—¬ê¸°ê¹Œì§€í•˜ë©´ `MessageBoxA`ì˜ ì£¼ì†Œë¥¼ ì•Œì•˜ë‹¤

```cpp
int main()
{
    // MessageBoxAì˜ ì£¼ì†Œë¥¼ ë‹´ì€ IAT í•­ëª©ì„ ë®ì–´ì“´ë‹¤.

    // ìš°ì„  MessageBoxA ì£¼ì†Œì˜ ë³´í˜¸ì†ì„±ì„ ë³€ê²½í•´ì•¼ ë‹¤ë¥¸ì£¼ì†Œë¥¼ ì“¸ ìˆ˜ ìˆë‹¤.
    DWROD old;
    VirtualProtect((void*)0x041B098, sizeof(void*), PAGE_READWRITE, &old);

    *((int*)0x041B098) = (int)&foo;     // ì•ì—ì„œ êµ¬í•œ MessageBoxAì˜ ì£¼ì†Œ

    MessageBoxA(0, "API Hook", "AAA", 0);
}
```

<br>

ğŸ˜º ì—¬ê¸°ê¹Œì§€í•˜ë©´ `foo`ê°€ í˜¸ì¶œì€ ë˜ì§€ë§Œ `MessageBox`ëŠ” í˜¸ì¶œì´ ë˜ì§€ ì•ŠëŠ”ë‹¤. `MessageBox`ê¹Œì§€ í˜¸ì¶œí•´ë³´ì

```cpp
typedef UINT (_stdcall *F)(HWND hwnd, const char* s1, const char* s2, UINT btn);

UINT _stdcall foo(HWND hwnd, const char* s1, const char* s2, UINT btn)
{
    printf("foo : %s, %s\n", s1, s2);

	// do something

    // return MessageBoxA(hwnd, s1, s1, btn);   // ì¬ê·€ í˜¸ì¶œ ì´ë°©ë²•ì€ ì•ˆë¨.
    HMODULE hDll = GetModuleHandleA("user32.dll");  // Dllì˜ ì£¼ì†Œë¥¼ êµ¬í•˜ê³ 
    F f = (F)GetProcAddress(hDll, "MessageBoxA");   // í•¨ìˆ˜ì˜ ì£¼ì†Œê°€ ì–´ë”˜ì§€ êµ¬í•´ì„œ
    return f(hwnd, s2, s1, btn);    // ì§ì ‘ í˜¸ì¶œí•´ì¤€ë‹¤.
}
```

<br>

ğŸ˜º ë‹¨, ì—¬ê¸°ê¹Œì§€ëŠ” ì‹¤í–‰íŒŒì¼ì´ í•­ìƒ ê°™ì€ ë©”ëª¨ë¦¬ê³µê°„ì— ì˜¬ë¼ê°„ë‹¤ëŠ” ê°€ì •ì´ ìˆì—ˆë‹¤.

---

## Hookingí•  ì£¼ì†Œë¥¼ ëª¨ë¥¸ë‹¤ë©´?

```cpp
#include <Windows.h>
#include <stdio.h>
#include <DbgHelp.h>  	// for ImageDirectoryEntryToData
#pragma comment( lib, "DbgHelp.lib") 

typedef UINT(__stdcall* FUNC)(HWND, const char*, const char*, UINT);

UINT __stdcall foo(HWND hwnd, const char* s1, const char* s2, UINT btn)
{
	printf("foo : %s, %s\n", s1, s2);

	// do something

	HMODULE hDll = GetModuleHandleA("user32.dll");
	FUNC f = (FUNC)GetProcAddress(hDll, "MessageBoxA");
	return f(hwnd, s1, s2, btn);
}


/*
	// ì°¸ê³ )
	Replace(GetModuleHandle(0), //= API í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ëª¨ë“ˆ(exe)ì˜ ì£¼ì†Œ
		"user32.dll",			//= í›„í‚¹í•  í•¨ìˆ˜ê°€ ìˆëŠ” dllì´ë¦„
		&MessageBoxA,			//= í›„í‚¹í•  API í•¨ìˆ˜ ì£¼ì†Œ
		&foo);					//= ì‚¬ìš©ì í•¨ìˆ˜
*/

void Replace(HMODULE hExe, const char* dllname, void* api, void* func)
{
	// 1. .exeì—ì„œ import(.idata) ì„¹ì…˜ì˜ ì£¼ì†Œë¥¼ ì–»ì–´ë‚¸ë‹¤.
		// DbgHelp.dllì˜ ImageDirectoryEntryToDataí•¨ìˆ˜ë¥¼ ì´ìš©í•œë‹¤
	ULONG sz;
	IMAGE_IMPORT_DESCRIPTOR* pImage = 
		(IMAGE_IMPORT_DESCRIPTOR*)::ImageDirectoryEntryToData(hExe,
			TRUE, IMAGE_DIRECTORY_ENTRY_IMPORT, &sz);
		// hExeì˜ ImageDirectoryë¥¼ ë¦¬í„´í•´ì£¼ì„¸ìš”
		
	printf("Address Import Directory : %p\n", pImage);


	    




	// 2. í•´ë‹¹ DLLì˜ ì •ë³´ë¥¼ ê°€ì§„ í•­ëª©ì„ ì°¾ì•„ë‚¸ë‹¤.
	for (; pImage->Name; pImage++)
	{
		char* s = ((char*)hExe + pImage->Name);

		if (_strcmpi(s, dllname) == 0) break;
	}
	if (pImage->Name == 0)
	{
		printf("can not found %s\n", dllname);
		return;
	}
	printf("%s import table : %p\n", dllname, pImage);






	// 3. ì´ì œ í•¨ìˆ˜ì£¼ì†Œë¥¼ ë‹´ì€ tableì„ ì¡°ì‚¬í•©ë‹ˆë‹¤.
	IMAGE_THUNK_DATA* pThunk =
		(IMAGE_THUNK_DATA*)((char*)hExe + pImage->FirstThunk);

	for (; pThunk->u1.Function; pThunk++)
	{
		if (pThunk->u1.Function == (DWORD)api)
		{
			DWORD* addr = &(pThunk->u1.Function);

			DWORD old;
			VirtualProtect(addr, sizeof(DWORD), PAGE_READWRITE, &old);

            // ì´ë ‡ê²Œ ë®ì–´ì¨ë„ ë˜ì§€ë§Œ
			//*addr = (DWORD)func;

			// WriteProcessMemory() ë¥¼ ì´ìš©í•´ì„œ ë®ì–´ì“°ëŠ” ê²ƒì„ ì¶”ì²œ
			DWORD len;
			WriteProcessMemory(GetCurrentProcess(), addr, &func, sizeof(DWORD), &len);

			VirtualProtect(addr, sizeof(DWORD), old, &old);
			break;
		}
	}
}

int main()
{
	Replace(GetModuleHandle(0), //= API í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ëª¨ë“ˆ(exe)ì˜ ì£¼ì†Œ
		"user32.dll",			//= í›„í‚¹í•  í•¨ìˆ˜ê°€ ìˆëŠ” dllì´ë¦„
		&MessageBoxA,			//= í›„í‚¹í•  API í•¨ìˆ˜ ì£¼ì†Œ
		&foo);					//= ì‚¬ìš©ì í•¨ìˆ˜


	MessageBoxA(0, "aaa", "bbb", 0); 
}
```