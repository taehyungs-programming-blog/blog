---
layout: default
title: "4. calling-convention"
parent: (Windows API)
grand_parent: (C++)
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

ğŸ˜º ì–´ì…ˆë¸”ë¦¬ì—ì„œ ë§¤ê°œë³€ìˆ˜ì˜ ì „ë‹¬ ë°©ì‹ì€ ë‘ ê°€ì§€ê°€ ìˆë‹¤

* ë ˆì§€ìŠ¤í„°ì— ë„£ê¸°
* ìŠ¤íƒì— ë„£ê¸°

```
.model flat
public _asm_main
.code
_asm_main:
    call _add
    ret
_add:   ; _add í˜¸ì¶œ ì‹œ ì¸ìë¥¼ ë„£ì–´ë³´ì.
    mov eax, 100
    ret
end
```

---

## ë ˆì§€ìŠ¤í„°ì— ë§¤ê°œë³€ìˆ˜ ë„£ê¸°

* ê´€ë¡€ì ìœ¼ë¡œ ecx edx, esi, edi ë¥¼ ì¸ì ë ˆì§€ìŠ¤í„°ë¡œ ë§ì´ ì“´ë‹¤.

```
.model flat
public _asm_main
.code
_asm_main:
    mov edx, 2
    mov ecx, 2
    call _add
    ret
_add:
    mov eax, edx ; eax = edx
    add eax, ecx ; eax += ecx
    ret
end
```

<br>

* ì¥ì  : ë¹ ë¥´ë‹¤
* ë‹¨ì  : ì¸ìì˜ ê°œìˆ˜ì— ì œí•œì´ ìˆë‹¤

---

## ìŠ¤íƒì— ë§¤ê°œë³€ìˆ˜ ë„£ê¸°

```
.model flat
public _asm_main
.code
_asm_main:
    push 2  ; 2ë²ˆì§¸ ì¸ì
    push 1  ; 1ë²ˆì§¸ ì¸ì
    call _add
    ret
_add:
    ; ë‹¨ìˆœíˆ popì„ ì“¸ ìˆ˜ ì—†ëŠ”ê²Œ callì€ ìŠ¤íƒì— ëŒì•„ì˜¬ ë©”ëª¨ë¦¬ë¥¼ ë‹´ëŠ”ë‹¤.
    ; ì¢€ ë” ìì„¸íˆ ì„¤ëª…í•˜ë©´ í•¨ìˆ˜ë¥¼ callí•˜ë©´ ìŠ¤íƒì— 'push ëŒì•„ì˜¬ ì£¼ì†Œ'ì™€ ë™ì¼í•˜ë‹¤
    ; ë‹¨ìˆœíˆ popì„ í•´ë²„ë ¤ì„œ ëŒì•„ì˜¬ ì£¼ì†Œë¥¼ popí•´ë²„ë¦´ê²½ìš° ëŒì•„ê°ˆ ì£¼ì†Œë¥¼ ì•Œ ìˆ˜ ì—†ê²Œ ëœë‹¤.
    ; ë”°ë¼ì„œ ì ˆëŒ€ popì„ ì“°ë©´ ì•ˆë˜ëŠ”ê²Œ ëŒì•„ê°ˆ ì£¼ì†Œë¥¼ ì•Œìˆ˜ ì—†ê²Œ ë˜ì–´ë²„ë¦°ë‹¤
    ret
end
```

<br>

* esp ë ˆì§€ìŠ¤í„°ë¡œ í•´ê²°í•œë‹¤
    * ESP(Extended Stack Pointer) : ê°€ì¥ ìµœê·¼ì— ì‚¬ìš©í•œ ìŠ¤íƒì„ ê°€ë¦¬í‚¤ëŠ” ë ˆì§€ìŠ¤í„°
    * ESP ê¸°ì¤€ 4ë°”ì´íŠ¸ ë–¨ì–´ì§„ ì£¼ì†Œê°’ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼í•œë‹¤.

```
.model flat
public _asm_main
.code
_asm_main:
    push 2
    push 1
    call _add
    ret
_add:
    mov eax, dword ptr[esp+4]
    add eax, dword ptr[esp+8]
    ; ì´ë ‡ê²Œ êµ¬í˜„í•˜ë©´ ì—ëŸ¬ë°œìƒ
    ; why? 
    ; retë¥¼ í•˜ë©° ë¬¸ì œê°€ ë°œìƒí•œë‹¤
        ; retëŠ” `pop ëŒì•„ê°ˆ ì£¼ì†Œ`(ìŠ¤íƒì˜ ë°”ë¡œ ìœ„ ì£¼ì†Œ)
        ; `jmp êº¼ë‚¸ì£¼ì†Œ`
        ; ì´ëŸ°ì‹ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ë° ì¡°ê¸ˆë” ìì„¸í•œ ì„¤ëª…ì„ ìœ„í•´ ì•„ë˜ ì°¸ì¡°
    ret
end
```

```
_main ìœ¼ë¡œ ëŒì•„ê°ˆ ì£¼ì†Œ
2
1
_asm_main ìœ¼ë¡œ ëŒì•„ê°ˆ ì£¼ì†Œ ( <- í˜„ì¬ esp )
```

retí˜¸ì¶œ ì‹œ

```
_main ìœ¼ë¡œ ëŒì•„ê°ˆ ì£¼ì†Œ
2
1 ( <- í˜„ì¬ esp )
_asm_main ìœ¼ë¡œ ëŒì•„ê°ˆ ì£¼ì†Œ
```

<br>

* ìŠ¤íƒì— ë°ì´í„°ë¥¼ 2ê°œë¥¼ ìŒ“ì•˜ê¸°ì— _main ìœ¼ë¡œ ëŒì•„ê°ˆ ì£¼ì†Œë¡œ ëŒì•„ê°€ì•¼í•˜ëŠ”ë° ë°ì´í„° 1ë¡œ ëŒì•„ê°€ê²Œ ëœë‹¤.
    * í•´ê²°ì±…) í•¨ìˆ˜ í˜¸ì¶œì´ ì¢…ë£Œë˜ë©´ ì¸ì ì „ë‹¬ì— ì‚¬ìš©ëœ ìŠ¤íƒì€ ë°˜ë“œì‹œ íŒŒê´´ë˜ì–´ì•¼ í•œë‹¤.

```
.model flat
public _asm_main
.code
_asm_main:
    push 2
    push 1
    call _add
    add esp, 8 ; esp = esp + 8
    ; ì´ë ‡ê²Œë§Œ í•´ì¤˜ë„ ìŠ¤íƒì´ íŒŒê´´ëœë‹¤.
    ret
_add:
    mov eax, dword ptr[esp+4]
    add eax, dword ptr[esp+8]
    ret
end
```

```
_mainìœ¼ë¡œ ëŒì•„ê°ˆ ì£¼ì†Œ ( <- í˜„ì¬ esp )
2
1
_asm_main ìœ¼ë¡œ ëŒì•„ê°ˆ ì£¼ì†Œ
```

<br>

* ë‹¤ë¥¸ ë°©ë²•?
* íŒŒê´´í•˜ëŠ” ë°©ì‹ì´ ë‘ ê°€ì§€ë‹¤.
    * (ê¸°ì¡´ë°©ë²•) í˜¸ì¶œì íŒŒê´´ - add esp, 8 : espë¥¼ ì¡°ì •
        * ì½”ë“œê°€ ê¸¸ì–´ì§„ë‹¤(í•¨ìˆ˜ í˜¸ì¶œì‹œ ë§ˆë‹¤ ì¶”ê°€ë˜ì–´ì•¼ í•¨)
    * í”¼í˜¸ì¶œì íŒŒê´´ - ret 8 : ë¦¬í„´ê³¼ ë™ì‹œì— íŒŒê´´
        * ì½”ë“œê°€ ì§§ì•„ì§€ë©° í”¼í˜¸ì¶œìì—ì„œ íŒŒê´´í•˜ê¸°ì— ì—ëŸ¬(ë©”ëª¨ë¦¬ ì˜¤ì ‘ê·¼)ê°€ ì ë‹¤
* ì´ ë‘ê°€ì§€ ë°©ë²•ì— ë”°ë¼ calling-conventionì´ ë‹¬ë¼ì§„ë‹¤

```
.model flat
public _asm_main
.code
_asm_main:
    push 2
    push 1
    call _add
    add esp, 8  ; (í˜¸ì¶œì íŒŒê´´) ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ íŒŒê´´í•  ìˆ˜ ìˆì„ê¹Œ?
    ret
_add:
    mov eax, dword ptr[esp+4]
    add eax, dword ptr[esp+8]
    ret
end
```

```
_add:
    mov eax, dword ptr[esp+4]
    add eax, dword ptr[esp+8]
    ret 8   ; ì´ë ‡ê²Œ íŒŒê´´ê°€ëŠ¥ (í˜¸ì¶œ ë‹¹í•œ íŒŒê´´)
end
```

---

## Cì–¸ì–´ì˜ calling-conventionì€?

```cpp
#include <stdio.h>
int add(int a, int b)
{
    int c = a + b;
    return c;
}
int main()
{
    int ret = 0;
    ret = add(1, 2);    // 1, 2ëŠ” ë ˆì§€ìŠ¤í„°ë¡œ ê°ˆê¹Œ ìŠ¤íƒìœ¼ë¡œ ê°ˆê¹Œ?
    printf("result : %d\n", ret);
}
```

<br>

* ë¬¼ë¡  ì»´íŒŒì¼ëŸ¬ ë§ˆë‹¤ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆë‹¤

```
push 2
push 1      ; ìŠ¤íƒì— ë„£ê³ 
call _add   ; í•¨ìˆ˜í˜¸ì¶œ
add esp, 8  ; í˜¸ì¶œí•œ ê³³ì—ì„œ íŒŒê´´
```

<br>

* ì¸ë¼ì¸ ì–´ì…ˆë¸”ë¦¬ë¡œ ë§Œë“¤ì–´ ë³´ìë©´

```
int main()
{
    int ret = 0;
    
    __asm
    {
        push 2
        push 1
        call add
        add esp, 8
        mov ret, eax
    }
    printf("result : %d\n", ret);
}
```

---

## ì •ë¦¬í•˜ìë©´ ...

* í•¨ìˆ˜ í˜¸ì¶œ ê·œì•½(calling convention)
    * í˜¸ì¶œ ê·œì•½ì— ë”°ë¼ ë‹¬ë¼ì§€ëŠ” ë¶€ë¶„ì€ í•¨ìˆ˜ ì´ë¦„ ê·œì¹™, ì¸ì ì „ë‹¬ ë°©ë²•, ìŠ¤íƒ íŒŒê´´ ìœ„ì¹˜ ì´ë‹¤.
    * `__cdecl` : í•¨ìˆ˜ ì´ë¦„ (_f) / ì¸ì ì „ë‹¬ (ìŠ¤íƒ) / íŒŒê´´ ìœ„ì¹˜ (í˜¸ì¶œì)
    * `__stdcall` : í•¨ìˆ˜ ì´ë¦„ (_f@ì¸ìí¬ê¸°) / ì¸ì ì „ë‹¬ (ìŠ¤íƒ) / íŒŒê´´ ìœ„ì¹˜ (í”¼í˜¸ì¶œì)
    * `__fastcall` : í•¨ìˆ˜ ì´ë¦„ (@f@ì¸ìí¬ê¸°) / ì¸ì ì „ë‹¬ (2ê¹Œì§€ ë ˆì§€ìŠ¤í„°, 3ë¶€í„° ìŠ¤íƒ) / íŒŒê´´ ìœ„ì¹˜ (3ê°œ ì´ìƒ í”¼í˜¸ì¶œì)
* ë‹¨, ì£¼ì˜í•  ì ì€ ê°€ë³€ì¸ìë¡œ(...) ë³´ë‚¼ê²½ìš° ë¬´ì¡°ê±´ __cdeclë¡œ í˜¸ì¶œê·œì•½ì´ ê³ ì •ë¨

```cpp
void __cdecl f1(int a, int b) {}
void __stdcall f2(int a, int b) {}
void __fastcall f3(int a, int b) {}
void __fastcall f4(int a, int b, int c, int d) {}
int main()  // __cdecl : ë””í´íŠ¸
{
    f1(1, 2);
    f2(1, 2);
    f3(1, 2);
    f4(1, 2, 3, 4);
}
```

```
; __cdecl
    push 2
    push 1
    call _f1
    add esp, 8
; __stdcall
    push 2
    push 1
    call _f2@8
; __fastcall
    mov edx, 2
    mov ecx, 1
    call @f@8
; __fastcall(ì¸ì 3ê°œ ì´ìƒ)
    push 4
    push 3
    mov edx, 2
    mov ecx, 1
    call @f4@16
```

<br>

* ì°¨ì´ì ?
    * ê²°êµ­ ì°¨ì´ì ì€ ìŠ¤íƒì˜ íŒŒê´´ ìœ„ì¹˜ì´ë‹¤.
    * `__cdecl` :
        * í˜¸ì¶œìì—ì„œ ìŠ¤íƒì •ë¦¬
        * ê°€ë³€ì¸ì(â€¦) ì²˜ë¦¬ê°€ëŠ¥
    * `__stdcall` :
        * í”¼í˜¸ì¶œìì—ì„œ retë¥¼ í†µí•´ ìŠ¤íƒì •ë¦¬
        * ë¹ ë¥´ë‹¤(ìŠ¤íƒì„ ë³„ë„ì˜ ëª…ë ¹ìœ¼ë¡œ ì •ë¦¬í•˜ì§€ ì•Šê³  retë¥¼ í†µí•´ ì •ë¦¬í•´ì„œ)
            * ì™œ? retì´ ë”ë¹ ë¥¸ë°? ìì„¸í•œ ì‚¬í•­ì€ ë‚˜ë„ ëª¨ë¦„â€¦
* DLLì´ë‚˜ OSì—ì„œëŠ” __stdcallì„ ë§ì´ ì‚¬ìš©í•˜ëŠ”ë° í”„ë¡œê·¸ë˜ë° ì–¸ì–´ ì‚¬ì´ì˜ í‘œì¤€ì´ê¸°ì— ê·¸ë ‡ë‹¤.
ì•„ë§ˆ ë¹¨ë¼ì„œê°€ ì•„ë‹ê¹Œ?

```cpp
void f1(int n, ...) {} // __cdecl
void __stdcall f2(int n, ...) {}
void __fastcall f3(int n, ...) {}
int main()
{
    f1(1, 2);           // add esp, 8
    f1(1, 2, 3, 4);     // add esp, 16
    f2(1, 2);   // í•¨ìˆ˜ë‚´ì—ì„œ ret8ì„ í•´ì¤˜ì•¼ í•˜ëŠ”ë° ê°€ë³€ ë§¤ê°œë³€ìˆ˜ëŠ” ret ëª‡ì„ í•´ì¤˜ì•¼í•˜ëŠ”ì§€ ì•Œ ìˆ˜ ì—†ìŒ
    // ì»´íŒŒì¼ëŸ¬ê°€ ìë™ìœ¼ë¡œ __cdeclë¡œ ë³€ê²½í•œë‹¤.
    f3(1, 2);   // ìƒë™
}
```

---

## Example

```cpp
#include <stdio.h>
int asm_main();
int main()
{
    asm_main();
}
void __cdecl    f1(int a, int b) { printf("f1 : %d, %d\n", a, b); }
void __stdcall  f2(int a, int b) { printf("f2 : %d, %d\n", a, b); }
void __fastcall f3(int a, int b) { printf("f3 : %d, %d\n", a, b); }
void __fastcall f4(int a, int b, int c, int d)
{ 
    printf("f4 : %d, %d, %d, %d\n", a, b, c, d);
}
```

```
.model flat
public _asm_main
; cì— ìˆëŠ” í•¨ìˆ˜ë¥¼ includeí•œë‹¤ê³  ìƒê°
extern _f1: proc
extern _f2@8: proc
extern @f3@8: proc
extern @f4@16: proc
; printf, MessagBox ì¨ë³´ê¸°ìš© include
extern _printf: proc
extern _MessageBoxA@16: proc
; printf, MessagBox ì¨ë³´ê¸°ìš© string
.data
S1 DB "hello", 10, 0 
; ì°¸ê³ ) 10ì€ ì•„ìŠ¤í‚¤ ì½”ë“œë¡œ '\n'ì„ ë§í•˜ë©° 0ì€ stringì˜ ë§ˆì§€ë§‰ ë¬¸ì null
.code
_asm_main:
    ; f1(1, 2) í˜¸ì¶œ
    push 2
    push 1
    call _f1
    add esp, 8
    ; f2(1,2)
    push 2
    push 1
    call _f2@8
    ; f3(1,2)
    mov edx, 2
    mov ecx, 1
    call @f3@8
    ; f4(1,2,3,4)
    push 4
    push 3
    mov edx, 2
    mov ecx, 1
    call @f4@16
    ; ì¶”ê°€) printf ì¶œë ¥
    push offset S1
    call _printf
    add esp, 4  ; __cdecl ì´ë¼ì„œ í˜¸ì¶œìì—ì„œ ìŠ¤íƒì •ë¦¬
    ; MessageBoxA(0, "Hello", "Hello", MB_OK) í˜¸ì¶œ
    push 0
    push offset S1
    push offset S1
    call _MessageBoxA@16    ; __stdcallì´ë¼ í”¼í˜¸ì¶œìì—ì„œ ì •ë¦¬
    
    ret
end
```