---
layout: default
title: "3. std::weak_ptr"
parent: (C++)
grand_parent: (C++)
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## weak_ptrì€ ì–¸ì œì“¸ê¹Œ?

* ì°¸ì¡°ë³€ìˆ˜ê°€ ì¦ê°€í•˜ì§€ ì•ŠëŠ” ìŠ¤ë§ˆíŠ¸ í¬ì¸í„°ê°€ í•„ìš”í•˜ë‹¤.
* ì›ë³¸ ê°ì²´ê°€ íŒŒê´´ë˜ì—ˆì„ ì‹œ ë‹¤ ê°™ì´ ì‚­ì œ ë˜ëŠ” ìŠ¤ë§ˆíŠ¸ í¬ì¸í„°ê°€ í•„ìš”í•˜ë‹¤.

---

## shared_ptrì˜ ë¬¸ì œì 

ğŸ˜º ìˆœí™˜ ì°¸ì¡°ì˜ ë¬¸ì œë¥¼ ê°–ëŠ”ë‹¤

```cpp
#include <iostream>
#include <string>
#include <memory>
using namespace std;

struct People
{
    People(string s) : name(s) {}
    ~People() { cout << "~People : " << name << endl; }
    string name;
    shared_ptr<People> bf;  // best friend
};

int main()
{
    shared_ptr<People> p1(new People("Kim"));
    shared_ptr<People> p2(new People("Lee"));
    p1->bf = p2;
    p2->bf = p1;
    // ìì›ì´ íŒŒê´´ë˜ì§€ ì•ŠëŠ”ë‹¤.
    // ì„œë¡œê°€ ì„œë¡œë¥¼ ê°€ë¥´í‚¤ê²Œ ëœë‹¤.
}
```

<br>

ğŸ˜º í•´ê²°ë²•?? ì°¸ì¡°ë³€ìˆ˜ê°€ ì¦ê°€í•˜ì§€ ì•ŠëŠ” í¬ì¸í„°ê°€ í•„ìš”í•˜ë‹¤ ğŸ‘‰ `weak_ptr`

```cpp
struct People
{
    People(string s) : name(s) {}
    ~People() { cout << "~People : " << name << endl; }
    string name;
    weak_ptr<People> bf;  
    // ì°¸ì¡°ë³€ìˆ˜ê°€ ì¦ê°€í•˜ì§€ ì•ŠëŠ” í¬ì¸í„°ê°€ í•„ìš”
    // ë˜í•œ ì›ë³¸ ê°ì²´ê°€ íŒŒê´´ë˜ì—ˆëŠ”ì§€ ì•Œìˆ˜ë„ ìˆì–´ì•¼ í•œë‹¤
};
```

```cpp
// (ì°¸ê³ ) shared_ptrì˜ ì°¸ì¡°ê°œìˆ˜ë¥¼ í™•ì¸í•´ ë³´ì
class Car
{
    int color;
    int speed;
public:
    ~Car() { cout << "~Car()" << endl; }
    void Go() { cout << "Car go" << endl; }
};

int main()
{
    shared_ptr<Car> wp; // use count ì¦ê°€
    shared_ptr<Car> sp(new Car);
    wp = sp;
    cout << sp.use_count() << endl; // 2
}
```

---

## weak_ptr ì¨ë³´ê¸°

```cpp
int main()
{
    weak_ptr<Car> wp; // use count ì¦ê°€ X
    
    {
        shared_ptr<Car> sp(new Car);
        wp = sp;
        cout << sp.use_count() << endl; // 1
    }
    if( wp.expired() )      // ì›ë³¸ ê°ì²´ê°€ íŒŒê´´ë˜ì—ˆëŠ”ì§€ í™•ì¸ ê°€ëŠ¥
        cout << "destory" << endl;
    else
        cout << "not destory" << endl;
}
```

<br>

ğŸ˜º weak_ptrë¡œ shared_ptrë§Œë“¤ê¸°

```cpp
shared_ptr<Car> sp2 = wp.lock();
if(sp2)
    sp->Go();
```

---

## Example

```cpp
class Dog {
    shared_ptr<Dog> m_pFriend;
public:
    string m_name;
    void bark() { cout << "Dog" << m_name << " rules!" << endl; }
    Dog() { //create }
    ~Dog() { cout << "dog is destroyed: " << m_name << endl; }
    void makeFriend(shared_ptr<Dog> f) { m_pFriend = f; }
};

int main()
{
    shared_ptr<Dog> pD(new Dog("Gunner"));
    shared_ptr<Dog> pD(new Dog("Smokey"));
    pD->makeFriend(pD2);
    pD->makeFriend(pD);
    // ì„œë¡œ ë¬¼ê³ ìˆì–´ ì‚­ì œê°€ ë˜ì§€ ì•ŠìŒ.
    // cyclic reference
}
```

```cpp
class Dog {
    weak_ptr<Dog> m_pFriend;        // í•´ê²°
    // ì‚¬ì‹¤ weak_ptrì€ raw pointer(Dog *) ì‚¬ìš©ê³¼ ë™ì¼í•˜ë‹¤ ë‹¨, weak_ptrë¡œ deleteë¥¼ í•  ìˆ˜ ì—†ë‹¤ëŠ” ì ë§Œ ë‹¤ë¥´ë‹¤
public:
    string m_name;
    void bark() { cout << "Dog" << m_name << " rules!" << endl; }
    Dog() { //create }
    ~Dog() { cout << "dog is destroyed: " << m_name << endl; }
    void makeFriend(shared_ptr<Dog> f) { m_pFriend = f; }
};
```

```cpp
// weak_ptrì€ ê·¸ëƒ¥ ì‚¬ìš©í•˜ë©´ ì•ˆëœë‹¤.
class Dog {
    weak_ptr<Dog> m_pFriend;
public:
    string m_name;
    void bark() { cout << "Dog" << m_name << " rules!" << endl; }
    Dog() { //create }
    ~Dog() { cout << "dog is destroyed: " << m_name << endl; }
    void makeFriend(shared_ptr<Dog> f) { m_pFriend = f; }
    void showFriend() {
        if(!m_pFriend.expired()) {
            cout << "My friend is : " << m_pFriend.lock()->m_name << endl;
            cout << m_pFriend.use_count() << endl;
        }
    }
};
```

---

## owner_beforeì— ê´€í•´

* [ì°¸ê³  ì‚¬ì´íŠ¸ ğŸŒ](https://cplusplus.com/reference/memory/weak_ptr/owner_before/)
* [ì°¸ê³  ì‚¬ì´íŠ¸2 ğŸŒ](https://runebook.dev/ko/docs/cpp/memory/shared_ptr/owner_before)

ğŸ¤·â€â™‚ï¸ ì‚¬ìš©ì¤‘ì¸ `shared_ptr`, `weak_ptr`ì´ ê°™ì€ groupì— ì†í•˜ëŠ”ì§€ í™•ì¸í•´ì•¼í•  ë•Œê°€ ìˆì„ê²ƒì´ë‹¤. ê·¸ëŸ´ë•Œ ì‚¬ìš©ëœë‹¤.<br>
ğŸ¤·â€â™‚ï¸ ì ê³ ë³´ë‹ˆ ìœ„ ë§ì´ ë” ì–´ë ¤ìš´ë° ... ì¢€ ë” ì„¤ëª…í•˜ìë©´ ìš°ì„  **alias constructor**ë¥¼ ì•Œì•„ì•¼í•œë‹¤.<br>
ğŸ¤·â€â™‚ï¸ `std::shared_ptr<int> b (a,p);` - bë¼ëŠ” shared_ptrì„ aì˜ ì†Œìœ ì˜ pí¬ì¸í„°ì˜ shared_ptrë¡œ ë§Œë“¤ì–´ì£¼ì„¸ìš”.<br>
ğŸ¤·â€â™‚ï¸ ìœ„ ì²˜ëŸ¼ ì„ ì–¸í•  ê²½ìš° aì™€ bëŠ” í•˜ë‚˜ì˜ **groupì— ì†í•œë‹¤** í•  ìˆ˜ ìˆë‹¤.

```cpp
// weak_ptr::owner_before
// weak_ptrì˜ ë¹„êµì— ì‚¬ìš©ëœë‹¤.
#include <iostream>
#include <memory>

int main () {
    int * p = new int (10);

    std::shared_ptr<int> a (new int (20));
    std::shared_ptr<int> b (a,p);  // alias constructor

    std::weak_ptr<int> c (b);

    std::cout << *p << std::endl;   // 10
    std::cout << *a << std::endl;   // 20
    std::cout << *b << std::endl;   // 10

    std::cout << "comparing a and c...\n" << std::boolalpha;
    std::cout << "value-based: " << ( !(a<c.lock()) && !(c.lock()<a) ) << '\n';             // false
    // ë³´í†µ ì•„ë˜ì™€ ê°™ì´ ì“°ì„.
    std::cout << "owner-based: " << ( !a.owner_before(c) && !c.owner_before(a) ) << '\n';   // true


    std::shared_ptr<int> e (new int (20));
    std::cout << "e owner-based: " << ( !e.owner_before(c) && !c.owner_before(e) ) << '\n'; // false

    delete p;
    return 0;
}
```

```cpp
#include <iostream>
#include <memory>
 
struct Foo {
    int n1;
    int n2; 
    Foo(int a, int b) : n1(a), n2(b) {}
};
int main()
{   
    auto p1 = std::make_shared<Foo>(1, 2);
    std::shared_ptr<int> p2(p1, &p1->n1);   // p1ì˜ n1ì˜ shared_ptr
    std::shared_ptr<int> p3(p1, &p1->n2);   // p1ì˜ n2ì˜ shared_ptr
 
    std::cout << std::boolalpha
    // ê°’ì˜ ë¹„êµê°€ ì•„ë‹ˆë¼ ì£¼ì†Œê°’ì˜ ë¹„êµì„ì„ ê¸°ì–µí•˜ì.
              << "p2 < p3 " << (p2 < p3) << '\n'    // true
              << "p3 < p2 " << (p3 < p2) << '\n'    // false
              << "p2.owner_before(p3) " << p2.owner_before(p3) << '\n'  // false
              << "p3.owner_before(p2) " << p3.owner_before(p2) << '\n'; // false
 
    std::weak_ptr<int> w2(p2);
    std::weak_ptr<int> w3(p3);
    std::cout 
// << "w2 <w3"<< (w2 <w3) << '\ n'// ì»´íŒŒì¼ë˜ì§€ ì•ŠìŒ
// << "w3 <w2"<< (w3 <w2) << '\ n'// ì»´íŒŒì¼ë˜ì§€ ì•ŠìŒ
              << "w2.owner_before(w3) " << w2.owner_before(w3) << '\n'  // false
              << "w3.owner_before(w2) " << w3.owner_before(w2) << '\n'; // false
 
}
```