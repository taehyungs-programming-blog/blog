---
layout: default
title: "12. new, deleteì— ê´€í•˜ì—¬"
parent: (C++)
grand_parent: C++
nav_order: 2
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

{% raw %}

```cpp
#include <iostream> 
#include <new>

class Point 
{ 
	int x, y; 
public: 
	Point(int a, int b) : x{a}, y{b} { std::cout << "Point(int, int)"  << std::endl; } 
	~Point()		 	 { std::cout << "~Point()" << std::endl; } 
};

int main() 
{ 
	Point* p1 = new Point(1,2); 
	delete p1;
    // C++ì—ì„œ newë¥¼ ì‚¬ìš©ì‹œ ë‚´ë¶€ì ìœ¼ë¡  ì•„ë˜ì™€ ê°™ì€ ì¼ì„ í•œë‹¤.
        // 1. operator new - ë©”ëª¨ë¦¬ í• ë‹¹
            // void* p = operator new(sizeof(Point));
        // 2. placement new - ìƒì„±ì í˜¸ì¶œ
            // Point* p1 = new(p) Point(1, 2);

    // C++ì—ì„œ deleteë¥¼ ì‚¬ìš©ì‹œë„ ë‚´ë¶€ì ìœ¼ë¡œ ì•„ë˜ì™€ ê°™ì€ ì¼ì„ í•œë‹¤.
        // 1. p1->~Point(); - ì†Œë©¸ì í˜¸ì¶œ
        // 2. operator delete(p1); - ë©”ëª¨ë¦¬ í•´ì§€

    // ì§ì ‘ í•´ë³´ìë©´
	void* p = operator new(sizeof(Point));     // ë©”ëª¨ë¦¬ë§Œ í• ë‹¹ 
	std::cout << p << std::endl; 
	operator delete(p);                        // ë©”ëª¨ë¦¬ë§Œ í•´ì œ 
}
```


```cpp
#include <iostream> 
#include <new> 
#include <memory>

class Point 
{ 
	int x, y; 
public: 
	Point(int a, int b) : x{a}, y{b} { std::cout << "Point(int, int)"  << std::endl; } 
	~Point()		 	 { std::cout << "~Point()" << std::endl; } 
};

int main() 
{
    // operator newí•˜ë©´ ë¦¬í„´ì´ void*ë¡œ ë„˜ì–´ì˜´ì„ ì£¼ëª©.
	void* p1 = operator new(sizeof(Point));

    // placement newëŠ” ë¦¬í„´ì´ Point* ì´ë‹¤. 
	Point* p2 = new(p1) Point(1, 2); // ìƒì„±ì í˜¸ì¶œ 

	p2->~Point(); 
	operator delete(p1);

    // operator newë¥¼ í•˜ë”ë¼ë„ Point*ë¡œ ë°›ê³ ì‹¶ë‹¤ë©´ static_castë¥¼ í•˜ì
	Point* p3 = static_cast<Point*>(operator new(sizeof(Point))); 
    // C++20 - placement new ìƒˆë¡œìš´ ë°©ë²•
	std::construct_at(p3, 1, 2);

    // C++17 - ì†Œë©¸ìë¥¼ í˜¸ì¶œí•˜ëŠ” ë°©ë²•
	std::destroy_at(p3);

    // ë©”ëª¨ë¦¬ í•´ì œ
	operator delete(p3); 
}
```

ğŸ˜º ì–´ì…ˆë¸”ë¦¬ë¡œ ìƒì„± í•´ì œë¥¼ í™•ì¸í•´ ë³´ìë©´

* [Compiler Explorer ğŸŒ](https://godbolt.org/z/5z1zqMEqh)

```cpp
#include <iostream> 
class Point 
{ 
	int x, y; 
public: 
	Point(int a, int b) : x{a}, y{b} { } 
	~Point()		 				 { } 
}; 
int main() 
{ 
    Point* p1 = new Point(1, 2); 
    delete p1; 
}
```

```bash
main: 
        push    rbp 
        mov     rbp, rsp 
        push    rbx 
        sub     rsp, 24 
        mov     edi, 8

        // ë©”ëª¨ë¦¬ í• ë‹¹ 
        call    operator new(unsigned long) 
        mov     rbx, rax 
        mov     edx, 2 
        mov     esi, 1 
        mov     rdi, rbx

        // ìƒì„±ì í˜¸ì¶œ 
        call    Point::Point(int, int) [complete object constructor] 
        mov     QWORD PTR [rbp-24], rbx 
        mov     rbx, QWORD PTR [rbp-24] 
        test    rbx, rbx 
        je      .L4 
        mov     rdi, rbx

        // ì†Œë©¸ì í˜¸ì¶œ 
        call    Point::~Point() [complete object destructor] 
        mov     esi, 8 
        mov     rdi, rbx

        // ë©”ëª¨ë¦¬ í•´ì œ 
        call    operator delete(void*, unsigned long)
```

---

## Example) ì–¸ì œ ì“¸ê¹Œ?

```cpp
#include <iostream> 
#include <new> 
#include <memory>

class Point 
{ 
	int x, y; 
public: 
	Point(int a, int b) : x{a}, y{b} { } 
	~Point()	     { } 
};

int main() 
{ 
	// Point ê°ì²´ í•œê°œë¥¼ í™ì— ìƒì„±í•˜ê³  ì‹¶ë‹¤. 
	Point* p1 = new Point(0, 0);

	// Point ê°ì²´ 3ê°œë¥¼ í™ì—  
        // ì—°ì†ì ìœ¼ë¡œ(ë°°ì—´í˜•íƒœë¡œ) ìƒì„±í•˜ê³  ì‹¶ë‹¤. 
    //	Point* p2 = new Point[3];    // ë‹¨, ì´ë ‡ê²Œ ì‚¬ìš©í•˜ë ¤ë©´ ë””í´íŠ¸ ìƒì„±ìê°€ ë¬´ì¡°ê±´ ìˆì–´ì•¼ í•œë‹¤.

    //	Point* p2 = new Point[3]{{0,0},{0,0},{0,0}};    // ì´ë ‡ê²Œ í• ê¹Œ? - í ... ê·¸ëŸ¼ 100ê°œë¥¼ ë§Œë“œë ¤ë©´ 100ë²ˆ ì ì–´ì•¼ í•˜ë‚˜?
        // ì´ëŸ°ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ì„œ operator new íƒ„ìƒ
	Point* p2 = static_cast<Point*>(operator new(sizeof(Point) * 3)) ; 
	for (int i = 0; i < 3; i++) 
	{ 
        new(&p2[i]) Point(0, 0);
        //      construct_atì„ ì¨ë„ ìƒê´€ì—†ìŒ.
    	//	std::construct_at(&p2[i], 0, 0); 
	}

	for (int i = 0; i < 3; i++) 
	{ 
        p2[i].~Point(); 
    	//	std::destroy_at(&p2[i]); 
	}

    // ë©”ëª¨ë¦¬ í•´ì œ 
	operator delete(p2); 
}
```

---

## Example2) ì–¸ì œ ì“¸ê¹Œ2?

```cpp
#include <iostream> 
#include <vector>

struct X 
{ 
	X()  { std::cout << "X()  get resource"     << std::endl;} 
	~X() { std::cout << "~X() release resource" << std::endl;} 
};

int main() 
{ 
	std::vector<X> v(10); 
	std::cout << "------------" << std::endl; 
	v.resize(7);    // resizeë¡œ ì—†ì–´ì§„ ë©”ëª¨ë¦¬ ë§Œí¼ ì†Œë©¸ìëŠ” í˜¸ì¶œë˜ì–´ì•¼ í•¨ -> ì´ë•Œ ì‚¬ìš©ë¨. 
	std::cout << "------------" << std::endl; 
	std::cout << v.size() << std::endl;// 7 
	std::cout << v.capacity() << std::endl;// 10

	std::cout << "------------" << std::endl;

	v.resize(8);     // ìƒì„±ëœ ë§Œí¼ ìƒì„±ìëŠ” í˜¸ì¶œë˜ì–´ì•¼ í•¨. -> ì´ë•Œ ì‚¬ìš©ë¨. 
	std::cout << "------------" << std::endl; 
	std::cout << v.size() << std::endl;// 8 
	std::cout << v.capacity() << std::endl;// 10	 
}
```

{% endraw %}

