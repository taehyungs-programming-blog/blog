---
layout: default
title: "18. move semantics"
parent: (C++)
grand_parent: C++
nav_order: 2
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## moveì£¼ì˜ í•  ì ?

ğŸ„â€â™‚ï¸ `std::move`ëŠ” ë³µì‚¬ë¥¼ í•´ì£¼ëŠ” ê¸°ëŠ¥ì´ ì•„ë‹ˆë¼ ë‹¨ìˆœ íƒ€ì…ìºìŠ¤íŒ…ë§Œ í•´ì¤€ë‹¤.

```cpp
// std::moveì˜ ë‚´ë¶€êµ¬í˜„ì€ ëŒ€ëµ ì•„ë˜ì™€ ê°™ì€ë°

// 1. forwarding reference(&&)ë¡œ ë°›ì•„ì•¼ í•œë‹¤.
    // moveë¡œ r, l valueëª¨ë‘ ë“¤ì–´ê°ˆ ìˆ˜ ìˆì–´ì•¼ í•¨.
// 2. remove_reference_të¡œ referenceë¥¼ ì œê±°í•´ì•¼í•œë‹¤.
    // Tê°€ Object&ë¼ ê°€ì •í•˜ë©´ Object& && ê°€ ë˜ë©° Object&ë¡œ ë³€í™˜ëœë‹¤(copy ìƒì„±ìê°€ í˜¸ì¶œë¨)
    // Object&ì˜ referenceë¥¼ ì œê±°í•´ì•¼í•œë‹¤.
// 3. ì„±ëŠ¥í–¥ìƒìœ¼ë¡œ constexpr, noexcept ì„ ì¶”ê°€í•˜ë©´ ì¢‹ìŒ.

// ë§ì´ì¦‰ìŠ¨ ë§¤ê°œë³€ìˆ˜ë¥¼ r-valueë¡œ ë§Œë“¤ì–´ ë‹¬ë¼ëŠ” ëœ»ì´ë‹¤.
// ì™œ r-valueë¡œ ë§Œë“¤ì–´ì•¼ í•˜ë‚˜? -> r-valueë³µì‚¬ê°€ ê°€ëŠ¥í•˜ë‹¤ë©´ r-valueë³µì‚¬ë¥¼ í•˜ê¸° ìœ„í•´ì„œì´ë‹¤.
template<class T> 
constexpr std::remove_reference_t<T>&& move(T&& obj) noexcept 
{
	return static_cast<std::remove_reference_t<T> &&>(obj);
}
```

```cpp
int a = 4;						// default constructor
int b = std::move(a);			// default constructor - intì—ëŠ” move constructorê°€ êµ¬í˜„ë˜ì–´ ìˆì§€ ì•ŠìŒ
vector<int> c = {1, 2, 3};		// default constructor
vector<int> d = std::move(c);	// heapì— í• ë‹¹ëœ vector<int> cì˜ ë°ì´í„° ì£¼ì†Œë¥¼ dê°€ ê°€ë¦¬í‚¤ê²Œ ëœë‹¤.

std::cout << a << std::endl;		// 4
std::cout << b << std::endl;		// 4
//std::cout << c[0] << std::endl; 	// Crash
std::cout << d[0] << std::endl;		// 1
```

---

## moveì˜ ê°œë…

```cpp
#include <iostream>
#include <string>

int main()
{
	std::string s1 = "Practice make perfect";
	std::string s2 = s1;

	std::string s3 = "Practice make perfect";
	std::string s4 = std::move(s3);

	std::cout << s1 << std::endl;   // Practice make perfect
	std::cout << s2 << std::endl;   // Practice make perfect
	std::cout << s3 << std::endl;   // "" - s3ì˜ ìì›ì„ move(ì´ë™) ì‹œí‚´
	std::cout << s4 << std::endl;   // Practice make perfect
}
```

```cpp
// moveì˜ ì¥ì ?

#include <iostream>
#include <string>

template<class T>
void swap1(T& lhs, T& rhs)
{
    // ì„¸ ë²ˆì˜ ë©”ëª¨ë¦¬ ë³µì‚¬ê°€ ì¼ì–´ë‚œë‹¤.
	T tmp = lhs;
	lhs = rhs;
	rhs = tmp;
}

template<class T>
void swap2(T& lhs, T& rhs)
{
    // ì£¼ì†Œ ë³µì‚¬ ì„¸ ë²ˆìœ¼ë¡œ ì²˜ë¦¬ëœë‹¤.
	T tmp = std::move(lhs);
	lhs = std::move(rhs);
	rhs = std::move(tmp);
}

int main()
{
	std::string s1 = "Practice make perfect";
	std::string s2 = "To be or not to be";

	swap1(s1, s2);
}
```

* moveë“±ì¥ìœ¼ë¡œ ìƒˆë¡­ê²Œ ì•Œê²Œ ëœ ê²ƒ
    * swap ê°™ì€ ì•Œê³ ë¦¬ì¦˜ì€ ì„±ëŠ¥í–¥ìƒì„ ë³¼ ìˆ˜ ìˆë‹¤.
    * move ìƒì„±ìë¥¼ ì´ì œ ë³„ë„ë¡œ ë§Œë“¤ì–´ ì¤˜ì•¼í•œë‹¤.

---

## move ìƒì„±ì

```cpp
#include <iostream>
#include <cstring>

class Person
{
	char* name;
	int   age;
public:
	Person(const char* s, int a) : age(a)
	{
		name = new char[strlen(s) + 1];
		strcpy_s(name, strlen(s) + 1, s);
	}
	~Person() { delete[] name; }

};
int main()
{
	Person p1("john", 20);
	Person p2 = p1; // ?? - ë³µì‚¬ìƒì„±ìê°€ ë¶ˆë¦¬ë©´ ì–´ë–»ê²Œ ë™ì‘í•˜ê²Œ ë ê¹Œ?
    // ë³µì‚¬ ìƒì„±ìë¥¼ ì§ì ‘ë§Œë“¤ì§€ ì•Šì•˜ê¸°ì— ì–•ì€ ë³µì‚¬ê°€ ì¼ì–´ë‚˜ë©°, 
    // p1, p2ì˜ nameì€ ê°™ì€ ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ê²Œ ëœë‹¤.
}
```

```cpp
#include <iostream>
#include <cstring>

class Person
{
	char* name;
	int   age;
public:
	Person(const char* s, int a) : age(a)
	{
		name = new char[strlen(s) + 1];
		strcpy_s(name, strlen(s) + 1, s);
	}
	~Person() { delete[] name; }

    // ë§Œì•½ ë³µì‚¬ìƒì„±ì ê¹Œì§€ ë§Œë“ ë‹¤ë©´?
	Person(const Person& p) : age(p.age)
	{
		name = new char[strlen(p.name) + 1];
		strcpy_s(name, strlen(p.name) + 1, p.name);	
	}
};
```

ğŸ˜º ë³µì‚¬ìƒì„±ì—ë„ ì•„ë˜ì™€ ê°™ì€ ë¬¸ì œê°€ ìˆë‹¤.

```cpp
Person foo()
{
    // ê°ì²´ë¥¼ ìƒì„±í•˜ê³ 
	Person p("john", 20);
	return p;
}

int main()
{
    // retì— ë„£ìœ¼ë©´ì„œ ë‹¤ì‹œ ë³µì‚¬ìƒì„±ì´ ì¼ì–´ë‚œë‹¤.
	Person ret = foo();
	
}
```

```cpp
#include <iostream>
#include <cstring>

class Person
{
	char* name;
	int   age;
public:
	Person(const char* s, int a) : age(a)
	{
		name = new char[strlen(s) + 1];
		strcpy_s(name, strlen(s) + 1, s);
	}
	~Person() { delete[] name; }

	Person(const Person& p) : age(p.age)
	{
		name = new char[strlen(p.name) + 1];
		strcpy_s(name, strlen(p.name) + 1, p.name);	
	}

    // move ìƒì„±ìë¥¼ ë§Œë“¤ì–´ ë³´ì
	Person(Person&& p) : name(p.name), age(p.age)
	{
        // ê¸°ì¡´ì˜ ë©”ëª¨ë¦¬ ì£¼ì†ŒëŠ” ëª» ì‚¬ìš©í•˜ê²Œ ë‚ ë ¤ì¤€ë‹¤
		p.name = nullptr;	
	}

};
Person foo()
{
	Person p("john", 20);
	return p;
}
int main()
{
	Person robert("robert", 30);

	Person p1 = robert;     // ë³µì‚¬ ìƒì„±
	Person p2 = foo();      // move ìƒì„±

}
```

---

## std::moveì˜ í™œìš©

```cpp
#include <iostream>

class Object
{
public:
	Object() = default;
	Object(const Object& obj) { std::cout << "copy ctor" << std::endl;}
	Object(Object&& obj)      { std::cout << "move ctor" << std::endl;}
};

Object foo() 
{
	Object obj;
	return obj;
}
int main()
{
	Object obj1;
	Object obj2 = obj1;	                        // copy
	Object obj3 = foo();                        // move
	Object obj4 = static_cast<Object&&>(obj1);  // move - obj1ì„ ë”ì´ìƒ ì“°ì§€ ì•Šì„ê²½ìš° ê°•ì œë¡œ ë³µì‚¬ìƒì„±ì„ í•˜ê²Œ í•´ë³´ì.
	Object obj5 = std::move(obj2);              // move - ë§¤ë²ˆ static_cast<Object&&>ë¥¼ ì–¸ì œ ì ë‚˜ stdì•¼ ë¶€íƒí•´...
}
```

```cpp
#include <iostream>

class Object
{
public:
	Object() = default;
	Object(const Object& obj) { std::cout << "copy ctor" << std::endl;}

// ë§Œì•½ moveìƒì„±ìë¥¼ ì œê³µí•˜ì§€ ì•ŠëŠ”ë‹¤ë©´??
//	Object(Object&& obj)      { std::cout << "move ctor" << std::endl;}
};

int main()
{
	Object obj1;
	Object obj2 = obj1;	 
	Object obj3 = std::move(obj1);  // copy ctor - ê·¸ëƒ¥ ë³µì‚¬ìƒì„±ìê°€ í˜¸ì¶œëœë‹¤.

    // ì´ë ‡ê²Œ ë§Œë“ ì´ìœ ëŠ” std::moveë¥¼ ì“°ë”ë¼ë„ ì•ˆë˜ëŠ” ê²½ìš°ê°€ ì—†ê²Œí•˜ê¸° ìœ„í•´ì„œì´ë‹¤(ì˜ˆì „ì½”ë“œ ê³ ë ¤)
}
```

---

## std::move ë§Œë“¤ì–´ë³´ê¸°

```cpp
#include <iostream>
#include <type_traits>  // for std::remove_reference_t

class Object
{
public:
	Object() = default;
	Object(const Object& obj) { std::cout << "copy ctor" << std::endl;}
	Object(Object&& obj)      { std::cout << "move ctor" << std::endl;}
};

// 1. forwarding reference(&&)ë¡œ ë°›ì•„ì•¼ í•œë‹¤.
    // moveë¡œ r, l valueëª¨ë‘ ë“¤ì–´ê°ˆ ìˆ˜ ìˆì–´ì•¼ í•¨.
// 2. remove_reference_të¡œ referenceë¥¼ ì œê±°í•´ì•¼í•œë‹¤.
    // Tê°€ Object&ë¼ ê°€ì •í•˜ë©´ Object& && ê°€ ë˜ë©° Object&ë¡œ ë³€í™˜ëœë‹¤(copy ìƒì„±ìê°€ í˜¸ì¶œë¨)
    // Object&ì˜ referenceë¥¼ ì œê±°í•´ì•¼í•œë‹¤.
// 3. ì„±ëŠ¥í–¥ìƒìœ¼ë¡œ constexpr, noexcept ì„ ì¶”ê°€í•˜ë©´ ì¢‹ìŒ.
template<class T> 
constexpr std::remove_reference_t<T>&& move(T&& obj) noexcept 
{
	return static_cast<std::remove_reference_t<T> &&>(obj);
}

int main()
{
	Object obj1;
	Object obj2 = obj1;	 	        // copy
	Object obj3 = move(obj1);       // move
	Object obj4 = move(Object());   // move
}
```

---

## ë””í´íŠ¸ move ìƒì„±ì

| - | ì‚¬ìš©ì ì œê³µ | ì»´íŒŒì¼ëŸ¬ |
|:-------------|:------------------|:------|
| ë³µì‚¬ ìƒì„±ì | X | ë””í´íŠ¸ ë²„ì „ ì œê³µ |
| ë³µì‚¬ ëŒ€ì… ì—°ì‚°ì | X | ë””í´íŠ¸ ë²„ì „ ì œê³µ |
| move ìƒì„±ì | X | ë””í´íŠ¸ ë²„ì „ ì œê³µ |
| move ëŒ€ì… ì—°ì‚°ì | X | ë””í´íŠ¸ ë²„ì „ ì œê³µ |

| - | ì‚¬ìš©ì ì œê³µ | ì»´íŒŒì¼ëŸ¬ |
|:-------------|:------------------|:------|
| ë³µì‚¬ ìƒì„±ì | O | - |
| ë³µì‚¬ ëŒ€ì… ì—°ì‚°ì | X | ë””í´íŠ¸ ë²„ì „ ì œê³µ |
| move ìƒì„±ì | X | ì œê³µ ì•ˆí•¨(ë³µì‚¬ì‚¬ìš©) |
| move ëŒ€ì… ì—°ì‚°ì | X | ì œê³µ ì•ˆí•¨(ë³µì‚¬ì‚¬ìš©) |

| - | ì‚¬ìš©ì ì œê³µ | ì»´íŒŒì¼ëŸ¬ |
|:-------------|:------------------|:------|
| ë³µì‚¬ ìƒì„±ì | X | ì‚­ì œ ë¨ |
| ë³µì‚¬ ëŒ€ì… ì—°ì‚°ì | X | ì‚­ì œ ë¨ |
| move ìƒì„±ì | O | - |
| move ëŒ€ì… ì—°ì‚°ì | X | ì œê³µ ì•ˆí•¨(error) |

```cpp
// ì´ ì½”ë“œë¡œ í…ŒìŠ¤íŠ¸ í•´ë³´ì„¸ìš”

#include <iostream>

class String
{
public:
	String() = default;
	String(const String& obj) 		 { std::cout << "String copy ctor" << std::endl;}
	String(String&& obj)      		 { std::cout << "String move ctor" << std::endl;}
	String& operator=(const String&) { std::cout << "String copy assignment" << std::endl; return *this;}
	String& operator=(String&&)      { std::cout << "String move assignment" << std::endl; return *this;}
};

class Object
{
	String name;
public:	
	Object() = default;
	
//	Object(const Object& obj) : name(obj.name) {}
	Object& operator=(const Object& obj) { name = obj.name; return *this;}
	Object(Object&& obj) 	  : name(std::move(obj.name)) {}
//	Object& operator=(Object&& obj) { name = std::move(obj.name);return *this;}

    // ì°¸ê³ ë¡œ ì§ì ‘ ë‹¤ ì•ˆë§Œë“¤ì–´ë„ ëœë‹¤.
        // defaultë¡œ ì»´íŒŒì¼ëŸ¬ì—ê²Œ ìš”ì²­í•  ìˆ˜ ìˆìŒ.
	Object(const Object& obj) = default;
	Object& operator=(const Object& obj) = default;
	Object(Object&& obj) = default;
	Object& operator=(Object&& obj) = default;
};

int main()
{
	Object obj1;
	Object obj2 = obj1;	// error 

	obj2 = obj2; // ok


	Object obj3 = std::move(obj1);  // ok
	obj3 = std::move(obj1); // ok
}
```

* [Run This Code ğŸŒ](https://ideone.com/RyEJvE)

---

## í•µì‹¬ì„ ì •ë¦¬í•´ ë³´ìë©´ ...

* C++98
    * ì†Œë©¸ì, ë³µì‚¬ ìƒì„±ì, ë³µì‚¬ ëŒ€ì…ì—°ì‚°ì(Rule Of 3ë¼ ë¶ˆë¦¼)ë¥¼ ë¬´ì¡°ê±´ ë§Œë“¤ì–´ ì¤˜ì•¼í•œë‹¤.
    * ì†Œë©¸ìëŠ” ì•Œí…Œê³  ë³µì‚¬ ìƒì„±ì, ë³µì‚¬ ëŒ€ì…ì—°ì‚°ìëŠ” ì–•ì€ë³µì‚¬ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•¨
* C++11ì´í›„
    * ì†Œë©¸ì, ë³µì‚¬ ìƒì„±ì, ë³µì‚¬ ëŒ€ì…ì—°ì‚°ì, move ìƒì„±ì, move ëŒ€ì…ì—°ì‚°ì(Rule Of 5)ë¥¼ ë¬´ì¡°ê±´ ë§Œë“¤ì–´ ì¤˜ì•¼í•œë‹¤.
* ë‹¨, `char*`ì™€ ê°™ì´ ë©”ëª¨ë¦¬ë¥¼ ì§ì ‘ê´€ë¦¬í•´ì•¼í•˜ëŠ” ìë£Œí˜•ì„ ì¼ì„ë•Œ ì–˜ê¸°ê³ ... ê·¸ëƒ¥ `string`ì„ ì“°ë©´ ì´ëŸ° ê±±ì •í•  í•„ìš”ì—†ì´ **Rule Of 0**ê°€ ëœë‹¤.
    * ë­ê°€ ë” ì¢‹ì€ ì½”ë“œì¸ì§€ëŠ” ë³¸ì¸ì´ íŒë‹¨í•˜ì ê°œì¸ì ìœ¼ë¡  char*ê°™ì€ê±° ì“°ì§€ë§ê³  ê·¸ëƒ¥ string ì“°ì