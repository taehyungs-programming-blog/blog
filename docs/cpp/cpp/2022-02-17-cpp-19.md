---
layout: default
title: "19. perfect forwarding"
parent: (C++)
grand_parent: C++
nav_order: 2
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* perfect forwardingì´ ê·¸ë˜ì„œ ë­”ê°€?
    * ë§¤ê°œë³€ìˆ˜ë¡œ ë“¤ì–´ì˜¨ ë°ì´í„°(r, l value ëª¨ë‘)ë¥¼ ì•„ë¬´ëŸ° ê°€ê³µì—†ì´ ë‹¤ë¥¸ í•¨ìˆ˜ì— ë„˜ê¸°ê³ (forward) ì‹¶ë‹¤

ğŸ˜º ê²°ë¡ ë¶€í„° ë³´ìë©´

```cpp
// ì´ë ‡ê²Œ í•´ê²°ê°€ëŠ¥
template<class F, class ... T>
decltype(auto) chronometry(F f, T&& ... arg)
{
	return f(std::forward<T>(arg)... );
}
```

* ê·¸ ë„˜ê¸°ëŠ” ë°©ë²•ì´ ì•„ë˜ì„œ ì„¤ëª…ëœë‹¤.

---

```cpp
#include <iostream>

void foo(int  n) {} 
void goo(int& r) { r = 20;} 

// í•¨ìˆ˜ì˜ ì„±ëŠ¥(ì‹œê°„)ì„ ì¸¡ì •í•˜ëŠ” í…œí”Œë¦¿ì„ ë§Œë“ ë‹¤ê³  ê°€ì •í•´ ë³´ì.
template<class F, class T>
void chronometry(F f, T arg)
{
	// í˜„ì¬ ì‹œê°„ ë³´ê´€
	f(arg);
	// í•¨ìˆ˜ ì†Œìš” ì‹œê°„ ì¶œë ¥
}

int main()
{
	int n = 10;

    // ì•„ë˜ì²˜ëŸ¼ foo, gooí•¨ìˆ˜ì— ì¸ìë¥¼ ë³´ë‚´ê³  ì‹¶ì€ë° r, l value ì–´ë–¤ê²ƒì´ë“  ë“¤ì–´ê°ˆ ìˆ˜ ìˆë‹¤.
    // ì´ë ‡ê²Œ ì–´ë–¤ì¸ìëŠ” ì™„ë²½í•˜ê²Œ ë³´ë‚´ëŠ” ê¸°ë²•ì„ perfect forwardingì´ë¼ í•œë‹¤.
	chronometry(foo, 10); // foo(10)
	chronometry(goo, n);  // goo(n)

	std::cout << n << std::endl;
}
```

```cpp
// ì¼ë‹¨ perfect forwardingì„ êµ¬í˜„í•˜ë ¤í•˜ë©´ ê°€ì¥ ì‰½ê²Œ í•˜ëŠ” ìƒê°ì€
// const T&ë¡œ ë°›ëŠ”ê²ƒì´ë‹¤.
    // ì´ë ‡ê²Œ í•˜ë©´ r, l value ëª¨ë‘ ë°›ìœ¼ë‹ˆ í•´ê²°ëê² ì§€?
    // Nope! r, l valueë¥¼ ë°›ê¸°ëŠ” í–ˆìœ¼ë‚˜ fì— ë„˜ê¸¸ìˆ˜ê°€ ì—†ë‹¤.
    // gooì˜ ê²½ìš° ë§¤ê°œë³€ìˆ˜ê°€ int& rì¸ë° const int&ë¡œ ë³€í™˜ì‹œ int&ë¡œ ë³€í™˜ì´ ë¶ˆê°€í•˜ë‹¤
template<class F, class T>
void chronometry(F f,const T& arg)
{
	f(arg);
}
```

```cpp
void foo(int  n) {} 
void goo(int& r) { r = 20;} 

void hoo(int&& r) {}

// ìš°ì„  ì„¤ëª…ì„ ì¢€ ì‰½ê²Œ í•˜ê¸°ìœ„í•´ì„œ T = intë¡œ ê³ ì •í•˜ê³ 
// r, l valueë¥¼ ë°›ì„ìˆ˜ ìˆê²Œ ë‘ ê°œë¡œ ë§Œë“¤ë©´ ì–´ë–¨ê¹Œ?
template<class F>
void chronometry(F f, int& arg)
{
	f(arg);
}
template<class F>
void chronometry(F f, int&& arg)
{
	f(arg);
}

int main()
{
	hoo(10); // ok
	chronometry(hoo, 10);   // Error - ì™œê·¸ëŸ°ì§€ëŠ” ì•„ë˜ì„œ ì„¤ëª…

	int n = 10;
	chronometry(foo, 10); 
	chronometry(goo, n);  
	std::cout << n << std::endl;
}
```

```cpp
// chronometry(hoo, 10); í˜¸ì¶œì‹œ 10ì€ r-valueì´ê¸°ì—
template<class F>
void chronometry(F f, int&& arg)    // ì—¬ê¸°ë¡œ í˜¸ì¶œë˜ë©°
{
    // 10ì€ argë¼ëŠ” ì´ë¦„ì„ ê°–ê²Œ ë˜ë©° l-valueê°€ ëœë‹¤.
	f(arg);
}

// void hoo(int& r) {} ì»´íŒŒì¼ëŸ¬ëŠ” l-value ë§¤ê°œë³€ìˆ˜ë¥¼ ê°–ëŠ” hooë¥¼ ì°¾ê²Œë˜ë©° Errorë°œìƒ!
```

```cpp
// í•´ê²°ì±…?

template<class F>
void chronometry(F f, int&& arg)
{
    // r-valueë¡œ ë“¤ì–´ì™”ë˜ì• ëŠ” ë‹¤ì‹œ r-valueë¡œ ìºìŠ¤íŒ…í•´ì£¼ì
	f(static_cast<int&&(arg));
}
```

* ê²°ë¡ 
    * perfect forwardingì„ ìœ„í•´ì„œëŠ”
    * r-value í•¨ìˆ˜, l-value í•¨ìˆ˜ë¥¼ ëª¨ë‘ ì œê³µí•´ì•¼í•œë‹¤.
    * ë‹¨, r-value í•¨ìˆ˜ì˜ ê²½ìš° ë“¤ì–´ì˜¨ ë§¤ê°œë³€ìˆ˜ë¥¼ ë‹¤ì‹œ r-valueë¡œ ìºìŠ¤íŒ… í•´ì¤˜ì•¼ í•œë‹¤.

```cpp
#include <iostream>

void goo(int&  n) { n = 20;}
void hoo(int&& r) {}

/*
    // ë§¤ë²ˆ ì´ë ‡ê²Œ ì½”ë“œë¥¼ ì§œì•¼í• ê¹Œ?

    template<class F>
    void chronometry(F f, int& arg)
    {
    //	f(arg);
        f( static_cast<int&>(arg) );
    }
    template<class F>
    void chronometry(F f, int&& arg)
    {
        f(static_cast<int&&>(arg));
    }
*/

template<class F, class T>
void chronometry(F f, T&& arg)
{
// forwarding referenceë¥¼ ì´ìš©í•˜ì—¬ 
    // & && -> &
    // && & -> &
    // && && -> &&
    // ì¼í…Œë‹ˆ í•´ê²°ê°€ëŠ¥?
//	f(static_cast<T&&>(arg));
// static_cast<T&&>ë„ ê¸¸ë‹¤ ì‹¶ì–´ì„œ stdì—ì„œ forwardë¥¼ ì œê³µí•œë‹¤.

	f( std::forward<T>(arg));
}

int main()
{	
	int n = 0;
	chronometry(goo, n);
	chronometry(hoo, 10);

	std::cout << n << std::endl; // 20
}
```

ğŸ˜º ê·¸ëŸ°ë° ë§¤ê°œë³€ìˆ˜ê°€ í•˜ë‚˜ë§Œ ì „ë‹¬ë ê¹Œ?

```cpp
#include <iostream>

void foo() {}

int& goo(int a, int& b, int&& c)
{
	b = 20;
	return b;
}

// ê°€ë³€ì¸ì í…œí”Œë¦¿ìœ¼ë¡œ ê°„ë‹¨íˆ í•´ê²°ê°€ëŠ¥.
template<class F, class ... T>
decltype(auto) chronometry(F f, T&& ... arg)
{
    // ë¦¬í„´í˜•ê¹Œì§€ ì²˜ë¦¬ë¥¼ ìœ„í•´ì„œ decltype(auto)ë¥¼ ë„£ìŒ
        // ê·¸ëƒ¥ autoë¡œ ì•ˆì“´ì´ìœ ëŠ” autoëŠ” reference íŠ¹ì„±ì„ ë²„ë¦¬ê²Œ ëœë‹¤.
	return f(std::forward<T>(arg)... );
}

int main()
{	
	int n = 0;

	int& ret = chronometry(goo, 10, n, 10);
				// goo(10, n, 10)
	chronometry(foo);
	ret = 100;
	
	std::cout << n << std::endl; 
}
```

ğŸ˜º ì¡°ê¸ˆë§Œ ë” ê°œì„ í•´ë³´ì.

```cpp
// ë©¤ë²„í•¨ìˆ˜ê¹Œì§€ ì²˜ë¦¬ê°€ëŠ¥í•˜ê²Œ í•´ë³´ì

#include <iostream>
#include <functional>

void foo(int n) {}

class Test
{
public:
	void f1(int n) { std::cout << "Test f1" << std::endl; }
};

template<class F, class ... T>
decltype(auto) chronometry(F f, T&& ... arg)
{
//	return f(std::forward<T>(arg)... );
// ë©¤ë²„í•¨ìˆ˜ í¬ì¸í„°ë¥¼ í˜¸ì¶œí•˜ë ¤ë©´ (obj.*f)(arg); ë¼ëŠ” ê·œì¹™ì„ ì§€ì¼œì¤˜ì•¼í•œë‹¤.
// ë‹¨, C++17 ì´í›„ invokeì˜ ë“±ì¥ìœ¼ë¡œ ì•„ë˜ì™€ ê°™ì´ ì²˜ë¦¬ê°€ëŠ¥

	return std::invoke( f, std::forward<T>(arg)... );
}

int main()
{	
	chronometry(foo, 10);

	Test obj;
	chronometry(&Test::f1, &obj, 10);

}
```

```cpp
// í•¨ìˆ˜ ê°ì²´ê¹Œì§€ ì§€ì›í•˜ê²Œ í•´ë³´ì.
    // í•¨ìˆ˜ ê°ì²´ -> () ì—°ì‚°ìë¥¼ ì¬ì •ì˜í•´ì„œ í•¨ìˆ˜ì²˜ëŸ¼ ì‚¬ìš©ê°€ëŠ¥í•œ ê°ì²´

#include <iostream>
#include <functional>

struct Functor
{
	void operator()(int n) &
	{
		std::cout << "operator() &" << std::endl;
	}
	void operator()(int n) &&
	{
		std::cout << "operator() &&" << std::endl;
	}
};

template<class F, class ... T>
decltype(auto) chronometry(F&& f, T&& ... arg)
{
    // std::forward<F>(f)ë¥¼ í•˜ëŠ”ì´ìœ ëŠ” fì— ë“¤ì–´ì˜¤ë©´ì„œ ì´ë¦„ì´ ìƒê²¨
        // r-valueê°€ l-valueê°€ ë˜ì–´ë²„ë¦¼ ë”°ë¼ì„œ std::forward<F>(f)ë¥¼ ì¨ì¤˜ì•¼í•œë‹¤.
	return std::invoke( std::forward<F>(f), 
				        std::forward<T>(arg)... );
}

int main()
{	
	Functor f;
	f(10); // f.operator()(10)
	Functor()(10); // operator() &&
	chronometry(f, 10);
	chronometry(Functor(), 10);
}
```

