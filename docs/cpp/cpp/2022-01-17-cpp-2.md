---
layout: default
title: "2. shared_ptr"
parent: (C++)
grand_parent: C++
nav_order: 1
---

* ì´ë ‡ê²Œë§Œ ê¸°ì–µí•´ë„ 90ì ì€ ë°›ëŠ”ë‹¤
    * í•´ë‹¹ í´ë˜ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ëŠ” í¬ì¸í„° ğŸ‘‰ `unique_ptr`
    * ë‹¤ë¥¸ í´ë˜ìŠ¤ì—ì„œ ì°¸ì¡°í•´ì•¼í•  í¬ì¸í„° ğŸ‘‰ `shared_ptr`

```cpp
// Example
#include <iostream>
#include <memory>
using namespace std;

class cl1
{
public:
    cl1() { cout << "cl1()" << endl; }
    ~cl1() { cout << "~cl1()" << endl; } 
    void printCL1() { cout << "Hello This is CL!" << endl; }
};

class parent1
{
public:
    parent1(int num) { cout << "parent1() : " << num << endl; m_num = num; }
    ~parent1() { cout << "~parent1() : " << m_num  << endl; }
    void SetCL1(shared_ptr<cl1> _cl1) { m_cl1 = _cl1; }
    void PrintCL1() { m_cl1->printCL1(); }
private:
    shared_ptr<cl1> m_cl1;
    int m_num = -1;
};

int main() {
    // your code goes here
    shared_ptr<cl1> m_cl1 = make_shared<cl1>();
    unique_ptr<parent1> m_pr1 = make_unique<parent1>(1);
    parent1* m_pr2 = new parent1(2);

    m_pr1->SetCL1(m_cl1);
    m_pr2->SetCL1(m_cl1);

    m_pr1->PrintCL1();
    m_pr2->PrintCL1();

    return 0;
}
```

```
cl1()
parent1() : 1
parent1() : 2
Hello This is CL!
Hello This is CL!
~parent1() : 1
```

<br>

---

ì´ë ‡ê²Œ ëë‚´ê¸´ ì•„ì‰¬ìš°ë‹ˆ...

##  shared_ptrì´ë€?

* ê²°ë¡ ì ìœ¼ë¡  ê°œë°œìê°€ deleteë¥¼ ì§ì ‘í•˜ì§€ ì•Šê²Œ í•˜ê² ë‹¤ê°€ í•µì‹¬ì´ë‹¤.

```cpp
// Example
class Car
{
    int color;
    int speed;
public:
    ~Car() { cout << "~Car()" << endl; }
    void Go() { cout << "Car go" << endl; }
};

int main() {
    vector<shared_ptr<Car>> m_carVec;
    for(int i =0 ; i < 10; i++)
    {
        m_carVec.push_back(make_shared<Car>());
    }
    // ~Car() 10ë²ˆ í˜¸ì¶œë¨.
    // ì´ëŸ°ì‹ìœ¼ë¡œ deleteë¥¼ ì§ì ‘í•´ì£¼ì§€ ì•Šì•„ë„ ëœë‹¤.
    /*
        ì°¸ê³ )
        m_carVec.pop_back();        // pop_backì„ í•´ë„ ì—­ì‹œí•˜ ì†Œë©¸ì´ ëœë‹¤.
    */
    return 0;
}
```

```cpp
// ìƒì„±ì‹œ ìœ ì˜ ì‚¬í•­
shared_ptr<Car> p = new Car;        // error
shared_ptr<Car> p(new Car);         // ok, ì‚¬ì‹¤ ì¶”ì²œì€ make_sharedì´ë‹¤.
```

---

## ì‚­ì œì ë„£ê¸°

```cpp
void foo(Car* p)
{
    cout << "Delete Car" << endl;
    delete p;
}

int main()
{
    shared_ptr<Car> p(new Car, foo);    // ì‚­ì œìë¥¼ ë„£ì„ ìˆ˜ ìˆë‹¤.
    shared_ptr<Car> p(new Car, [](Car* p){ delete p; }]);
}
```

```cpp
shared_ptr<Car> p(new Car, foo, MyAlloc<Car>);  // í• ë‹¹ì ì—­ì‹œ ë„£ì„ ìˆ˜ ìˆë‹¤.
// ìì„¸í•œê±´ ë‚´ìš©ì´ ê¸¸ì–´ì ¸ iocpë‚´ìš© ì°¸ê³ 
```

---

## ë°°ì—´ì‚¬ìš©í•˜ê¸°

```cpp
shared_ptr<Car> p(new Car[10], [](Car* p){ delete[] p; });
// ë°°ì—´ì„ ì“¸ ê²½ìš° ì‚­ì œìë¥¼ ë¬´ì¡°ê±´ ë„£ì–´ì¤˜ì•¼í•œë‹¤.
p[0].Go();      // error - shared_ptrì€ ë°°ì—´ì„ ê³ ë ¤í•´ì„œ ë§Œë“¤ì–´ì§€ì§€ ì•Šì•˜ìŒ
```

```cpp
// C++17 ì´í›„ì—ëŠ” shared_ptrì— ë°°ì—´ì„ ì§€ì›í•œë‹¤.
shared_ptr<Car> p1(new Car[10]);       // error - ì‚­ì œìë¥¼ ë„£ì–´ì¤˜ì•¼í•¨!
shared_ptr<Car[]> p1(new Car[10]);      // ok!
```

---

## ì°¸ê³  í•¨ìˆ˜ë“¤

```cpp
shared_ptr<Car> p(new Car);
p->Go();
//p.something; // shared_ptrìì²´ ë©¤ë²„ì— ì ‘ê·¼
p.get();                // ëŒ€ìƒì²´ì˜ í¬ì¸í„°
p.usecount();           // ì°¸ì¡°ê³„ìˆ˜ ë°˜í™˜
p.reset(new Car);       // ëŒ€ìƒì²´ ë³€ê²½
p.swap(new Car);        // ëŒ€ìƒì²´ êµí™˜
```