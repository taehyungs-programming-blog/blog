---
layout: default
title: "13. memory order"
parent: (Concurrency)
grand_parent: C++
nav_order: 2
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## reorder

```cpp
int a = 0;
int b = 0;

// thread A
void foo()
{
    a = b + 1;
    b = 1;
}

// thread B
void goo()
{
    if(b == 1)
    {
        // a == 1 ì„ ë³´ì¥í• ìˆ˜ ìˆì„ê¹Œ?
        // ë³´ì¥í• ìˆœ ì—†ë‹¤.) 
        // ìµœì í™” ì˜µì…˜ì— ë”°ë¼ fooí•¨ìˆ˜ì—ì„œ b = 1ì´ ë¨¼ì €ì‹¤í–‰ë˜ê¸°ë„ a = b + 1ì´ ë¨¼ì € ì‹¤í–‰ë˜ê¸°ë„ í•œë‹¤.
    }
}
```

ğŸ¦„ ì™œ ê·¸ë ‡ê²Œ ë ê¹Œ? ğŸ‘‰ **re-ordering**ë•Œë¬¸ì´ë‹¤.

```cpp
void foo()
{
    a = b + 1;  // aë¥¼ ì“°ê¸°ìœ„í•´ì„œ bì„ ì½ì–´ì™€ì•¼í•œë‹¤.
    b = 1;      // ì–´ì°¨í”¼ ì—¬ê¸°ì„œ bì— 1ì„ ë„£ì–´ì•¼ í•˜ê¸°ì—
    // a = b + 1;ì—ì„œ bì„ ì½ì–´ì™”ì„ë•Œ bë¥¼ ë¨¼ì € 1ì„ ë„£ì–´ë²„ë¦°ë‹¤ë©´? -> re-ordering
    // ì»´íŒŒì¼ëŸ¬ ë‚˜ë¦„ëŒ€ë¡œ ì„±ëŠ¥í–¥ìƒì„ ë³¼ ìˆ˜ ìˆì„ê²ƒì´ë‹¤.
    // ì´ê²ƒì´ ë¬¸ì œê°€ ëœë‹¤.
}
```

ğŸ¦„ ì„±ëŠ¥í–¥ìƒì„ ìœ„í•´ ì½”ë“œì˜ ì‹¤í–‰ìˆœì„œë¥¼ ë³€ê²½í•˜ê²Œ ë˜ëŠ”ë°<Br> 
ğŸ¦„ ì»´íŒŒì¼, ì‹¤í–‰ì‹œê°„ì— ë°œìƒí•˜ë©° ì´ë¡œ ì¸í•´ì„œ ìƒê°ì§€ ëª»í•œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤<Br> 
ğŸ¦„ í•´ê²°ì±…ì€ ì—†ë‚˜ ğŸ‘‰ `fence`ì´ìš©

```cpp
#include <atomic>

// ...

void foo()
{
    a = b + 1;
    
    // ìœ„ ì½”ë“œê°€ ì•„ë˜ë¡œ ë„˜ì–´ê°ˆìˆ˜ ì—†ë‹¤.
    std::atomic_thread_fence(std::memory_order_release);

    b = 1;
}
```

---

## memory_order

```cpp
#include <thread>

int x = 0;
int y = 0;

// foo, gooë¥¼ ë³¼ë•Œ 
// 1. ìŠ¤ë ˆë“œ ì„¸ì´í”„í•œê°€(atomic operation ê°€ëŠ¥)
// 2. re-orderingìœ¼ë¡œ ì½”ë“œì˜ ìˆœì„œê°€ ë³€ê²½ë  ì¼ì´ ì—†ëŠ”ê°€
// ë¥¼ ì¤‘ì ìœ¼ë¡œ í™•ì¸í•´ ë³´ì

void foo()
{
    // ë³´ë©´ ì•Œê² ì§€ë§Œ atomicí•˜ì§€ë„ re-orderingì´ ë‚˜íƒ€ì§€ ì•Šì„ ê²ƒì´ë€ ë³´ì¥ë„ ì—†ë‹¤.
    // ë©€í‹°ìŠ¤ë ˆë“œì—ì„œëŠ” ì‚¬ìš©í•˜ë©´ ì•ˆë˜ëŠ” ì½”ë“œì´ë‹¤.
    int n1 = y;
    x = n1;
}

void goo()
{
    int n2 = x;
    y = 100;
}

int main()
{
    std::thread t1(foo);
    std::thread t2(goo);
    t1.join(); t2.join();
}
```

í•´ê²°í•´ë³´ì.

```cpp
#include <thread>
#include <atomic>

std::atomic<int> x = 0;
std::atomic<int> y = 0;

void foo()
{
    int n1 = y.load(std::memory_order_relaxed);
    // std::memory_order_relaxed : atomicë§Œ ë³´ì¥, re-orderingì€ ë³´ì¥í•˜ì§€ ì•ŠìŒ, ë‹¨, ì˜¤ë²„í—¤ë“œê°€ ê°€ì¥ ì‘ë‹¤
    x.store(n1, std::memory_order_relaxed);
}

void goo()
{
    int n2 = x.load(std::memory_order_relaxed);
    y.store(100, std::memory_order_relaxed);
}

int main()
{
    std::thread t1(foo);
    std::thread t2(goo);
    t1.join(); t2.join();
}
```

```cpp
#include <thread>
#include <atomic>
#include <cassert>

std::atomic<int> data1 = 0;
std::atomic<int> data2 = 0;
std::atomic<int> flag = 0;

void foo()
{
    data1.store(100, std::memory_order_relaxed);
    data2.store(200, std::memory_order_relaxed);
    flag.store(1, std::memory_order_relaxed);
}

void goo()
{
    if(flag.load(std::memory_order_relaxed) > 0)
    {
        // re-orderingì´ ë³´ì¥ë˜ì§€ ì•Šê¸°ì— assertì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
        assert(data1.load(std::memory_order_relaxed) == 100);
        assert(data2.load(std::memory_order_relaxed) == 200);
    }
}

int main()
{
    std::thread t1(foo);
    std::thread t2(goo);
    t1.join(); t2.join();
}
```

```cpp
void foo()
{
    data1.store(100, std::memory_order_relaxed);
    data2.store(200, std::memory_order_relaxed);
    flag.store(1, std::memory_order_release);
    // std::memory_order_release ì´ì „ì˜ ì½”ë“œëŠ” std::memory_order_acquireì´í›„ì— ì½ì„ìˆ˜ ìˆìŒì„ ë³´ì¥
    // ë¬´ì¡°ê±´ data1.store(100, std::memory_order_relaxed);, data2.store(200, std::memory_order_relaxed); ì‹¤í–‰ì„ ë³´ì¥
}

void goo()
{
    if(flag.load(std::memory_order_acquire) > 0)
    {
        // re-orderingì´ ë³´ì¥ë˜ì§€ ì•Šê¸°ì— assertì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
        assert(data1.load(std::memory_order_relaxed) == 100);
        assert(data2.load(std::memory_order_relaxed) == 200);
    }
}
```

```cpp
#include <thread>
#include <atomic>
#include <cassert>

std::atomic<int> data1 = 0;
std::atomic<int> data2 = 0;

int main()
{
    // std::memory_order_seq_cst : atomic, re-ordering ëª¨ë‘ ë³´ì¥í•´ ë‹¬ë¼
    data1.store(100, std::memory_order_seq_cst);
    data2.store(200, std::memory_order_seq_cst);
    data2.store(300);   // ë””í´íŠ¸ê°€ std::memory_order_seq_cstì´ê³  ì˜¤ë²„í—¤ë“œê°€ ê°€ì¥ í¼.
}
```