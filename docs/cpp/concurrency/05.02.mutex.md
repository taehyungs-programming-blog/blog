---
layout: default
title: "5-2. mutex lock vs spin lock"
parent: (Concurrency)
grand_parent: (C++)
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* [ì°¸ê³  ì‚¬ì´íŠ¸ ğŸŒ](https://jabdon4ny.tistory.com/m/112)

---

## mutex lockì˜ ë‹¨ì ?

```cpp
#include <iostream>
#include <atomic>
#include <thread>
#include <mutex>

std::mutex m;
int shared_counter = 0;

void work()
{
	m.lock();
	shared_counter++;
	m.unlock();
}

int main()
{
	std::thread t1(work), t2(work);

	t1.join();
	t2.join();
}
```

* ë‘ ë²ˆì§¸ë¡œ ë„ì°©í•œ ThreadëŠ” blockì´ ë˜ë©° threadê°€ ëŒ€ê¸°í•˜ê²Œ ëœë‹¤.
* Q) ì´ê²Œ ì™œ ë‹¨ì ??
    * ê¸ˆë°© blockì´ í’€ë¦´ê²½ìš°, ê´œí•œ context switching ë¹„ìš©ë§Œ ì“°ê²Œëœë‹¤.

---

## spin lockìœ¼ë¡œ í•´ê²°í•´ ë³´ì

```cpp
#include <iostream>
#include <atomic>
#include <thread>


class SpinLock {
 public:
  SpinLock() : locked_(ATOMIC_FLAG_INIT) {}

  void lock() {
    // ì—¬ê¸°ì„œ spinì„ ëŒë©° ëŒ€ê¸°í•œë‹¤
    while (locked_.test_and_set()) {};
  }
  void unlock() {
    locked_.clear();
  }

 private:
  std::atomic_flag locked_;
};

SpinLock spin;
int shared_counter = 0;

void work()
{
	spin.lock();

	shared_counter++;
	
	spin.unlock();
}

int main()
{
	std::thread t1(work),t2(work);

	t1.join();
	t2.join();
	
    std::cout << "shared_counter = " << shared_counter << std::endl;
}
```
