---
layout: default
title: "10. call_once"
parent: (Concurrency)
grand_parent: C++
nav_order: 2
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

ğŸ¦„ ë™ì¼í•œ í•¨ìˆ˜ë¥¼ ì—¬ëŸ¬ ê°œì˜ ìŠ¤ë ˆë“œë¥¼ ìˆ˜í–‰í•˜ì§€ë§Œ, ì´ˆê¸°í™” ì‘ì—…ì€ í•œ ë²ˆë§Œ í•˜ê³  ì‹¶ë‹¤ë©´?

```cpp
#include <iostream>
#include <thread>
#include <chrono>
#include <mutex>
using namespace std::literals;

std::once_flag init_flag;

void init(int a, double d)
{
    std::cout << "init" << std::endl;
    std::this_thread::sleep_for(2s);
    // ë§Œì•½ ì—¬ê¸°ì„œ ëŒ€ê¸°ë¥¼ í•´ì•¼í•œë‹¤ë©´
    // ì´ ì´í›„ì— í˜¸ì¶œëœ ìŠ¤ë ˆë“œë“¤ì€ ëª¨ë‘ std::call_onceì—ì„œ initì´ ì¢…ë£Œë˜ê¸°ë¥¼ ëŒ€ê¸°í•˜ê³  ìˆëŠ”ë‹¤
}

void foo()
{
    std::cout << "start foo" << std::endl;
    //init(10, 3.4);
    std::call_once(init_flag, init, 10, 3.4);   // ì²˜ìŒ ë¶ˆë¦°ì´í›„ì—ëŠ” í˜¸ì¶œë˜ì§€ ì•ŠìŒ.
    std::cout << "finish foo" << std::endl;
}

int main()
{
    std::thread t1(foo);
    std::thread t2(foo);
    std::thread t3(foo);
    t1.join();
    t2.join();
    t3.join();
}
```

---

## Example 1

```cpp
class Singleton
{
private:
    Singleton() = default;
    static Singleton* sinstance;
public:
    Singleton(const Singleton&) = delete;
    Singleton& operator=(const Singleton&) = delete;

    static Singleton* getInstance()
    {
        // ì—¬ê¸°ê°€ ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ë¶ˆì•ˆì •í•˜ë‹¤
        if(sinstance == nullptr)
            // newë¥¼ í•˜ëŠ” ì¤‘ê°„ì— ë‹¤ë¥¸ threadì—ì„œ newë¥¼ í•´ë²„ë¦¬ë©´??
            sinstance = new Singleton;
        return sinstance;
    }
};
Singleton* Singleton::sinstance == nullptr;
```

```cpp
class Singleton
{
private:
    Singleton() = default;
    static Singleton* sinstance;
    static std::once_flag create_flag;
public:
    Singleton(const Singleton&) = delete;
    Singleton& operator=(const Singleton&) = delete;

    static Singleton* getInstance()
    {
        std::call_once(create_flag, initSingleton);
        return sinstance;
    }
    static void initSingleton()
    {
        sinstance = new Singleton;
    }
};
Singleton* Singleton::sinstance == nullptr;
std::once_flag Singleton::create_flag;
```

---

## Example 2

```cpp
class Singleton
{
private:
    Singleton()
    {
        std::cout << "start ctor" << std::endl;
        std::this_thread::sleep_for(3s);
        std::cout << "finish ctor" << std::endl;
    }
public:
    Singleton(const Singleton&) = delete;
    Singleton& operator=(const Singleton&) = delete;

    static Singleton& getInstance()
    {
        std::cout << "start getInstance" << std::endl;
        static Singleton instance;
        std::cout << "finish getInstance" << std::endl;
        return instance;
        // staticìœ¼ë¡œ ì„ ì–¸ë˜ì–´ìˆìœ¼ë‹ˆ ì•ˆì „í• ê¹Œ?
        // Yes! C++11ë¶€í„°ëŠ” static ì§€ì—­ë³€ìˆ˜ëŠ” ìŠ¤ë ˆë“œì— ì•ˆì „í•˜ë‹¤
    }
};
```