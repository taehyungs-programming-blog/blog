---
layout: default
title: "2. Promise, Future"
parent: (Concurrency)
grand_parent: (C++)
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## Promise

* ìƒˆë¡œìš´ threadì˜ ê²°ê³¼ë¥¼ ì‰½ê²Œ ê³µìœ í•˜ëŠ” ë°©ë²•ì´ë‹¤.
* ì£¼ì˜í•  ì ì€ `promise` ê°ì²´ë¥¼ ì°¸ì¡°(&, &&)ë¡œ ì „ë‹¬í•´ì•¼í•œë‹¤.

* **future**: 
    * future ê°ì²´ëŠ” ì•„ì§ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ê°’ì„ í‘œí˜„í•©ë‹ˆë‹¤. ì´ ê°’ì€ ë¹„ë™ê¸°ì ìœ¼ë¡œ ê³„ì‚°ë˜ë©°, **ë¯¸ë˜ì— ì–´ëŠ ì‹œì ì— ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.** 
    * futureë¥¼ ì‚¬ìš©í•˜ëŠ” ì£¼ëœ ëª©ì ì€ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ì„œ ìˆ˜í–‰ ì¤‘ì¸ **ì‘ì—…ì˜ ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ê³ ** ê·¸ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²ƒì…ë‹ˆë‹¤. 
    * future.get() í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´, í•´ë‹¹ ì‘ì—…ì´ ì™„ë£Œë  ë•Œê¹Œì§€ í˜„ì¬ ìŠ¤ë ˆë“œê°€ ë¸”ë¡ë˜ê³ , ì‘ì—…ì´ ì™„ë£Œë˜ë©´ ê²°ê³¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
* **promise**: 
    * promise ê°ì²´ëŠ” ì–´ë–¤ ê°’ì„ ì„¤ì •í•˜ê³ , í•´ë‹¹ ê°’ì„ future ê°ì²´ì™€ ì—°ê²°í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. 
    * ì¦‰, **promiseëŠ” ê°’ì„ ìƒì„±í•˜ê³ , futureëŠ” ê·¸ ê°’ì„ ì†Œë¹„í•©ë‹ˆë‹¤.** 
* promiseì— ê°’ ì„¸íŒ…, futureë¡œ ê°’ ì½ì–´ì˜¨ë‹¤. ë¼ê³  ìƒê°í•˜ë©´ í¸í•˜ë‹¤

```cpp
#include <iostream>
#include <thread>
#include <future>
#include <chrono>
using namespace std::literals;

//void add(std::promise<int>&& p, int a, int b)
void add(std::promise<int>& p, int a, int b)
{
    int s = a + b;
    std::this_thread::sleep_for(1s);
    p.set_value(s);                     // ì§€ê¸ˆ ë°”ë¡œ ê°’ì„ ë„£ì–´ì£¼ì„¸ìš”
    // p.set_value_at_thread_exit(s);   // ìŠ¤ë ˆë“œê°€ ëë‚ ë•Œ ê°’ì„ ë„£ì–´ì£¼ì„¸ìš”
}

int main()
{
    std::promise<int> pm;
    std::future<int> ft = pm.get_future();
    //std::thread t(add, std::move(pm), 10, 20);
    std::thread t(add, std::ref(pm), 10, 20);

    // ...

    int ret = ft.get();
    std::cout << ret << std::endl;
    t.join();
}
```

---

## exception ì²˜ë¦¬

```cpp
#include <iostream>
#include <thread>
#include <future>
#include <chrono>
using namespace std::literals;

void divide(std::promise<int>&& p, int a, int b)
{
    try
    {
        if(b == 0) throw std::runtime_error("divide by zero");
        p.set_value(a/b);
    }
    catch(...)
    {
        p.set_exception(std::current_exception());  // ì£¼ threadë¡œ exceptionì„ ë³´ë‚¸ë‹¤
    }
}

int main()
{
    std::promise<int> pm;
    std::future<int> ft = pm.get_future();

    std::thread t(divide, std::move(pm), 10, 0);
    try
    {
        int ret = ft.get();
    }
    catch(std::exception& e)
    {
        std::cout << e.what() << std::endl;
    }

    t.join();
}
```

---

## Example

* ì•„ë˜ì™€ ê°™ì€ ë¬¸ì œê°€ ìˆë‹¤ê³  ê°€ì •í•´ ë³´ì.

```cpp
#include <iostream>
#include <thread>
#include <future>
#include <vector>
#include <numeric>

int main()
{
    std::vector<int> v1 = {1,2,3,4,5,6,7,8,9,10};
    std::vector<int> v2(10);

    std::partial_sum(v1.begin(), v1.end(), v2.begin());
    // v1ì˜ ë¶€ë¶„í•©ì„ êµ¬í•´ì„œ v2ì— ë„£ì–´ë¼

    int s = std::accumulate(v2.begin(), v2.end(), 0);
    // v2ë¥¼ ëª¨ë‘ ë”í•´ë¼

    // ìœ„ ë‘ ì‘ì—…ì´ ì‹œê°„ì´ ë§ì´ ê±¸ë¦°ë‹¤ë©´? 
    // threadë¡œ ë”°ë¡œ ë¹¼ì„œ ì‘ì—…í•˜ëŠ”ê²Œ íš¨ìœ¨ì ì¼ ê²ƒì´ë‹¤.

    for(auto n : v2)
        std::cout << n << ", ";

    std::cout << "\n" << s << std::endl;
}
```

```cpp
int main()
{
    std::vector<int> v1 = {1,2,3,4,5,6,7,8,9,10};
    std::vector<int> v2(10);

    // ì´ë ‡ê²Œ í•˜ë©´ë ê¹Œ?
    std::thread t([&]{
        std::partial_sum(v1.begin(), v1.end(), v2.begin());
        int s = std::accumulate(v2.begin(), v2.end(), 0);
    });

    // Nope! : tì˜ ì—°ì‚°ì´ ëë‚˜ê¸°ì „ forë¬¸ì„ ëŒê²Œëœë‹¤
    for(auto n : v2)
        std::cout << n << ", ";

    std::cout << "\n" << s << std::endl;
    t.join();
}
```

```cpp
// í•´ê²°ì±…

int main()
{
    std::vector<int> v1 = {1,2,3,4,5,6,7,8,9,10};
    std::vector<int> v2(10);

    std::promise<void> pm1;
    std::future<void> ft1 = pm1.get_future();

    std::promise<int> pm2;
    std::future<int> ft2 = pm2.get_future();
    
    std::thread t([&]{
        std::partial_sum(v1.begin(), v1.end(), v2.begin());
        pm1.set_value();    // ì²« ë²ˆì§¸ ì—°ì‚°ì´ ëë‚¨ì„ ì•Œë¦°ë‹¤.
        int s = std::accumulate(v2.begin(), v2.end(), 0);
        pm2.set_value(s);
    });

    ft1.get();  // ì²« ë²ˆì§¸ ì—°ì‚°ëŒ€ê¸°
    for(auto n : v2)
        std::cout << n << ", ";

    int ret = ft2.get();
    std::cout << "\n" << s << std::endl;
    t.join();
}
```

---

## futureë¥¼ íŠ¹ì • ì‹œê°„ë§Œ ëŒ€ê¸°í•˜ê³  ì‹¶ë‹¤ë©´?

```cpp
#include <iostream>
#include <thread>
#include <future>
#include <chrono>
using namespace std::literals;

void add(std::promise<int>&& p, int a, int b)
{
    std::this_thread::sleep_for(3s);
    p.set_value(a+b);
}

int main()
{
    std::promise<int> pm;
    std::future<int> ft = pm.get_future();

    std::thread t(add, std::move(pm), 10, 20);
    
    //int n1 = ft.get();  // getì€ ë¬´í•œì • ëŒ€ê¸° -> íŠ¹ì •ì‹œê°„ë§Œ ëŒ€ê¸°í•˜ê³  ì‹¶ë‹¤ë©´?
    std::future_status ret = ft.wait_for(2s);

    if(ret == std::future_status::ready)
        std::cout << "ready!" << std::endl;
    else if(ret == std::future_status::timeout)
        std::cout << "timeout!" << std::endl;
    else
        std::cout << "deferred!" << std::endl;

    t.join();
}
```

---

## shared future

* `set_value`ë¥¼ í•œ ê°’ì„ ì—¬ëŸ¬ `thread`ì—ì„œ `get`í•˜ê³  ì‹¶ë‹¤

```cpp
#include <iostream>
#include <thread>
#include <future>
#include <chrono>
using namespace std::literals;

void add(std::promise<int>&& p, int a, int b)
{
    std::this_thread::sleep_for(3s);
    p.set_value(a+b);
}

void consume(std::shared_future<int> sf)
{
    sf.get();
    std::cout << "finish foo" << std::endl;
}

int main()
{
    std::promise<int> pm;
    std::future<int> ft = pm.get_future();
    //std::future<int> ft2 = ft;  // Error futureëŠ” ë³µì‚¬ê°€ ì•ˆëœë‹¤.
    std::shared_future<int> ft2 = ft.share();

    std::thread t(add, std::move(pm), 10, 20);

    std::thread t1(consume, ft2);
    std::thread t2(consume, ft2);

    t.join();
    t1.join();
    t2.join();
}
```

ğŸ¦„ ì£¼ì˜ì‚¬í•­

```cpp
#include <iostream>
#include <thread>
#include <future>
#include <chrono>
using namespace std::literals;

void add(std::promise<int>&& p, int a, int b)
{
    std::this_thread::sleep_for(3s);
    p.set_value(a+b);   // 1. set_valueëŠ” í•œ ë²ˆë§Œ í•  ìˆ˜ ìˆë‹¤.
}

int main()
{
    std::promise<int> pm;
    std::future<int> ft = pm.get_future();  // 2. futureëŠ” í•œ ë²ˆë§Œ í•  ìˆ˜ ìˆë‹¤(ì—¬ëŸ¬ê°œ êº¼ë‚´ê³  ì‹¶ë‹¤ë©´ shared_future)
    std::thread t(add, std::move(pm), 10, 20);

    ft.get();   // 3. getë„ í•œ ë²ˆë§Œ í•  ìˆ˜ ìˆë‹¤(getì„ í–ˆëŠ”ì§€ ì—¬ë¶€ëŠ” valid()ë¡œ í™•ì¸)
    t.join();
}
```

---

## `promise`ë¥¼ ë„˜ê¸°ì§€ ì•Šê³  ê¸°ì¡´ í•¨ìˆ˜ë¥¼ futureë¡œ ì“°ê³ ì‹¶ë‹¤ë©´?

```cpp
#include <iostream>
#include <thread>
#include <future>

// promiseë¥¼ ì¼ë‹¤ëŠ”ê²Œ ì´ë¯¸ ë©€í‹° ìŠ¤ë ˆë“œë¥¼ ì—¼ë‘ì— ë‘” í•¨ìˆ˜ì´ë‹¤.
void add(std::promise<int>&& p, int a, int b)
{
    p.set_value(a+b);
}

// ë§Œì•½ ê¸°ì¡´í•¨ìˆ˜ë¥¼ ì“°ê³ ì‹¶ë‹¤ë©´? -> packaged_task
int add(int a, int b)
{
    return a+b;
}

int main()
{
    std::promise<int> pm;
    std::future<int> ft = pm.get_future();
    std::thread t(add, std::move(pm), 10, 20);

    ft.get();
    t.join();

    // ----------------

    // packaged_task

    std::packaged_task<int(int, int)> task(add);
    std::future<int> ft = task.get_future();
    task(10, 20);   // í•¨ìˆ˜ê°€ í˜¸ì¶œëœë‹¤.
    std::thread t(std::move(task), 10, 20); // ë©€í‹°ì“°ë ˆë“œë¥¼ ì“°ê² ë‹¤ë©´
    int ret = ft.get();
    t.join();
}
```

---

## Example

```cpp
#include <iostream>
#include <future>
#include <thread>

void compute(std::promise<int> &&p) {
    // ì–´ë–¤ ê³„ì‚°ì„ ìˆ˜í–‰í•œë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤. ì—¬ê¸°ì—ì„œëŠ” ë‹¨ìˆœíˆ ìˆ«ìë¥¼ ì œê³±í•˜ëŠ” ê²ƒìœ¼ë¡œ í•©ë‹ˆë‹¤.
    int result = 2 * 2;
    
    // ê³„ì‚°ì´ ì™„ë£Œë˜ë©´ promiseë¥¼ í†µí•´ ê²°ê³¼ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
    p.set_value(result);
}

int main() {
    // promiseì™€ future ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    std::promise<int> p;
    std::future<int> f = p.get_future();

    // ê³„ì‚°ì„ ìˆ˜í–‰í•  ìƒˆë¡œìš´ ìŠ¤ë ˆë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. promise ê°ì²´ë¥¼ ìŠ¤ë ˆë“œì— ì „ë‹¬í•©ë‹ˆë‹¤.
    std::thread t(compute, std::move(p));

    // ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œëŠ” futureë¥¼ í†µí•´ ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
    std::cout << "Waiting for the result..." << std::endl;
    int result = f.get();  // ê²°ê³¼ê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ë¸”ë¡ë©ë‹ˆë‹¤.

    // ê²°ê³¼ë¥¼ ì¶œë ¥í•˜ê³  ìŠ¤ë ˆë“œë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤.
    std::cout << "Result is: " << result << std::endl;
    t.join();

    return 0;
}

```