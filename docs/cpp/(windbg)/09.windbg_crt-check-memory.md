---
layout: default
title: "09. CrtCheckMemory"
parent: "(Windows Debugging)"
grand_parent: "(C++)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* `_CrtCheckMemory()`는 Visual C++에서 제공하는 디버그 힙 메모리 검증 함수
* 메모리 손상 여부를 확인하여 메모리 누수 및 오버런 문제를 조기에 발견

## 기본 설정

### 1. 공용 헤더 설정
```cpp
#ifdef _DEBUG
    #define _CRTDBG_MAP_ALLOC       // heap 메모리 앞에 메타데이터 붙여달라
    #include <crtdbg.h>
    #define new new(_NORMAL_BLOCK, __FILE__, __LINE__) // new 코드라인, 파일명 넣기
#endif
```

**주요 매크로 설명:**
- `_CRTDBG_MAP_ALLOC`: 힙 메모리 할당 시 추가 메타데이터를 포함
- `new` 재정의: 메모리 할당 위치(파일명, 라인 번호) 추적

### 2. 프로그램 시작 시 설정
```cpp
#ifdef _DEBUG
    _CrtSetDbgFlag(_CRTDBG_ALLOC_MEM_DF | _CRTDBG_LEAK_CHECK_DF);
#endif
```

**플래그 설명:**
- `_CRTDBG_ALLOC_MEM_DF`: 디버그 힙 할당 추적 활성화
- `_CRTDBG_LEAK_CHECK_DF`: 프로그램 종료 시 자동으로 메모리 누수 검사

### 3. 프로그램 종료 시 검증
```cpp
#ifdef _DEBUG
    _ASSERT(_CrtCheckMemory());
#endif
```

## 활용법

### 소거법을 이용한 메모리 오류 추적

메모리 오류가 발생하는 구간을 좁혀가며 `_CrtCheckMemory()`를 삽입하여 문제 위치를 특정

```cpp
void SomeFunction()
{
    // 작업 1
    DoSomething1();
    _ASSERT(_CrtCheckMemory());  // 첫 번째 체크포인트
    
    // 작업 2
    DoSomething2();
    _ASSERT(_CrtCheckMemory());  // 두 번째 체크포인트
    
    // 작업 3
    DoSomething3();
    _ASSERT(_CrtCheckMemory());  // 세 번째 체크포인트
}
```

**추적 전략:**
1. 의심되는 코드 블록 사이에 `_CrtCheckMemory()` 삽입
2. 어떤 체크포인트에서 실패하는지 확인
3. 실패 구간을 더 세분화하여 정확한 위치 파악
4. 문제 코드를 특정하여 수정

## 반환값

- **TRUE**: 힙 메모리가 정상 상태
- **FALSE**: 힙 메모리 손상 감지 (버퍼 오버런, 언더런 등)

## 관련 함수

- `_CrtDumpMemoryLeaks()`: 메모리 누수 정보 출력
- `_CrtSetBreakAlloc()`: 특정 할당 번호에서 중단점 설정
- `_CrtMemCheckpoint()`: 현재 힙 상태 스냅샷 저장
