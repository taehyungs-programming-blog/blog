---
layout: default
title: "05. windbg"
parent: "(Windows Debugging)"
grand_parent: "(C++)"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* 이걸 써야할 상황이 왔다면 마지막 까지 온 것이다. (아주 불편)

## 사전사항

* windbg를 vs에서 설치된걸 쓰지말고 [MSDN](https://learn.microsoft.com/ko-kr/windows-hardware/drivers/debugger/)에서 새로 받자
    * 신규기능이 추가 됨.

---

## 유저 PC에서 덤프 파일을 받은 경우 초기 설정

덤프 파일 분석을 시작하기 전에 반드시 확인하고 설정해야 할 항목

### 1. 심볼 경로 확인

현재 설정된 심볼 경로를 확인

```
.sympath
```

### 2. 심볼 경로 설정

Microsoft 심볼 서버를 포함한 심볼 경로를 설정

```
.symfix {path}
```

기존 심볼 경로에 추가 경로를 더하려면:

```
.sympath+ {path}
```

### 3. 실행 파일 경로 설정

확인

```
.exepath
```

실행 파일(executable)의 경로를 지정

```
.exepath+ {path}
```

### 4. 소스 코드 경로 설정

확인

```
.srcpath
```

소스 파일의 경로를 지정

```
.srcpath+ {path}
```

### 5. 모듈 목록 확인

로드된 모듈들의 목록과 심볼 상태를 확인

```
lm
```

- `lm` 명령으로 각 모듈의 심볼 로드 상태를 확인하고, 필요한 경우 `.reload /f` 명령으로 심볼을 강제로 다시 로드

---

## 자주 사용하는 명령어 정리

### 스레드 및 컨텍스트 관련

#### 스레드 목록 확인
```
~
```
모든 스레드의 목록과 상태를 표시

#### 예외 컨텍스트 설정
```
.ecxr
```
예외가 발생한 시점의 컨텍스트로 전환 크래시 분석 시 가장 먼저 실행하는 명령어

### 레지스터 및 모듈 관련

#### 레지스터 값 확인
```
r
```
현재 컨텍스트의 레지스터 값들을 표시

#### 로드된 모듈 확인
```
lm
```
로드된 모든 모듈과 심볼 상태를 표시

#### 심볼 재로드
```
.reload
```
모든 모듈의 심볼을 다시 로드 심볼 문제 발생 시 사용

### 힙(Heap) 분석 명령어

#### 힙 정보 확인
```
!heap
```
프로세스의 모든 힙 정보를 표시

#### 힙 요약 정보
```
!heap -s
```
각 힙의 요약 정보를 표시

#### 특정 힙 주소 분석
```
!heap -a {heap_address}
```
지정한 힙 주소의 상세 정보를 분석

#### 힙 블록 검색
```
!heap -x {heap_address}
```
특정 주소가 포함된 힙 블록을 검색

### 구조체 및 데이터 타입 관련

#### 구조체 정의 출력
```
dt {구조체_이름}
```
구조체의 정의(멤버 변수 목록)를 표시

**예시:**
```
dt _LIST_ENTRY
```

#### 특정 주소의 구조체 데이터 출력
```
dt {구조체_이름} {주소}
```
지정한 주소에 있는 구조체의 실제 값을 표시

**예시:**
```
dt _EPROCESS 0x12345678
```

#### 구조체의 특정 멤버 변수 출력
```
dt {구조체_이름} {주소} {멤버_변수}
```
구조체의 특정 멤버 변수 값만 표시

**예시:**
```
dt _EPROCESS 0x12345678 ImageFileName
```

### 수식 평가

#### C++ 표현식 평가
```
?? {구문}
```
C++ 표현식을 평가하고 타입 정보를 포함하여 결과를 표시

**예시:**
```
?? sizeof(int)
?? pMyObject->member
```

#### MASM 표현식 평가
```
? {구문}
```
MASM(Microsoft Assembler) 표현식을 평가 주로 16진수 연산에 사용

**예시:**
```
? 0x1000 + 0x200
```

### 메모리 읽기 명령어

#### 메모리 읽기 (다양한 크기)
```
db {주소}    # Display Bytes (1바이트 단위)
dw {주소}    # Display Words (2바이트 단위)
dd {주소}    # Display DWords (4바이트 단위)
dq {주소}    # Display QWords (8바이트 단위)
```

**예시:**
```
db 0x12345678
dd esp
dq rax
```

### 메모리 쓰기 명령어

#### 메모리 수정 (다양한 크기)
```
eb {주소} {데이터}    # Edit Bytes (1바이트 단위)
ew {주소} {데이터}    # Edit Words (2바이트 단위)
ed {주소} {데이터}    # Edit DWords (4바이트 단위)
eq {주소} {데이터}    # Edit QWords (8바이트 단위)
```

**예시:**
```
eb 0x12345678 90
ed esp 0
```

### 유틸리티 명령어

#### 화면 지우기
```
cls
```
명령 창의 내용을 지웁니다.

#### 서식 출력
```
.printf
```
C 스타일의 printf 형식으로 출력

**예시:**
```
.printf "Value: 0x%p\n", poi(esp)
```

## 명령어 사용 팁

- **주소 표기**: 주소는 16진수로 표기하며, `0x` 접두사를 사용
- **명령어 조합**: 여러 명령어를 세미콜론(`;`)으로 연결하여 한 번에 실행
- **출력 제어**: 명령어 뒤에 `L{개수}`를 붙여 출력량을 제한 (예: `db 0x12345678 L10`).
- **도움말**: 모든 명령어는 `명령어 /?`로 상세 도움말을 확인

---

## 사전지식 : TEB(Thread Environment Block)

### TEB의 주요 특징:

* 각 스레드는 자신만의 TEB를 가진다
* 사용자 모드(User Mode)에서 접근 가능한 구조체
* 스레드별 정보를 저장하는 저장소 역할

### TEB에 저장되는 주요 정보:

#### 스택 정보

* 스택의 베이스 주소와 한계(limit)
* 현재 스택 포인터

#### TLS (Thread Local Storage)

* 스레드별 로컬 저장소 포인터

#### PEB 포인터

* Process Environment Block으로의 포인터
* 프로세스 전역 정보에 접근

#### 예외 처리

* 예외 핸들러 체인의 시작 주소

#### 스레드 ID

* 현재 스레드와 프로세스의 ID

#### Last Error 값

* GetLastError()가 반환하는 값 저장

```
!teb                    // 현재 스레드의 TEB 출력
dt _TEB @$teb           // TEB 구조체 상세 정보
~~[스레드번호] !teb     // 특정 스레드의 TEB 확인
```

---

## 사전지식 : PEB(Process  Environment Block)

**PEB(Process Environment Block)**는 Windows 운영체제에서 각 프로세스마다 할당되는 데이터 구조체입니다.

### PEB의 주요 특징

* 프로세스당 하나의 PEB를 가진다
* 사용자 모드(User Mode)에서 접근 가능
* 프로세스 전역 정보를 저장하는 저장소 역할
* 모든 스레드의 TEB가 동일한 PEB를 가리킨다

### PEB에 저장되는 주요 정보:

#### 로더 정보

* 로드된 모듈(DLL) 리스트
* 실행 파일과 DLL들의 베이스 주소

#### 힙 정보

* 프로세스 힙의 개수와 주소
* 기본 힙(Default Heap) 포인터

#### 프로세스 파라미터

* 명령줄 인자(Command Line)
* 환경 변수
* 현재 디렉토리
* 이미지 파일 경로

#### 디버깅 관련

* 디버거 연결 여부
* BeingDebugged 플래그

#### OS 버전 정보

* Windows 버전 정보

```
!peb                    // 현재 프로세스의 PEB 출력
dt _PEB @$peb           // PEB 구조체 상세 정보
!peb 주소               // 특정 주소의 PEB 확인
lm                      // 로드된 모듈 리스트 (PEB 정보 활용)
```

---

## 본격적으로 dmp디버깅을 해보자

```
# 분석을 시작해 주세요
!analyze –v

# heap 체크
!heap
```

---

## Win11 24H2의 OS 버그

```
!heap
```

* 명령을 하면 heap이 하나만 보임
* 실제론 하나가 아니다. windbg가 24H2의 업데이트를 못 따라가는 듯.