---
layout: default
title: "1. ê°„ë‹¨ ì‚¬ìš©ë²• ì •ë¦¬"
parent: (Protobuf)
grand_parent: C++
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

{% raw %}

ğŸ¶ ì •í™•í•œ ì´í•´ë¥¼ ìœ„í•´ì„œ ì™œ protobufê°€ í•„ìš”í•œì§€ ì´í•´ê°€ í•„ìš”í•œë°... ì„¤ëª…ì´ ë„ˆë¬´ ê¸¸ì–´ì§€ë‹ˆ ì°¸ê³ ì‚¬ì´íŠ¸ë¥¼ ì°¸ê³ í•˜ê³ , ëŒ€ëµ ì„¤ëª…í•˜ìë©´ ì‚¬ìš©ì„±ì˜ í¸ì˜ë¥¼ ìœ„í•´ì„œ protobufë¥¼ ì‚¬ìš©í•œë‹¤. ê³  ì´í•´í•˜ë©´ 90ì ì€ ë°›ëŠ”ë‹¤.

---

## ë‹¤ìš´ë¡œë“œ

* [protobuf git ğŸŒ](https://github.com/protocolbuffers/protobuf/releases)ì—ì„œ ìš°ì„  win64ìš© protobuf ì»´íŒŒì¼ëŸ¬ë¥¼ ë‹¤ìš´ ë°›ì

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/cpp/protobuf/protobuf-1-1.png"/>
</p>

ğŸ¶ ìœ„ì—ì„œ ë§í•˜ëŠ” ì»´íŒŒì¼ëŸ¬ë€ íŠ¹ì • ì–‘ì‹ìœ¼ë¡œ íŒ¨í‚·ì„ ì •ì˜í•˜ë©´ ìë™ìœ¼ë¡œ ì½”ë“œë¥¼ ë½‘ì•„ì£¼ëŠ” ë„êµ¬ë¥¼ ì»´íŒŒì¼ëŸ¬ë¼ ë§í•œë‹¤.<br>
ğŸ¶ íŒŒì¼ì˜ êµ¬ì¡°ëŠ” ì•„ë˜ì™€ ê°™ê³  protobufë¥¼ ì‚¬ìš©í•  í”„ë¡œì íŠ¸ì™€ í•¨ê»˜ ë‘ì

```
protobuf
   |
   ------- bin
   |        |
   |        ------- protoc.exe
   |
   ------- include
            |
            ------- google
                       |
                       --------- protobuf
                                    |
                                    ...
```

---

## ê°„ë‹¨ í…ŒìŠ¤íŠ¸

ğŸ¶ `protoc.exe`ê°€ ìˆëŠ” í´ë”ë‚´ì—ì„œ protocol.proto íŒŒì¼ì„ ìƒì„±í›„ ë‚´ìš©ì„ ì•„ë˜ì™€ ê°™ì´ ë§Œë“¤ì–´ ë³´ì.

* ì°¸ê³ ) [proto3 ë¬¸ë²• ğŸŒ](https://developers.google.com/protocol-buffers/docs/proto3)

```
syntax = "proto3";              // proto ë²„ì „ì„ ì•Œë¦°ë‹¤.
package Protocol;               // íŒ¨í‚¤ì§€ ì¸ìŠ¤í†¨

// êµ¬ì¡°ì²´
message BuffData
{
	uint64 buffId = 1;              // 1ì€ íŒ¨í‚·ì˜ ì²« ë²ˆì§¸ì— ìˆë‹¤ê³  ì•Œë¦°ë‹¤.
	float remainTime = 2;
	repeated uint64 victims = 3;    // repeatedëŠ” ê°€ë³€ë°ì´í„°ë¥¼ ì˜ë¯¸
}

message S_TEST
{
	uint64 id = 1;
	uint32 hp = 2;
	uint32 attack = 3;
	repeated BuffData buffs = 4;
}
```

ğŸ¶ ìœ„ íŒ¨í‚·ì„ ì½”ë“œë¡œ ë½‘ì•„ë³´ì

```bash
# GenPackets.bat
    # "-I=./" --> .proto íŒŒì¼ì´ ì–´ë””ìˆëŠ”ì§€ ì•Œë¦¼
    # "--cpp_out=./" --> cppë¡œ ë½‘ì•„ì£¼ì„¸ìš”

protoc.exe -I=./ --cpp_out=./ ./Protocol.proto
IF ERRORLEVEL 1 PAUSE   # ì—ëŸ¬ê°€ ìˆë‹¤ë©´ pause
```

ğŸ¶ ìœ„ batíŒŒì¼ì„ ì‹¤í–‰í•´ë³´ë©´ `.cc`, `.h`ê°€ ìƒì„±ëœë‹¤.

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/cpp/protobuf/protobuf-1-2.png"/>
</p>

ğŸ¶ `Protocol.pb.h`, `Protocol.pb.cc`ë¥¼ ì—´ì–´ë³´ë©´ ì½”ë“œê°€ ì—„ì²­ê¸´ë° ì•„ì§ì€ ë¶„ì„í•˜ë ¤ í•˜ì§€ë§ê³  ìš°ì„ ì€ ìì‹ ì´ ì‚¬ìš©í•˜ëŠ” í”„ë¡œì íŠ¸ì— ë‘ íŒŒì¼ì„ ì¶”ê°€ë§Œ í•˜ê³  ë¹Œë“œê°€ ë˜ê²Œê¹Œì§€ë§Œ í•´ë³´ì.

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/cpp/protobuf/protobuf-1-3.png"/>
</p>

* ë¬´ì¡°ê±´ ë¹Œë“œê°€ ì•ˆë í…ë° 
    * protobufì— í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•˜ë‹¤.
    * í•¨ê»˜ ì¶”ê°€í–ˆë˜ protobuf includeí´ë”ì˜ includeê°€ í•„ìš”í•˜ë‹¤.

### protobufì— í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•˜ë‹¤.

* [probuf github ğŸŒ](https://github.com/protocolbuffers/protobuf)ì—ì„œ ì›í•˜ëŠ” ë²„ì „ì˜ branchë¡œ ê°€ì„œ cloneì„ ë°›ì
    * cloneì‹œ sub-module ê¹Œì§€ cloneí•´ì•¼í•¨ì„ ìŠì§€ë§ì.
* CMAKEë¥¼ í†µí•´ ë¹Œë“œí•´ë³´ì.

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/cpp/protobuf/protobuf-1-4.png"/>
</p>

ğŸ¶ ì—ëŸ¬ê°€ í•œ ë²ˆëœ¨ëŠ”ë° ì •ìƒì„ ì•„ë˜ì™€ ê°™ì´ ì„¤ì •í•˜ê³  ë‹¤ì‹œ Generate

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/cpp/protobuf/protobuf-1-5.png"/>
</p>

ğŸ¶ ì•„ë˜ì™€ ê°™ì´ ìƒì„±ëœ í”„ë¡œì íŠ¸ íŒŒì¼(`protobuf.sln`)ì„ ë¹Œë“œí•œë‹¤.

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/cpp/protobuf/protobuf-1-6.png"/>
</p>

ğŸ¶ ìƒì„±ëœ `dll`, `lib`, `pdb` ë¥¼ ì˜®ê¸´ë‹¤.

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/cpp/protobuf/protobuf-1-7.png"/>
</p>

ğŸ¶ protobufë¥¼ ì‚¬ìš©í•  í”„ë¡œì íŠ¸ ë‚´ë¶€ì— libì˜ ìœ„ì¹˜ë¥¼ ì•Œë ¤ì¤€ë‹¤.

```cpp
// pch.h

#ifdef _DEBUG
#pragma comment(lib, "Protobuf\\Debug\\libprotobufd.lib")
#else
#pragma comment(lib, "Protobuf\\Release\\libprotobuf.lib")
#endif
```

---

## ì‹¤ì œë¡œ ì¨ë³´ì.

```cpp
while (true)
{
    Protocol::S_TEST pkt;
    pkt.set_id(1000);
    pkt.set_hp(100);
    pkt.set_attack(10);
    {
        // ë°ì´í„° ë‚´ë¶€ë¥¼ ì±„ìš°ëŠ” ë°©ë²•ì´ ì•„ì£¼ ë‹¤ì–‘í•˜ê²Œ ìˆìŒ(iterator ì“°ëŠ” ë²• ë“±)
            // ë‚˜ì¤‘ì— ìì„¸íˆ ì•Œì•„ë³¼ ê²ƒ.
        Protocol::BuffData* data = pkt.add_buffs();
        data->set_buffid(100);
        data->set_remaintime(1.2f);
        data->add_victims(4000);
    }
    {
        Protocol::BuffData* data = pkt.add_buffs();
        data->set_buffid(200);
        data->set_remaintime(2.5f);
        data->add_victims(1000);
        data->add_victims(2000);
    }

    SendBufferRef sendBuffer = ServerPacketHandler::MakeSendBuffer(pkt);
    GSessionManager.Broadcast(sendBuffer);

    this_thread::sleep_for(250ms);
}
```

```cpp
template<typename T>
SendBufferRef _MakeSendBuffer(T& pkt, uint16 pktId)
{
	const uint16 dataSize = static_cast<uint16>(pkt.ByteSizeLong());
	const uint16 packetSize = dataSize + sizeof(PacketHeader);

	SendBufferRef sendBuffer = GSendBufferManager->Open(packetSize);
	PacketHeader* header = reinterpret_cast<PacketHeader*>(sendBuffer->Buffer());
	header->size = packetSize;
	header->id = pktId;

    // &header[1]ì— dataSizeë§Œí¼ ì§ë ¬í™”ë¡œ ë„£ì–´ì¤˜ë¼
	ASSERT_CRASH(pkt.SerializeToArray(&header[1], dataSize));
	sendBuffer->Close(packetSize);

	return sendBuffer;
}
```

```cpp
void ClientPacketHandler::Handle_S_TEST(BYTE* buffer, int32 len)
{
	Protocol::S_TEST pkt;

    // ParseFromArray : byteë°°ì—´ì—ì„œ ë°ì´í„° íŒŒì‹±
	ASSERT_CRASH(pkt.ParseFromArray(buffer + sizeof(PacketHeader), len - sizeof(PacketHeader)));

	cout << pkt.id() << " " << pkt.hp() << " " << pkt.attack() << endl;

	cout << "BUFSIZE : " << pkt.buffs_size() << endl;

	for (auto& buf : pkt.buffs())
	{
		cout << "BUFINFO : " << buf.buffid() << " " << buf.remaintime() << endl;
		cout << "VICTIMS : " << buf.victims_size() << endl;
		for (auto& vic : buf.victims())
		{
			cout << vic << " ";
		}

		cout << endl;
	}
}
```

{% endraw %}
