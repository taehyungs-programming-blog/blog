---
layout: default
title: "3. pin을 재활용하는 방법"
parent: (DShow)
grand_parent: C++
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* [Get This Code 🌎](https://github.com/EasyCoding-7/dshow-basic/tree/main/dshow-basic-4)
* [참고 OBS GitHub 🌎](https://github.com/obsproject/obs-studio)

😺 obs에서 보면 pin을 재활용 하는 부분이 나온다.

```cpp
class CapturePin : public IPin, public IMemInputPin {/**/}
class OutputPin : public IPin, public IAMStreamConfig, public IKsPropertySet {/**/}
```

😺 어떤식으로 재활용하는지 보자.

😺 (참고) obs에서 사용된 이 캡쳐는 미디어 장비의 캡처 후 인코딩 도구로 사용되기에 미디어 장비가 없다면 캡처가 불가능하다

```cpp
bool HVideoEncoder::SetupEncoder(IBaseFilter *filter)
{
	// ...

    // 네 개의 필터가 사용되는데

	encoder = filter;
	device = std::move(deviceFilter);
	capture = new CaptureFilter(captureInfo);
	output = new OutputFilter(VideoFormat::YV12, config.cx, config.cy,
				  frameTime);

	graph->AddFilter(output, nullptr);                  // 우리가 만든 output 필터
	graph->AddFilter(device, L"Device Filter");         // 캡쳐 필터
	graph->AddFilter(encoder, L"Encoder Filter");       // 인코더 필터
	graph->AddFilter(capture, nullptr);                 // 우리가 만든 capture 필터
	return true;
}
```

<br>

😺 어떻게 Connect되는지 보면

```
-------------        -------------         -------------          -------------
|           |        |           |         |           |          |           |
|           |        |           |         |           |          |           |
|  output   |------->|  device   |-------->|  encoder  |--------->|  capture  |
|           |        |           |         |           |          |           |
|           |        |           |         |           |          |           |
-------------        -------------         -------------          -------------
```

```cpp
bool HVideoEncoder::ConnectFilters()
{
	ComPtr<IPin> deviceIn;
	ComPtr<IPin> deviceOut;
	ComPtr<IPin> encoderIn;
	ComPtr<IPin> encoderOut;
	bool success;
	HRESULT hr;

	success = GetPinByName(device, PINDIR_INPUT, L"YUV In", &deviceIn);
	if (!success) {
		Warning(L"Failed to get YUV In pin");
		return false;
	}

	success = GetPinByName(device, PINDIR_OUTPUT, L"Virtual Video Out",
			       &deviceOut);
	if (!success) {
		Warning(L"Failed to get Virtual Video Out pin");
		return false;
	}

	success = GetPinByName(encoder, PINDIR_INPUT, L"Virtual Video In",
			       &encoderIn);
	if (!success) {
		Warning(L"Failed to get encoder input pin");
		return false;
	}

	success = GetPinByName(encoder, PINDIR_OUTPUT, nullptr, &encoderOut);
	if (!success) {
		Warning(L"Failed to get encoder output pin");
		return false;
	}

	hr = graph->ConnectDirect(output->GetPin(), deviceIn, nullptr);
	if (FAILED(hr)) {
		WarningHR(L"Failed to connect output to device", hr);
		return false;
	}

	hr = graph->ConnectDirect(deviceOut, encoderIn, nullptr);
	if (FAILED(hr)) {
		WarningHR(L"Failed to connect device to encoder", hr);
		return false;
	}

	hr = graph->ConnectDirect(encoderOut, capture->GetPin(), nullptr);
	if (FAILED(hr)) {
		WarningHR(L"Failed to connect encoder to capture", hr);
		return false;
	}

	return true;
}
```