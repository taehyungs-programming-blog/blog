---
layout: default
title: "2. Win32 í”„ë¡œì íŠ¸ ì„¸íŒ… + VMR9 Surface Allocator"
parent: (DShow)
grand_parent: C++
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

ğŸ˜º VMR9ì˜ renderingì„ ìš°ë¦¬ê°€ ì›í•˜ëŠ” í™”ë©´ì— í•˜ê³ ì í•œë‹¤.

ğŸ˜º ì´ì œ ë‹¤ì´ì–¼ë¡œê·¸ê°€ í•„ìš”í•˜ê¸°ì— ìƒˆë¡œ í”„ë¡œì íŠ¸ë¥¼ ì„¸íŒ…í•´ ë³´ì

---

## í”„ë¡œì íŠ¸ ì„¸íŒ…

* [Get This Code ğŸŒ](https://github.com/EasyCoding-7/dshow-basic/tree/main/dshow-basic-2)
* [ì°¸ê³ ì‚¬ì´íŠ¸ ğŸŒ(ë‚´ê°€ ë§Œë“  ì˜ˆì „ë¸”ë¡œ êµ³ì´ ì•ˆë´ë„ ë¨.)](https://8bitscoding.github.io/cpp/directx/basic/1/)

ğŸ˜º ì„¤ì •í•­ëª©

* C++20 ì„¸íŒ…
* ë‹¤ì¤‘ í”„ë¡œì„¸ì„œ ì»´íŒŒì¼(`/MP`) ì„¸íŒ… - ì»´íŒŒì¼ì†ë„ ì¦ê°€
* [ì½”ë“œ ì†ë„ ìš°ì„ ](https://docs.microsoft.com/ko-kr/cpp/build/reference/os-ot-favor-small-code-favor-fast-code?view=msvc-170) (`/Ot`) ì„¸íŒ… - EXE/DLL í¬ê¸°ë¥¼ ì¦ëŒ€ì‹œí‚¤ëŠ” ëŒ€ì‹  ì†ë„ë¥¼ ë¹ ë¥´ê²Œ í•œë‹¤.
* Release - 
    * ì „ì²˜ë¦¬ê¸° `NDEBUG`ì„ ì–¸
    * ë‹¤ì¤‘ ìŠ¤ë ˆë“œ(`/MT`) ì„ ì–¸ - ê° EXE/DLLì˜ heapì— CRT DLL ì˜¬ë¦°ë‹¤. + ë‚´ EXE/DLLì— CRT DLLì„ í¬í•¨, [ì°¸ê³  ğŸŒ](https://taehyungs-programming-blog.github.io/blog/docs/cpp/win32api/2022-01-14-win32-9/#printf%EC%99%80-%EA%B0%99%EC%9D%80-%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC%EB%8A%94-%EB%8F%99%EC%A0%81-%EC%A0%95%EC%A0%81-%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC-%EC%A4%91-%EB%AD%98%EA%B9%8C)
* Debug - 
    * ë‹¤ì¤‘ ìŠ¤ë ˆë“œ ë””ë²„ê·¸(`/MTd`) ì„ ì–¸
    * ë¶€ë™ ì†Œìˆ˜ì  ëª¨ë¸ (`/fp:fast`) ì„ ì–¸

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/cpp/dshow/dshow-2-1.png" style="border-radius:5%;border:1px solid #e6e1e8"/>
</p>

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/cpp/dshow/dshow-2-2.png" style="border-radius:5%;border:1px solid #e6e1e8"/>
</p>

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/cpp/dshow/dshow-2-3.png" style="border-radius:5%;border:1px solid #e6e1e8"/>
</p>

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/cpp/dshow/dshow-2-4.png" style="border-radius:5%;border:1px solid #e6e1e8"/>
</p>

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/cpp/dshow/dshow-2-5.png" style="border-radius:5%;border:1px solid #e6e1e8"/>
</p>

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/cpp/dshow/dshow-2-6.png" style="border-radius:5%;border:1px solid #e6e1e8"/>
</p>

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/cpp/dshow/dshow-2-7.png" style="border-radius:5%;border:1px solid #e6e1e8"/>
</p>

<br>

---

## VMR9 Surface Allocatorê°€ í•„ìš”í•œ ì´ìœ ?

ğŸ˜º ë‚´ê°€ ì›í•˜ëŠ” í™”ë©´ì— ì¶œë ¥í•˜ê¸° ìœ„í•´ì„  VMR9ì˜ ëœë”ë§ ê²°ê³¼ë¥¼ ì¶œë ¥í•  allocatorê°€ í•„ìš”í•˜ë‹¤

* [Get This Code ğŸŒ](https://github.com/EasyCoding-7/dshow-basic/tree/main/dshow-basic-3)
* [ì°¸ê³  ì½”ë“œëŠ” MSì˜ Windows-classic-samples ì°¸ì¡° ğŸŒ](https://github.com/microsoft/Windows-classic-samples/tree/main/Samples/Win7Samples/multimedia/directshow/vmr9/vmr9allocator)

```cpp
HRESULT SetAllocatorPresenter(IBaseFilter* filter/* CLSID_VideoMixingRenderer9 */, HWND window)
{
  if (filter == NULL)
  {
      return E_FAIL;
  }

  HRESULT hr;

  // CLSID_VideoMixingRenderer9ì˜ IVMRSurfaceAllocatorNotify9 ì¸í„°í˜ì´ìŠ¤ë¥¼ ë°›ëŠ”ë°
    // IVMRSurfaceAllocatorNotify9ê°€ í•„ìš”í•œ ì´ìœ ëŠ” Allocatorì„ ì–¸ì„ ìœ„í•´ì„œì´ë‹¤.
  SmartPtr<IVMRSurfaceAllocatorNotify9> lpIVMRSurfAllocNotify;
  FAIL_RET(filter->QueryInterface(IID_IVMRSurfaceAllocatorNotify9, reinterpret_cast<void**>(&lpIVMRSurfAllocNotify)));

  // ìš°ë¦¬ê°€ ë§Œë“  CAllocatorë¥¼ ìƒì„±
  g_allocator.Attach(new CAllocator(hr, window));
  if (FAILED(hr))
  {
      g_allocator = NULL;
      return hr;
  }

  // let the allocator and the notify know about each other
  // IVMRSurfaceAllocatorNotify9ì—ê²Œ Allocatorë¥¼ g_allocatorë¡œ ì‚¬ìš©í•œë‹¤ê³  ì•Œë¦°ë‹¤.
  FAIL_RET(lpIVMRSurfAllocNotify->AdviseSurfaceAllocator(g_userId, g_allocator)); // allocator í• ë‹¹

  // allocatorì—­ì‹œ IVMRSurfaceAllocatorNotify9ì„ ì•Œê³ ìˆì–´ì•¼ í•œë‹¤.
  FAIL_RET(g_allocator->AdviseNotify(lpIVMRSurfAllocNotify));                     // allocatorë„ notifyë¥¼ ì•Œê³ ìˆì–´ì•¼ vmrìƒíƒœ ë³€ê²½ì„ í˜¸ì¶œê°€ëŠ¥

  return hr;
}
```

* [IVMRSurfaceAllocatorNotify9 MSDN ğŸŒ](https://docs.microsoft.com/en-us/previous-versions/windows/desktop/api/Vmr9/nn-vmr9-ivmrsurfaceallocatornotify9)

```cpp
class CAllocator  : public  IVMRSurfaceAllocator9, // D3Deviceë¥¼ ì„ ì–¸, ê·¸ë ¤ì§ˆ Surfaceë¥¼ ë°›ì•„ì˜¨ë‹¤
                            IVMRImagePresenter9    // Surfaceì— ì–´ë–»ê²Œ ê·¸ë ¤ì§ˆì§€ ê²°ì •
{
public:
    CAllocator(HRESULT& hr, HWND wnd, IDirect3D9* d3d = NULL, IDirect3DDevice9* d3dd = NULL);
    virtual ~CAllocator();

    // IVMRSurfaceAllocator9
    virtual HRESULT STDMETHODCALLTYPE InitializeDevice( 
            /* [in] */ DWORD_PTR dwUserID,
            /* [in] */ VMR9AllocationInfo *lpAllocInfo,
            /* [out][in] */ DWORD *lpNumBuffers);
            
    virtual HRESULT STDMETHODCALLTYPE TerminateDevice( 
        /* [in] */ DWORD_PTR dwID);
    
    virtual HRESULT STDMETHODCALLTYPE GetSurface( 
        /* [in] */ DWORD_PTR dwUserID,
        /* [in] */ DWORD SurfaceIndex,
        /* [in] */ DWORD SurfaceFlags,
        /* [out] */ IDirect3DSurface9 **lplpSurface);
    
    virtual HRESULT STDMETHODCALLTYPE AdviseNotify( 
        /* [in] */ IVMRSurfaceAllocatorNotify9 *lpIVMRSurfAllocNotify);

    // IVMRImagePresenter9
    virtual HRESULT STDMETHODCALLTYPE StartPresenting( 
        /* [in] */ DWORD_PTR dwUserID);
    
    virtual HRESULT STDMETHODCALLTYPE StopPresenting( 
        /* [in] */ DWORD_PTR dwUserID);
    
    virtual HRESULT STDMETHODCALLTYPE PresentImage( 
        /* [in] */ DWORD_PTR dwUserID,
        /* [in] */ VMR9PresentationInfo *lpPresInfo);
    
    // IUnknown
    virtual HRESULT STDMETHODCALLTYPE QueryInterface( 
        REFIID riid,
        void** ppvObject);

    virtual ULONG STDMETHODCALLTYPE AddRef();
    virtual ULONG STDMETHODCALLTYPE Release();

protected:
    HRESULT CreateDevice();

    // a helper function to erase every surface in the vector
    void DeleteSurfaces();

    bool NeedToHandleDisplayChange();

    // This function is here so we can catch the loss of surfaces.
    // All the functions are using the FAIL_RET macro so that they exit
    // with the last error code.  When this returns with the surface lost
    // error code we can restore the surfaces.
    HRESULT PresentHelper(VMR9PresentationInfo *lpPresInfo);

private:
    // needed to make this a thread safe object
    CCritSec    m_ObjectLock;
    HWND        m_window;
    long        m_refCount;

    SmartPtr<IDirect3D9>                     m_D3D;
    SmartPtr<IDirect3DDevice9>               m_D3DDev;
    SmartPtr<IVMRSurfaceAllocatorNotify9>    m_lpIVMRSurfAllocNotify;
    vector<SmartPtr<IDirect3DSurface9> >     m_surfaces;
    SmartPtr<IDirect3DSurface9>              m_renderTarget;
    SmartPtr<IDirect3DTexture9>              m_privateTexture;
    CPlaneScene                             m_scene;
};
```

```cpp
HRESULT CAllocator::AdviseNotify( 
        /* [in] */ IVMRSurfaceAllocatorNotify9 *lpIVMRSurfAllocNotify)
{
    CAutoLock Lock(&m_ObjectLock);

    HRESULT hr;

    m_lpIVMRSurfAllocNotify = lpIVMRSurfAllocNotify;

    HMONITOR hMonitor = m_D3D->GetAdapterMonitor( D3DADAPTER_DEFAULT );

    // IVMRSurfaceAllocatorNotify9ì—ê²Œ D3DDeviceë¥¼ m_D3DDevë¡œ ì“°ê² ë‹¤ê³  ì•Œë¦°ë‹¤.
    FAIL_RET( m_lpIVMRSurfAllocNotify->SetD3DDevice( m_D3DDev, hMonitor ) );

    return hr;
}
```