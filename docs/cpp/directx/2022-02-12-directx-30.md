---
layout: default
title: "30. Instancing(+ PIX)"
parent: (DirectX)
grand_parent: C++
nav_order: 4
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## ì´ë¡ 

ğŸ˜º Particleì„ ë§Œë“¤ì‹œ Instanceë¥¼ ì—¬ëŸ¬ê°œ ë‘˜ ìˆ˜ ìˆì—ˆë‹¤.

```cpp
void Mesh::Render(uint32 instanceCount)
{
	GRAPHICS_CMD_LIST->IASetVertexBuffers(0, 1, &_vertexBufferView); // Slot: (0~15)
	GRAPHICS_CMD_LIST->IASetIndexBuffer(&_indexBufferView);

	GEngine->GetGraphicsDescHeap()->CommitTable();

	GRAPHICS_CMD_LIST->DrawIndexedInstanced(_indexCount, instanceCount, 0, 0, 0);
}
```

ğŸ˜º ì™œ Instanceë¥¼ ì—¬ëŸ¬ê°œ ë‘˜ ì‹œ ì„±ëŠ¥ìƒ ì´ë“ì„ ë³´ëŠ”ê°€?

<p align="center">
  <img src="https://taehyungs-programming-blog.github.io/blog/assets/images/cpp/directx/directx-29-2.png"/>
</p>

ğŸ˜º ì–´ë–»ê²Œ ë³´ë©´ ë‹¹ì—°í•œ ì–˜ê¸°ì¼ ìˆ˜ ìˆìœ¼ë‚˜ Vertex, Index Bufferë¥¼ GPUë¡œ ë„˜ê¸°ëŠ” ì‹œê°„ + Materialì„ ë„˜ê¸°ëŠ” ì‹œê°„ + ì‰ì´ë”ë¥¼ ê³„ì‚°í•˜ëŠ” ì‹œê°„ = ì´ ì†Œëª¨í•˜ëŠ” ì‹œê°„ì´ ëœë‹¤. ê²°ë¡ ì ìœ¼ë¡œ ë§í•˜ìë©´ Vertex, Index, Material, Shaderê°€ ê°™ë‹¤ë©´ Instancingì„ ì´ìš©í•˜ëŠ” ê²ƒì´ ì„±ëŠ¥ìƒ ë§¤ìš°ë§¤ìš°ë§¤ìš° ìœ ë¦¬í•˜ë‹¤

ğŸ˜º ì´ì „ê°• Instanceë¥¼ ì´ìš©ì‹œ GPUì—ì„œ í¬ê¸°, ìœ„ì¹˜, ì†ë„ ë“±ì„ ê³„ì‚°í–ˆëŠ”ë° ê·¸ëŸ° ì •ë³´ë¥¼ CPUì—ì„œ ì§ì ‘ì£¼ê³  ì‹¶ë‹¤ë©´ Constant Bufferë¥¼ ì‚¬ìš©í•´ì•¼í• ê¹Œ? 

```cpp
// ìš°ì„  ì •ë‹µë¶€í„° ë§í•˜ìë©´ Constant Bufferë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ê²Œ ë§ìŒ

void Mesh::Render(shared_ptr<InstancingBuffer>& buffer)
{
	D3D12_VERTEX_BUFFER_VIEW bufferViews[] = { _vertexBufferView, buffer->GetBufferView() };
	GRAPHICS_CMD_LIST->IASetVertexBuffers(0, 2/* CBë¥¼ 2ê°œ ì‚¬ìš©í•œë‹¤ ì•Œë¦°ë‹¤ */, bufferViews);
	GRAPHICS_CMD_LIST->IASetIndexBuffer(&_indexBufferView);

	GEngine->GetGraphicsDescHeap()->CommitTable();

	GRAPHICS_CMD_LIST->DrawIndexedInstanced(_indexCount, buffer->GetCount(), 0, 0, 0);
}
```

---

## êµ¬í˜„

```cpp
struct InstancingParams
{
    // ì¸ìŠ¤í„´ìŠ¤ë§ˆë‹¤ì˜ ì¢Œí‘œì •ë³´
	Matrix matWorld;
	Matrix matWV;
	Matrix matWVP;
};

class InstancingBuffer
{
public:
	InstancingBuffer();
	~InstancingBuffer();

	void Init(uint32 maxCount = 10);

	void Clear();
	void AddData(InstancingParams& params);
	void PushData();

public:
	uint32						GetCount() { return static_cast<uint32>(_data.size()); }
	ComPtr<ID3D12Resource>		GetBuffer() { return _buffer; }
	D3D12_VERTEX_BUFFER_VIEW	GetBufferView() { return _bufferView; }

	void	SetID(uint64 instanceId) { _instanceId = instanceId; }
	uint64	GetID() { return _instanceId; }

private:
	uint64						_instanceId = 0;
	ComPtr<ID3D12Resource>		_buffer;
	D3D12_VERTEX_BUFFER_VIEW	_bufferView;

	uint32						_maxCount = 0;
	vector<InstancingParams>	_data;
};
```

```cpp
// Instanceë„ ë³„ë„ì˜ Managerë¡œ ê´€ë¦¬í•˜ê²Œ ë˜ëŠ”ë°
class InstancingManager
{
	DECLARE_SINGLE(InstancingManager);

public:
	void Render(vector<shared_ptr<GameObject>>& gameObjects);

	void ClearBuffer();
	void Clear() { _buffers.clear(); }

private:
    // ì°¸ê³ ë¡œ ì´ì œ Instanceë¥¼ Instanceë³„ IDë¡œ ê´€ë¦¬í•˜ê²Œ ëœë‹¤.
    // Instance IDëŠ” Vertex, Index, Material ì •ë³´ê°€ ì¼ì¹˜í• ì‹œ ê°™ì€ IDë¥¼ ë¶€ì—¬í•  ê²ƒì¸ë° ë’¤ì—ì„œ ìì„¸íˆ ë‚˜ì˜´.
	void AddParam(uint64 instanceId, InstancingParams& data);

private:
	map<uint64/*instanceId*/, shared_ptr<InstancingBuffer>> _buffers;
    /*
        // InstanceIDëŠ” ì´ë ‡ê²Œ êµ¬í•œë‹¤
        uint64 MeshRenderer::GetInstanceID()
        {
            if (_mesh == nullptr || _material == nullptr)
                return 0;

            //uint64 id = (_mesh->GetID() << 32) | _material->GetID();
            InstanceID instanceID{ _mesh->GetID(), _material->GetID() };
            return instanceID.id;
        }
    */
};
```

* [PIX on Windows ğŸŒ](https://devblogs.microsoft.com/pix/download/)