---
layout: default
title: "04. [ë³µìŠµ] IOCP ë™ì‘ ì •ë¦¬"
parent: "(UE + IOCP)"
grand_parent: "Game Server ğŸ‘¾"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* [Get Code ğŸŒ](https://github.com/Arthur880708/cpp.unreal.server.example/tree/1)

---

## Service, Sessionì´ ë‚˜ì˜¤ëŠ”ë° ì´í•´ê°€ ì˜ ì•ˆëœë‹¤ë©´ ... IOCP ë™ì‘ ì •ë¦¬ê°€ í•„ìš”í•œ ì‹œì ì´ë‹¤.

* Socketì„ ë§Œë“¤ë©° ë“±ë¡í•˜ê²Œ ëœë‹¤.

```cpp
// Registerë¥¼ ì´ìš©í•´ Socketì„ ë“±ë¡í•œë‹¤
bool IocpCore::Register(IocpObjectRef iocpObject)
{
	return ::CreateIoCompletionPort(iocpObject->GetHandle()/*Handleì´ ì†Œì¼“ì„*/, _iocpHandle, /*key*/0, 0);
    /*
    HANDLE Session::GetHandle()
    {
        return reinterpret_cast<HANDLE>(_socket);
    }
    */
}
```

* ë‹¤ë¥¸ Threadì—ì„œ Dispatchê°€ í˜¸ì¶œëœë‹¤

```cpp
bool IocpCore::Dispatch(uint32 timeoutMs)
{
	// ...

	if (::GetQueuedCompletionStatus(_iocpHandle, OUT &numOfBytes, OUT &key, OUT reinterpret_cast<LPOVERLAPPED*>(&iocpEvent), timeoutMs))
	{
		IocpObjectRef iocpObject = iocpEvent->owner;
		iocpObject->Dispatch(iocpEvent, numOfBytes);
	}
    
	// ...
```

* Recvë¥¼ IOCPë¡œ ë°›ëŠ”ê³¼ì •ì„ ë³´ì

```cpp
void Session::RegisterRecv()
{
	if (IsConnected() == false)
		return;

    // Eventë¥¼ ë§Œë“¤ê³ 
	_recvEvent.Init();
	_recvEvent.owner = shared_from_this();

	WSABUF wsaBuf;
	wsaBuf.buf = reinterpret_cast<char*>(_recvBuffer.WritePos());
	wsaBuf.len = _recvBuffer.FreeSize();

	DWORD numOfBytes = 0;
	DWORD flags = 0;
    // IOCPì— ë“±ë¡í•´ë‘”ë‹¤
	if (SOCKET_ERROR == ::WSARecv(_socket, &wsaBuf, 1, OUT &numOfBytes, OUT &flags, &_recvEvent, nullptr))
	// ...
```

```cpp
bool IocpCore::Dispatch(uint32 timeoutMs)
{
	DWORD numOfBytes = 0;
	ULONG_PTR key = 0;	
	IocpEvent* iocpEvent = nullptr;

    // ì—¬ê¸°ì„œ Dispatchë˜ì–´ ë„˜ì–´ì˜¨ë‹¤
	if (::GetQueuedCompletionStatus(_iocpHandle, OUT &numOfBytes, OUT &key, OUT reinterpret_cast<LPOVERLAPPED*>(&iocpEvent), timeoutMs))
	{
		IocpObjectRef iocpObject = iocpEvent->owner;
		iocpObject->Dispatch(iocpEvent, numOfBytes);
	}
	
    // ...
```

```cpp
void Session::Dispatch(IocpEvent* iocpEvent, int32 numOfBytes)
{
    // ì—¬ê¸°ì„œ ë¶„ê¸°
	switch (iocpEvent->eventType)
	{
	case EventType::Connect:
		ProcessConnect();
		break;
	case EventType::Disconnect:
		ProcessDisconnect();
		break;
	case EventType::Recv:
		ProcessRecv(numOfBytes);
		break;
	case EventType::Send:
		ProcessSend(numOfBytes);
		break;
	default:
		break;
	}
}
```
