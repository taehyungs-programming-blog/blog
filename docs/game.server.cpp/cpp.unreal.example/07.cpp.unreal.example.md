---
layout: default
title: "07. PacketSession"
parent: "(UE + IOCP)"
grand_parent: "Game Server ğŸ‘¾"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* [Get Code ğŸŒ](https://github.com/Arthur880708/cpp.unreal.server.example/tree/2)

---

## FSocketì„ í™œìš©í•´ì„œ PacketSessionì„ ë§Œë“¤ì–´ ë³´ì

### ìš°ì„  Socket ì²˜ë¦¬ë¶€í„°

* Socket Programmingì´ ì–´ë””ë“¤ì–´ê°€ë©´ ì¢‹ì„ê¹Œ?
* GameInstanceì— ë„£ì–´ë³´ì
    * ì£¼ì˜í• ê²Œ Projectì— ê°€ì„œ GameInstanceë¥¼ ë‚´ê°€ ë§Œë“  GameInstanceë¡œ ë³€ê²½í•´ì¤˜ì•¼í•¨

```cpp
UCLASS()
class MyGameInstance : public UGameInstance
{
	// ...

    // BPë¥¼ í†µí•´ í•œë‹¤
    UFUNCTION(BlueprintCallable)
	void ConnectToGameServer();

	UFUNCTION(BlueprintCallable)
	void DisconnectFromGameServer();

public:
	// GameIstanceì—ì„œ Socketì—°ê²°ì„ ì‹œì‘í•  ì˜ˆì •
	class FSocket* Socket;
	FString IpAddress = TEXT("127.0.0.1");
	int16 Port = 7777;
	TSharedPtr<class PacketSession> GameServerSession;
};
```

```cpp
void US1GameInstance::ConnectToGameServer()
{
	// ...

	if (Connected)
	{
		GEngine->AddOnScreenDebugMessage(-1, 5.f, FColor::Red, FString::Printf(TEXT("Connection Success")));

		// ì—°ê²°ì´ ë§ºì–´ ì§„ ê²½ìš° PacketSessionì„ ì‹œì‘
		GameServerSession = MakeShared<PacketSession>(Socket);
		GameServerSession->Run();
	}
	else
	{
		GEngine->AddOnScreenDebugMessage(-1, 5.f, FColor::Red, FString::Printf(TEXT("Connection Failed")));
	}
}
```

* Q) FSocketì€ Blockingë°©ì‹ì¼ê¹Œ Non-Blocking ë°©ì‹ì¼ê¹Œ?
    * A) Blockingì„. ì£¼ì˜í•´ì„œ ì‚¬ìš©í•´ì•¼í•œë‹¤

### Sesssion ë§Œë“¤ê¸°

```cpp
class PacketSession : public TSharedFromThis<PacketSession>
{
public:
	PacketSession(class FSocket* Socket);
	~PacketSession();

	void Run();
    /*
void PacketSession::Run()
{
    // Runê³¼ ë™ì‹œì— ê° Threadë¥¼ ëŒë¦¬ê²Œ ëœë‹¤.
	RecvWorkerThread = MakeShared<RecvWorker>(Socket, AsShared());
	SendWorkerThread = MakeShared<SendWorker>(Socket, AsShared());
}
    */

	UFUNCTION(BlueprintCallable)
	void HandleRecvPackets();

	void SendPacket(SendBufferRef SendBuffer);

	void Disconnect();

public:
	class FSocket* Socket;

	TSharedPtr<class RecvWorker> RecvWorkerThread;
	TSharedPtr<class SendWorker> SendWorkerThread;

	TQueue<TArray<uint8>> RecvPacketQueue;
	TQueue<SendBufferRef> SendPacketQueue;
};
```

---

### Send ê³¼ì • ì •ë¦¬

```cpp
class ClientPacketHandler
{
    // ...

    // ê²°êµ­ ì—¬ê¸°ê°€ í•µì‹¬.
	template<typename T>
        // Të¡œ Protobufê°€ ë“¤ì–´ì˜¨ë‹¤
	static SendBufferRef MakeSendBuffer(T& pkt, uint16 pktId)
	{
		const uint16 dataSize = static_cast<uint16>(pkt.ByteSizeLong());
		const uint16 packetSize = dataSize + sizeof(PacketHeader);

        // Bufferì— packetSizeë§Œí¼ ë²„í¼ë¥¼ ë§Œë“ ë‹¤
		SendBufferRef sendBuffer = MakeShared<SendBuffer>(packetSize);


		PacketHeader* header = reinterpret_cast<PacketHeader*>(sendBuffer->Buffer());
		header->size = packetSize;
		header->id = pktId;

        // í—¤ë” ì´í›„ì— ë°ì´í„°ë¥¼ ë„£ëŠ”ë‹¤
            // pkg -> header[1]ì„
		pkt.SerializeToArray(&header[1], dataSize);
		sendBuffer->Close(packetSize);

		return sendBuffer;
	}
};
```

