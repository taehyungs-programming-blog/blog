---
layout: default
title: "05. [ë³µìŠµ] Service, Session, Recv, Send Buffer"
parent: "(UE + IOCP)"
grand_parent: "Game Server ğŸ‘¾"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* [Get Code ğŸŒ](https://github.com/Arthur880708/cpp.unreal.server.example/tree/1)

---

## Service

* ì—°ê²°ì„ ë‹´ë‹¹

```cpp
int main()
{
	// ...

    // ì‚¬ìš©ì€ ì´ë ‡ê²Œ í•œë‹¤
	ClientServiceRef service = make_shared<ClientService>(
		NetAddress(L"127.0.0.1", 7777),
		make_shared<IocpCore>(),
        // Session Factoryë¥¼ ë„˜ê¸´ë‹¤
		[=]() { return make_shared<ServerSession>(); }, 
		1);

	ASSERT_CRASH(service->Start());

	for (int32 i = 0; i < 2; i++)
	{
		GThreadManager->Launch([=]()
			{
				while (true)
				{
					service->GetIocpCore()->Dispatch();
				}
			});
	}
```

---

## Session

* íŒ¨í‚·ì´ ì˜¬ê²½ìš° ì–´ë–»ê²Œ ì²˜ë¦¬í•  ê²ƒì¸ê°€

```cpp
class ServerSession : public PacketSession
{
public:
	~ServerSession()
	{
		cout << "~ServerSession" << endl;
	}

	virtual void OnConnected() override
	{
		cout << "OnConnected" << endl;
		
		Protocol::C_ENTER_GAME pkt;
		auto sendBuffer = ClientPacketHandler::MakeSendBuffer(pkt);
		Send(sendBuffer);
	}

	virtual void OnRecvPacket(BYTE* buffer, int32 len) override
	{
		PacketSessionRef session = GetPacketSessionRef();
		PacketHeader* header = reinterpret_cast<PacketHeader*>(buffer);

		// TODO : packetId ëŒ€ì—­ ì²´í¬
		ClientPacketHandler::HandlePacket(session, buffer, len);
	}

	virtual void OnSend(int32 len) override
	{
		cout << "OnSend Len = " << len << endl;
	}

	virtual void OnDisconnected() override
	{
		cout << "Disconnected" << endl;
	}
};
```

---

## Recv Buffer

```cpp
void Session::RegisterRecv()
{
	if (IsConnected() == false)
		return;

    // Event ë“±ë¡
	_recvEvent.Init();
	_recvEvent.owner = shared_from_this(); // ADD_REF

    // Bufferë“±ë¡
	WSABUF wsaBuf;
	wsaBuf.buf = reinterpret_cast<char*>(_recvBuffer.WritePos());
	wsaBuf.len = _recvBuffer.FreeSize();

	DWORD numOfBytes = 0;
	DWORD flags = 0;
    // IOCPì— Recvë¥¼ ê±´ë‹¤
	if (SOCKET_ERROR == ::WSARecv(_socket, &wsaBuf, 1, OUT &numOfBytes, OUT &flags, &_recvEvent, nullptr))
	{
		int32 errorCode = ::WSAGetLastError();
		if (errorCode != WSA_IO_PENDING)
		{
			HandleError(errorCode);
			_recvEvent.owner = nullptr; // RELEASE_REF
		}
	}
}
```

---

## Send Buffer

* ë©€í‹°ì“°ë ˆë“œ ê³ ë ¤í•´ì•¼í•¨.

```cpp
void Session::Send(SendBufferRef sendBuffer)
{
	if (IsConnected() == false)
		return;

	bool registerSend = false;

	{
		WRITE_LOCK;

		_sendQueue.push(sendBuffer);

		if (_sendRegistered.exchange(true) == false)
			registerSend = true;
	}
	
	if (registerSend)
		RegisterSend();
}
```