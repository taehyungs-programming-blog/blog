---
layout: default
title: "09. ì´ë™ ë™ê¸°í™”"
parent: "(UE + IOCP)"
grand_parent: "Game Server ğŸ‘¾"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* [Get Code ğŸŒ](https://github.com/Arthur880708/cpp.unreal.server.example/tree/4)

---

## ìºë¦­í„° ê´€ë¦¬í•˜ê¸°

```cpp
// Spawn ì²˜ë¦¬
void GameInstance::HandleSpawn(const Protocol::PlayerInfo& PlayerInfo, bool IsMine)
{
	// ...

	if (IsMine)
	{
        // PlayerControllerë¥¼ ì–»ì–´ì™€
		auto* PC = UGameplayStatics::GetPlayerController(this, 0);
        // 
		AS1Player* Player = Cast<AS1Player>(PC->GetPawn());
		if (Player == nullptr)
			return;

		Player->SetPlayerInfo(PlayerInfo);
		MyPlayer = Player;
		Players.Add(PlayerInfo.object_id(), Player);
	}
	else
	{
		AS1Player* Player = Cast<AS1Player>(World->SpawnActor(OtherPlayerClass, &SpawnLocation));
		Player->SetPlayerInfo(PlayerInfo);
		Players.Add(PlayerInfo.object_id(), Player);
	}
}
```

### ì°¸ê³ ) **Pawn**ì´ë€?

* **Pawn**ì€ ê²Œì„ ë‚´ì—ì„œ í”Œë ˆì´ì–´ë‚˜ AIì— ì˜í•´ ì¡°ì¢…ë  ìˆ˜ ìˆëŠ” ëª¨ë“  ì•¡í„°(Actor)ì˜ ê¸°ë³¸ í´ë˜ìŠ¤ì…ë‹ˆë‹¤. 
* Pawnì€ ê²Œì„ ì›”ë“œ ë‚´ì˜ ìºë¦­í„°, ì°¨ëŸ‰, ë˜ëŠ” ê¸°íƒ€ ì¡°ì¢… ê°€ëŠ¥í•œ ì—”í‹°í‹°ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
* **ì–´ë””ì„œ ì„¤ì •í•˜ë‚˜?**
    * ì°½ -> ì›”ë“œ ì„¸íŒ… -> Game Mode -> ì„ íƒëœ ê²Œì„ ëª¨ë“œ -> ë””í´íŠ¸ í° í´ë˜ìŠ¤

---

## ìºë¦­í„° ì´ë™ì²˜ë¦¬

```cpp
// ë‚´ í‚¤ë¦­í„° ê¸°ì¤€
void MyPlayer::Tick(float DeltaTime)
{
	Super::Tick(DeltaTime);

	// ...
    
	MovePacketSendTimer -= DeltaTime;

	if (MovePacketSendTimer <= 0 || ForceSendPacket)
	{
		MovePacketSendTimer = MOVE_PACKET_SEND_DELAY;

		Protocol::C_MOVE MovePkt;

		// í˜„ì¬ ìœ„ì¹˜ ì •ë³´
		{
			Protocol::PlayerInfo* Info = MovePkt.mutable_info();
			Info->CopyFrom(*PlayerInfo);
			Info->set_yaw(DesiredYaw);
			Info->set_state(GetMoveState());
		}

		SEND_PACKET(MovePkt);
	}
}
```

```cpp
void Player::Tick(float DeltaSeconds)
{
	Super::Tick(DeltaSeconds);

	{
		FVector Location = GetActorLocation();
		PlayerInfo->set_x(Location.X);
		PlayerInfo->set_y(Location.Y);
		PlayerInfo->set_z(Location.Z);
		PlayerInfo->set_yaw(GetControlRotation().Yaw);
	}

	if (IsMyPlayer() == false)
	{
		const Protocol::MoveState State = PlayerInfo->state();

		if (State == Protocol::MOVE_STATE_RUN)
		{
			SetActorRotation(FRotator(0, DestInfo->yaw(), 0));
			AddMovementInput(GetActorForwardVector());
		}
	}
}
```

```cpp
// Move Packetì´ ì˜¤ë©´ ì²˜ë¦¬í•œë‹¤
void GameInstance::HandleMove(const Protocol::S_MOVE& MovePkt)
{
	if (Socket == nullptr || GameServerSession == nullptr)
		return;

	auto* World = GetWorld();
	if (World == nullptr)
		return;

	const uint64 ObjectId = MovePkt.info().object_id();
	AS1Player** FindActor = Players.Find(ObjectId);
	if (FindActor == nullptr)
		return;

	AS1Player* Player =	(*FindActor);
	if (Player->IsMyPlayer())
		return;
		
	const Protocol::PlayerInfo& Info = MovePkt.info();
	//Player->SetPlayerInfo(Info);
	Player->SetDestInfo(Info);
}
```

---

## ì´ë™ì²˜ë¦¬ì‹œ Tickì´ ê¸¸ì–´ì§ˆ ê²½ìš° ëŠê²¨ ë³´ì´ì§€ ì•Šì„ê¹Œ? -> ë³´ì •ì²˜ë¦¬ë¥¼ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œ?

```cpp
// ì§ì ‘ì´ë™í•˜ì§€ ì•Šê³  ì´ë™ì²˜ë¦¬ë§Œ ìš”ì²­í•œë‹¤

void Player::SetDestInfo(const Protocol::PlayerInfo& Info)
{
	if (PlayerInfo->object_id() != 0)
	{
		assert(PlayerInfo->object_id() == Info.object_id());
	}

	// ìµœì¢…ìƒíƒœ ë³µì‚¬
	DestInfo->CopyFrom(Info);

	// ìƒíƒœë§Œ ë³€ê²½
	SetMoveState(Info.state());
}
```

```cpp
void Player::Tick(float DeltaSeconds)
{
	Super::Tick(DeltaSeconds);

	{
		FVector Location = GetActorLocation();
		PlayerInfo->set_x(Location.X);
		PlayerInfo->set_y(Location.Y);
		PlayerInfo->set_z(Location.Z);
		PlayerInfo->set_yaw(GetControlRotation().Yaw);
	}

	if (IsMyPlayer() == false)
	{
		const Protocol::MoveState State = PlayerInfo->state();

		if (State == Protocol::MOVE_STATE_RUN)
		{
			SetActorRotation(FRotator(0, DestInfo->yaw(), 0));
			AddMovementInput(GetActorForwardVector());
		}
	
	}
}
```