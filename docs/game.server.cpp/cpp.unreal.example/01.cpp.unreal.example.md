---
layout: default
title: "01. ë³µìŠµ - Protobuf, CodeGen"
parent: "(UE + IOCP)"
grand_parent: "Game Server ğŸ‘¾"
nav_order: 1
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

* [Get Code ğŸŒ](https://github.com/Arthur880708/cpp.unreal.server.example/tree/1)

---

## Protobufë¥¼ ì–´ë–»ê²Œ í™œìš©í•  ê²ƒì¸ê°€?

* XXXHandler.h/cpp ìë™ìƒì„±í•˜ëŠ” ê²ƒ
    * Python Generator ì°¸ì¡°
* .proto íŒŒì¼ì˜ 
    * `C_` : Client to Server
    * `S_` : Server to Client

---

## CodeGen

* Build ì´ë²¤íŠ¸ë¡œ GenPackets.batì„ ì‹¤í–‰í•œë‹¤

```bat
@rem bat íŒŒì¼ ë‚´ë¶€

@rem í˜„ì¬ ë””ë ‰í„°ë¦¬ë¥¼ working ë””ë ‰í„°ë¦¬ë¡œ ì§€ì •
pushd %~dp0

@rem protobufë¥¼ ì´ìš©í•´ .protoë¥¼ ì½ì–´ .pb.h/.cppë¥¼ ë§Œë“ ë‹¤
protoc.exe -I=./ --cpp_out=./ ./Enum.proto
protoc.exe -I=./ --cpp_out=./ ./Struct.proto
protoc.exe -I=./ --cpp_out=./ ./Protocol.proto

GenPackets.exe --path=./Protocol.proto --output=ClientPacketHandler --recv=S_ --send=C_
GenPackets.exe --path=./Protocol.proto --output=ServerPacketHandler --recv=C_ --send=S_

IF ERRORLEVEL 1 PAUSE

@rem ... 
@rem ë§Œë“¤ì–´ì§„ íŒŒì¼ ë³µì‚¬
```

---

### .proto

```csharp
syntax = "proto3";
package Protocol;

// enum ì§€ì •
enum PlayerType
{
	PLAYER_TYPE_NONE = 0;
	PLAYER_TYPE_KNIGHT = 1;
	PLAYER_TYPE_MAGE = 2;
	PLAYER_TYPE_ARCHER = 3;
}
```

```csharp
syntax = "proto3";
package Protocol;

// êµ¬ì¡°ì²´ ì§€ì •
import "Enum.proto";

message Player
{
	uint64 playerId = 1;
}
```

```csharp
syntax = "proto3";
package Protocol;

import "Enum.proto";
import "Struct.proto";

// ë©”ì‹œì§€ ì§€ì •
message C_LOGIN
{

}

message S_LOGIN
{
	bool success = 1;
	repeated Player players = 2;
}

message C_ENTER_GAME
{
	uint64 playerIndex = 1;
}

message S_ENTER_GAME
{
	bool success = 1;
}

message C_CHAT
{
	string msg = 1;
}

message S_CHAT
{
	uint64 playerId = 1;
	string msg = 2;
}
```

```cpp
bool Handle_S_CHAT(PacketSessionRef& session, Protocol::S_CHAT& pkt)
{
    // ì´ëŸ°ì‹ìœ¼ë¡œ ì ‘ê·¼ê°€ëŠ¥.
	pkt.playerid();
	pkt.msg();
	return true;
}
```

---

## (ì¶”ê°€) Protobufì— ëŒ€í•´ì„œ

* Protocol Buffers (protobuf)
    * Googleì—ì„œ ê°œë°œí•œ **ë°ì´í„° ì§ë ¬í™” ì‹œìŠ¤í…œ**ì…ë‹ˆë‹¤. 
    * ì´ ì‹œìŠ¤í…œì€ íŠ¹íˆ ë„¤íŠ¸ì›Œí¬ í†µì‹  ë° ë°ì´í„° ì €ì¥ì„ ìœ„í•œ êµ¬ì¡°í™”ëœ ë°ì´í„°ì˜ íš¨ìœ¨ì ì¸ ì§ë ¬í™”ë¥¼ ëª©ì ìœ¼ë¡œ í•©ë‹ˆë‹¤. 
* ì¥ì :
    * íš¨ìœ¨ì ì¸ ë°ì´í„° ì €ì¥ ë° ì „ì†¡: protobufëŠ” JSONì´ë‚˜ XMLë³´ë‹¤ í›¨ì”¬ íš¨ìœ¨ì ì¸ ë°”ì´ë„ˆë¦¬ í˜•ì‹ì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  ì „ì†¡í•©ë‹ˆë‹¤. ì´ëŠ” ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ê³¼ ì €ì¥ **ê³µê°„ì„ ì ˆì•½**í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.
    * ì–¸ì–´ ì¤‘ë¦½ì : protobufëŠ” ë‹¤ì–‘í•œ í”„ë¡œê·¸ë˜ë° ì–¸ì–´ë¥¼ ì§€ì›í•˜ì—¬, **ì„œë¡œ ë‹¤ë¥¸ ì–¸ì–´ë¡œ ì‘ì„±ëœ ì‹œìŠ¤í…œ ê°„ì˜ í†µì‹ ì„ ìš©ì´**í•˜ê²Œ í•©ë‹ˆë‹¤.
    * í™•ì¥ ê°€ëŠ¥í•œ ë°ì´í„° í˜•ì‹: ìƒˆë¡œìš´ í•„ë“œë¥¼ ë©”ì‹œì§€ì— ì¶”ê°€í•´ë„ ì´ì „ ë²„ì „ì˜ protobuf ì½”ë“œì™€ í˜¸í™˜ë©ë‹ˆë‹¤. ì´ëŠ” ì‹œìŠ¤í…œì˜ í™•ì¥ì„± ë° ìœ ì§€ ê´€ë¦¬ì— ìœ ë¦¬í•©ë‹ˆë‹¤.
    * ê°•ë ¥í•œ íƒ€ì… ì²´í¬: ë°ì´í„° í•„ë“œëŠ” ëª…í™•í•œ íƒ€ì…ì„ ê°€ì§€ë¯€ë¡œ, ì˜¤ë¥˜ ê°€ëŠ¥ì„±ì„ ì¤„ì—¬ì¤ë‹ˆë‹¤.
    * ìë™ ì½”ë“œ ìƒì„±: .proto íŒŒì¼ì—ì„œ ë°ì´í„° êµ¬ì¡°ë¥¼ ì •ì˜í•˜ë©´, protobuf ì»´íŒŒì¼ëŸ¬ê°€ ìë™ìœ¼ë¡œ í•´ë‹¹ ë°ì´í„° êµ¬ì¡°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

```
syntax = "proto3";

message Person {
  string name = 1;
  int32 id = 2;
  string email = 3;
}
```

```cpp
// C++ Example

#include <iostream>
#include <fstream>
#include "person.pb.h"  // protobuf ì»´íŒŒì¼ëŸ¬ì— ì˜í•´ ìƒì„±ëœ í—¤ë” íŒŒì¼

using namespace std;

int main() {
    Person person;
    person.set_name("Alice");
    person.set_id(123);
    person.set_email("alice@example.com");

    // ë©”ì‹œì§€ë¥¼ ì§ë ¬í™”
    string binary;
    person.SerializeToString(&binary);

    // ë©”ì‹œì§€ë¥¼ íŒŒì¼ì— ì €ì¥
    ofstream output("person.bin", ios::binary);
    person.SerializeToOstream(&output);
    output.close();

    // íŒŒì¼ì—ì„œ ë©”ì‹œì§€ ì½ê¸°
    Person person2;
    ifstream input("person.bin", ios::binary);
    if (person2.ParseFromIstream(&input)) {
        cout << "Name: " << person2.name() << endl;
        cout << "ID: " << person2.id() << endl;
        cout << "Email: " << person2.email() << endl;
    }

    return 0;
}

```

```csharp
// ë¬¼ë¡  C#ë„ ê°€ëŠ¥í•˜ë‹¤

using System;
using System.IO;
using Google.Protobuf;  // protobuf ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.

public class ProtobufExample {
    public static void Main() {
        // Person ê°ì²´ ìƒì„± ë° ì´ˆê¸°í™”
        Person person = new Person {
            Name = "Alice",
            Id = 123,
            Email = "alice@example.com"
        };

        // ë©”ì‹œì§€ë¥¼ ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¡œ ì§ë ¬í™”
        using (var output = File.Create("person.bin")) {
            person.WriteTo(output);
        }

        // íŒŒì¼ì—ì„œ ë©”ì‹œì§€ ì½ê¸° ë° ì—­ì§ë ¬í™”
        Person person2;
        using (var input = File.OpenRead("person.bin")) {
            person2 = Person.Parser.ParseFrom(input);
        }

        // ì½ì€ ë°ì´í„° ì¶œë ¥
        Console.WriteLine($"Name: {person2.Name}");
        Console.WriteLine($"ID: {person2.Id}");
        Console.WriteLine($"Email: {person2.Email}");
    }
}

```